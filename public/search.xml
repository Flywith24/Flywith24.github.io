<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä½¿ç”¨ AccountManager å®ç°ç³»ç»Ÿå†…å…±äº«è´¦å·</title>
      <link href="/2020/09/04/AccountManager/"/>
      <url>/2020/09/04/AccountManager/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨-AccountManager-å®ç°ç³»ç»Ÿå†…å…±äº«è´¦å·"><a href="#ä½¿ç”¨-AccountManager-å®ç°ç³»ç»Ÿå†…å…±äº«è´¦å·" class="headerlink" title="ä½¿ç”¨ AccountManager å®ç°ç³»ç»Ÿå†…å…±äº«è´¦å·"></a>ä½¿ç”¨ AccountManager å®ç°ç³»ç»Ÿå†…å…±äº«è´¦å·</h1><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯èƒ½é‡åˆ°è‡ªå®¶åº”ç”¨é—´å…±äº«è´¦å·çš„åœºæ™¯ã€‚ä¾‹å¦‚ APP1 ç™»å½•æˆåŠŸåï¼Œå¯åŠ¨ APP2 æ—¶è‡ªåŠ¨å®Œæˆç™»å½•å¹¶ä¸ APP1 å…±äº«è´¦å·ä¿¡æ¯ã€‚</p><p>Android ä¸ºæˆ‘ä»¬æä¾›äº†AccountManager æ¥ç®¡ç†è´¦å·ä¿¡æ¯ã€‚</p><p><a href="https://github.com/Flywith24/AccountManagerDemo" target="_blank" rel="noopener">demo åœ°å€</a></p><a id="more"></a><h2 id="å…±äº«å‰æ"><a href="#å…±äº«å‰æ" class="headerlink" title="å…±äº«å‰æ"></a>å…±äº«å‰æ</h2><ol><li>ä¸¤ä¸ª app åœ¨ä¸€ä¸ªç”¨æˆ·ç»„å†…</li><li>ä½¿ç”¨ç›¸åŒçš„ç­¾åï¼ˆä½¿ç”¨ debug é»˜è®¤ç­¾åä¹Ÿå¯ä»¥å…±äº«ï¼‰</li><li>accountType ç›¸åŒ</li></ol><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><blockquote><p>AccountManageræ˜¯ä¸€ä¸ªé¢å‘åº”ç”¨ç¨‹åºå¼€å‘çš„ç»„ä»¶ï¼Œå®ƒæä¾›äº†ä¸€å¥—å¯¹åº”äº IAccountManager åè®®çš„åº”ç”¨ç¨‹åºæ¥å£ï¼›è¿™ç»„æ¥å£é€šè¿‡Binderæœºåˆ¶ä¸ç³»ç»ŸæœåŠ¡AccountManagerServiceè¿›è¡Œé€šä¿¡ï¼Œåä½œå®Œæˆå¸å·ç›¸å…³çš„æ“ä½œã€‚åŒæ—¶ï¼ŒAccountManageræ¥æ”¶authenticators æä¾›çš„å›è°ƒï¼Œä»¥ä¾¿åœ¨å¸å·æ“ä½œå®Œæˆä¹‹åå‘<em>è°ƒç”¨æ­¤å¸å·æœåŠ¡çš„ä¸šåŠ¡</em>è¿”å›å¯¹åº”çš„æ¥å£ï¼ŒåŒæ—¶è§¦å‘è¿™ä¸ªä¸šåŠ¡å¯¹ç»“æœçš„å¤„ç†ã€‚<br>- authenticators å³æ³¨å†Œå¸å·æœåŠ¡çš„appï¼›<br>- ä¸šåŠ¡è°ƒç”¨æ–¹ å³ä½¿ç”¨authenticatorsæä¾›çš„å¸å·æœåŠ¡çš„ç¬¬ä¸‰æ–¹ï¼Œä¹Ÿå¯ä»¥æ˜¯authenticatorè‡ªå·±</p><p>æ‘˜è‡ªï¼š<a href="https://blog.csdn.net/dzkdxyx/article/details/78569867" target="_blank" rel="noopener">Android AccountManagerå¸å·ç®¡ç†ï¼ˆä¸€ï¼‰</a></p></blockquote><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>è¯¥é¡¹ç›®ä¸­æœ‰ä¸¤ä¸ª module ï¼Œapp å¯¹åº”æ³¨å†Œè´¦å·æœåŠ¡çš„appï¼Œapp1 å¯¹åº”ä½¿ç”¨è´¦å·æœåŠ¡çš„ç¬¬ä¸‰æ–¹åº”ç”¨</p><ul><li><p>åœ¨ä¸¤ä¸ªåº”ç”¨çš„ manifest ä¸­åŠ å…¥ <code>&lt;uses-permission android:name=&quot;android.permission.GET_ACCOUNTS&quot; /&gt;</code> æƒé™</p></li><li><p>åœ¨ app ä¸­åˆ›å»º <code>authenticator.xml</code> æ–‡ä»¶ï¼Œæ³¨æ„ accountType çš„é…ç½®ï¼Œè¿™é‡Œçš„åº”ç”¨ååŠ icon ä¼šåœ¨è®¾å¤‡çš„ è®¾ç½® -&gt; è´¦å· ä¸­æ˜¾ç¤º</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904152225.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p></li><li><p>åœ¨ app ä¸­æ³¨å†Œä¸€ä¸ª action ä¸ºâ€œandroid.accounts.AccountAuthenticatorâ€çš„ authenticator serviceï¼Œå¼•å…¥ä¸Šä¸€æ­¥åˆ›å»ºçš„ xml æ–‡ä»¶</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904152006.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904152029.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p></li></ul><ul><li><p>åœ¨ app ä¸­åˆ›å»º  authenticator</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904151929.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p></li></ul><h2 id="åˆ›å»ºè´¦å·"><a href="#åˆ›å»ºè´¦å·" class="headerlink" title="åˆ›å»ºè´¦å·"></a>åˆ›å»ºè´¦å·</h2><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904153019.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h2 id="åˆ é™¤è´¦å·"><a href="#åˆ é™¤è´¦å·" class="headerlink" title="åˆ é™¤è´¦å·"></a>åˆ é™¤è´¦å·</h2><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904153112.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h2 id="ç¬¬ä¸‰æ–¹-app-è·å–-ç”¨æˆ·ï¼Œtoken-ç­‰ä¿¡æ¯"><a href="#ç¬¬ä¸‰æ–¹-app-è·å–-ç”¨æˆ·ï¼Œtoken-ç­‰ä¿¡æ¯" class="headerlink" title="ç¬¬ä¸‰æ–¹ app è·å– ç”¨æˆ·ï¼Œtoken ç­‰ä¿¡æ¯"></a>ç¬¬ä¸‰æ–¹ app è·å– ç”¨æˆ·ï¼Œtoken ç­‰ä¿¡æ¯</h2><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200904154855.png" src="/2020/09/04/AccountManager/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> ROM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROM </tag>
            
            <tag> framework </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€æŠ˜è…¾Frameworkã€‘æºç ç¼–è¯‘ä¸çƒ§å†™</title>
      <link href="/2020/08/18/Framework-Compile/"/>
      <url>/2020/08/18/Framework-Compile/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç¯å¢ƒæ­å»ºç­‰å†…å®¹ç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p>æ­¤å¤„ä»¥ Pixel 3a &amp; Android 10 ä¸ºä¾‹ä»‹ç»å¦‚ä½•ç¼–è¯‘ ROM åŒ…å¹¶çƒ§å½•</p><p>æ‰‹ä¸Šæ²¡æœ‰çœŸæœºçš„å°ä¼™ä¼´å¯ä»¥é€‰æ‹©åˆ¶ä½œæ¨¡æ‹Ÿå™¨ï¼Œæœ¬æ–‡æœ€åæä¾›äº†åŸºäº Android 10 ç¼–è¯‘çš„è‡ªå®šä¹‰ AVD ä¸‹è½½é“¾æ¥</p><a id="more"></a><h2 id="ç¼–è¯‘ç¯å¢ƒ"><a href="#ç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="ç¼–è¯‘ç¯å¢ƒ"></a>ç¼–è¯‘ç¯å¢ƒ</h2><p><a href="https://source.android.com/setup/build/initializing" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><h2 id="ä¸‹è½½æºç "><a href="#ä¸‹è½½æºç " class="headerlink" title="ä¸‹è½½æºç "></a>ä¸‹è½½æºç </h2><p>è¿™é‡Œæ¨èä½¿ç”¨ <a href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/" target="_blank" rel="noopener">æ¸…åé•œåƒ</a></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200628155443.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä¸‹è½½ <a href="https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar" target="_blank" rel="noopener">æ¯æœˆæ›´æ–°çš„åˆå§‹åŒ–åŒ…</a> å¹¶è§£å‹</p><h2 id="ä¸‹è½½é©±åŠ¨ï¼ˆå¯é€‰ï¼‰"><a href="#ä¸‹è½½é©±åŠ¨ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="ä¸‹è½½é©±åŠ¨ï¼ˆå¯é€‰ï¼‰"></a>ä¸‹è½½é©±åŠ¨ï¼ˆå¯é€‰ï¼‰</h2><p>å¦‚æœè¦åˆ·åˆ°çœŸæœºä¸Šï¼Œéœ€è¦ä¸‹è½½ç›¸åº”æœºå‹çš„é©±åŠ¨ï¼Œè¿›å…¥ <a href="https://developers.google.com/android/drivers" target="_blank" rel="noopener">è¯¥é“¾æ¥</a>ï¼Œé€‰æ‹©ç›¸åº”çš„æœºå‹å¯¹åº”çš„ Android ç‰ˆæœ¬å·å’Œé©±åŠ¨</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200628160058.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ Android 10.0.0ï¼ˆQQ3A.200605.002.A1ï¼‰</p><p>å°†ä¸¤ä¸ªé©±åŠ¨æ–‡ä»¶ä¸‹è½½å¹¶è§£å‹ï¼Œå¹¶æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs undefined">./extract-qcom-sargo.sh<br>./extract-google_devices-sargo.sh<br></code></pre></td></tr></table></figure><p>ç‚¹å‡» Enter å¹¶è¾“å…¥ I ACCEPT åŒæ„ License</p><p>æ ¹æ® Build åœ¨ <a href="https://source.android.com/setup/start/build-numbers" target="_blank" rel="noopener">è¯¥é“¾æ¥</a> ä¸­æ‰¾åˆ°ç›¸åŒ¹é…çš„åˆ†æ”¯ï¼Œæœ¬ä¾‹ä¸­å¯¹åº” <code>android-10.0.0_r39</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200628160259.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="QQ3A.200605.002.A1 å¯¹åº”çš„åˆ†æ”¯"></p><h2 id="é€‰æ‹©åˆ†æ”¯"><a href="#é€‰æ‹©åˆ†æ”¯" class="headerlink" title="é€‰æ‹©åˆ†æ”¯"></a>é€‰æ‹©åˆ†æ”¯</h2><p>æ‰§è¡Œå®Œä¸Šè¿°æ“ä½œå¦‚æœç›´æ¥ç¼–è¯‘çš„è¯å®é™…ä¸Šæ˜¯ç¼–è¯‘çš„ master åˆ†æ”¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ‡æ¢åˆ°æƒ³è¦ç¼–è¯‘çš„åˆ†æ”¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs undefined">repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-10.0.0_r39 --depth=1<br>repo sync -j8<br>repo start android-10.0.0_r39 --all<br></code></pre></td></tr></table></figure><h2 id="ç¼–è¯‘ä¸çƒ§å†™"><a href="#ç¼–è¯‘ä¸çƒ§å†™" class="headerlink" title="ç¼–è¯‘ä¸çƒ§å†™"></a>ç¼–è¯‘ä¸çƒ§å†™</h2><p>åœ¨æºç ç›®å½•æ‰§è¡Œ</p><p><code>source build/envsetup.sh</code></p><p><code>lunch</code> è¿›å…¥èœå•</p><p>é€‰æ‹©ç›¸åº”çš„ç‰ˆæœ¬</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200628162935.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ 19</p><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>æ¥ç€ä¾¿å¯ä»¥è¿›è¡Œç¼–è¯‘äº†ï¼Œå¯ä»¥ä½¿ç”¨ <code>make -j</code> å‘½ä»¤ï¼Œå…¶ä¸­ j ä»£è¡¨çš„æ˜¯ç¼–è¯‘ job çš„æ•°é‡</p><p>æ‰§è¡Œï¼ˆæˆ‘è¿™é‡ŒæŒ‡å®šäº†ç”Ÿæˆ log æ–‡ä»¶ï¼‰</p><p><code>make -j32 2&gt;&amp;1 | tee build_20200628_1635.log</code></p><p>ç¼–è¯‘æˆåŠŸåä¼šå‡ºç°ä¸€ä¸ª out ç›®å½•ï¼ŒROM é•œåƒæ–‡ä»¶å°±åœ¨æ­¤å¤„</p><p>ä¾‹å¦‚æˆ‘çš„è·¯å¾„ä¸ºï¼š<code>~/aosp/out/target/product/sargo</code></p><h2 id="çƒ§å†™"><a href="#çƒ§å†™" class="headerlink" title="çƒ§å†™"></a>çƒ§å†™</h2><p>è®¾å¤‡è¿›å…¥ bootloader å¹¶æ‰§è¡Œï¼š<code>fastboot flashall -w</code>ï¼Œå…¶ä¸­ -w ä»£è¡¨æ¸…ç©ºæ•°æ®</p><p>çƒ§å†™æˆåŠŸï¼Œå¼€æœºï¼</p><h2 id="åˆ¶ä½œè‡ªå®šä¹‰-AVDï¼ˆAndroid-Virtual-Devicesï¼‰-ç³»ç»Ÿé•œåƒ"><a href="#åˆ¶ä½œè‡ªå®šä¹‰-AVDï¼ˆAndroid-Virtual-Devicesï¼‰-ç³»ç»Ÿé•œåƒ" class="headerlink" title="åˆ¶ä½œè‡ªå®šä¹‰ AVDï¼ˆAndroid Virtual Devicesï¼‰ ç³»ç»Ÿé•œåƒ"></a>åˆ¶ä½œè‡ªå®šä¹‰ AVDï¼ˆAndroid Virtual Devicesï¼‰ ç³»ç»Ÿé•œåƒ</h2><p>å¾ˆå¤šå°ä¼™ä¼´æ²¡æœ‰ç›¸åº”çš„çœŸæœºï¼Œä¸è¿‡å¯ä»¥åˆ¶ä½œå‡ºè‡ªå®šä¹‰çš„ AVD ä½œä¸ºæ¨¡æ‹Ÿå™¨ä½¿ç”¨ã€‚</p><p><code>lunch</code> è¿›å…¥èœå•æ—¶é€‰æ‹©ç›¸åº”çš„æ¨¡æ‹Ÿå™¨ï¼Œä¾‹å¦‚é€‰æ‹©ä¸Šå›¾çš„ 24ï¼Œ64 ä½çš„é€šç”¨è®¾å¤‡</p><p>æƒ³è¦åˆ¶ä½œ AVD ç³»ç»Ÿé•œåƒéœ€è¦åˆ¶ä½œé™„åŠ  <code>sdk</code> å’Œ <code>sdk_repo</code> è½¯ä»¶åŒ…</p><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span> make -j32 sdk sdk_repo<br></code></pre></td></tr></table></figure><p>è¯¥æ“ä½œå¯èƒ½ä¼šå‡ºç°å¼‚å¸¸ï¼Œä¾‹å¦‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200818135050.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™æ˜¯ç”±äºæ²¡æœ‰ç¼–è¯‘è¿™äº›å·¥å…·å¯¼è‡´çš„ï¼Œè§£å†³åŠæ³•æ˜¯ä¾æ¬¡ç¼–è¯‘è¿™äº›å·¥å…·</p><p>ä¾æ¬¡è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œåé¢å·¥å…·è§†æƒ…å†µè€Œå®š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span> make libaapt2_jni<br><span class="hljs-meta"><br>$</span> make dmtracedump<br><span class="hljs-meta"><br>$</span> make etc1tool<br><span class="hljs-meta"><br>$</span> make deployagent<br><span class="hljs-meta"><br>$</span> make aapt<br><span class="hljs-meta"><br>$</span> make split-select<br><span class="hljs-meta"><br>$</span> make bcc_compat<br><span class="hljs-meta"><br>$</span> make apksigner<br><span class="hljs-meta"><br>$</span> make dx<br><span class="hljs-meta"><br>$</span> make layoutlib-legacy<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å¥½ç›¸å…³å·¥å…·æˆ‘ä»¬å†æ¬¡æ‰§è¡Œ <code>make -j32 sdk sdk_repo</code></p><p>ç¼–è¯‘æˆåŠŸåä¼šåœ¨ <code>out/host/linux-x86/sdk/aosp_x86_64</code> ç›®å½•ä¸‹ç”Ÿæˆ <code>sdk-repo-linux-system-images-eng.[username].zip</code> æ–‡ä»¶</p><p>æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä¸­ä½¿ç”¨é•œåƒçš„æ–¹å¼æˆ‘æ²¡æœ‰æˆåŠŸ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200818135851.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªå–å·§çš„æ–¹å¼</p><p>æˆ‘ä»¬åœ¨ Android Studio åˆ›å»º AVD æ—¶å¯é€‰çš„é•œåƒä¸€èˆ¬æœ‰ä¸‰ç§ï¼Œè¿™é‡Œè¿˜æ˜¯ä»¥ Android 10 ä¸ºä¾‹</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200818140305.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>Google Playï¼ŒGoogle APIsï¼Œå’Œé»˜è®¤çš„</p><p>å®ƒä»¬ä¼šä¸‹è½½åˆ° SDK/system-images/android-29 ä¸­</p><p>Google APIs ç‰ˆæœ¬å¯¹åº”çš„ç›®å½•å°±æ˜¯ google_apis</p><p>æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬ç¼–è¯‘å‡ºçš„ AVD é•œåƒ copy åˆ°å…¶ä¸­çš„ä¸€ä¸ªç›®å½•</p><p>ä¾‹å¦‚ï¼Œæˆ‘å°†è‡ªå®šä¹‰çš„ AVD é•œåƒæ”¾ç½®åœ¨äº†è¿™é‡Œï¼š</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200818140734.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘ä»¬åœ¨åˆ›å»ºæ¨¡æ‹Ÿå™¨æ—¶é€‰æ‹©è‡ªå®šä¹‰çš„ AVD é•œåƒå³å¯åˆ›å»ºå‡ºè‡ªå·±ç¼–è¯‘ ROM  çš„æ¨¡æ‹Ÿå™¨</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200818141020.png" src="/2020/08/18/Framework-Compile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™é‡Œæä¾›äº†æˆ‘ç¼–è¯‘å‡ºæ¥çš„è‡ªå®šä¹‰ AVDï¼Œä¸æ–¹ä¾¿è‡ªå·±ç¼–è¯‘çš„å°ä¼™ä¼´å¯ä»¥åœ¨æ­¤å¤„ä¸‹è½½</p><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1LIcuycoU4Ou42VsSBM_MuQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1LIcuycoU4Ou42VsSBM_MuQ</a><br>æå–ç ï¼šCAVD</p>]]></content>
      
      
      <categories>
          
          <category> ROM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROM </tag>
            
            <tag> framework </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¥‡æŠ€æ·«å·§ã€‘ä½¿ç”¨ ProcessLifecycle ä¼˜é›…åœ°ç›‘å¬åº”ç”¨å‰åå°åˆ‡æ¢</title>
      <link href="/2020/07/01/Tips-ProcessLifecycle/"/>
      <url>/2020/07/01/Tips-ProcessLifecycle/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¾ˆé«˜å…´è§åˆ°ä½ ï¼Œåˆæ¥åˆ°äº†ã€Œå¥‡æŠ€æ·«å·§ã€ç³»åˆ—ï¼Œæœ¬ç³»åˆ—ä»‹ç»ä¸€äº›ã€Œéªšæ“ä½œã€ï¼Œå¯èƒ½ä¸é€‚åˆç”¨äºç”Ÿäº§ï¼Œä½†å¯ä»¥å¼€æ‹“æ€è·¯</p><p>å‰äº›å¤©åœ¨ç¾¤é‡Œçœ‹åˆ°æœ‰äººè®¨è®ºé€šè¿‡ç»´æŠ¤ activity æ ˆæ¥ç›‘å¬ç¨‹åºå‰åå°åˆ‡æ¢çš„é—®é¢˜ã€‚å…¶å®å•çº¯ç›‘å¬ç¨‹åºçš„å‰åå°åˆ‡æ¢å®Œå…¨ä¸éœ€è¦ç»´æŠ¤ activity æ ˆï¼Œè€Œç°åœ¨æ¯”è¾ƒä¸»æµçš„åšæ³•æ˜¯ä½¿ç”¨ <code>registerActivityLifecycleCallbacks</code>ã€‚è€Œä»Šå¤©æˆ‘æ¥ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ ProcessLifecycleOwner æ¥å®ç°è¿™ä¸€åŠŸèƒ½</p><a id="more"></a><h2 id="lifecycle-process-åº“"><a href="#lifecycle-process-åº“" class="headerlink" title="lifecycle-process åº“"></a>lifecycle-process åº“</h2><p>Android Jetpack Lifecycle ç»„ä»¶æœ‰ä¸€ä¸ªå¯é€‰åº“ï¼šlifecycle-processï¼Œå®ƒå¯ä»¥ä¸ºæ•´ä¸ª app è¿›ç¨‹æä¾›ä¸€ä¸ª ProcessLifecycleOwner</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701110431.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="lifecycle-process å¼•å…¥"></p><p>è¯¥åº“ååˆ†ç®€å•ï¼Œåªæœ‰å››ä¸ªæ–‡ä»¶</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701110904.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="lifecycle-process"></p><p><code>ProcessLifecycleOwnerInitializer</code> å€ŸåŠ© ContentProvider æ‹¿åˆ° Contextï¼Œç”¨äºåˆå§‹åŒ–æ“ä½œ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701112017.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="init"></p><p><code>EmptyActivityLifecycleCallbacks</code> ä¸º <code>Application.ActivityLifecycleCallbacks</code> çš„å®ç°ç±»ï¼Œå†…éƒ¨ä¸ºç©ºå®ç°</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701112219.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="EmptyActivityLifecycleCallbacks"></p><p><code>LifecycleDispatcher</code> é€šè¿‡ ReportFragment æ¥ hook å®¿ä¸»çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701113143.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æ ¸å¿ƒé€»è¾‘éƒ½åœ¨ ProcessLifecycleOwner ä¸­</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701113324.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ProcessLifecycleOwner "></p><p>è¯¥ç±»æä¾›äº†æ•´ä¸ª app è¿›ç¨‹çš„ lifecycle</p><p>å¯ä»¥å°†å…¶è§†ä¸ºæ‰€æœ‰ activity çš„ LifecycleOwner ï¼Œå…¶ä¸­ <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle.Event#ON_CREATE" target="_blank" rel="noopener">Lifecycle.Event.ON_CREATE</a> åªä¼šåˆ†å‘ä¸€æ¬¡ï¼Œè€Œ <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle.Event#ON_DESTROY" target="_blank" rel="noopener">Lifecycle.Event.ON_DESTROY</a> åˆ™æ°¸è¿œä¸ä¼šåˆ†å‘</p><p>å…¶å®ƒçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å°†æŒ‰ä»¥ä¸‹è§„åˆ™åˆ†å‘ï¼š</p><p><code>ProcessLifecycleOwner</code> ä¼šåˆ†å‘ <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle.Event#ON_START" target="_blank" rel="noopener">Lifecycle.Event.ON_START</a> å’Œ <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle.Event#ON_RESUME" target="_blank" rel="noopener">Lifecycle.Event.ON_RESUME</a> äº‹ä»¶ï¼ˆåœ¨ç¬¬ä¸€ä¸ª activity ç§»åŠ¨åˆ°è¿™äº›äº‹ä»¶æ—¶ï¼‰</p><p><a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle.Event#ON_PAUSE" target="_blank" rel="noopener">Lifecycle.Event.ON_PAUSE</a> ä¸ <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle.Event#ON_STOP" target="_blank" rel="noopener">Lifecycle.Event.ON_STOP</a> ä¼šåœ¨æœ€åä¸€ä¸ª activity ç§»åŠ¨åˆ°è¿™äº›çŠ¶æ€å <strong>å»¶è¿Ÿ</strong> åˆ†å‘ï¼Œè¯¥å»¶è¿Ÿè¶³å¤Ÿé•¿ï¼Œä»¥ç¡®ä¿ç”±äºé…ç½®æ›´æ”¹ç­‰æ“ä½œé‡å»º activity åä¸ä¼šåˆ†å‘ä»»ä½•äº‹ä»¶</p><p>å¯¹äºç›‘å¬åº”ç”¨åœ¨å‰åå°åˆ‡æ¢ä¸”ä¸éœ€è¦æ¯«ç§’çº§çš„ç²¾åº¦çš„åœºæ™¯ï¼Œè¿™ååˆ†æœ‰ç”¨</p><h2 id="ProcessLifecycleOwner-æºç è§£æ"><a href="#ProcessLifecycleOwner-æºç è§£æ" class="headerlink" title="ProcessLifecycleOwner  æºç è§£æ"></a>ProcessLifecycleOwner  æºç è§£æ</h2><p>æ ¹æ®ä¸Šå›¾æˆ‘ä»¬å¾—çŸ¥ <code>ProcessLifecycleOwner</code>  å®ç°äº† LifecycleOwner æ¥å£</p><p>ç”±äºåœ¨ <code>ProcessLifecycleOwnerInitializer</code> ä¸­åˆå§‹åŒ–æ—¶ä¼ å…¥äº† Contextï¼Œå› æ­¤ <code>ProcessLifecycleOwner</code>  åœ¨ attach æ–¹æ³•ä¸­å€ŸåŠ© Context æ‹¿åˆ°äº† Application å®ä¾‹ï¼Œå¹¶è°ƒç”¨äº† <code>registerActivityLifecycleCallbacks</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">attach</span><span class="hljs-params">(Context context)</span> </span>&#123;<br>    mHandler = <span class="hljs-keyword">new</span> Handler();<br>    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);<br>    Application app = (Application) context.getApplicationContext();<br>    app.registerActivityLifecycleCallbacks(<span class="hljs-keyword">new</span> EmptyActivityLifecycleCallbacks() <br>        <span class="hljs-meta">@RequiresApi</span>(<span class="hljs-number">29</span>)<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPreCreated</span><span class="hljs-params">(@NonNull Activity activity,<br>                @Nullable Bundle savedInstanceState)</span> </span>&#123;<br>            <span class="hljs-comment">//æˆ‘ä»¬éœ€è¦ ProcessLifecycleOwner åˆšå¥½åœ¨ç¬¬ä¸€ä¸ª activity çš„ LifecycleOwner started/resumed ä¹‹å‰è·å– ON_START å’Œ ON_RESUMEã€‚</span><br>            <span class="hljs-comment">//activity çš„ LifecycleOwner é€šè¿‡åœ¨ onCreate() ä¸­æ·»åŠ  activity æ³¨å†Œçš„ callback æ¥è·å– started/resumed çŠ¶æ€ã€‚</span><br>            <span class="hljs-comment">//é€šè¿‡åœ¨ onActivityPreCreated() ä¸­æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„ activity æ³¨å†Œçš„ callbackï¼Œæˆ‘ä»¬é¦–å…ˆè·å¾—äº†å›è°ƒï¼ŒåŒæ—¶ä¸ Activity çš„ onStart()/ onResume()å›è°ƒç›¸æ¯”ä»å…·æœ‰æ­£ç¡®çš„ç›¸å¯¹é¡ºåº</span><br>     <br>            activity.registerActivityLifecycleCallbacks(<span class="hljs-keyword">new</span> EmptyActivityLifecycl<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPostStarted</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>                    activityStarted();<br>                &#125;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPostResumed</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>                    activityResumed();<br>                &#125;<br>            &#125;);<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityCreated</span><span class="hljs-params">(Activity activity, Bundle savedInstanceStat<br>            //ä»…åœ¨API <span class="hljs-number">29</span> ä¹‹å‰ä½¿ç”¨ ReportFragmentï¼Œåœ¨æ­¤ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨ onActivityPreCreated()</span> ä¸­æ³¨å†Œçš„ onActivityPostStarted å’Œ onActivityPostResumed å›è°ƒ<br>            <span class="hljs-title">if</span> <span class="hljs-params">(Build.VERSION.SDK_INT &lt; <span class="hljs-number">29</span>)</span> </span>&#123;<br>                ReportFragment.get(activity).setProcessListener(mInitializationLi<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPaused</span><span class="hljs-params">(Activity activity)</span> </span>&#123;<br>            activityPaused();<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityStopped</span><span class="hljs-params">(Activity activity)</span> </span>&#123;<br>            activityStopped();<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>å†…éƒ¨ç»´æŠ¤äº† Started å’Œ Resumed çš„æ•°é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mStartedCounter = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mResumedCounter = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> mPauseSent = <span class="hljs-keyword">true</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> mStopSent = <span class="hljs-keyword">true</span>;<br></code></pre></td></tr></table></figure><p>å¹¶åœ¨ activityStarted å’Œ activityResumed æ–¹æ³•ä¸­å¯¹ è¿™ä¸¤ä¸ªæ•°å€¼è¿›è¡Œ ++ï¼Œå¹¶æ›´æ”¹ lifecycle çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">activityStarted</span><span class="hljs-params">()</span> </span>&#123;<br>    mStartedCounter++;<br>    <span class="hljs-keyword">if</span> (mStartedCounter == <span class="hljs-number">1</span> &amp;&amp; mStopSent) &#123;<br>        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);<br>        mStopSent = <span class="hljs-keyword">false</span>;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">activityResumed</span><span class="hljs-params">()</span> </span>&#123;<br>    mResumedCounter++;<br>    <span class="hljs-keyword">if</span> (mResumedCounter == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (mPauseSent) &#123;<br>            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);<br>            mPauseSent = <span class="hljs-keyword">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mHandler.removeCallbacks(mDelayedPauseRunnable);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ activityPaused å’Œ activityStopped æ–¹æ³•å¯¹è¿™ä¸¤ä¸ªæ•°å€¼è¿›è¡Œ â€“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">activityPaused</span><span class="hljs-params">()</span> </span>&#123;<br>    mResumedCounter--;<br>    <span class="hljs-keyword">if</span> (mResumedCounter == <span class="hljs-number">0</span>) &#123;<br>        mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">activityStopped</span><span class="hljs-params">()</span> </span>&#123;<br>    mStartedCounter--;<br>    dispatchStopIfNeeded();<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œåœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸Šæ–‡æåˆ°çš„å»¶è¿Ÿæ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä½¿ç”¨ handler è¿›è¡Œå»¶è¿Ÿæ“ä½œ</span><br>mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);<br><br><span class="hljs-comment">// å»¶è¿Ÿ 700 ms</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> TIMEOUT_MS = <span class="hljs-number">700</span>; <span class="hljs-comment">//mls</span><br><br><span class="hljs-keyword">private</span> Runnable mDelayedPauseRunnable = <span class="hljs-keyword">new</span> Runnable() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// æ ¹æ®éœ€è¦åˆ†å‘äº‹ä»¶</span><br>        dispatchPauseIfNeeded();<br>        dispatchStopIfNeeded();<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dispatchPauseIfNeeded</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (mResumedCounter == <span class="hljs-number">0</span>) &#123;<br>        mPauseSent = <span class="hljs-keyword">true</span>;<br>        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dispatchStopIfNeeded</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (mStartedCounter == <span class="hljs-number">0</span> &amp;&amp; mPauseSent) &#123;<br>        mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);<br>        mStopSent = <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æºç å°±è§£æåˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å§</p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>é¦–å…ˆå¼•å…¥è¯¥åº“</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-process:2.3.0-alpha05"</span><br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬è¦è‡ªå®šä¹‰ lifecycleObserverï¼Œå› æ­¤è¿˜éœ€å¼•å…¥</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-common-java8:2.3.0-alpha05"</span><br></code></pre></td></tr></table></figure><p>é¦–å…ˆåˆ›å»º <code>ProcessLifecycleObserver</code> ç±»ï¼Œå®ç° <code>DefaultLifecycleObserver</code> æ¥å£ï¼Œåœ¨ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰“å° log</p><p>æ¥ç€åœ¨è‡ªå®šä¹‰ Application ä¸­åŠ å…¥</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200701121028.png" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™æ ·ä¾¿å®Œæˆäº†ï¼</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/7/1/173089686a09e8f3?w=1854&h=999&f=gif&s=2823298" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ¼”ç¤º"></p><p><a href="https://github.com/Flywith24/ProcessLifecycle-Demo" target="_blank" rel="noopener">Demo åœ¨è¿™é‡Œ</a></p><h2 id="ç³»åˆ—æ–‡ç« "><a href="#ç³»åˆ—æ–‡ç« " class="headerlink" title="ç³»åˆ—æ–‡ç« "></a>ç³»åˆ—æ–‡ç« </h2><ul><li><a href="https://juejin.im/post/5e481a28f265da570b3f235c" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘AndroidStudio Nexus3.xæ­å»ºMavenç§æœé‡åˆ°é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</a></li></ul><ul><li><a href="https://juejin.im/post/5e22c2ce6fb9a02ff67d41c3" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘ä»€ä¹ˆï¼Ÿé¡¹ç›®é‡Œgradleä»£ç è¶…è¿‡200è¡Œäº†ï¼ä½ å¯èƒ½éœ€è¦ Kotlin+buildSrc Plugin</a></li></ul><ul><li><a href="https://juejin.im/post/5e481a28f265da570b3f235c" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘gradleä¾èµ–æŸ¥æ‰¾å¤ªéº»çƒ¦ï¼Ÿè¿™ä¸ªæ’ä»¶å¯èƒ½å¸®åˆ°ä½ </a></li></ul><ul><li><a href="https://juejin.im/post/5e967f35f265da47d77cd4c3" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘Androidç»„ä»¶åŒ–ä¸ä½¿ç”¨ Router å¦‚ä½•å®ç°ç»„ä»¶é—´ activity è·³è½¬</a></li></ul><ul><li><a href="https://juejin.im/post/5ebdfb0b6fb9a0436153db22" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘æ–°çš„å›¾ç‰‡åŠ è½½åº“ï¼ŸåŸºäºKotlinåç¨‹çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil</a></li></ul><ul><li><a href="https://juejin.im/post/5ec50ae46fb9a047a862124f" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘ä½¿ç”¨ Navigation + Dynamic Feature Module å®ç°æ¨¡å—åŒ–</a></li></ul><ul><li><a href="https://juejin.im/post/5ecde219e51d457841190d08" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘é™¤äº† buildSrc è¿˜èƒ½è¿™æ ·ç»Ÿä¸€é…ç½®ä¾èµ–ç‰ˆæœ¬ï¼Ÿå·§ç”¨ includeBuild</a></li></ul><ul><li><a href="https://juejin.im/post/5ed9c92ce51d45789b35afa9" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘å·§ç”¨ kotlin æ‰©å±•å‡½æ•°å’Œ typealias å°è£… å¸¦ç½‘ç»œçŠ¶æ€å’Œè§£å†³ã€Œç²˜æ€§ã€äº‹ä»¶çš„ LiveData</a></li></ul><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/07/01/Tips-ProcessLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tips </tag>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¥‡æŠ€æ·«å·§ã€‘ä½¿ç”¨ Navigation + Dynamic Feature Module å®ç°æ¨¡å—åŒ–</title>
      <link href="/2020/05/20/Tips-Navagion+DynamicFeatureModule/"/>
      <url>/2020/05/20/Tips-Navagion+DynamicFeatureModule/</url>
      
        <content type="html"><![CDATA[<p><code>androidx navigation 2.3.0</code> åŠ å…¥äº†å¯¹ <code>dynamic feature module</code> çš„å¯¼èˆªæ”¯æŒï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ¥åˆ†ç¦»å‡ºå¤šä¸ªåŠŸèƒ½ module æ¥å®ç°æ¨¡å—åŒ–</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520170621.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="navigation 2.3.0 æ›´æ–°"></p><a id="more"></a><h2 id="å›½å†…åŸºæœ¬ä¸ç”¨çš„-dynamic-feature-module"><a href="#å›½å†…åŸºæœ¬ä¸ç”¨çš„-dynamic-feature-module" class="headerlink" title="å›½å†…åŸºæœ¬ä¸ç”¨çš„ dynamic feature module"></a>å›½å†…åŸºæœ¬ä¸ç”¨çš„ dynamic feature module</h2><p><a href="https://developer.android.com/guide/app-bundle" target="_blank" rel="noopener">Android App Bundle</a> æ˜¯å®˜æ–¹ 18 å¹´æ¨å‡ºçš„åŠ¨æ€å‘å¸ƒæ–¹æ¡ˆï¼Œç±»ä¼¼å›½å†…å„ç§æ’ä»¶åŒ–æ–¹æ¡ˆã€‚ä¸è¿‡å®ƒéœ€è¦ Google Play Store æ”¯æŒï¼Œè¿™å¯¼è‡´åœ¨å›½å†…æ— æ³•ä½¿ç”¨</p><p>å€Ÿç€ navigation ç»„ä»¶æ”¯æŒ <code>dynamic feature module</code> é—´å¯¼èˆªçš„å¥‘æœºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>dynamic feature module</code> æ¥æ‹†åˆ†åŠŸèƒ½æ¨¡å—ä»¥å®ç°æ¨¡å—åŒ–</p><p>ä¼ ç»Ÿçš„æ‹†åˆ†æ–¹æ¡ˆå¤§æ¦‚æ˜¯è¿™æ ·ï¼Œfeature module ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œapp module ä¾èµ–å„ä¸ª feature module é—´æ¥ä¾èµ– base åº“ï¼Œå…¬å…±åº“</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520165717.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä¼ ç»Ÿæ¶æ„"></p><p>è€Œä½¿ç”¨ <code>dynamic feature module</code> ï¼Œå…¶ç»“æ„æ˜¯è¿™æ ·çš„</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520172609.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="dynamic feature æ¶æ„"></p><p><code>dynamic feature module</code> ä¹Ÿå¯ä»¥æŒ‰éœ€å®‰è£…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬å¯èƒ½ä¸åŒ…å«åœ¨ç”¨æˆ·æœ€åˆä¸‹è½½çš„ APK ä¸­ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶å®‰è£…ã€‚è€Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å®ƒä»¬åŒ…å«åˆ° APK ä¸­</p><h2 id="ä½¿ç”¨-dynamic-feature-module"><a href="#ä½¿ç”¨-dynamic-feature-module" class="headerlink" title="ä½¿ç”¨ dynamic feature module"></a>ä½¿ç”¨ dynamic feature module</h2><p>é¦–å…ˆæˆ‘ä»¬åœ¨ base lib ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>    <span class="hljs-keyword">def</span> nav_version = <span class="hljs-string">"2.3.0-alpha06"</span><br><br>    api <span class="hljs-string">"androidx.navigation:navigation-fragment-ktx:$nav_version"</span><br>    api <span class="hljs-string">"androidx.navigation:navigation-ui-ktx:$nav_version"</span><br>    api <span class="hljs-string">"androidx.navigation:navigation-dynamic-features-fragment:$nav_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ app module ä¸­çš„ res/navigation ç›®å½•ä¸‹åˆ›å»º main_nav.xml</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520173227.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="main_nav.xml"></p><p>æ¥ç€æˆ‘ä»¬åœ¨ activity_main ä¸­è®¾ç½®é»˜è®¤çš„ host</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520173336.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="é»˜è®¤ host"></p><blockquote><p>è¿™é‡Œä¸åŒäºæ­£å¸¸ navigation çš„ç”¨æ³•ï¼Œæ²¡æœ‰ä½¿ç”¨ NavHostFragmentï¼Œè€Œæ˜¯ä½¿ç”¨ DynamicNavHostFragment</p></blockquote><h3 id="ç›´æ¥è·³è½¬-fragment"><a href="#ç›´æ¥è·³è½¬-fragment" class="headerlink" title="ç›´æ¥è·³è½¬ fragment"></a>ç›´æ¥è·³è½¬ fragment</h3><p>æˆ‘ä»¬åˆ›å»º dynamic feature module ï¼Œå–åä¸º feature1</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520174302.gif" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="åˆ›å»º dynamic feature module"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520174505.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="åŒ…åå‰éƒ¨åˆ†éœ€ä¿è¯ä¸ applicationId ç›¸åŒ"></p><blockquote><p>è¿™é‡Œ <code>dynamic feature module</code> çš„åŒ…åå‰éƒ¨åˆ†è¦å’Œ applicationId å³ app module åŒ…åç›¸åŒï¼Œå¦åˆ™åç»­çš„ include æ“ä½œä¼šæœ‰é—®é¢˜</p></blockquote><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520174757.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="é€‰æ‹©åŠ è½½æ¨¡å¼"></p><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©åœ¨å®‰è£…æ—¶é›†æˆè¯¥ module</p><p>æ¥ç€æˆ‘ä»¬åœ¨è¯¥ module ä¸‹åˆ›å»ºä¸€ä¸ª fragment å–åä¸º <code>Feature1OneFragment</code></p><p>ä¹‹åæˆ‘ä»¬ç›´æ¥åœ¨ main_nav.xml ä¸­å¼•å…¥ è¯¥ fragment å¹¶åŠ å…¥ action</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520175351.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ç›´æ¥å¼•å…¥ fragment"></p><p>æ¥ç€æˆ‘ä»¬å°±å¯ä»¥åœ¨ app ä¸‹çš„ MainFragment æ‰“å¼€ Feature1OneFragment</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520175841.gif" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å¯åŠ¨ fragment"></p><blockquote><p>æˆ‘çš„ demo ä¸­ feature2 æ˜¯ç›´æ¥å¼•å…¥ fragmentï¼Œå› æ­¤è·³è½¬çš„æ˜¯ Feature2OneFragment</p></blockquote><h3 id="ç›´æ¥è·³è½¬-activity"><a href="#ç›´æ¥è·³è½¬-activity" class="headerlink" title="ç›´æ¥è·³è½¬ activity"></a>ç›´æ¥è·³è½¬ activity</h3><p>åœ¨ feature1 ä¸­åˆ›å»º activity (demo ä¸­ä¸º feature2)</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520180201.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è·³è½¬ activity"></p><p>åŒæ ·éœ€è¦æŒ‡å®š moduleName</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520180434.gif" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å¯åŠ¨activity"></p><h3 id="ä½¿ç”¨-dynamic-feature-module-å†…éƒ¨çš„-graph"><a href="#ä½¿ç”¨-dynamic-feature-module-å†…éƒ¨çš„-graph" class="headerlink" title="ä½¿ç”¨ dynamic feature module å†…éƒ¨çš„ graph"></a>ä½¿ç”¨ dynamic feature module å†…éƒ¨çš„ graph</h3><p>æˆ‘ä»¬å¯ä»¥ä¸º dynamic feature module å•ç‹¬é…ç½® navigation graphï¼Œè¿™æ ·å°±å¯ä»¥å¤„ç† dynamic feature module å†…éƒ¨çš„è·³è½¬äº†</p><p>åœ¨ feature1 ä¸­åˆ›å»º feature1_nav.xml ï¼Œå…¶ä¸­ startDestination ä¸º Feature1OneFragment</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520181021.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="feature1_nav.xml"></p><p>åœ¨ main_nav.xml æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹å¼æ¥ä½¿ç”¨è¯¥ graph</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520181145.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="include-dynamic"></p><p>æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„æ ‡ç­¾ <code>include-dynamic</code>ï¼ŒåŒæ—¶æˆ‘ä»¬çœ‹åˆ°äº†å‡ ä¸ªæ²¡ç”¨è¿‡çš„å±æ€§</p><ul><li><code>graphPackage</code> ä¸º <code>dynamic feature module</code> çš„åŒ…å</li><li><code>graphResName</code> ä¸º <code>dynamic feature module</code> å†…éƒ¨ graph çš„åå­—</li><li><code>moduleName</code> ä¸º module å</li></ul><blockquote><p>æ³¨æ„ï¼šè¿™é‡Œçš„ graphPackage å¯ä»¥çœç•¥</p><ol><li>å¦‚æœ module çš„åŒ…åæ²¡ç”¨æŒ‰ç…§å‰æ–‡çš„æ ¼å¼é…ç½®ä¼šå¯¼è‡´æ— æ³•æ‰¾åˆ° graphId çš„å¼‚å¸¸</li><li>include-dynamic æ ‡ç­¾çš„ id è¦ä¸ <code>feature1_nav.xml</code> navigation æ ‡ç­¾ä¸‹çš„ id ä¸€è‡´ï¼Œæˆ–è€…åè€…ä¸è®¾ç½® id</li></ol></blockquote><p>è¿™æ ·ä» app module å¯¼èˆªåˆ° feature1 çš„ startDestination åä¾¿å¯ä½¿ç”¨å…¶å†…éƒ¨çš„é€»è¾‘è¿›è¡Œåç»­çš„å¯¼èˆªäº†</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520182339.gif" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="include è·³è½¬"></p><h2 id="feature-module-é—´è·³è½¬"><a href="#feature-module-é—´è·³è½¬" class="headerlink" title="feature module é—´è·³è½¬"></a>feature module é—´è·³è½¬</h2><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200520182529.png" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æš‚ä¸æ”¯æŒ deep link"></p><p>Navigation ç»„ä»¶æš‚ä¸æ”¯æŒ Dynamic include graph çš„ deep link</p><p>å› æ­¤æˆ‘ç›®å‰ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç‰¹åˆ«ä¼˜é›…çš„æ–¹å¼ï¼Œå·²çŸ¥çš„æ–¹æ¡ˆå¦‚ä¸‹</p><ul><li>åå°„</li><li>ä½¿ç”¨ <a href="https://developer.android.com/reference/java/util/ServiceLoader" target="_blank" rel="noopener">ServiceLoader</a></li><li>ä½¿ç”¨ä¾èµ–æ³¨å…¥</li></ul><p><a href="https://github.com/Flywith24/DynamicFeatureDemo" target="_blank" rel="noopener">demo</a></p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/05/20/Tips-Navagion+DynamicFeatureModule/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tips </tag>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¥‡æŠ€æ·«å·§ã€‘æ–°çš„å›¾ç‰‡åŠ è½½åº“ï¼ŸåŸºäºKotlinåç¨‹çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil</title>
      <link href="/2020/05/18/Tips-Coil/"/>
      <url>/2020/05/18/Tips-Coil/</url>
      
        <content type="html"><![CDATA[<h2 id="æ–°çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil"><a href="#æ–°çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil" class="headerlink" title="æ–°çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil"></a>æ–°çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil</h2><p><a href="https://coil-kt.github.io/coil/" target="_blank" rel="noopener">Coil</a> æ˜¯ <a href="https://www.instacart.com/" target="_blank" rel="noopener">Instacart</a> å›¢é˜Ÿç ”å‘çš„æ–°çš„çš„å›¾ç‰‡åŠ è½½åº“ï¼Œå®ƒä½¿ç”¨äº†å¾ˆå¤šé«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚åç¨‹ï¼Œ<code>Okhttp</code>ï¼Œ<code>androidx.lifecycle</code>ã€‚<code>Coil</code> è¿˜åŒ…æ‹¬ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚å›¾åƒé‡‡æ ·ï¼Œæœ‰æ•ˆçš„å†…å­˜ä½¿ç”¨ä»¥åŠè¯·æ±‚çš„è‡ªåŠ¨å–æ¶ˆ/æš‚åœ</p><p>é»˜è®¤æƒ…å†µä¸‹ <code>Coil</code> ä¸ R8 å®Œå…¨å…¼å®¹ï¼Œå¼€ç®±å³ç”¨ï¼Œä¸éœ€è¦æ·»åŠ é¢å¤–çš„è§„åˆ™ã€‚å¦‚æœä½¿ç”¨ Proguard ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸º <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/jvm/resources/META-INF/proguard/coroutines.pro" target="_blank" rel="noopener">Coroutines</a>, <a href="https://github.com/square/okhttp/blob/master/okhttp/src/main/resources/META-INF/proguard/okhttp3.pro" target="_blank" rel="noopener">OkHttp</a> å’Œ <a href="https://github.com/square/okio/blob/master/okio/src/jvmMain/resources/META-INF/proguard/okio.pro" target="_blank" rel="noopener">Okio</a> æ·»åŠ è§„åˆ™</p><a id="more"></a><h2 id="Coil-çš„ä¼˜åŠ¿"><a href="#Coil-çš„ä¼˜åŠ¿" class="headerlink" title="Coil çš„ä¼˜åŠ¿"></a>Coil çš„ä¼˜åŠ¿</h2><ul><li>å¿«é€Ÿï¼š<code>Coil</code> è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼ŒåŒ…æ‹¬å†…å­˜å’Œç£ç›˜ç¼“å­˜ï¼Œå¯¹å†…å­˜ä¸­çš„å›¾åƒè¿›è¡Œé‡‡æ ·ï¼Œé‡æ–°ä½¿ç”¨ä½å›¾ï¼Œè‡ªåŠ¨æš‚åœ/å–æ¶ˆè¯·æ±‚ç­‰ç­‰</li><li>è½»é‡ï¼š<code>Coil</code> åœ¨æ‚¨çš„APKä¸­æ·»åŠ äº†çº¦ 2000 ç§æ–¹æ³•ï¼ˆå¯¹äºå·²ç»ä½¿ç”¨ <code>OkHttp</code> å’Œ <code>Coroutines</code> çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œä¸ <code>Picasso</code> ç›¸å½“ï¼Œè¿œå°‘äº <code>Glide</code> å’Œ <code>Fresco</code></li><li>æ˜“ç”¨ï¼š<code>Coil</code> çš„ API åˆ©ç”¨ Kotlin çš„ç‰¹æ€§ç®€åŒ–äº†æ ·æ¿ä»£ç </li><li>ç°ä»£ï¼š<code>Coil</code> æ˜¯ <code>Kotlin-first</code>ï¼Œä½¿ç”¨ç°ä»£åŒ–çš„åº“ï¼Œä¾‹å¦‚ <code>Coroutines</code>, <code>OkHttp</code>, <code>Okio</code>, ä»¥åŠ <code>AndroidX Lifecycles</code></li></ul><p><code>Coil</code> æ˜¯ä»¥ä¸‹åç§°çš„ç¼©å†™ï¼š<strong>Coroutine Image Loader</strong></p><h2 id="Artifacts"><a href="#Artifacts" class="headerlink" title="Artifacts"></a>Artifacts</h2><p><code>Coil</code> æ‹¥æœ‰ 5 ä¸ª artifact å¹¶å‘å¸ƒåœ¨ <code>mavenCentral()</code></p><ul><li><code>io.coil-kt:coil</code>ï¼šä¾èµ–äº  <code>io.coil-kt:coil-base</code> å¹¶ä¸”åŒ…å«äº† <code>Coil</code> çš„å•ä¾‹å’Œ  <code>ImageView.load</code> çš„æ‰©å±•å‡½æ•°</li><li><code>io.coil-kt:coil-base</code>ï¼šbase åº“ï¼Œ<strong>ä¸åŒ…å«</strong> <code>Coil</code> çš„å•ä¾‹å’Œ  <code>ImageView.load</code> çš„æ‰©å±•å‡½æ•°ï¼Œå¦‚æœä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¯¥åº“</li><li><code>io.coil-kt:coil-gif</code>ï¼šå¼•å…¥ä¸€ç³»åˆ—è§£ç å™¨ä»¥æ”¯æŒè§£ç  gif</li><li><code>io.coil-kt:coil-svg</code>ï¼šå¼•å…¥ä¸€ç³»åˆ—è§£ç å™¨ä»¥æ”¯æŒ svg</li><li><code>io.coil-kt:coil-video</code>ï¼šåŒ…æ‹¬ä¸¤ä¸ª <a href="https://coil-kt.github.io/coil/api/coil-base/coil.fetch/-fetcher" target="_blank" rel="noopener">fetchers</a> ï¼Œä»¥æ”¯æŒä» Android æ”¯æŒçš„ä»»ä½•è§†é¢‘æ ¼å¼ä¸­æå–å’Œè§£ç å¸§</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-comment">// æ™®é€šä½¿ç”¨å¼•ç”¨</span><br>implementation <span class="hljs-string">"io.coil-kt:coil:0.11.0"</span><br><span class="hljs-comment">// ä½¿ç”¨ä¾èµ–æ³¨å…¥æ—¶æˆ–è€…åˆ¶ä½œåŸºäº coil çš„åº“å¼•ç”¨</span><br>implementation <span class="hljs-string">"io.coil-kt:coil-base:0.11.0"</span><br></code></pre></td></tr></table></figure><h2 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a>Java 8</h2><p><code>Coil</code> è¦æ±‚ Java 8ï¼Œè¦é€šè¿‡ D8 å¯ç”¨ Java 8 è°ƒè¯•ï¼Œè¯·å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ° Gradle è„šæœ¬</p><p>Gradle (<code>.gradle</code>)</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs groovy">android &#123;<br>    compileOptions &#123;<br>        sourceCompatibility JavaVersion.VERSION_1_8<br>        targetCompatibility JavaVersion.VERSION_1_8<br>    &#125;<br>&#125;<br><br>tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).all &#123;<br>    kotlinOptions &#123;<br>        jvmTarget = <span class="hljs-string">"1.8"</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Gradle Kotlin DSL (<code>.gradle.kts</code>)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">android &#123;<br>    compileOptions &#123;<br>        sourceCompatibility = JavaVersion.VERSION_1_8<br>        targetCompatibility = JavaVersion.VERSION_1_8<br>    &#125;<br>&#125;<br><br>tasks.withType&lt;KotlinCompile&gt; &#123;<br>    kotlinOptions &#123;<br>        jvmTarget = <span class="hljs-string">"1.8"</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="ImageView-æ‰©å±•å‡½æ•°"><a href="#ImageView-æ‰©å±•å‡½æ•°" class="headerlink" title="ImageView æ‰©å±•å‡½æ•°"></a>ImageView æ‰©å±•å‡½æ•°</h3><p><code>io.coil-kt:coil</code> æä¾›äº† ç±»å‹å®‰å…¨çš„ ImageView æ‰©å±•å‡½æ•°</p><p>åœ¨ ImageView ä¸­åŠ è½½å›¾ç‰‡ï¼Œåªéœ€è°ƒç”¨ load æ‰©å±•å‡½æ•°</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// URL</span><br>imageView.load(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br><br><span class="hljs-comment">// Resource</span><br>imageView.load(R.drawable.image)<br><br><span class="hljs-comment">// File</span><br>imageView.load(File(<span class="hljs-string">"/path/to/image.jpg"</span>))<br><br><span class="hljs-comment">// And more...</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¯·æ±‚ç­‰ä»·äºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> imageLoader = Coil.imageLoader(context)<br><span class="hljs-keyword">val</span> request = LoadRequest.Builder(imageView.context)<br>    .<span class="hljs-keyword">data</span>(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br>    .target(imageView)<br>    .build()<br>imageLoader.execute(request)<br></code></pre></td></tr></table></figure><p>å¯é€‰çš„è¯·æ±‚é…ç½®å¯ä»¥é€šè¿‡ lambda æ¥æ“ä½œ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">imageView.load(<span class="hljs-string">"https://www.example.com/image.jpg"</span>) &#123;<br>    crossfade(<span class="hljs-literal">true</span>)<br>    placeholder(R.drawable.image)<br>    transformations(CircleCropTransformation())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Image-LoadersÂ¶"><a href="#Image-LoadersÂ¶" class="headerlink" title="Image LoadersÂ¶"></a>Image Loaders<a href="https://coil-kt.github.io/coil/#image-loaders" target="_blank" rel="noopener">Â¶</a></h3><p><code>ImageLoader</code> æ˜¯æ‰§è¡Œè¯·æ±‚çš„æœåŠ¡ç±»ã€‚ ä»–ä»¬å¤„ç†ç¼“å­˜ï¼Œæ•°æ®è·å–ï¼Œå›¾åƒè§£ç ï¼Œè¯·æ±‚ç®¡ç†ï¼Œbitmap poolï¼Œå†…å­˜ç®¡ç†ç­‰ã€‚ å¯ä»¥ä½¿ç”¨ builder æ¥åˆ›å»ºå’Œé…ç½®æ–°å®ä¾‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> imageLoader = ImageLoader.Builder(context)<br>    .availableMemoryPercentage(<span class="hljs-number">0.25</span>)<br>    .crossfade(<span class="hljs-literal">true</span>)<br>    .build()<br></code></pre></td></tr></table></figure><p>imageView.load ä½¿ç”¨å•ä¾‹ <code>ImageLoader</code> æ‰§è¡Œ <code>LoadRequest</code> ã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è®¿é—®å•ä¾‹ <code>ImageLoader</code>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> imageLoader = Coil.imageLoader(context)<br></code></pre></td></tr></table></figure><p>ï¼ˆå¯é€‰ï¼‰æ‚¨å¯ä»¥åˆ›å»ºè‡ªå·±çš„ImageLoaderå®ä¾‹ï¼Œå¹¶é€šè¿‡ä¾èµ–é¡¹æ³¨å…¥å°†å®ƒä»¬æ³¨å…¥ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> imageLoader = ImageLoader(context)<br></code></pre></td></tr></table></figure><p>å½“æ‚¨åˆ›å»ºå•ä¸ª <code>ImageLoader</code> å¹¶åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å…±äº«æ—¶ï¼Œ<code>Coil</code> çš„æ€§èƒ½æœ€ä½³ã€‚ è¿™æ˜¯å› ä¸ºæ¯ä¸ª <code>ImageLoader</code> éƒ½æœ‰è‡ªå·±çš„å†…å­˜ç¼“å­˜ï¼Œbitmap pool å’Œç½‘ç»œç›‘å¬</p><h3 id="RequestsÂ¶"><a href="#RequestsÂ¶" class="headerlink" title="RequestsÂ¶"></a>Requests<a href="https://coil-kt.github.io/coil/#requests" target="_blank" rel="noopener">Â¶</a></h3><p>æœ‰ä¸¤ç§ Request ç±»å‹</p><ul><li><a href="https://coil-kt.github.io/coil/api/coil-base/coil.request/-load-request/" target="_blank" rel="noopener"><code>LoadRequest</code></a> æ˜¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸèŒƒå›´çš„ requestï¼Œæ”¯æŒ <a href="https://coil-kt.github.io/coil/api/coil-base/coil.target/-target/" target="_blank" rel="noopener"><code>Target</code></a>ï¼Œ<a href="https://coil-kt.github.io/coil/api/coil-base/coil.transition/-transition/" target="_blank" rel="noopener"><code>Transition</code></a> ç­‰ç­‰</li><li><a href="https://coil-kt.github.io/coil/api/coil-base/coil.request/-get-request/" target="_blank" rel="noopener"><code>GetRequest</code></a> æŒ‚èµ·å¹¶è¿”å›  <a href="https://coil-kt.github.io/coil/api/coil-base/coil.request/-request-result/" target="_blank" rel="noopener"><code>RequestResult</code></a></li></ul><p>å¦‚æœè¦åŠ è½½åˆ°è‡ªå®šä¹‰ target ä¸­ï¼Œå¯ä»¥æ‰§è¡Œ <code>LoadRequest</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> request = LoadRequest.Builder(context)<br>    .<span class="hljs-keyword">data</span>(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br>    .target &#123; drawable -&gt;<br>        <span class="hljs-comment">// Handle the result.</span><br>    &#125;<br>    .build()<br>imageLoader.execute(request)<br></code></pre></td></tr></table></figure><p>è¦å¼ºåˆ¶è·å–å›¾åƒï¼Œè¯·æ‰§è¡ŒGetRequestï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> request = GetRequest.Builder(context)<br>    .<span class="hljs-keyword">data</span>(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br>    .build()<br><span class="hljs-keyword">val</span> drawable = imageLoader.execute(request).drawable<br></code></pre></td></tr></table></figure><h3 id="å•ä¾‹"><a href="#å•ä¾‹" class="headerlink" title="å•ä¾‹"></a>å•ä¾‹</h3><p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ <code>io.coil-kt:coil</code> ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»æ„æ–¹å¼è®¾ç½® <code>ImageLoader</code> çš„å®ä¾‹</p><p>åœ¨ Application ä¸­å®ç° <code>ImageLoaderFactory</code>ï¼ˆæ¨èï¼‰</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplication</span> : <span class="hljs-type">Application</span></span>(), ImageLoaderFactory &#123;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newImageLoader</span><span class="hljs-params">()</span></span>: ImageLoader &#123;<br>        <span class="hljs-keyword">return</span> ImageLoader.Builder(context)<br>            .crossfade(<span class="hljs-literal">true</span>)<br>            .okHttpClient &#123;<br>                OkHttpClient.Builder()<br>                    .cache(CoilUtils.createDefaultCache(context))<br>                    .build()<br>            &#125;<br>            .build()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ Coil.setImageLoader</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> imageLoader = ImageLoader.Builder(context)<br>    .crossfade(<span class="hljs-literal">true</span>)<br>    .okHttpClient &#123;<br>        OkHttpClient.Builder()<br>            .cache(CoilUtils.createDefaultCache(context))<br>            .build()<br>    &#125;<br>    .build()<br>Coil.setImageLoader(imageLoader)<br></code></pre></td></tr></table></figure><p>é»˜è®¤çš„ <code>ImageLoader</code> å¯ä»¥é€šè¿‡è¿™æ ·å–å›</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> imageLoader = Coil.imageLoader(context)<br></code></pre></td></tr></table></figure><p>è®¾ç½®é»˜è®¤çš„ <code>ImageLoader</code> æ˜¯å¯é€‰çš„ã€‚ å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ <code>Coil</code> ä¼šå»¶è¿Ÿåˆ›å»ºå…·æœ‰é»˜è®¤å€¼çš„ <code>ImageLoader</code></p><p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ <code>io.coil-kt:coil-base</code>ï¼Œæ‚¨åº”åˆ›å»ºè‡ªå·±çš„ <code>ImageLoader</code> å®ä¾‹å¹¶é€šè¿‡ä¾èµ–æ³¨å…¥å°†å®ƒæ³¨å…¥åˆ° app ä¸­</p><blockquote><p>æ³¨æ„ï¼šå¦‚æœè®¾ç½®è‡ªå®šä¹‰OkHttpClientï¼Œåˆ™å¿…é¡»è®¾ç½®ç¼“å­˜å®ç°ï¼Œå¦åˆ™ImageLoaderå°†æ²¡æœ‰ç£ç›˜ç¼“å­˜ã€‚ å¯ä»¥ä½¿ç”¨CoilUtils.createDefaultCache åˆ›å»ºé»˜è®¤çš„ Coil ç¼“å­˜å®ä¾‹</p></blockquote><h2 id="æ”¯æŒçš„æ•°æ®ç±»å‹"><a href="#æ”¯æŒçš„æ•°æ®ç±»å‹" class="headerlink" title="æ”¯æŒçš„æ•°æ®ç±»å‹"></a>æ”¯æŒçš„æ•°æ®ç±»å‹</h2><p>ImageLoader æ”¯æŒçš„æ•°æ®ç±»å‹ä¸º</p><ul><li>String (mapped to a Uri)</li><li>HttpUrl</li><li>Uri (<code>android.resource</code>, <code>content</code>, <code>file</code>, <code>http</code>, and <code>https</code> schemes only)</li><li>File</li><li>@DrawableRes Int</li><li>Drawable</li><li>Bitmap</li></ul><h2 id="é¢„åŠ è½½"><a href="#é¢„åŠ è½½" class="headerlink" title="é¢„åŠ è½½"></a>é¢„åŠ è½½</h2><p>å¦‚æœè¦é¢„åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ‰§è¡Œä¸€ä¸ªä¸å¸¦ target çš„ <code>LoadRequest</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> request = LoadRequest.Builder(context)<br>    .<span class="hljs-keyword">data</span>(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br>    <span class="hljs-comment">// å¯é€‰çš„ï¼Œä½†æ˜¯è®¾ç½® ViewSizeResolver å¯ä»¥é€šè¿‡é™åˆ¶é¢„åŠ è½½çš„å¤§å°æ¥èŠ‚çœå†…å­˜</span><br>    .size(ViewSizeResolver(imageView))<br>    .build()<br>imageLoader.execute(request)<br></code></pre></td></tr></table></figure><p>å¦‚æœåªæƒ³å°†ç½‘ç»œå›¾ç‰‡é¢„åŠ è½½åˆ°ç£ç›˜ä¸­ï¼Œå¯ä»¥ä¸º request å…³é—­å†…å­˜ç¼“å­˜</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> request = LoadRequest.Builder(context)<br>    .<span class="hljs-keyword">data</span>(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br>    .memoryCachePolicy(CachePolicy.DISABLED)<br>    .build()<br>imageLoader.execute(request)<br></code></pre></td></tr></table></figure><h2 id="å–æ¶ˆè¯·æ±‚"><a href="#å–æ¶ˆè¯·æ±‚" class="headerlink" title="å–æ¶ˆè¯·æ±‚"></a>å–æ¶ˆè¯·æ±‚</h2><p><code>LoadRequest</code> ä¼šè‡ªåŠ¨å–æ¶ˆåœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹</p><ul><li><p>å…³è”çš„ view detachedï¼Œ</p></li><li><p>å…³è”çš„ lifecycle destroyed</p></li><li><p>å¦ä¸€ä¸ª request  åœ¨ç›¸åŒçš„ view ä¸­å¼€å¯</p></li></ul><p>æ­¤å¤–ï¼Œæ¯ä¸ª <code>LoadRequest</code> è¿”å›ä¸€ä¸ª <code>RequestDisposable</code>ï¼Œå¯ç”¨äºæ£€æŸ¥è¯·æ±‚æ˜¯å¦åœ¨è¿è¡Œä¸­æˆ–å¤„ç†è¯¥è¯·æ±‚ï¼ˆæœ‰æ•ˆåœ°å–æ¶ˆè¯·æ±‚å¹¶é‡Šæ”¾å…¶å…³è”èµ„æºï¼‰</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> disposable = imageView.load(<span class="hljs-string">"https://www.example.com/image.jpg"</span>)<br><br><span class="hljs-comment">// Cancel the request.</span><br>disposable.dispose()<br></code></pre></td></tr></table></figure><p><code>GetRequest</code> ä»…å½“åç¨‹çš„ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæ—¶æ‰ä¼šå–æ¶ˆ</p><h2 id="å›¾ç‰‡é‡‡æ ·"><a href="#å›¾ç‰‡é‡‡æ ·" class="headerlink" title="å›¾ç‰‡é‡‡æ ·"></a>å›¾ç‰‡é‡‡æ ·</h2><p>å‡è®¾ç£ç›˜ä¸Šæœ‰ä¸€ä¸ª 500x500 çš„æ˜ åƒï¼Œä½†æ˜¯åªéœ€è¦ä»¥ 100x100 çš„å¤§å°å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­å³å¯åœ¨è§†å›¾ä¸­æ˜¾ç¤ºã€‚ <code>Coil</code> ä¼šå°†å›¾åƒåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯å¦‚æœæ‚¨éœ€è¦ 500x500 çš„å›¾åƒä¼šæ€æ ·å‘¢ï¼Ÿ ä»ç£ç›˜è¯»å–è¿˜æœ‰æ›´å¥½çš„ã€Œè´¨é‡ã€ï¼Œä½†æ˜¯å›¾åƒå·²ç»ä»¥ 100x100 åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬ä»ç£ç›˜ä»¥ 500x500 è¯»å–å›¾åƒæ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ 100x100 å›¾åƒä½œä¸ºå ä½ç¬¦ã€‚</p><p>è¿™æ­£æ˜¯ <code>Coil</code> æ‰€åšçš„ï¼Œå¹¶ä¸” <code>Coil</code> è‡ªåŠ¨ä¸ºæ‰€æœ‰ <code>BitmapDrawables</code> å¤„ç†æ­¤è¿‡ç¨‹ã€‚ ä¸ <code>crossfade(true)</code> æ­é…ä½¿ç”¨æ—¶ï¼Œå¯ä»¥åˆ›å»ºè§†è§‰æ•ˆæœï¼Œä½¿å›¾åƒç»†èŠ‚çœ‹èµ·æ¥åƒæ·¡å…¥æ·¡å‡ºï¼Œç±»ä¼¼äºæ¸è¿›å¼ JPEG</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/5/15/1721615615eb45ef?w=600&h=1067&f=gif&s=4714987" src="/2020/05/18/Tips-Coil/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h2 id="ä½¿ç”¨è¦æ±‚"><a href="#ä½¿ç”¨è¦æ±‚" class="headerlink" title="ä½¿ç”¨è¦æ±‚"></a>ä½¿ç”¨è¦æ±‚</h2><ul><li>AndroidX</li><li>Min SDK 14+</li><li>Compile SDK: 29+</li><li><a href="https://coil-kt.github.io/coil/getting_started/#java-8" target="_blank" rel="noopener">Java 8+</a></li></ul><p>è¯¦ç»†å†…å®¹ç§»æ­¥ <a href="https://coil-kt.github.io/coil/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/05/18/Tips-Coil/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tips </tag>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Jetpackæ›´æ–°ä¹‹Fragmentã€‘setRetainInstance è¢«å¼ƒç”¨ï¼Œé‚£ä¹ˆ fragment æ˜¯å¦‚ä½•ä¿å­˜çŠ¶æ€çš„ï¼Ÿ</title>
      <link href="/2020/04/30/Jetpack-fragment-savestate/"/>
      <url>/2020/04/30/Jetpack-fragment-savestate/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬éƒ½çŸ¥é“ fragment ä¸­çš„ <code>setRetainInstance</code> ç”¨äºæ§åˆ¶æ˜¯å¦åœ¨ activity ä¿ç•™ fragment å®ä¾‹ï¼Œå…·ä½“å†…å®¹å¯å‚è§ <a href="https://www.wanandroid.com/wenda/show/12574" target="_blank" rel="noopener">WanAndroid çš„æ¯æ—¥ä¸€é—®ï¼šFragment æ˜¯å¦‚ä½•è¢«å­˜å‚¨ä¸æ¢å¤çš„ï¼Ÿ</a></p><p>ä½†æ˜¯è¯¥æ–¹æ³•å·²äº <code>androidx fragment 1.3.0-alpha01</code> å¼ƒç”¨äº†</p><a id="more"></a><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200422093129.png" src="/2020/04/30/Jetpack-fragment-savestate/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è€è§„çŸ©ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ commit log</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200422094533.png" src="/2020/04/30/Jetpack-fragment-savestate/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç®€å•æ¦‚å†µä¸€ä¸‹</p><p><code>SetRetainInstance</code> å°è¯•åœ¨ activity é‡å»ºæ—¶ä¿å­˜çŠ¶æ€ã€‚ä½†å®ƒå¸¦æ¥äº†å¾ˆå¤šå‰¯ä½œç”¨ã€‚</p><p>éšç€ <code>ViewModel</code> çš„å¼•å…¥ï¼Œå¼€å‘è€…æ‹¥æœ‰ä¸€ä¸ªç‰¹å®šçš„ APIï¼Œç”¨äºä¿ç•™ä¸ Activityï¼ŒFragments å’Œ Navigation ç›¸å…³è”çš„çŠ¶æ€ã€‚ è¿™ä½¿å¼€å‘è€…å¯ä»¥ä½¿ç”¨æ­£å¸¸çš„ï¼Œä¸éœ€è¦ä¿ç•™ fragment ï¼Œä»è€Œåœ¨ä¿å­˜å•ä¸ªéœ€è¦çš„å±æ€§æ—¶é¿å…äº†å¸¸è§çš„æ³„æ¼æºï¼Œå¹¶ä¸”å¯ä»¥é”€æ¯ä¿å­˜çš„çŠ¶æ€ï¼ˆå³ <code>ViewModel</code> çš„æ„é€ å™¨å’Œ <code>onCleared</code> å›è°ƒï¼‰</p><p>è¯¦æƒ…å¯å‚è§ <a href="https://juejin.im/post/5e738d12518825495d69cfb9" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘ç»ä¸ä¸¢å¤±çš„çŠ¶æ€ androidx SaveState ViewModel-SaveState åˆ†æ</a> å’Œ <a href="https://juejin.im/post/5e786d415188255e00661a4e" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackä¹‹ViewModelã€‘å³ä½¿æ‚¨ä¸ä½¿ç”¨MVVMä¹Ÿè¦äº†è§£ViewModel â€”â€”ViewModel çš„èŒèƒ½è¾¹ç•Œ</a></p><p>ä»è¿™ä¸ªæ”¹åŠ¨å¯ä»¥çœ‹å‡ºå®˜æ–¹æ­£è‡´åŠ›äºä¿è¯é€»è¾‘çš„å•ä¸€æ€§ï¼ŒçŠ¶æ€ä¿å­˜äº¤ç»™ <code>ViewModel</code> ï¼Œå‡å°‘è¿™ç§ç‰¹æ®Šçš„ä¾‹å¤–æƒ…å†µï¼Œä»è€Œæ¶ˆé™¤ä¸€äº›ä¸ç¬¦åˆé¢„æœŸçš„é—®é¢˜</p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><center><p> æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·</p></center><div align="center"><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200429102625.jpg" src="/2020/04/30/Jetpack-fragment-savestate/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></div>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
            <tag> Fragment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Jetpackæ›´æ–°ä¹‹Fragmentã€‘1.3.0-alpha04 æ¥è¢­ï¼ŒFragment é—´é€šä¿¡çš„æ–°å§¿åŠ¿</title>
      <link href="/2020/04/30/Jetpack-fragment-ResultAPI/"/>
      <url>/2020/04/30/Jetpack-fragment-ResultAPI/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>fragment 1.3.0-alpha04</code> å‘å¸ƒäº†ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šå˜åŠ¨ï¼Œå…¶ä¸­æä¾›äº† fragment é—´ä¼ é€’æ•°æ®çš„æ–°æ–¹å¼</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430090529.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="1.3.0-alpha04 æ›´æ–°"></p><a id="more"></a><h3 id="API-æ›´æ”¹"><a href="#API-æ›´æ”¹" class="headerlink" title="API æ›´æ”¹"></a>API æ›´æ”¹</h3><p>é¦–å…ˆæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ API æ›´æ”¹</p><ul><li><code>startActivityForResult()</code>/<code>onActivityResult()</code> å’Œ <code>requestPermissions()</code>/<code>onRequestPermissionsResult()</code> å¼ƒç”¨</li><li><code>prepareCall()</code> é‡å‘½åä¸º <code>registerForActivityResult()</code> </li><li><code>target fragment API</code> è¢«å¼ƒç”¨</li></ul><h3 id="Activity-Result-API-ä¸Šä½"><a href="#Activity-Result-API-ä¸Šä½" class="headerlink" title="Activity Result API ä¸Šä½"></a>Activity Result API ä¸Šä½</h3><p>ç”±äºå®˜æ–¹æä¾›äº† <strong>Activity Result API</strong> æ¥æ›¿æ¢ <strong>onActivityResult</strong>  æœºåˆ¶ï¼Œå› æ­¤ fragment çš„  <code>startActivityForResult()</code>/<code>onActivityResult()</code> å’Œ <code>requestPermissions()</code>/<code>onRequestPermissionsResult()</code> æ–¹æ³•è¢«æ ‡è®°å¼ƒç”¨äº†</p><p><strong>Activity Result API</strong> è¯¦æƒ…å¯å‚è€ƒ <a href="https://juejin.im/user/586eff908d6d81005879507d" target="_blank" rel="noopener">ç§‰å¿ƒè¯´</a> çš„ <a href="https://juejin.im/post/5e80cb1ee51d45471654fae7" target="_blank" rel="noopener">æ˜¯æ—¶å€™ä¸¢æ‰ onActivityResult äº† ï¼</a></p><p>æ–‡ç« ä»‹ç»çš„å¾ˆè¯¦å°½ï¼Œè¿™é‡Œä¸å†èµ˜è¿°</p><h3 id="prepareCall-é‡å‘½å"><a href="#prepareCall-é‡å‘½å" class="headerlink" title="prepareCall é‡å‘½å"></a>prepareCall é‡å‘½å</h3><p>å€¼å¾—æ³¨æ„çš„åœ°æ–¹æ˜¯ <code>prepareCall()</code> è¢«å‘½åä¸º <code>registerForActivityResult()</code> </p><blockquote><p>æ³¨æ„ï¼šåœ¨ç‰ˆæœ¬å¤„äº Alpha ç‰ˆçŠ¶æ€æ—¶ï¼Œå¯ä»¥æ·»åŠ ã€ç§»é™¤æˆ–æ›´æ”¹ APIã€‚å› æ­¤ Alpha ç‰ˆæœ¬ä¸é€‚åˆåœ¨ç”Ÿäº§ä¸Šä½¿ç”¨</p></blockquote><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430091418.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ¥è‡ªæˆ‘çš„å¦ä¸€ç¯‡åšå®¢"></p><h3 id="target-fragment-API-è¢«å¼ƒç”¨"><a href="#target-fragment-API-è¢«å¼ƒç”¨" class="headerlink" title="target fragment API è¢«å¼ƒç”¨"></a>target fragment API è¢«å¼ƒç”¨</h3><p>å…¶å® <code>target fragment API</code> æ—©å·²è¢«å¼ƒç”¨</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430092548.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="setTargetFragment è¢«å¼ƒç”¨"></p><p><code>target fragment</code> éœ€è¦ç›´æ¥è®¿é—®å¦ä¸€ä¸ª fragment çš„å®ä¾‹ï¼Œè¿™æ˜¯ååˆ†å±é™©çš„ï¼Œå› ä¸ºä½ ä¸çŸ¥é“ç›®æ ‡ fragment å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚è€Œä¸” <code>target fragment</code> ä¸æ”¯æŒ Navigation</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430092824.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å¼ƒç”¨ target fragment API"></p><p>é‚£ä¹ˆï¼Œfragment ä¹‹é—´ä¼ é€’æ•°æ®æ›´å¹²å‡€çš„æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="fragment-ä¹‹é—´ä¼ é€’æ•°æ®çš„æ–°æ–¹å¼"><a href="#fragment-ä¹‹é—´ä¼ é€’æ•°æ®çš„æ–°æ–¹å¼" class="headerlink" title="fragment ä¹‹é—´ä¼ é€’æ•°æ®çš„æ–°æ–¹å¼"></a>fragment ä¹‹é—´ä¼ é€’æ•°æ®çš„æ–°æ–¹å¼</h3><p>å‰æ–‡æåˆ°ï¼Œåœ¨ç›¸åŒçš„ FragmentManager ä¸­å¯ä»¥ä½¿ç”¨ target fragment API æ¥åœ¨ fragment é—´ä¼ é€’æ•°æ®ï¼Œä½†è¿™ç§æ–¹å¼éœ€è¦ç›´æ¥è®¿é—®ç›®æ ‡fragment çš„å®ä¾‹ï¼Œè¿™å¾ˆå±é™©ï¼Œå› ä¸ºç›®æ ‡ fragment çš„çŠ¶æ€æ˜¯æœªçŸ¥çš„</p><p>å› æ­¤å®˜æ–¹æä¾›äº†è¿™æ ·çš„ APIï¼Œå®ƒå…è®¸åœ¨ä¸€ä¸ª fragment ä¸Šè®¾ç½®ç»“æœï¼Œå¹¶å°†è¯¥ç»“æœåœ¨ fragment çš„é€‚å½“çš„ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ã€‚</p><p>è¿™ç§ä¼ é€’æ•°æ®çš„æ–¹å¼é€‚ç”¨äº DialogFragment ï¼ŒNavigation ä¸­çš„ fragment</p><p>æ­¤æ›´æ”¹è¿˜åŒ…æ‹¬ -ktx æ‰©å±•åŠŸèƒ½ä»¥ç¡®ä¿ kotlin ç”¨æˆ·å¯ä»¥å°† FragmentResultListener ä½œä¸º lambda ä¼ é€’</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430105343.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="FragmentA æºç "></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430105411.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="FragmentB æºç "></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430105045.gif" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="demo"></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>è€è§„çŸ©ï¼Œæˆ‘ä»¬æ²¿ç€å®˜æ–¹çš„ commit log æ¥çœ‹çœ‹å®˜æ–¹å®ç°è¯¥åŠŸèƒ½çš„æ€è·¯</p><p>é¦–å…ˆï¼Œæ·»åŠ äº† FragmentResultOwner è¿™æ ·çš„çš„æŠ½è±¡ï¼Œç”¨äºå¤„ç† fragment resultï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ªæ–¹æ³•</p><ul><li>setResult</li><li>setResultListener</li></ul><p>å‰è€…ç”¨äºå‘é€æ•°æ®ï¼Œåè€…ç”¨äºæ¥æ”¶æ•°æ®</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430110206.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="FragmentResultOwner"></p><p>è€Œå…¶å®ç°ç±»ä¸º FragmentManager</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430110412.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="FragmentManager implement FragmentResultOwner "></p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ FragmentManager ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200430111003.png" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFragmentResultListener</span><span class="hljs-params">(@NonNull <span class="hljs-keyword">final</span> String requestKey,<br>        @NonNull <span class="hljs-keyword">final</span> LifecycleOwner lifecycleOwner,<br>        @Nullable <span class="hljs-keyword">final</span> FragmentResultListener listener)</span> </span>&#123;<br>    <span class="hljs-comment">// è®¾ç½®çš„ listener ä¸ºç©ºæ—¶å°† requestKey å¯¹åº”çš„ listener ç§»é™¤</span><br>    <span class="hljs-keyword">if</span> (listener == <span class="hljs-keyword">null</span>) &#123;<br>        mResultListeners.remove(requestKey);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å½“fragment å¤„äºDESTROYED çŠ¶æ€æ—¶ ç›´æ¥ return ï¼Œé¿å…äº†å¼‚å¸¸</span><br>    <span class="hljs-keyword">final</span> Lifecycle lifecycle = lifecycleOwner.getLifecycle();<br>    <span class="hljs-keyword">if</span> (lifecycle.getCurrentState() == Lifecycle.State.DESTROYED) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è§‚å¯Ÿç”Ÿå‘½å‘¨æœŸï¼Œfragment started åæ¥æ”¶å›è°ƒï¼Œdestroyed ç§»é™¤å›è°ƒ</span><br>    LifecycleEventObserver observer = <span class="hljs-keyword">new</span> LifecycleEventObserver() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStateChanged</span><span class="hljs-params">(@NonNull LifecycleOwner source,<br>                @NonNull Lifecycle.Event event)</span> </span>&#123;<br>            <span class="hljs-keyword">if</span> (event == Lifecycle.Event.ON_START) &#123;<br>                <span class="hljs-comment">// once we are started, check for any stored results</span><br>                Bundle storedResult = mResults.get(requestKey);<br>                <span class="hljs-keyword">if</span> (storedResult != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-comment">// if there is a result, fire the callback</span><br>                    listener.onFragmentResult(requestKey, storedResult);<br>                    <span class="hljs-comment">// and clear the result</span><br>                    setFragmentResult(requestKey, <span class="hljs-keyword">null</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;<br>                lifecycle.removeObserver(<span class="hljs-keyword">this</span>);<br>                mResultListeners.remove(requestKey);<br>            &#125;<br>        &#125;<br>    &#125;;<br>    lifecycle.addObserver(observer);<br>    mResultListeners.put(requestKey, <span class="hljs-keyword">new</span> LifecycleAwareResultListener(lifecycle, listener));<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä¾¿æ˜¯è¿™éƒ¨åˆ†çš„æºç </p><blockquote><p>è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ <code>fragment result api</code> æ˜¯åŸºäºåŒä¸€ <code>FragmentManager</code> çš„</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å®˜æ–¹ä¸€ç›´è‡´åŠ›äºå°† fragment çš„ api å˜å¾—æ›´å¥½ç”¨</p><p><a href="https://medium.com/@ianhlake" target="_blank" rel="noopener">Ian Lake</a> åœ¨ <a href="https://www.youtube.com/watch?v=RS1IACnZLy4" target="_blank" rel="noopener">Fragments: Past, Present, and Future (Android Dev Summit â€˜19)</a> ä¸­æåˆ°äº† fragment é—´é€šä¿¡çš„é—®é¢˜ï¼Œæœªæ¥ fragment ä¼šæ•´åˆ fragment è‡ªèº«å’Œå…¶å†…éƒ¨ view çš„ç”Ÿå‘½å‘¨æœŸï¼Œæä¾›åŒä¸€ FragmentManager å¤šè¿”å›æ ˆçš„æ”¯æŒ</p><p>çœ‹åˆ° <code>fragment result API</code> ï¼Œæˆ‘çªç„¶æœ‰ä¸ªæƒ³æ³•ï¼Œå¦‚æœå°†å…¶åº”ç”¨åˆ° Navigation ä¸­æ˜¯å¦æ˜¯è§£å†³ Navigation è·³è½¬è¿”å›åçŠ¶æ€é‡ç½®çš„ä¸€ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p><p>å„ä½å°ä¼™ä¼´æœ‰ä»€ä¹ˆæƒ³æ³•æ¬¢è¿è¯„è®ºåŒºç•™è¨€</p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><center><p> æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·</p></center><div align="center"><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200429102625.jpg" src="/2020/04/30/Jetpack-fragment-ResultAPI/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></div>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
            <tag> Fragment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Jetpackæ›´æ–°ä¹‹Fragmentã€‘setMaxLifecycle ä¸Šä½ï¼ŒsetUserVisibleHint è¢«å¼ƒç”¨</title>
      <link href="/2020/04/29/Jetpack-fragment-setMaxLifecycle/"/>
      <url>/2020/04/29/Jetpack-fragment-setMaxLifecycle/</url>
      
        <content type="html"><![CDATA[<p>å¾ˆå¤šæƒ…å†µä¸‹ï¼Œfragment çš„ç”Ÿå‘½å‘¨æœŸä¸Šé™åº”è¯¥ä½äº FragmentManager/Activityã€‚ä¾‹å¦‚ï¼Œ<code>ViewPager</code> å±å¹•å¤–çš„ç•Œé¢ä¸åº”è¢« <code>resumed</code></p><p>ç†æƒ³çŠ¶æ€ä¸‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ API å®ç°</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">supportFragmentManager<br>  .beginTransaction()<br>      .setMaxLifecycle(fragment, Lifecycle.State.RESUMED)<br>      .commit()<br></code></pre></td></tr></table></figure><p>å°†æœ€å¤§ç”Ÿå‘½å‘¨æœŸè®¾ç½®ä¸º <code>Lifecycle.State.RESUMED</code> å°†æœ‰æ•ˆåœ°æ¶ˆé™¤é™åˆ¶ï¼ˆå› ä¸ºè¿™æ˜¯æœ€é«˜ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼‰</p><p>è¿™å°†å…è®¸åºŸå¼ƒ <code>setUserVisibleHint()</code> API</p><a id="more"></a><h2 id="setMaxLifecycle-å‡ºç°å§‹æœ«"><a href="#setMaxLifecycle-å‡ºç°å§‹æœ«" class="headerlink" title="setMaxLifecycle å‡ºç°å§‹æœ«"></a>setMaxLifecycle å‡ºç°å§‹æœ«</h2><p>è¯¥åŠŸèƒ½åº”å¦‚ä½•å®ç°çš„ï¼Ÿæˆ‘ä»¬æ²¿ç€ <code>commit log</code> æ¥ç†ä¸€ä¸‹å®˜æ–¹çš„æ€è·¯</p><p>å°† <code>BackStackRecord</code> çš„éƒ¨åˆ†é€»è¾‘è½¬ç§»è‡³çˆ¶ç±» <code>FragmentTransaction</code> ä¸­</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423094356.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423101522.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>åœ¨ <code>FragmentTransaction</code> ä¸­æ·»åŠ  <code>setMaxLifecycle</code> API</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423101908.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423102052.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä¿å­˜ fragment <code>maxState</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423103245.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423103057.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å¼ƒç”¨ <code>setUserVisibleHint</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423103528.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><code>FragmentPagerAdapter</code> æ„é€ å™¨æ–°å¢å‚æ•°ï¼Œä½¿ç”¨ <code>setMaxLifecycle()</code> API ç¡®ä¿ fragment <code>resumed</code> æ—¶å¯¹ç”¨æˆ·å¯è§</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423104355.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423104634.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å¼ƒç”¨ <code>FragmentStatePagerAdapter</code> åŸæ¥çš„å•å‚æ„é€ å™¨ï¼Œæ¨èä½¿ç”¨æ–°çš„æ„é€ </p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423105038.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423105144.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><strong>éšç€ <code>ViewPager2 1.0.0</code> æ­£å¼ç‰ˆå‘å¸ƒï¼Œä¸ <code>ViewPager</code> äº¤äº’çš„<code>FragmentPagerAdapter</code> å’Œ <code>FragmentStatePagerAdapter</code> è¢«å¼ƒç”¨äº†</strong></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423111201.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è‡³æ­¤æˆ‘ä»¬æ‹é¡ºäº† <code>setMaxLifecycle</code> çš„å‡ºç°ï¼Œ<code>setUserVisibleHint</code> çš„å¼ƒç”¨ä»¥åŠä¸<code>ViewPager</code> ç›¸å…³çš„ <code>FragmentPagerAdapter</code> å’Œ <code>FragmentStatePagerAdapter</code> çš„å¼ƒç”¨</p><h2 id="setMaxLifecycle-å†…éƒ¨é€»è¾‘"><a href="#setMaxLifecycle-å†…éƒ¨é€»è¾‘" class="headerlink" title="setMaxLifecycle å†…éƒ¨é€»è¾‘"></a>setMaxLifecycle å†…éƒ¨é€»è¾‘</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ <code>setMaxLifecycle</code>  æ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„</p><p>é¦–å…ˆæˆ‘ä»¬è¦ç ”ç©¶ä¸€ä¸‹ fragment çš„çŠ¶æ€ç®¡ç†ï¼Œä¸ºäº†æ›´å¥½çš„ç®¡ç† fragment çš„çŠ¶æ€ï¼Œå®˜æ–¹æ·»åŠ äº† <code>FragmentStateManager</code> ç±»æ¥ä¸“é—¨ç®¡ç† fragment çš„çŠ¶æ€ï¼ŒèŒèƒ½å•ä¸€åŸåˆ™å“ˆ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423113312.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423113509.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æ¥ç€åœ¨è¯¥ç±»ä¸­æ·»åŠ äº†è®¡ç®— fragment æœ€å¤§ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³• <code>computeMaxState()</code> </p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423114557.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423114615.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>åæ¥è¯¥æ–¹æ³•æ”¹åä¸º <code>computeExpectedState()</code> å¹¶åŠ å…¥äº† <code>moveToExpectedState()</code> æ–¹æ³•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423115055.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><code>computeExpectedState()</code>  æ–¹æ³•ä¼šæ ¹æ® fragment <code>mMaxState</code> è®¡ç®— fragment åº”è¯¥æ‰€å¤„çš„ç”Ÿå‘½å‘¨æœŸ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423115521.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è€Œ fragment çš„ <code>mMaxState</code> æ˜¯é€šè¿‡ <code>FragmentManager</code> çš„ <code>setMaxLifecycle()</code> æ–¹æ³•è®¾ç½®çš„ ï¼Œè€Œè¯¥æ–¹æ³•æ˜¯ <code>BackStackRecord</code> æ‰§è¡Œ OP æ—¶è°ƒç”¨çš„ï¼Œè€Œ OP å€¼æ­£æ˜¯é€šè¿‡ <code>FragmentTransaction</code> çš„ <code>setMaxLifecycle()</code> è®¾ç½®çš„</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423115744.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200423115928.png" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬ç†æ¸…äº† <code>setMaxLifecycle()</code> çš„å†…éƒ¨é€»è¾‘</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®˜æ–¹ä¸ºäº†ä½¿ fragment èƒ½å¤Ÿåœ¨æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸä¸Šï¼Œå¼•å…¥äº† <code>setMaxLifecycle()</code> æ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†æ›´å¥½çš„ç®¡ç† fragment çš„çŠ¶æ€ï¼ŒæŠ½è±¡å‡ºäº† <code>FragmentStateManager</code> ã€‚<em>æ›´å°‘çš„ä»£ç ï¼Œæ›´å°‘çš„èŒè´£</em>ï¼Œfragment çš„å†…éƒ¨é€»è¾‘ä¼šè¶Šæ¥è¶Šæ¸…æ™°</p><ul><li><p>å…³äºå¦‚ä½•è¿ç§»è‡³ ViewPager2 ï¼Œè¯·ç§»æ­¥ <a href="https://www.bilibili.com/video/BV1uJ411C7S4?from=search&seid=7755962876168902731" target="_blank" rel="noopener">å®˜æ–¹è§†é¢‘</a></p></li><li><p>å…³äºæ–°çš„ API ä¸‹æ‡’åŠ è½½å®ç°ï¼Œè¯·ç§»æ­¥ <a href="https://juejin.im/post/5e232d01e51d455801624c06" target="_blank" rel="noopener">Androidx ä¸‹ Fragment æ‡’åŠ è½½çš„æ–°å®ç°</a></p></li></ul><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><center><p> æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·</p></center><div align="center"><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200429102625.jpg" src="/2020/04/29/Jetpack-fragment-setMaxLifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></div>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
            <tag> Fragment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¥‡æŠ€æ·«å·§ã€‘Androidç»„ä»¶åŒ–ä¸ä½¿ç”¨ Router å¦‚ä½•å®ç°ç»„ä»¶é—´ activity è·³è½¬</title>
      <link href="/2020/04/15/Tips-Components-Jump/"/>
      <url>/2020/04/15/Tips-Components-Jump/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®ä½¿ç”¨äº†ç»„ä»¶åŒ–ï¼Œç»„ä»¶ä¹‹é—´çš„é€šä¿¡æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„é—®é¢˜ã€‚<code>ARouter</code> ç­‰è·¯ç”±æ–¹æ¡ˆä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³åŠæ³•ã€‚é‚£ä¹ˆå¦‚æœä¸ä½¿ç”¨ Router å¦‚ä½•å®ç°ç»„ä»¶é—´çš„ç•Œé¢è·³è½¬å‘¢ï¼Ÿ</p><a id="more"></a><h2 id="ä¸‡èƒ½çš„-setClassName"><a href="#ä¸‡èƒ½çš„-setClassName" class="headerlink" title="ä¸‡èƒ½çš„ setClassName"></a>ä¸‡èƒ½çš„ <code>setClassName</code></h2><p>ä»ä¸€ä¸ª Activity è·³è½¬åˆ°å¦ä¸€ä¸ªActivity çš„æœ€ç›´æ¥æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, TestActivity::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br>startActivity(intent)<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œé‡‡ç”¨è¿™ç§æ–¹æ³•ï¼Œå½“åŸ activity ä½äºä¸€ä¸ª moduleï¼ˆä¾‹å¦‚ <code>FeatureA</code> ï¼‰ä¸­ï¼Œè€Œç›®æ ‡ activity ä½äºå¦ä¸€ä¸ª moduleï¼ˆ<code>FeatureB</code>ï¼‰ä¸­æ—¶ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200415110401.png" src="/2020/04/15/Tips-Components-Jump/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Intent çš„ <code>setClassName</code> æ–¹æ³•</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> intent = Intent()<br>intent.setClassName(<span class="hljs-keyword">this</span>, â€œcom.flywith24.demo.TestActivityâ€)<br>startActivity(intent)<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ–¹å¼ç¡¬ç¼–ç ç›®æ ‡ activity çš„å®Œæ•´ç±»åï¼Œå¦‚æœ activity çš„ç±»åè¢«æ›´æ”¹æˆ–è€…ç§»åŠ¨ï¼Œè€Œä¸”æ²¡æœ‰æ›´æ”¹ç¡¬ç¼–ç ï¼Œåˆ™ç¼–è¯‘å¯ä»¥é€šè¿‡ï¼Œä½†æ˜¯è¿è¡Œæ—¶å´©æºƒ</p><p>å¦‚æœå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ activity å®Œæ•´ç±»åå°±å¥½äº†</p><h2 id="ä½¿ç”¨æ’ä»¶"><a href="#ä½¿ç”¨æ’ä»¶" class="headerlink" title="ä½¿ç”¨æ’ä»¶"></a>ä½¿ç”¨æ’ä»¶</h2><p>æˆ‘ä»¬çŸ¥é“ activity ä½œä¸º Android çš„ç»„ä»¶ä¹‹ä¸€éœ€è¦åœ¨ Manifest æ–‡ä»¶ä¸­å£°æ˜</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">â€com.flywith24.demo.MainActivityâ€</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">â€com.flywith24.demo.TestActivityâ€</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬çš„æ•°æ®æ˜¯ä» Manifest ä¸­è·å¾—çš„ï¼Œé‚£ä¹ˆå°±è§£å†³äº†ç¡¬ç¼–ç çš„é—®é¢˜äº†</p><p>æœ‰è¿™æ ·ä¸€ä¸ª<a href="https://github.com/gaelmarhic/Quadrant" target="_blank" rel="noopener">æ’ä»¶</a> ï¼Œåœ¨ build æ—¶ä¼šå°†æ‰€æœ‰åœ¨ Manifest ä¸­å£°æ˜çš„ activity çš„å®Œæ•´ç±»åä»¥é™æ€å¸¸é‡çš„å½¢å¼ç½—åˆ—åˆ°ä¸€ä¸ªé™æ€ç±»ä¸­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">object</span> QuadrantConstants &#123;<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAIN_ACTIVITY: String = <span class="hljs-string">"com.gaelmarhic.quadrant.MainActivity"</span><br><br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> SECONDARY_ACTIVITY: String = <span class="hljs-string">"com.gaelmarhic.quadrant.SecondaryActivity"</span><br><br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TERTIARY_ACTIVITY: String = <span class="hljs-string">"com.gaelmarhic.quadrant.TertiaryActivity"</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·åœ¨ä½¿ç”¨æ—¶å°±é¿å…äº†ç¡¬ç¼–ç </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> intent = Intent()<br>intent.setClassName(context, QuadrantConstants.MAIN_ACTIVITY)<br>startActivity(intent)<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨ä¾èµ–æ³¨å…¥"><a href="#ä½¿ç”¨ä¾èµ–æ³¨å…¥" class="headerlink" title="ä½¿ç”¨ä¾èµ–æ³¨å…¥"></a>ä½¿ç”¨ä¾èµ–æ³¨å…¥</h2><p>ç»„ä»¶åŒ–ä¸­ <code>app</code> module ä¼šä¾èµ–æ‰€æœ‰çš„åŠŸèƒ½ module ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¾èµ–æ³¨å…¥åœ¨ <code>app</code> ä¸­å°†æ‰€æœ‰çš„ç›®æ ‡ activity çš„å®Œæ•´ç±»åå£°æ˜å‡ºæ¥ï¼Œä¹Ÿèƒ½è¾¾åˆ°è§£å†³ç¡¬ç¼–ç çš„é—®é¢˜</p><p>è¿™é‡Œä»¥ <a href="https://insert-koin.io/" target="_blank" rel="noopener">koin</a> ä¸ºä¾‹</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplication</span> : <span class="hljs-type">Application</span></span>() &#123;<br>    <span class="hljs-keyword">val</span> myModule = module &#123;<br>        single &#123; Feature2Activity::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>.<span class="hljs-title">name</span> &#125;</span><br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onCreate()<br>        startKoin &#123;<br>            androidContext(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MyApplication</span>)<br>            modules(myModule)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·é€šè¿‡ get() æ–¹æ³•å³å¯æ‹¿åˆ° <code>Feature2Activity</code> çš„å®Œæ•´ç±»å</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> intent = Intent()<br>    .setClassName(<span class="hljs-keyword">this</span><span class="hljs-symbol">@Feature1Activity</span>, <span class="hljs-keyword">get</span>())<br>    .putExtra(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>)<br>startActivity(intent)<br></code></pre></td></tr></table></figure><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p><a href="https://github.com/Flywith24/MultitableModuleApp" target="_blank" rel="noopener">Demo åœ°å€</a></p><p>å„ä½æœ‰ä»€ä¹ˆæƒ³æ³•æ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€</p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/04/15/Tips-Components-Jump/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tips </tag>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¥‡æŠ€æ·«å·§ã€‘å·§ç”¨ kotlin æ‰©å±•å‡½æ•°å’Œ typealias å°è£… LiveData</title>
      <link href="/2020/04/15/Tips-StateLiveData/"/>
      <url>/2020/04/15/Tips-StateLiveData/</url>
      
        <content type="html"><![CDATA[<h2 id="å…³äº-LiveData-ä¸¤ä¸ªå¸¸ç”¨çš„å§¿åŠ¿"><a href="#å…³äº-LiveData-ä¸¤ä¸ªå¸¸ç”¨çš„å§¿åŠ¿" class="headerlink" title="å…³äº LiveData ä¸¤ä¸ªå¸¸ç”¨çš„å§¿åŠ¿"></a>å…³äº LiveData ä¸¤ä¸ªå¸¸ç”¨çš„å§¿åŠ¿</h2><h3 id="ä½¿ç”¨åŒ…è£…ç±»ä¼ é€’äº‹ä»¶"><a href="#ä½¿ç”¨åŒ…è£…ç±»ä¼ é€’äº‹ä»¶" class="headerlink" title="ä½¿ç”¨åŒ…è£…ç±»ä¼ é€’äº‹ä»¶"></a>ä½¿ç”¨åŒ…è£…ç±»ä¼ é€’äº‹ä»¶</h3><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ LiveData æ—¶å¯èƒ½ä¼šé‡åˆ°ã€Œç²˜æ€§ã€äº‹ä»¶çš„é—®é¢˜ï¼Œè¯¥é—®é¢˜å¯ä»¥ä½¿ç”¨åŒ…è£…ç±»çš„æ–¹å¼è§£å†³ã€‚è§£å†³æ–¹æ¡ˆè§ <a href="https://juejin.im/post/5b2b1b2cf265da5952314b63#heading-7" target="_blank" rel="noopener">[è¯‘] åœ¨ SnackBarï¼ŒNavigation å’Œå…¶ä»–äº‹ä»¶ä¸­ä½¿ç”¨ LiveDataï¼ˆSingleLiveEvent æ¡ˆä¾‹ï¼‰</a></p><a id="more"></a><p>ä½¿ç”¨æ—¶æ˜¯è¿™æ ·çš„</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListViewModel</span> : <span class="hljs-type">ViewModel &#123;</span></span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _navigateToDetails = MutableLiveData&lt;Event&lt;String&gt;&gt;()<br><br>    <span class="hljs-keyword">val</span> navigateToDetails : LiveData&lt;Event&lt;String&gt;&gt;<br>        <span class="hljs-keyword">get</span>() = _navigateToDetails<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userClicksOnButton</span><span class="hljs-params">(itemId: <span class="hljs-type">String</span>)</span></span> &#123;<br>        _navigateToDetails.value = Event(itemId)  <span class="hljs-comment">// Trigger the event by setting a new Event as a new value</span><br>    &#125;<br>&#125;<br><br>myViewModel.navigateToDetails.observe(<span class="hljs-keyword">this</span>, Observer &#123;<br>    it.getContentIfNotHandled()?.let &#123; <span class="hljs-comment">// Only proceed if the event has never been handled</span><br>        startActivity(DetailsActivity...)<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>ä¸è¿‡è¿™æ ·å†™ç”šæ˜¯ç¹çï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´ä¼˜é›…çš„æ–¹å¼è§£å†³è¯¥é—®é¢˜</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//ä¸º LiveData&lt;Event&lt;T&gt;&gt;æä¾›ç±»å‹åˆ«åï¼Œä½¿ç”¨ EventLiveData&lt;T&gt; å³å¯</span><br><span class="hljs-keyword">typealias</span> EventMutableLiveData&lt;T&gt; = MutableLiveData&lt;Event&lt;T&gt;&gt;<br><br><span class="hljs-keyword">typealias</span> EventLiveData&lt;T&gt; = LiveData&lt;Event&lt;T&gt;&gt;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>typealias</code> å…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªç±»å‹åˆ«åï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//ç­‰ä»·äº MutableLiveData&lt;Event&lt;Boolean&gt;&gt;(Event(false))</span><br><span class="hljs-keyword">val</span> eventContent = EventMutableLiveData&lt;<span class="hljs-built_in">Boolean</span>&gt;(Event(<span class="hljs-literal">false</span>))<br></code></pre></td></tr></table></figure><p>ç°åœ¨å£°æ˜æ—¶ä¸ç”¨å¤šåŠ ä¸€å±‚æ³›å‹äº†ï¼Œé‚£ä¹ˆä½¿ç”¨æ—¶è¿˜æ˜¯å¾ˆç¹ç</p><p>æˆ‘ä»¬å¯ä»¥å€ŸåŠ© kotlin çš„ æ‰©å±•å‡½æ•°æ›´ä¼˜é›…çš„ä½¿ç”¨</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605115649.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="event æ‰©å±•å‡½æ•°"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605121030.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä½¿ç”¨"></p><p>demo ä¸­å°è£…äº†ä¸¤ç§å½¢å¼çš„ LiveDataï¼Œä¸€ç§ä¸º <code>LiveData&lt;Boolean&gt;</code>ï¼Œä¸€ç§ä¸º <code>EventLiveData&lt;Boolean&gt;</code>ï¼Œå½“å±å¹•æ—‹è½¬æ—¶ï¼Œå‰è€…ä¼šå†æ¬¡å›è°ƒç»“æœï¼Œè€Œåè€…ç”±äºäº‹ä»¶å·²è¢«å¤„ç†è€Œä¸æ‰§è¡Œ onChangedï¼Œæˆ‘ä»¬é€šè¿‡ Toast å¯è§‚å¯Ÿåˆ°è¿™ä¸€ç°è±¡</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605121634.gif" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><a href="https://github.com/KunMinX/Jetpack-MVVM-Best-Practice" target="_blank" rel="noopener">java ç‰ˆçš„å¯å‚è€ƒ</a></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605122206.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h3 id="å°è£…å¸¦ç½‘ç»œçŠ¶æ€çš„æ•°æ®"><a href="#å°è£…å¸¦ç½‘ç»œçŠ¶æ€çš„æ•°æ®" class="headerlink" title="å°è£…å¸¦ç½‘ç»œçŠ¶æ€çš„æ•°æ®"></a>å°è£…å¸¦ç½‘ç»œçŠ¶æ€çš„æ•°æ®</h3><p>å¾ˆå¤šæ—¶å€™æˆ‘ä»¬åœ¨è·å–ç½‘ç»œæ•°æ®æ—¶è¦å°è£…ä¸€å±‚ç½‘ç»œçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šåŠ è½½ä¸­ï¼ŒæˆåŠŸï¼Œå¤±è´¥</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605115950.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>åœ¨ä½¿ç”¨æ—¶æˆ‘ä»¬é‡åˆ°äº†å’Œä¸Šé¢ä¸€æ ·çš„é—®é¢˜ï¼Œå¤šå±‚æ³›å‹ç”¨èµ·æ¥å¾ˆéº»çƒ¦</p><p>æˆ‘ä»¬ä¾ç„¶å¯ä»¥ä½¿ç”¨ typealias + æ‰©å±•å‡½æ•°æ¥ä¼˜é›…çš„å¤„ç†è¯¥é—®é¢˜</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605120336.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="typealias"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605120400.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ‰©å±•å‡½æ•°"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605120455.png" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä½¿ç”¨"></p><p>demo æˆªå›¾</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200605120721.gif" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="demo"></p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>demo <a href="https://github.com/Flywith24/WrapperLiveDataDemo" target="_blank" rel="noopener">åœ¨è¿™</a>ï¼Œå¦‚æœæ„Ÿè§‰è¿™ä¸ªæ€è·¯å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œç‚¹ä¸€é¢—å°æ˜Ÿæ˜Ÿå§ï½ ğŸ˜‰</p><p>å¦å¤–æˆ‘è¿˜å°†å®ƒä¼ åˆ°äº† JitPack ä¸Šï¼Œå¼•å…¥å§¿åŠ¿å¦‚ä¸‹ï¼š</p><p><a href="https://jitpack.io/#Flywith24/WrapperLiveData" target="_blank" rel="noopener"><img class="lazyload" data-original="https://jitpack.io/v/Flywith24/WrapperLiveData.svg" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></a></p><ol><li><p>åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ <code>build.gradle</code> åŠ å…¥</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs groovy">allprojects &#123;<br>  repositories &#123;<br>    <span class="hljs-comment">//...</span><br>    maven &#123; url <span class="hljs-string">'https://jitpack.io'</span> &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>æ·»åŠ ä¾èµ–</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>  implementation <span class="hljs-string">'com.github.Flywith24:WrapperLiveData:$version'</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="å¾€æœŸæ–‡ç« "><a href="#å¾€æœŸæ–‡ç« " class="headerlink" title="å¾€æœŸæ–‡ç« "></a>å¾€æœŸæ–‡ç« </h2><p>è¯¥ç³»åˆ—ä¸»è¦ä»‹ç»ä¸€äº›ã€Œéªšæ“ä½œã€ï¼Œå®ƒæœªå¿…é€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œä½†æ˜¯æ˜¯ä¸€äº›æ¯”è¾ƒæ–°é¢–çš„æ€è·¯</p><ul><li><a href="https://juejin.im/post/5e481a28f265da570b3f235c" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘AndroidStudio Nexus3.xæ­å»ºMavenç§æœé‡åˆ°é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</a></li></ul><ul><li><a href="https://juejin.im/post/5e22c2ce6fb9a02ff67d41c3" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘ä»€ä¹ˆï¼Ÿé¡¹ç›®é‡Œgradleä»£ç è¶…è¿‡200è¡Œäº†ï¼ä½ å¯èƒ½éœ€è¦ Kotlin+buildSrc Plugin</a></li></ul><ul><li><a href="https://juejin.im/post/5e481a28f265da570b3f235c" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘gradleä¾èµ–æŸ¥æ‰¾å¤ªéº»çƒ¦ï¼Ÿè¿™ä¸ªæ’ä»¶å¯èƒ½å¸®åˆ°ä½ </a></li></ul><ul><li><a href="https://juejin.im/post/5e967f35f265da47d77cd4c3" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘Androidç»„ä»¶åŒ–ä¸ä½¿ç”¨ Router å¦‚ä½•å®ç°ç»„ä»¶é—´ activity è·³è½¬</a></li></ul><ul><li><a href="https://juejin.im/post/5ebdfb0b6fb9a0436153db22" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘æ–°çš„å›¾ç‰‡åŠ è½½åº“ï¼ŸåŸºäºKotlinåç¨‹çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil</a></li></ul><ul><li><p><a href="https://juejin.im/post/5ec50ae46fb9a047a862124f" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘ä½¿ç”¨ Navigation + Dynamic Feature Module å®ç°æ¨¡å—åŒ–</a></p></li><li><p><a href="https://juejin.im/post/5ecde219e51d457841190d08" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘é™¤äº† buildSrc è¿˜èƒ½è¿™æ ·ç»Ÿä¸€é…ç½®ä¾èµ–ç‰ˆæœ¬ï¼Ÿå·§ç”¨ includeBuild</a></p></li></ul><p>æˆ‘çš„å…¶ä»–ç³»åˆ—æ–‡ç«  <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a></p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/04/15/Tips-StateLiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tips </tag>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€å¥‡æŠ€æ·«å·§ã€‘é™¤äº† buildSrc è¿˜èƒ½è¿™æ ·ç»Ÿä¸€é…ç½®ä¾èµ–ç‰ˆæœ¬ï¼Ÿå·§ç”¨ includeBuild</title>
      <link href="/2020/04/15/Tips-includeBuild/"/>
      <url>/2020/04/15/Tips-includeBuild/</url>
      
        <content type="html"><![CDATA[<h2 id="buildSrc-çš„ç¼ºé™·"><a href="#buildSrc-çš„ç¼ºé™·" class="headerlink" title="buildSrc çš„ç¼ºé™·"></a>buildSrc çš„ç¼ºé™·</h2><p>Android å¼€å‘ä¸­ç»Ÿä¸€ä¸åŒ module çš„ä¾èµ–ç‰ˆæœ¬ååˆ†é‡è¦ï¼Œä¼ ç»Ÿçš„æ–¹å¼æ˜¯ä½¿ç”¨ ext çš„æ–¹å¼</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200527111409.png" src="/2020/04/15/Tips-includeBuild/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ext"></p><p>ä¹‹å‰æˆ‘å‘è¿‡å…³äºä½¿ç”¨ buildSrc ç®€åŒ–é¡¹ç›®ä¸­ gradle ä»£ç çš„è¯‘æ–‡ï¼š<a href="https://juejin.im/post/5e22c2ce6fb9a02ff67d41c3" target="_blank" rel="noopener">ä»€ä¹ˆï¼Ÿé¡¹ç›®é‡Œgradleä»£ç è¶…è¿‡200è¡Œäº†ï¼ä½ å¯èƒ½éœ€è¦ Kotlin+buildSrc Plugin</a></p><p>è¯¥ç§æ–¹å¼å¯ä»¥å¾ˆå¥½çš„ç®¡ç† gradle çš„å…¬å…±é…ç½®ï¼Œè¿™å…¶ä¸­å½“ç„¶åŒ…æ‹¬ä¾èµ–ç‰ˆæœ¬</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200527111722.gif" src="/2020/04/15/Tips-includeBuild/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="é…ç½®ä¾èµ–"></p><p>å¦‚å›¾ï¼Œåœ¨ä½¿ç”¨ä¾èµ–æ—¶æœ‰ä»£ç æç¤ºï¼Œè€Œä¸”å¯ä»¥ç‚¹å‡»è¿›å…¥æŸ¥çœ‹</p><p>ä½†æ˜¯ç”±äº buildSrc æ˜¯å¯¹å…¨å±€çš„æ‰€æœ‰ module çš„é…ç½®ï¼Œå› æ­¤åœ¨æ„å»ºé€Ÿåº¦ä¸Šä¼šæ…¢ä¸€äº›ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªæ›´çº¯å‡€çš„æ–¹å¼æ¥é…ç½®ä¾èµ–ç‰ˆæœ¬å‘¢ï¼Ÿ</p><p>ä»Šå¤©æˆ‘ä»¬æ¥ä»‹ç»ä¸€ç§æ–°çš„æ–¹å¼</p><a id="more"></a><h2 id="è‡ªå®šä¹‰-plugin-includeBuild"><a href="#è‡ªå®šä¹‰-plugin-includeBuild" class="headerlink" title="è‡ªå®šä¹‰ plugin + includeBuild"></a>è‡ªå®šä¹‰ plugin + includeBuild</h2><p>ä½¿ç”¨ <a href="https://docs.gradle.org/current/userguide/composite_builds.html" target="_blank" rel="noopener">Gradle Composite builds</a> å¯ä»¥å¾ˆå®¹æ˜“è§£å†³è¿™ä¸€é—®é¢˜</p><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª moduleï¼Œå‘½åä¸º version ï¼Œå¹¶å°†åŸæ¥çš„ buildSrc çš„ä»£ç è½¬ç§»è¿‡æ¥</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DependencyVersionPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; </span>&#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ version çš„ build.gradle æ–‡ä»¶åŠ å…¥</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs groovy">gradlePlugin &#123;<br>    plugins &#123;<br>        version &#123;<br>            id = <span class="hljs-string">'com.flywith24.version'</span><br>            implementationClass = <span class="hljs-string">'com.flywith24.version.DependencyVersionPlugin'</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ settings.gradle åŠ å…¥ <code>includeBuild(&quot;version&quot;)</code> ï¼ˆ<strong>é‡ç‚¹</strong>ï¼‰</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs groovy">includeBuild(<span class="hljs-string">"version"</span>)<br><br>rootProject.name=<span class="hljs-string">'VersionControlDemo'</span><br>include <span class="hljs-string">':app'</span><br>include <span class="hljs-string">':lib'</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨éœ€è¦å¼•ç”¨çš„ module ä¸­å¼•å…¥è¯¥æ’ä»¶</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy">plugins &#123;<br>    id <span class="hljs-string">"com.flywith24.version"</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨äº†</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200527113952.png" src="/2020/04/15/Tips-includeBuild/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="demoä»£ç æˆªå›¾"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200527114023.png" src="/2020/04/15/Tips-includeBuild/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="demoä»£ç æˆªå›¾"></p><p><a href="https://github.com/Flywith24/VersionControlDemo" target="_blank" rel="noopener">demo åœ¨è¿™</a></p><h2 id="å¾€æœŸæ–‡ç« "><a href="#å¾€æœŸæ–‡ç« " class="headerlink" title="å¾€æœŸæ–‡ç« "></a>å¾€æœŸæ–‡ç« </h2><p>è¯¥ç³»åˆ—ä¸»è¦ä»‹ç»ä¸€äº›ã€Œéªšæ“ä½œã€ï¼Œå®ƒæœªå¿…é€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œä½†æ˜¯æ˜¯ä¸€äº›æ¯”è¾ƒæ–°é¢–çš„æ€è·¯</p><ul><li><a href="https://juejin.im/post/5e481a28f265da570b3f235c" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘AndroidStudio Nexus3.xæ­å»ºMavenç§æœé‡åˆ°é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</a></li></ul><ul><li><a href="https://juejin.im/post/5e22c2ce6fb9a02ff67d41c3" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘ä»€ä¹ˆï¼Ÿé¡¹ç›®é‡Œgradleä»£ç è¶…è¿‡200è¡Œäº†ï¼ä½ å¯èƒ½éœ€è¦ Kotlin+buildSrc Plugin</a></li></ul><ul><li><a href="https://juejin.im/post/5e481a28f265da570b3f235c" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘gradleä¾èµ–æŸ¥æ‰¾å¤ªéº»çƒ¦ï¼Ÿè¿™ä¸ªæ’ä»¶å¯èƒ½å¸®åˆ°ä½ </a></li></ul><ul><li><a href="https://juejin.im/post/5e967f35f265da47d77cd4c3" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘Androidç»„ä»¶åŒ–ä¸ä½¿ç”¨ Router å¦‚ä½•å®ç°ç»„ä»¶é—´ activity è·³è½¬</a></li></ul><ul><li><a href="https://juejin.im/post/5ebdfb0b6fb9a0436153db22" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘æ–°çš„å›¾ç‰‡åŠ è½½åº“ï¼ŸåŸºäºKotlinåç¨‹çš„å›¾ç‰‡åŠ è½½åº“â€”â€”Coil</a></li></ul><ul><li><a href="https://juejin.im/post/5ec50ae46fb9a047a862124f" target="_blank" rel="noopener">ã€å¥‡æŠ€æ·«å·§ã€‘ä½¿ç”¨ Navigation + Dynamic Feature Module å®ç°æ¨¡å—åŒ–</a></li></ul><p>æˆ‘çš„å…¶ä»–ç³»åˆ—æ–‡ç«  <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a></p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/04/15/Tips-includeBuild/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Tips </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tips </tag>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹DataBindingã€‘æ•°æ®é©±åŠ¨é­”æ³•å¸ˆ ä½•æ—¶è¿æ¥ç¿»èº«æ—¥ï¼Ÿ</title>
      <link href="/2020/04/09/Jetpack-DataBinding/"/>
      <url>/2020/04/09/Jetpack-DataBinding/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://juejin.im/post/5e834bb5f265da480d61668d" target="_blank" rel="noopener">LiveData ç¯‡</a> æˆ‘ä»¬æåˆ° Android å¼€å‘çš„ä¸»è¦å·¥ä½œå†…å®¹æ˜¯å°†æ•°æ®è½¬æ¢ä¸º UI ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿä»‹ç»äº†æ•°æ®é©±åŠ¨ UI çš„æ€æƒ³ï¼Œä½¿ç”¨ ViewModel + LiveDataï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨è®¢é˜…è€…çš„ç”Ÿå‘½å‘¨æœŸå†…åˆ†å‘æ­£ç¡®çš„æ•°æ®ã€‚ä½†æ˜¯ activity å’Œ fragment å……æ–¥ç€å¤§é‡çš„æ¨¡æ¿ä»£ç ï¼Œé“ºå¤©ç›–åœ°çš„ findViewByIdï¼Œä»¥åŠå„ç§ set ï¼ˆæ ¹æ®æ•°æ®è®¾ç½® UIï¼‰ã€‚å¦‚æœèƒ½å¤Ÿæ¶ˆç­æ‰è¿™äº›æ¨¡æ¿ä»£ç å°±å¥½äº†</p></blockquote><a id="more"></a><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200402101708.gif" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä»–æ¥äº†ä»–æ¥äº†"></p><p>ä»–æ¥äº†ä»–æ¥äº†ï¼Œä»–æ¬¢å¿«åœ°èµ°æ¥äº†</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200402101727.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="DataBinding"></p><p>ç„¶è€Œï¼Œå¾ˆå¤šå¼€å‘è€…å¯¹ DataBinding å­˜åœ¨åè§ï¼Œã€ŒDataBinding ä¸æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œåœ¨å£°æ˜å¼ç¼–ç¨‹ä¸­ä¹¦å†™ UI é€»è¾‘ï¼Œæ—¢ä¸å¯è°ƒè¯•ï¼Œä¹Ÿä¸ä¾¿äºå¯Ÿè§‰å’Œè¿½è¸ªï¼Œä¸‡ä¸€å‡ºç°é—®é¢˜å°±éº»çƒ¦äº†ã€‚ã€</p> <img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200402165235.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="zoom:200%;"><p>æœ¬æ–‡ä¸»è¦ä»‹ç» DataBinding çš„è§£å†³çš„é—®é¢˜ä»¥åŠå…¶èƒŒåçš„é€»è¾‘ï¼Œå¸¦æ‚¨å¯¹ DataBinding æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ã€‚æœ¬æ–‡æœ«å°¾ä¼šå¯¹å„ä¸ª findViewById çš„æ›¿ä»£æ–¹æ¡ˆè¿›è¡Œå¯¹æ¯”</p><p>DataBinding çš„ç›¸å…³èµ„æº</p><ul><li><a href="https://developer.android.com/topic/libraries/data-binding" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://codelabs.developers.google.com/codelabs/android-databinding/#0" target="_blank" rel="noopener">codelab</a></li><li><a href="https://github.com/android/databinding-samples" target="_blank" rel="noopener">å®˜æ–¹ç¤ºä¾‹</a></li></ul><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> æ•°æ®é©±åŠ¨é­”æ³•å¸ˆ</span></h2><p>DataBinding å…è®¸ä½¿ç”¨å£°æ˜æ€§æ ¼å¼è€Œä¸æ˜¯é€šè¿‡ç¼–ç¨‹æ–¹å¼å°†å¸ƒå±€ä¸­çš„ UI ç»„ä»¶ä¸æ•°æ®æºç»‘å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// before</span><br>TextView textView = findViewById(R.id.sample_text);<br>textView.setText(viewModel.getUserName());<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span><br>    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@&#123;viewmodel.userName&#125;"</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡åœ¨å¸ƒå±€æ–‡ä»¶ä¸­ç»‘å®šç»„ä»¶ï¼Œæ‚¨å¯ä»¥åˆ é™¤ activity ä¸­çš„è®¸å¤šè®¾ç½® UI è°ƒç”¨ï¼Œä»è€Œä½¿å®ƒä»¬æ›´æ˜“äºç»´æŠ¤ã€‚ è¿™ä¹Ÿå¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œå¹¶æœ‰åŠ©äºé˜²æ­¢å†…å­˜æ³„æ¼å’Œç©ºæŒ‡é’ˆå¼‚å¸¸</p><blockquote><p>å¦‚æœä»…æ›¿æ¢ findViewById è€Œä¸éœ€è¦æ•°æ®çš„ç»‘å®šï¼Œå¯ä»¥ä½¿ç”¨ ViewBindingï¼Œå®ƒä½¿ç”¨èµ·æ¥æ›´ç®€å•ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ã€‚</p><p>ä½¿ç”¨æ–¹æ³•å‚è§ <a href="https://juejin.im/post/5e4806f3e51d4526c550a2ef" target="_blank" rel="noopener">[è¯‘]æ·±å…¥ç ”ç©¶ViewBinding åœ¨ include, merge, adapter, fragment, activity ä¸­ä½¿ç”¨</a></p></blockquote><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> DataBinding åŸºç¡€</span></h2><p>è¯¦ç»†å†…å®¹å‚è§ <a href="https://developer.android.com/topic/libraries/data-binding" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> ï¼Œè¿™é‡Œåªç®€å•ä»‹ç» DataBinding</p><h3 id="DataBinding-å¼•å…¥"><a href="#DataBinding-å¼•å…¥" class="headerlink" title="DataBinding å¼•å…¥"></a>DataBinding å¼•å…¥</h3><p>app build.gradle ä¸­åŠ å…¥ </p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs groovy">android &#123;<br>    ...<br>    dataBinding &#123;<br>        enabled = <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Android Studio 4.0</span><br>android &#123;<br>    ...<br>    buildFeatures &#123;<br>        dataBinding = <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>å¿…é¡»åœ¨ app module ä¸­å£°æ˜ï¼Œå£°æ˜åå…¶ä»–å­ module å¯ç›´æ¥ä½¿ç”¨ DataBinding</p></blockquote><p>ä½¿ç”¨ DataBinding æ— éœ€å¼€å‘è€…æ‰‹åŠ¨å¼•å…¥åº“ï¼Œandroid build gradle plugin å†…éƒ¨å·²ç»å¼•å…¥äº†</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200402115116.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>DataBinding ä¸­ä½¿ç”¨äº†æ³¨è§£ï¼Œå› æ­¤åœ¨æ„å»ºé€Ÿåº¦ä¸Šæ¯” ViewBinding å·®äº›ï¼ˆä¸è¿‡åŠŸèƒ½è¿™ä¹ˆå¼ºå¤§è¦å•¥è‡ªè¡Œè½¦ï¼‰</p><h3 id="å¸ƒå±€"><a href="#å¸ƒå±€" class="headerlink" title="å¸ƒå±€"></a>å¸ƒå±€</h3><p>DataBinding å¸ƒå±€æ–‡ä»¶ç•¥æœ‰ä¸åŒï¼Œå®ƒä»¬ä»¥ layout çš„æ ¹æ ‡è®°å¼€å§‹ï¼Œåè·Ÿä¸€ä¸ª data å…ƒç´ å’Œä¸€ä¸ª view æ ¹å…ƒç´ ã€‚ view å…ƒç´ æ˜¯æ‚¨çš„æ ¹å°†ä½äºéç»‘å®šå¸ƒå±€æ–‡ä»¶ä¸­çš„å…ƒç´ ã€‚ ä»¥ä¸‹ä»£ç æ˜¾ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹å¸ƒå±€æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span><br>        <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">variable</span><br>            <span class="hljs-attr">name</span>=<span class="hljs-string">"viewmodel"</span><br>            <span class="hljs-attr">type</span>=<span class="hljs-string">"com.myapp.data.ViewModel"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ConstraintLayout...</span> /&gt;</span> <span class="hljs-comment">&lt;!-- UI layout's root element --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="ç”Ÿæˆç»‘å®šç±»"><a href="#ç”Ÿæˆç»‘å®šç±»" class="headerlink" title="ç”Ÿæˆç»‘å®šç±»"></a>ç”Ÿæˆç»‘å®šç±»</h3><p>DataBinding ä¼šä¸ºæ¯ä¸ªåœ¨å¸ƒå±€å£°æ˜ layout æ ‡ç­¾çš„ xml å¸ƒå±€æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªç»‘å®šç±»ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç±»çš„åç§°åŸºäºå¸ƒå±€æ–‡ä»¶çš„åç§°ã€‚ ä¸Šé¢çš„å¸ƒå±€æ–‡ä»¶åæ˜¯ activity_main.xmlï¼Œå› æ­¤ç›¸åº”çš„ç”Ÿæˆç±»æ˜¯ ActivityMainBindingã€‚ æ­¤ç±»åŒ…å«ä»å¸ƒå±€å±æ€§ï¼ˆä¾‹å¦‚ï¼Œviewmodel å˜é‡ï¼‰åˆ°å¸ƒå±€è§†å›¾çš„æ‰€æœ‰ç»‘å®šï¼Œå¹¶ä¸”çŸ¥é“å¦‚ä½•ä¸ºç»‘å®šè¡¨è¾¾å¼åˆ†é…å€¼</p><h3 id="é…ç½®ç»‘å®š"><a href="#é…ç½®ç»‘å®š" class="headerlink" title="é…ç½®ç»‘å®š"></a>é…ç½®ç»‘å®š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>    <span class="hljs-comment">// before</span><br>    <span class="hljs-comment">// setContentView(R.layout.activity_main)</span><br>    <br>    <span class="hljs-comment">// after</span><br>    val binding : ActivityMainBinding =<br>    DataBindingUtil.setContentView(<span class="hljs-keyword">this</span>, R.layout.activity_main)<br>&#125;<br></code></pre></td></tr></table></figure><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> ä½¿ç”¨DataBinding è§£å†³çš„é—®é¢˜åŠå®ç°åŸç†</span></h2><p>ä¸çŸ¥é“ä½ æ˜¯å¦æœ‰è¿™äº›çƒ¦æ¼ï¼šactivity å’Œ fragment ä¸­æœ‰ç€å¤§é‡çš„æ¨¡æ¿ä»£ç ï¼Œå³ä½¿ä½¿ç”¨ ButterKnife ç­‰å·¥å…·å†™èµ·ä»£ç æ¥ä¹Ÿå¾ˆç¹çã€‚è€Œä¸” View id ä¸ View çš„ç±»å‹ä¸åŒ¹é…æ—¶ï¼Œåªæœ‰åœ¨è¿è¡ŒæœŸæ‰èƒ½å‘ç°ï¼›æ—‹è½¬å±å¹•åå¦‚æœæ–°çš„å¸ƒå±€ä¸­ä¸å­˜åœ¨ä¹‹å‰ id çš„ view ï¼Œå¯èƒ½è¿˜å¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼›é¡¹ç›®ä¸­ä½¿ç”¨å„ç±» bus é€šçŸ¥ UI åˆ·æ–°ï¼Œä½†æ˜¯æœ‰æ—¶ UI çš„æ˜¾ç¤ºå¹¶ä¸ç¬¦åˆé¢„æœŸï¼Œè€Œæ’æŸ¥èµ·æ¥ç‰¹åˆ«å›°éš¾ï¼Œå› ä¸ºæ•°æ®æºå¾ˆå¤šâ€¦</p><p>ä¸è¦æ…Œï¼ŒDataBinding å¯ä»¥è§£å†³ä»¥ä¸‹é—®é¢˜</p><ul><li><p>æ›¿æ¢ findViewById ï¼Œå‡å°‘æ¨¡æ¿ä»£ç </p></li><li><p>è§£å†³ç±»å‹å®‰å…¨é—®é¢˜</p></li><li><p>è§£å†³ç©ºå®‰å…¨é—®é¢˜</p></li><li><p>ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§</p></li></ul><h3 id="é­”æ³•çš„èƒŒå"><a href="#é­”æ³•çš„èƒŒå" class="headerlink" title="é­”æ³•çš„èƒŒå"></a>é­”æ³•çš„èƒŒå</h3><p>com.android.tools.build:gradle æ’ä»¶ä¸­å°è£…äº† DataBinding çš„é­”æ³•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200402162010.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æŸ¥çœ‹ com.android.tools.build:gradle:3.6.2 çš„æºç ï¼Œæ‰¾åˆ° DataBinding é…ç½®é¡¹çš„ç±» DataBindingOptions</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// DataBindingOptions.java</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isEnabled</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// DataBinding æ˜¯å¦å¼€å¯ï¼Œå¯¹åº”ä¸Šé¢åœ¨ build.gradle ä¸­çš„é…ç½®</span><br>    <span class="hljs-keyword">return</span> enabled;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒçš„è°ƒç”¨è€…å¾ˆå¤šï¼Œåœ¨ TaskManager ä¸­çš„ createDataBindingTasksIfNecessary</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TaskManager </span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createDataBindingTasksIfNecessary</span><span class="hljs-params">(@NonNull VariantScope scope)</span> </span>&#123;<br>    <span class="hljs-comment">// æ˜¯å¦å¼€å¯ DataBinding</span><br>    <span class="hljs-keyword">boolean</span> dataBindingEnabled = extension.getDataBinding().isEnabled();<br>    <span class="hljs-keyword">boolean</span> viewBindingEnabled = extension.getViewBinding().isEnabled();<br>    <span class="hljs-keyword">if</span> (!dataBindingEnabled &amp;&amp; !viewBindingEnabled) &#123;<br>        <span class="hljs-comment">// DataBinding å’Œ ViewBinding å‡æœªå¼€å¯åˆ™ç›´æ¥ return</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    createDataBindingMergeBaseClassesTask(scope);<br>    createDataBindingMergeArtifactsTask(scope);<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">// æ„å»º DataBinding ç›¸åº”ç»‘å®šç±»</span><br>    taskFactory.register(<span class="hljs-keyword">new</span> DataBindingGenBaseClassesTask.CreationAction(scope));<br>&#125;<br><span class="hljs-comment">// CreationAction</span><br><span class="hljs-function">override fun <span class="hljs-title">handleProvider</span><span class="hljs-params">(taskProvider: TaskProvider&lt;out DataBindingGenBaseClassesTask&gt;)</span> </span>&#123;<br>    variantScope.artifacts.producesDir(<br>        <span class="hljs-comment">// DATA_BINDING_BASE_CLASS_SOURCE_OUT</span><br>        InternalArtifactType.DATA_BINDING_BASE_CLASS_SOURCE_OUT,<br>        BuildArtifactsHolder.OperationType.INITIAL,<br>        taskProvider,<br>        DataBindingGenBaseClassesTask::sourceOutFolder<br>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆ DataBinding ç»‘å®šç±»çš„ task ä¸º DataBindingGenBaseClassesTaskï¼Œè€ŒInternalArtifactType.DATA_BINDING_BASE_CLASS_SOURCE_OUT åˆ™å¯¹åº”ç€ build ç›®å½•ç”Ÿæˆçš„ DataBinding ç±»çš„</p><p>data_binding_base_class_source_out ç›®å½•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200402161451.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™é‡Œå¯ä»¥ç®€å•çœ‹ä¸€ä¸‹ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±æŸ¥çœ‹æºç </p><h3 id="DataBinding-å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜çš„"><a href="#DataBinding-å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜çš„" class="headerlink" title="DataBinding å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜çš„"></a>DataBinding å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜çš„</h3><p>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ DataBinding ç”Ÿæˆçš„ç»‘å®šç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FragmentSingleChildBinding</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ViewBinding</span> </span>&#123;<br>  <span class="hljs-comment">// NonNull æ³¨è§£æ ‡è®°</span><br>  <span class="hljs-comment">// å¦‚æœå­˜åœ¨ä¸åŒé…ç½®çš„ä¸åŒå¸ƒå±€æ–‡ä»¶ï¼ˆå¦‚æ¨ªç«–å±ï¼‰ä¸”è¯¥æ§ä»¶ä¸æ˜¯å­˜åœ¨äºæ‰€æœ‰å¸ƒå±€ï¼Œè¯¥å¤„ä½¿ç”¨ Nullableæ³¨è§£æ ‡è®°</span><br>  <span class="hljs-meta">@NonNull</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> MaterialButton button;<br>    <br>  <span class="hljs-comment">// çœç•¥...</span><br>    <br>  <span class="hljs-meta">@NonNull</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FragmentSingleChildBinding <span class="hljs-title">bind</span><span class="hljs-params">(@NonNull View rootView)</span> </span>&#123;<br>    String missingId;<br>    missingId: &#123;<br>      <span class="hljs-comment">//å…¶å†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨ findViewById</span><br>      MaterialButton button = rootView.findViewById(R.id.button);<br>      <span class="hljs-keyword">if</span> (button == <span class="hljs-keyword">null</span>) &#123;<br>        missingId = <span class="hljs-string">"button"</span>;<br>        <span class="hljs-keyword">break</span> missingId;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FragmentSingleChildBinding((MaterialButton) rootView, button);<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException(<span class="hljs-string">"Missing required view with ID: "</span>.concat(missingId));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>Binding ç±»å†…éƒ¨çš„ä¹Ÿæ˜¯ä½¿ç”¨ findViewById ï¼Œå› æ­¤ DataBinding å¯ä»¥ä»£æ›¿ findViewById ï¼Œå¹¶ä¸”å‡å°‘æ¨¡æ¿ä»£ç </p></li><li><p>View æ§ä»¶å˜é‡ç±»å‹æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ä¸ä¼šå‡ºç°ç±»å‹å®‰å…¨é—®é¢˜</p></li><li><p>View æ§ä»¶å˜é‡ç”±ç©º/éç©ºæ³¨è§£ä¿®é¥°ï¼Œï¼ˆå¦‚æœä¸º Nullable java ä¸­ä¼šæœ‰ lint è­¦å‘Šï¼Œè€Œ kotlin ç›´æ¥è°ƒç”¨æ—¶æ— æ³•é€šè¿‡ç¼–è¯‘çš„ï¼‰å› æ­¤ ä¸ä¼šå‡ºç°ç©ºå®‰å…¨é—®é¢˜</p></li><li><p>é€šè¿‡å£°æ˜å¼çš„é…ç½®ï¼ŒUI å®Œå…¨æ¥è‡ªå”¯ä¸€å¯ä¿¡çš„æ•°æ®æºé…ç½®ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§</p></li></ul><blockquote><p>æ³¨æ„ï¼šä»¥ä¸Šåˆ†æåŒæ ·é€‚ç”¨äº ViewBinding</p></blockquote><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> æ„Ÿå—é­”æ³•çš„é­…åŠ›</span></h2><p>è¿™é‡Œç®€å•å±•ç¤ºä¸€ä¸‹ DataBinding çš„ã€Œé­”æ³•ã€</p><h3 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span><br>      <br>   <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span><br>       <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span><br>       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span><br>           <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/firstName"</span><br>           <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span><br>           <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span><br>           /&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span><br>           <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/lastName"</span><br>           <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span><br>           <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span><br>           /&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br><br><span class="hljs-comment">// Before Data Binding</span><br><span class="hljs-comment">//setContentView(R.layout.activity_main);</span><br>        <br><span class="hljs-comment">//TextView firstName = (TextView) findViewById(R.id.firstName);</span><br><span class="hljs-comment">//TextView lastName = (TextView) findViewById(R.id.lastName);</span><br><br><span class="hljs-comment">//firstName.setText("xxx");</span><br><span class="hljs-comment">//lastName.setText("xxx");</span><br><br><br><span class="hljs-comment">// After Data Binding</span><br>        ActivityMainBinding binding = DataBindingUtil.setContentView(<span class="hljs-keyword">this</span>, R.layout.activity_main);<br><br>        binding.firstName.setText(<span class="hljs-string">"xxx"</span>);<br>        binding.lastName.setText(<span class="hljs-string">"xxx"</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å±•ç¤ºäº† DataBinding çš„åŸºç¡€æ“ä½œï¼ˆå•çº¯çš„æ›¿æ¢ findViewByIdï¼‰ï¼Œå¦‚æœä»…ä½¿ç”¨ DataBinding è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ ViewBinding</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409114053.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h3 id="ç»‘å®šæ•°æ®"><a href="#ç»‘å®šæ•°æ®" class="headerlink" title="ç»‘å®šæ•°æ®"></a>ç»‘å®šæ•°æ®</h3><p>åœ¨ä¹‹å‰çš„å¸ƒå±€çš„åŸºç¡€ä¸Šç»‘å®šæ•°æ®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.User"</span>/&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span><br>       <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span><br>       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span> <br>           <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/firstName"</span>      <br>           <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span><br>           <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span><br>           <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@&#123;user.firstName&#125;"</span>/&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span> <br>           <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/lastName"</span>      <br>           <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span><br>           <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span><br>           <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@&#123;user.lastName&#125;"</span>/&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>        ActivityMainBinding binding = DataBindingUtil.setContentView(<span class="hljs-keyword">this</span>, R.layout.activity_main);<br>binding.user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"xxx"</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥ç”¨åœ¨ recyclerview adapter ä¸­ï¼Œadapter ä¸­çš„ä»£ç å¤§å¤§å‡å°‘</p><h3 id="Binding-Adapter"><a href="#Binding-Adapter" class="headerlink" title="Binding Adapter"></a>Binding Adapter</h3><p>æ‚¨å¯èƒ½ä¼šå¥½å¥‡é…ç½® <code>android:text=&quot;@{user.firstName}</code> åå†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆ</p><p>DataBinding ä¸­ä½¿ç”¨ <code>Binding Adapter</code> æ¥å¤„ç†ï¼Œå®ƒä¸»è¦å¤„ç†ã€Œå±æ€§ã€å’Œã€Œäº‹ä»¶ã€ï¼Œå‰è€…å¦‚  <code>setText()</code> ï¼Œåè€…å¦‚ <code>setOnClickListener()</code>ã€‚ä¸Šé¢çš„ <code>android:text</code> å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä¸‹é¢çš„æ–¹æ³•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409145551.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>DataBinding ä¸­æä¾›äº†å¾ˆå¤š <code>Binding Adapter</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200410160031.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å¦‚æœå®˜æ–¹æä¾›çš„ <code>Binding Adapter</code> ä¸æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæ‚¨è¿˜å¯ä»¥è‡ªå®šä¹‰ <code>Binding Adapter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@BindingAdapter</span>(&#123;<span class="hljs-string">"imageUrl"</span>, <span class="hljs-string">"error"</span>&#125;)<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loadImage</span><span class="hljs-params">(ImageView view, String url, Drawable error)</span> </span>&#123;<br>  Glide.with(view).load(url).error(error).into(view);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span> <span class="hljs-attr">app:imageUrl</span>=<span class="hljs-string">"@&#123;venue.imageUrl&#125;"</span> <span class="hljs-attr">app:error</span>=<span class="hljs-string">"@&#123;@drawable/venueError&#125;"</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="DadaBinding-LiveData"><a href="#DadaBinding-LiveData" class="headerlink" title="DadaBinding + LiveData"></a>DadaBinding + LiveData</h3><p>è¦å°† LiveData ä¸ DataBinding ä¸€èµ·ä½¿ç”¨ï¼Œéœ€è¦æŒ‡å®šç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…æ¥å®šä¹‰ LiveData å¯¹è±¡çš„èŒƒå›´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewModelActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>        UserBinding binding = DataBindingUtil.setContentView(<span class="hljs-keyword">this</span>, R.layout.user);<br><br>        binding.setLifecycleOwner(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŒå‘ç»‘å®š"><a href="#åŒå‘ç»‘å®š" class="headerlink" title="åŒå‘ç»‘å®š"></a>åŒå‘ç»‘å®š</h3><p>ä½¿ç”¨å•å‘ DataBindingï¼Œå¯ä»¥åœ¨å±æ€§ä¸Šè®¾ç½®ä¸€ä¸ªå€¼ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªå¯¹è¯¥å±æ€§çš„æ›´æ”¹åšå‡ºååº”çš„ç›‘å¬å™¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">CheckBox</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/rememberMeCheckBox"</span><br>    <span class="hljs-attr">android:checked</span>=<span class="hljs-string">"@&#123;viewmodel.rememberMe&#125;"</span><br>    <span class="hljs-attr">android:onCheckedChanged</span>=<span class="hljs-string">"@&#123;viewmodel.rememberMeChanged&#125;"</span><br>/&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨åŒå‘ç»‘å®šå¯ä»¥ç®€åŒ–è¯¥è¿‡ç¨‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">CheckBox</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/rememberMeCheckBox"</span><br>    <span class="hljs-attr">android:checked</span>=<span class="hljs-string">"@=&#123;viewmodel.rememberMe&#125;"</span><br>/&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>@={}</code> æ¥æ”¶å¯¹è¯¥å±æ€§çš„æ•°æ®æ›´æ”¹ï¼Œå¹¶åŒæ—¶ç›‘å¬ç”¨æˆ·æ›´æ–°ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæœ‰ <code>=</code> ï¼‰</p><p>é‚£ä¹ˆç©¶ç«Ÿä»€ä¹ˆæ˜¯åŒå‘ç»‘å®šå‘¢ï¼Ÿ</p><p>æ‰€è°“çš„ã€Œæ•°æ®é©±åŠ¨ã€å°±æ˜¯æ•°æ®é©±åŠ¨è§†å›¾çš„å˜åŒ–ï¼Œè€Œ DataBinding çš„å•å‘ç»‘å®šå°±æ˜¯å¦‚æ­¤ã€‚åè¿‡æ¥è®²ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦è§†å›¾æ¥é©±åŠ¨æ•°æ®çš„å˜åŒ–ï¼ˆä¾‹å¦‚å½“æˆ‘ä»¬åœ¨ EditText ä¸Šè¾“å…¥äº†æ–‡å­—ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹åº”çš„ ViewModel çš„ LiveData çš„å€¼èƒ½å¤ŸåŠæ—¶å“åº”è¯¥å˜åŒ–ï¼‰</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409161036.jpg" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409110254.gif" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å¦‚å›¾ï¼Œç»¿è‰²éƒ¨åˆ†ä¸ºç‹¬ç«‹çš„ fragment ï¼Œå†…éƒ¨å­˜åœ¨ä¸¤ä¸ª TextViewï¼Œç”¨äºæ˜¾ç¤ºå¤–éƒ¨ fragment EditText è¾“å…¥çš„æ–‡å­—</p><p>å¦‚æœå®ç°ä¸Šè¿°åŠŸèƒ½ï¼Œä¼ ç»Ÿåšæ³•å¯èƒ½æ˜¯ä½¿ç”¨ activity çº§åˆ«çš„ ViewModel è¿›è¡Œä¸¤ä¸ª fragment ä¹‹é—´çš„é€šä¿¡ï¼Œé€šè¿‡ç›‘å¬ EditText æ–‡å­—çš„å˜åŒ–æ”¹å˜ ViewModel ä¸­ LiveData çš„å€¼ï¼Œå¹¶åœ¨ç»¿è‰² fragment ä¸­è§‚å¯Ÿ LiveData å¹¶æ˜¾ç¤ºåˆ° TextView ä¸­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NormalViewModel</span> : <span class="hljs-type">ViewModel</span></span>() &#123;<br>    <span class="hljs-keyword">val</span> firstName = MutableLiveData&lt;String&gt;()<br>    <span class="hljs-keyword">val</span> lastName = MutableLiveData&lt;String&gt;()<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NormalDetailFragment</span> : <span class="hljs-type">Fragment</span></span>(R.layout.fragment_normal_detail) &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mViewModel <span class="hljs-keyword">by</span> activityViewModels&lt;NormalViewModel&gt;()<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        mViewModel.firstName.observe(viewLifecycleOwner) &#123;<br>            tvFirstName.text = it<br>        &#125;<br>        mViewModel.lastName.observe(viewLifecycleOwner) &#123;<br>            tvLastName.text = it<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NormalFragment</span> : <span class="hljs-type">Fragment</span></span>(R.layout.fragment_normal) &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mViewModel <span class="hljs-keyword">by</span> activityViewModels&lt;NormalViewModel&gt;()<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        etFirstName.addTextChangedListener &#123;<br>            mViewModel.firstName.value = it.toString()<br>        &#125;<br>        etLastName.addTextChangedListener &#123;<br>            mViewModel.lastName.value = it.toString()<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾—ç›Šäº kotlin ï¼Œä¸Šé¢çš„ä»£ç ä»¥åŠå¾ˆç®€æ´äº†ï¼Œå¦‚æœä½¿ç”¨ java ä»£ç ç‰‡æ®µåªä¼šæ›´é•¿ã€‚</p><p>ä¸è¿‡ä½¿ç”¨ DataBindingï¼Œè¿˜å¯ä»¥æ›´ç®€æ´</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textview.MaterialTextView</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/tvFirstName"</span><br>    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@&#123;vm.firstName&#125;"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textview.MaterialTextView</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/tvLastName"</span><br>    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@&#123;vm.lastName&#125;"</span>/&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textfield.TextInputEditText</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/etFirstName"</span><br>    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@=&#123;vm.firstName&#125;"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textfield.TextInputEditText</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/etLastName"</span><br>    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@=&#123;vm.lastName&#125;"</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>åªéœ€é…ç½®å¥½åŒå‘ç»‘å®šï¼ˆEditText é©±åŠ¨ ViewModel çš„ LiveData çš„å€¼å˜åŒ–ï¼ŒViewModel å†é©±åŠ¨ TextView æ˜¾ç¤ºæ•°æ®ï¼‰ï¼Œå¹¶åœ¨ fragment é€šè¿‡å›ºå®šçš„æ¨¡æ¿ä»£ç è®¾ç½®å¥½ ViewModel å³å¯</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409112128.jpg" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™é‡Œçš„é­”æ³•è¿˜æ˜¯æ¥è‡ª Binding Adapter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TextViewBindingAdapter.java</span><br><span class="hljs-meta">@BindingAdapter</span>(value = &#123;<span class="hljs-string">"android:beforeTextChanged"</span>, <span class="hljs-string">"android:onTextChanged"</span>,<br>        <span class="hljs-string">"android:afterTextChanged"</span>, <span class="hljs-string">"android:textAttrChanged"</span>&#125;, requireAll = <span class="hljs-keyword">false</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTextWatcher</span><span class="hljs-params">(TextView view, <span class="hljs-keyword">final</span> BeforeTextChanged before,<br>        <span class="hljs-keyword">final</span> OnTextChanged on, <span class="hljs-keyword">final</span> AfterTextChanged after,<br>        <span class="hljs-keyword">final</span> InverseBindingListener textAttrChanged)</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> TextWatcher newValue;<br>    <span class="hljs-keyword">if</span> (before == <span class="hljs-keyword">null</span> &amp;&amp; after == <span class="hljs-keyword">null</span> &amp;&amp; on == <span class="hljs-keyword">null</span> &amp;&amp; textAttrChanged == <span class="hljs-keyword">null</span>) &#123;<br>        newValue = <span class="hljs-keyword">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        newValue = <span class="hljs-keyword">new</span> TextWatcher() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeTextChanged</span><span class="hljs-params">(CharSequence s, <span class="hljs-keyword">int</span> start, <span class="hljs-keyword">int</span> count, <span class="hljs-keyword">int</span> after)</span> </span>&#123;<br>                <span class="hljs-keyword">if</span> (before != <span class="hljs-keyword">null</span>) &#123;<br>                    before.beforeTextChanged(s, start, count, after);<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onTextChanged</span><span class="hljs-params">(CharSequence s, <span class="hljs-keyword">int</span> start, <span class="hljs-keyword">int</span> before, <span class="hljs-keyword">int</span> count)</span> </span>&#123;<br>                <span class="hljs-keyword">if</span> (on != <span class="hljs-keyword">null</span>) &#123;<br>                    on.onTextChanged(s, start, before, count);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (textAttrChanged != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-comment">//é€šçŸ¥å‘ç”Ÿå˜åŒ–</span><br>                    textAttrChanged.onChange();<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterTextChanged</span><span class="hljs-params">(Editable s)</span> </span>&#123;<br>                <span class="hljs-keyword">if</span> (after != <span class="hljs-keyword">null</span>) &#123;<br>                    after.afterTextChanged(s);<br>                &#125;<br>            &#125;<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">final</span> TextWatcher oldValue = ListenerUtil.trackListener(view, newValue, R.id.textWatcher);<br>    <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-keyword">null</span>) &#123;<br>        view.removeTextChangedListener(oldValue);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (newValue != <span class="hljs-keyword">null</span>) &#123;<br>        view.addTextChangedListener(newValue);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ InverseBindingListener ï¼ˆè°ƒç”¨ <code>textAttrChanged.onChange()</code>ï¼‰æ¥é€šçŸ¥ LiveData æ•°æ®å‘ç”Ÿå˜åŒ–</p><p>è€Œå˜åŒ–åçš„å€¼ é€šè¿‡ @InverseBindingAdapter æ³¨è§£æ ‡è®°çš„æ–¹æ³•å¤„ç†ï¼Œè¿™é‡Œçš„ event ä¸ä¸Šé¢çš„æ ‡è®°åŒ¹é…ï¼ˆ<code>android:textAttrChanged</code>ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TextViewBindingAdapter.java</span><br><span class="hljs-meta">@InverseBindingAdapter</span>(attribute = <span class="hljs-string">"android:text"</span>, event = <span class="hljs-string">"android:textAttrChanged"</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getTextString</span><span class="hljs-params">(TextView view)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> view.getText().toString();<br>&#125;<br></code></pre></td></tr></table></figure><p>view å±‚å˜åŒ–é€šçŸ¥æ•°æ®å˜åŒ–ï¼Œæ•°æ®å˜åŒ–å†é€šçŸ¥ view å±‚å˜åŒ–ï¼Œä»¿ä½›æ˜¯ä¸ªå¥—å¨ƒ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409163420.jpg" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å› æ­¤é¿å…è¿™ç§æ­»å¾ªç¯ååˆ†é‡è¦ï¼ŒsetText æ–¹æ³•åˆ¤æ–­äº†æ–°æ—§å€¼æ˜¯å¦ç›¸ç­‰æ¥é¿å…æ­»å¾ªç¯</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409163541.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> æ€»ç»“</span></h2><p>DataBinding ä¸»è¦æä¾›ä¸¤éƒ¨åˆ†åŠŸèƒ½</p><ul><li>æ›¿æ¢ findViewById ï¼Œå¦‚æœåªç”¨è¿™éƒ¨åˆ†åŠŸèƒ½å¯ä»¥ä½¿ç”¨ ViewBinding</li><li>è¿›è¡Œ data å’Œ UI çš„ç»‘å®šï¼Œä½¿ç”¨ã€Œæ•°æ®é©±åŠ¨ã€çš„æ€æƒ³è§£å†³äº†è§†å›¾çš„ä¸€è‡´æ€§é—®é¢˜</li></ul><h3 id="å„ç§-findViewById-æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”"><a href="#å„ç§-findViewById-æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="å„ç§ findViewById æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”"></a>å„ç§ findViewById æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”</h3><ul><li>findViewById </li><li>Butterknife</li><li>Kotlin Synthetics</li><li>Data Binding</li><li>View Binding</li></ul><h4 id="findViewById"><a href="#findViewById" class="headerlink" title="findViewById"></a>findViewById</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409170514.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>findViewById æœ‰ä¸¤ä¸ªé—®é¢˜</p><ol><li>å½“ä¸èƒ½åœ¨ Activity/Fragment/ViewGroup ä¸­å®šä½åˆ°æŒ‡å®š id çš„ Viewï¼Œä¼šåœ¨è¿è¡ŒæœŸé—´å´©æºƒï¼Œå³éç©ºå®‰å…¨</li><li>å¦‚æœæŸä¸ª view ä¸º TextView ç±»å‹ï¼Œè€Œåœ¨ä½¿ç”¨ä¸­å°†å…¶æŒ‡å®šä¸ºå…¶ä»–ç±»å‹ä¸ä¼šåœ¨ç¼–è¯‘å™¨æŠ¥é”™ï¼Œå³éç±»å‹å®‰å…¨</li></ol><p>åœ¨ compileSdk çš„ API çº§åˆ« 26 ä¸­ï¼Œå¯¹è¯¥æ–¹æ³•çš„å®šä¹‰ç¨ä½œæ›´æ”¹ä»¥æ¶ˆé™¤å¼ºåˆ¶ç±»å‹è½¬æ¢é—®é¢˜</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409171139.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç°åœ¨ï¼Œå¼€å‘äººå‘˜æ— éœ€åœ¨ä»£ç ä¸­æ‰‹åŠ¨è½¬æ¢ view ç±»å‹ã€‚ å¦‚æœæ‚¨å¼•ç”¨ id æŒ‡å‘ç±»å‹ TextView çš„ View å¹¶å°†å…¶æŒ‡å®šä¸º Buttonï¼Œåˆ™ Android SDK ä¼šå°è¯•æŸ¥æ‰¾å…·æœ‰æä¾›çš„ id çš„ Buttonï¼Œå¹¶ä¸”å®ƒå°†è¿”å› Nullï¼Œå› ä¸ºå®ƒå°†æ— æ³•æ‰¾åˆ°å®ƒ</p><p>ä½†æ˜¯åœ¨ Kotlin ä¸­ï¼Œæ‚¨ä»ç„¶éœ€è¦æä¾›è¯¸å¦‚ findViewById<textview>(R.id.txtUsername) ä¹‹ç±»çš„ç±»å‹ã€‚ å¦‚æœæ‚¨ä¸æ£€æŸ¥è§†å›¾æ˜¯å¦å…·æœ‰ null å®‰å…¨ï¼Œåˆ™å¯èƒ½å‡ºç° NullPointerExceptionï¼Œä½†æ˜¯æ­¤æ–¹æ³•ä¸ä¼šåƒä»¥å‰é‚£æ ·æŠ›å‡ºClassCastException</textview></p><h4 id="Butterknife"><a href="#Butterknife" class="headerlink" title="Butterknife"></a>Butterknife</h4><p><a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="noopener">Butterknife</a> æ˜¯ <a href="https://medium.com/u/8ddd94878165?source=post_page-----98b8ef5b9249----------------------" target="_blank" rel="noopener">Jake Wharton</a> å¤§ç¥å†™çš„æ›¿ä»£ findViewById çš„åº“ï¼Œè¯¥åº“ä½¿ç”¨æ³¨è§£å¤„ç†å¹¶ç”Ÿæˆ findViewById ä»£ç </p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409171316.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å®ƒå…·æœ‰ä¸ findViewById å‡ ä¹ç›¸ä¼¼çš„é—®é¢˜ã€‚ ä½†æ˜¯ï¼Œå®ƒåœ¨è¿è¡Œæ—¶æ·»åŠ äº†null å®‰å…¨æ£€æŸ¥ä»¥é¿å… NullPointerException</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409171554.jpg" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç”±äº DataBinding å’Œ ViewBinding çš„å‡ºç°ï¼Œæ²ƒç¥å·²ç»å®£å¸ƒå¼ƒç”¨è¯¥åº“</p><h4 id="Kotlin-Synthetics"><a href="#Kotlin-Synthetics" class="headerlink" title="Kotlin Synthetics"></a>Kotlin Synthetics</h4><p>Kotlin å¼•å…¥çš„æœ€å¤§åŠŸèƒ½ä¹‹ä¸€æ˜¯ Kotlin æ‰©å±•æ–¹æ³•ã€‚ åœ¨å®ƒçš„å¸®åŠ©ä¸‹ï¼ŒKotlin Synthetics è¯ç”Ÿäº†ã€‚ Kotlin Synthetics é€šè¿‡è‡ªåŠ¨ç”Ÿæˆçš„ Kotlin æ‰©å±•æ–¹æ³•ï¼Œä½¿å¼€å‘äººå‘˜å¯ä»¥ä» xml å¸ƒå±€ç›´æ¥è®¿é—®å…¶å†…éƒ¨çš„ view</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409171843.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>Kotlin Synthetics ç¬¬ä¸€æ¬¡è°ƒç”¨ findViewById æ–¹æ³•ï¼Œç„¶åé»˜è®¤æƒ…å†µä¸‹å°† view å®ä¾‹ç¼“å­˜åœ¨ HashMap ä¸­ã€‚ å¯ä»¥é€šè¿‡Gradle è®¾ç½®å°†æ­¤ç¼“å­˜é…ç½®æ›´æ”¹ä¸º SparseArray æˆ–ä¸ç¼“å­˜</p><p>æ€»ä½“è€Œè¨€ï¼ŒKotlin Synthetics æ˜¯ä¸€ç§å¾ˆå¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒç±»å‹å®‰å…¨ï¼Œå¹¶ä¸”é€šè¿‡ Kotlin çš„ ï¼Ÿè¿›è¡Œç©ºæ£€æŸ¥ã€‚ å®ƒä¸éœ€è¦å¼€å‘äººå‘˜çš„é¢å¤–ä»£ç ã€‚ ä½†è¿™ä»…é€‚ç”¨äº Kotlin é¡¹ç›®</p><p>ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨ Kotlin Synthetics æ—¶é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœå°†å†…å®¹è§†å›¾è®¾ç½®ä¸ºå¸ƒå±€ï¼Œç„¶åä½¿ç”¨ä»…å­˜åœ¨äºå…¶ä»–å¸ƒå±€ä¸­çš„ id ï¼Œåˆ™ IDE å¯è®©æ‚¨è‡ªåŠ¨å®Œæˆå¹¶æ·»åŠ æ–°çš„ import è¯­å¥ã€‚ é™¤éæ‚¨ä¸“é—¨æ£€æŸ¥ä»¥ç¡®ä¿å…¶ import è¯­å¥ä»…å¯¼å…¥æ­£ç¡®çš„ viewï¼Œå¦åˆ™æ²¡æœ‰å®‰å…¨çš„æ–¹æ³•æ¥éªŒè¯è¿™ä¸ä¼šå¯¼è‡´è¿è¡Œæ—¶é—®é¢˜</p><h4 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a>DataBinding</h4><p>DataBinding åœ¨åŠŸèƒ½ä¸Šæ¯”å…¶ä»–æ–¹æ³•ä¼˜è¶Šå¾—å¤šï¼Œå› ä¸ºå®ƒä¸ä»…ä¸ºæ‚¨æä¾›ç±»å‹å®‰å…¨å’Œç©ºå®‰å…¨çš„ view å¼•ç”¨ï¼Œè€Œä¸”è¿˜å…è®¸æ‚¨ç›´æ¥åœ¨ xml å¸ƒå±€å†…ä½¿ç”¨æ•°æ®é©±åŠ¨è§†å›¾å˜åŒ–</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200409172613.png" src="/2020/04/09/Jetpack-DataBinding/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h4 id="ViewBinding"><a href="#ViewBinding" class="headerlink" title="ViewBinding"></a>ViewBinding</h4><p>æœ€è¿‘åœ¨ Android Studio 3.6 ä¸­å¼•å…¥çš„ ViewBinding æ˜¯ DataBinding åº“çš„å­é›†ã€‚ ç”±äºä¸éœ€è¦æ³¨è§£å¤„ç†ï¼Œå› æ­¤å¯ä»¥ç¼©çŸ­æ„å»ºæ—¶é—´ã€‚è¯¦ç»†çš„ä½¿ç”¨å¯ä»¥å‚è§ <a href="https://juejin.im/post/5e4806f3e51d4526c550a2ef" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p><table><thead><tr><th align="center"></th><th align="center">findViewById</th><th align="center">Butterknife</th><th align="center">Kotlin Synthetics</th><th align="center">DataBinding</th><th align="center">ViewBinding</th></tr></thead><tbody><tr><td align="center">ä¸€ç›´ç©ºå®‰å…¨</td><td align="center">âŒ</td><td align="center">éƒ¨åˆ†</td><td align="center">éƒ¨åˆ†</td><td align="center">âœ”ï¸</td><td align="center">âœ”ï¸</td></tr><tr><td align="center">ç±»å‹å®‰å…¨</td><td align="center">âŒ</td><td align="center">âŒ</td><td align="center">âœ”ï¸</td><td align="center">âœ”ï¸</td><td align="center">âœ”ï¸</td></tr><tr><td align="center">æ ·æ¿ä»£ç </td><td align="center"><font color="#CA0C16">å¤š</font></td><td align="center"><font color="#0DD613">å°‘</font></td><td align="center"><font color="#0DD613">å°‘</font></td><td align="center"><font color="#B77441">ä¸­ç­‰</font></td><td align="center"><font color="#0DD613">å°‘</font></td></tr><tr><td align="center">æ„å»ºæ—¶é—´</td><td align="center">âœ”ï¸</td><td align="center">âŒ</td><td align="center">âœ”ï¸</td><td align="center">âŒ</td><td align="center">âœ”ï¸</td></tr><tr><td align="center">æ”¯æŒè¯­éŸ³</td><td align="center">java/kotlin</td><td align="center">java/kotlin</td><td align="center">kotlin</td><td align="center">java/kotlin</td><td align="center">java/kotlin</td></tr></tbody></table><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> å…³äºæˆ‘</span></h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></li><li><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></li><li><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Jetpackæ›´æ–°ä¹‹Fragmentã€‘ç»ˆäºåŠ¨æ‰‹äº†ï¼ŒonActivityCreated è¢«å¼ƒç”¨</title>
      <link href="/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/"/>
      <url>/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬ç³»åˆ—æ–‡ç« ä»‹ç» Jetpack ç»„ä»¶åº“çš„æ›´æ–°<br><br>ä¸€ç›´ä»¥æ¥ï¼Œ fragment çš„ api éƒ½éå¸¸éš¾ç”¨ï¼Œå®˜æ–¹ä¹Ÿæ‰¿è®¤è¿™ä¸€ç‚¹ã€‚ä¸€ä¸ªæœˆå‰ï¼Œfragment ä¸­çš„ <code>onActivityCreated()</code> è¢«å¼ƒç”¨äº†</p></blockquote><a id="more"></a><h2 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h2><p><code>fragment 1.3.0-alpha02</code> ä¸­ <code>onActivityCreated()</code> æ–¹æ³•è¢«å¼ƒç”¨äº†</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200421095145.png" src="/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æäº¤ log </p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200421092105.png" src="/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç®€å•ç¿»è¯‘ä¸€ä¸‹</p><p><code>onActivityCreated()</code> æœ€åˆçš„ç›®çš„æ˜¯è®© fragment çš„é€»è¾‘ä¸å…¶å®¿ä¸» activity åˆ›å»ºå»ºç«‹å…³è”ï¼Œæˆ‘ä»¬ä¸é¼“åŠ±è¿™ç§è€¦åˆ</p><p>æˆ‘ä»¬åº”è¯¥ä¼ é€’å¤–éƒ¨ä¾èµ–æ¥ä½œä¸º <code>FragmentFactory</code> å‚æ•°ã€‚view ç›¸å…³çš„ä»£ç åº”è¯¥æ”¾ç½®åœ¨ <code>onViewCreated()</code> å®Œæˆï¼Œå…¶ä»–çš„åˆå§‹åŒ–ä»£ç åº”è¯¥åœ¨ <code>onCreate()</code> ä¸­å®Œæˆã€‚ä¸ºäº†åœ¨ <code>activity onCreate()</code> å®Œæˆåæ¥æ”¶å›è°ƒï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ª activity ç”Ÿå‘½å‘¨æœŸçš„ <code>LifecycleObserver</code> ï¼Œå¹¶ä¸”æ¥æ”¶åˆ° <code>Lifecycle.State#CREATED</code> å›è°ƒæ—¶å°†å…¶ç§»é™¤</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttach</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> &#123;<br>    <span class="hljs-keyword">super</span>.onAttach(context)<br>    requireActivity().lifecycle.addObserver(<span class="hljs-keyword">object</span> : DefaultLifecycleObserver &#123;<br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(owner: <span class="hljs-type">LifecycleOwner</span>)</span></span> &#123;<br>            <span class="hljs-comment">// æƒ³åšå•¥åšç‚¹å•¥</span><br>            owner.lifecycle.removeObserver(<span class="hljs-keyword">this</span>)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="DialogFragment"><a href="#DialogFragment" class="headerlink" title="DialogFragment"></a>DialogFragment</h2><p>é‚£ä¹ˆ <code>DialogFragment</code> æ€ä¹ˆåŠï¼Ÿå…¶ <code>onActivityCreated</code> å˜ä¸ºå¯é€‰çš„</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200421101629.png" src="/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç®€å•ç¿»è¯‘ä¸€ä¸‹</p><p><code>DialogFragment</code> ä½¿ç”¨ <code>onActivityCreated</code>() å¸®åŠ©åˆ›å»º dialogã€‚onActivityCreated() å¼ƒç”¨åæˆ‘ä»¬åº”å½“å¯»æ‰¾ä¸€ä¸ªæ›´å¥½çš„æ–¹å¼æ¥æ‰§è¡Œè¿™éƒ¨åˆ†é€»è¾‘</p><p>å…³äº view ç›¸å…³çš„ä»£ç å·²ç»è½¬ç§»è‡³ <code>DialogFragment</code></p><p> çš„ <code>viewLifecycleOwnerLiveData</code> ï¼Œå…¶ä»–åˆå§‹åŒ–é€»è¾‘å¯ä»¥æ”¾åœ¨ <code>onGetLayoutInflater</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200421103420.png" src="/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘ä»¬ä»æ”¯æŒä¸ºè‡ªå®šä¹‰ dialog åœ¨ <code>onActivityCreated()</code> ä¸­é…ç½® dialog</p><h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>æŸ¥çœ‹ <code>Jetpack fragment</code> çš„å˜åŠ¨ï¼Œä¸éš¾çœ‹å‡ºå®˜æ–¹æ­£è‡´åŠ›äºä¸º fragment ã€Œå‡è´Ÿã€ï¼Œå°†å°çš„ï¼Œç‹¬ç«‹çš„åŠŸèƒ½ä» fragment ä¸­æŠ½ç¦»å‡ºå»ï¼Œé™ä½è€¦åˆï¼Œåç»­æ–‡ç« æˆ‘ä»¬ä»‹ç»å…¶ä»–çš„æ”¹åŠ¨</p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><center><p> æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·</p></center><div align="center"><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200429102625.jpg" src="/2020/04/09/Jetpack-fragment-onActivityCreated-Deprecated/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="></div>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
            <tag> Fragment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Jetpackæ›´æ–°ä¹‹Recyclerviewã€‘æ›´ä¼˜é›…åœ°æ¢å¤ recyclerview çš„æ»šåŠ¨ä½ç½®</title>
      <link href="/2020/04/09/Jetpack-Recyclerview-Scoroll/"/>
      <url>/2020/04/09/Jetpack-Recyclerview-Scoroll/</url>
      
        <content type="html"><![CDATA[<h2 id="è¢«æˆ‘å¿½è§†çš„æ›´æ–°"><a href="#è¢«æˆ‘å¿½è§†çš„æ›´æ–°" class="headerlink" title="è¢«æˆ‘å¿½è§†çš„æ›´æ–°"></a>è¢«æˆ‘å¿½è§†çš„æ›´æ–°</h2><p><code>androidx recyclerview 1.2.0-alpha02</code> ç‰ˆæœ¬æ·»åŠ äº†æ–°åŠŸèƒ½ <a href="https://developer.android.com/reference/androidx/recyclerview/widget/MergeAdapter" target="_blank" rel="noopener">MergeAdapter</a>ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å®¹æ˜“åœ°ä¸º RecyclerView æ·»åŠ  Header å’Œ Footerã€‚è¯¦æƒ…å‚è§ <a href="https://juejin.im/post/5e86ffea51882573ba207a19" target="_blank" rel="noopener">ã€è¯‘ã€‘MergeAdapter çš„ä½¿ç”¨ ä½¿ç”¨å®˜æ–¹ API ä¸º Recyclerview æ·»åŠ  Header å’Œ Footer</a></p><p>è¯¥ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ä¸ªæ”¹åŠ¨ï¼š<strong><code>RecyclerView.Adapter</code> lazy state restoration</strong>ï¼Œå¸®åŠ©å¼€å‘è€…æ¢å¤ RecyclerView çš„çŠ¶æ€</p><a id="more"></a><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512105548.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="recyclerview update"></p><p>æˆ‘å¯¹è¿™ä¸ªåŠŸèƒ½å¹¶æ²¡æœ‰ä»€ä¹ˆæ„Ÿè§‰ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒAndroid ä¸­çš„ View å†…éƒ¨æ˜¯æœ‰ç€çŠ¶æ€ä¿å­˜å’Œæ¢å¤çš„æ–¹æ³•çš„ã€‚RecyclerView ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå®ƒå¯ä»¥æ¢å¤è‡ªèº«å·²æ»šåŠ¨çš„ä½ç½®</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512110411.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="View å†…éƒ¨æ¢å¤çŠ¶æ€"></p><p>æœ‰å…³çŠ¶æ€ä¿å­˜çš„å†…å®¹å¯ä»¥å‚è§ <a href="https://juejin.im/post/5e738d12518825495d69cfb9" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘ç»ä¸ä¸¢å¤±çš„çŠ¶æ€ androidx SaveState ViewModel-SaveState åˆ†æ</a></p><p>çœŸå®æƒ…å†µä¹Ÿæ˜¯å¦‚æ­¤</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512111315.gif" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="RecyclerView å†…éƒ¨å¯ä»¥æ¢å¤æ»šåŠ¨ä½ç½®"></p><h2 id="æ„å¤–å‘ç°"><a href="#æ„å¤–å‘ç°" class="headerlink" title="æ„å¤–å‘ç°"></a>æ„å¤–å‘ç°</h2><p>æœ€è¿‘çœ‹åˆ° <a href="https://medium.com/@florina.muntenescu?source=post_page-----a8fbdc9a9334----------------------" target="_blank" rel="noopener">Florina Muntenescu</a> çš„ <a href="https://medium.com/androiddevelopers/restore-recyclerview-scroll-position-a8fbdc9a9334" target="_blank" rel="noopener">Restore RecyclerView scroll position</a> ï¼Œå…¶ä¸­ä»‹ç»äº† <strong><code>RecyclerView.Adapter</code> lazy state restoration</strong>ï¼Œè¿™å‹¾èµ·äº†æˆ‘çš„å…´è¶£</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512111720.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ„å¤–å‘ç°"></p><p>å¦‚æ–‡ä¸­æè¿°ï¼ŒRecyclerView åœ¨ activity/fragment é‡å»ºæ—¶å¤±å»æ»šåŠ¨ä½ç½®æ˜¯å› ä¸º Adapter ä¸­çš„æ•°æ®æ˜¯ <strong>å¼‚æ­¥</strong> åŠ è½½çš„ï¼Œå½“ RecyclerView layout æ—¶æ•°æ®å¹¶æ²¡æœ‰åŠ è½½ï¼Œå› æ­¤ä¹Ÿæ¢å¤ä¸äº†ä¹‹å‰çš„ä½ç½®çŠ¶æ€ã€‚ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä¾‹å­æ˜¯ä½¿ç”¨ Navigation ç»„ä»¶è¿›è¡Œå¯¼èˆªï¼Œè¿”å›æ—¶ fragment ä¸­çš„ RecyclerView ç”±äºå†æ¬¡è°ƒç”¨æ¥å£è·å–æ•°æ®ï¼Œå¯¼è‡´å…¶æ»‘åŠ¨ä½ç½®å¤±å»</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512113141.gif" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œæ— æ³•æ¢å¤æ»šåŠ¨ä½ç½®"></p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ä¿è¯ RecyclerView æ¢å¤åˆ°æ­£ç¡®çš„æ»šåŠ¨ä½ç½®ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å€ŸåŠ©ç¼“å­˜ï¼ŒViewModel æˆ– Repository ä¸­ç¼“å­˜è¦æ˜¾ç¤ºçš„æ•°æ®ï¼Œç¡®ä¿å§‹ç»ˆåœ¨ç¬¬ä¸€ä¸ªå¸ƒå±€ä¼ å…¥å‰åœ¨ Adapter ä¸Šè®¾ç½®æ•°æ®ã€‚ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„æ–¹æ¡ˆï¼Œè¿™äº›æ–¹æ¡ˆè¦ä¹ˆå¤ªå¤æ‚ï¼Œè¦ä¹ˆä¸å¤Ÿä¼˜é›…</p><p><code>recyclerview:1.2.0-alpha02</code> ä¸­çš„è§£å†³æ–¹æ¡ˆæ˜¯æä¾›ä¸€ä¸ªæ–°çš„ Adapter æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…è®¸è®¾ç½®çŠ¶æ€æ¢å¤ç­–ç•¥ï¼Œå®ƒæœ‰ä¸‰ä¸ªé€‰é¡¹</p><ul><li><a href="https://developer.android.com/reference/androidx/recyclerview/widget/RecyclerView.Adapter.StateRestorationPolicy#ALLOW" target="_blank" rel="noopener">ALLOW</a></li><li><a href="https://developer.android.com/reference/androidx/recyclerview/widget/RecyclerView.Adapter.StateRestorationPolicy#PREVENT_WHEN_EMPTY" target="_blank" rel="noopener">PREVENT_WHEN_EMPTY</a></li><li><a href="https://developer.android.com/reference/androidx/recyclerview/widget/RecyclerView.Adapter.StateRestorationPolicy#PREVENT" target="_blank" rel="noopener">PREVENT</a></li></ul><h3 id="ALLOW"><a href="#ALLOW" class="headerlink" title="ALLOW"></a>ALLOW</h3><p>è¿™æ˜¯ <strong>é»˜è®¤</strong> çš„çŠ¶æ€ï¼Œå®ƒä¼šç«‹å³æ¢å¤ RecyclerView çš„çŠ¶æ€ï¼Œè¯¥ç§ç­–ç•¥æ— æ³•è§£å†³å»¶è¿ŸåŠ è½½çš„æ•°æ®çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ <code>PREVENT_WHEN_EMPTY</code></p><h3 id="PREVENT-WHEN-EMPTY"><a href="#PREVENT-WHEN-EMPTY" class="headerlink" title="PREVENT_WHEN_EMPTY"></a>PREVENT_WHEN_EMPTY</h3><p>ä»…å½“ Adapter ä¸ä¸ºç©ºï¼ˆadapter.getItemCount() &gt; 0ï¼‰æ—¶ï¼Œæ‰æ¢å¤ RecyclerView çŠ¶æ€ã€‚ å¦‚æœæ‚¨çš„æ•°æ®æ˜¯å¼‚æ­¥åŠ è½½çš„ï¼Œé‚£ä¹ˆ RecyclerView ä¼šä¸€ç›´ç­‰åˆ°æ•°æ®åŠ è½½å®Œæ¯•ï¼Œç„¶åçŠ¶æ€æ‰èƒ½æ¢å¤ã€‚ å¦‚æœæ‚¨æœ‰é»˜è®¤ itemï¼ˆä¾‹å¦‚ Header æˆ– åŠ è½½æŒ‡ç¤ºå™¨ï¼‰ä½œä¸ºé€‚é…å™¨çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™åº”è¯¥ä½¿ç”¨<code>PREVENT</code> é€‰é¡¹ï¼Œé™¤éä½¿ç”¨ MergeAdapter æ·»åŠ äº†é»˜è®¤ itemã€‚ MergeAdapter ç­‰å¾…æ‰€æœ‰é€‚é…å™¨å‡†å¤‡å°±ç»ªï¼Œç„¶åæ‰æ¢å¤çŠ¶æ€</p><h3 id="PREVENT"><a href="#PREVENT" class="headerlink" title="PREVENT"></a>PREVENT</h3><p>çŠ¶æ€ä¸ä¼šæ¢å¤ï¼Œç›´åˆ°é…ç½®äº† <code>ALLOW</code> æˆ–è€… <code>PREVENT_WHEN_EMPTY</code></p><p>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">adapter.stateRestorationPolicy = PREVENT_WHEN_EMPTY<br></code></pre></td></tr></table></figure><p><strong>åŠ å…¥äº†ä¸Šé¢çš„é…ç½®åå³ä½¿æ˜¯å¼‚æ­¥åŠ è½½æ•°æ®ä¹Ÿèƒ½æ¢å¤ RecyclerView çš„ä½ç½®</strong></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512114332.gif" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è®¾ç½® PREVENT_WHEN_EMPTY"></p><h2 id="è¿½è¸ªå¼•å…¥è¿‡ç¨‹"><a href="#è¿½è¸ªå¼•å…¥è¿‡ç¨‹" class="headerlink" title="è¿½è¸ªå¼•å…¥è¿‡ç¨‹"></a>è¿½è¸ªå¼•å…¥è¿‡ç¨‹</h2><p>è€è§„çŸ©ï¼Œæˆ‘ä»¬æ²¿ç€å®˜æ–¹çš„ commit log æ¥çœ‹çœ‹å…¶å®ç°åŸç†</p><p>é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹ <a href="https://issuetracker.google.com/issues/146365793" target="_blank" rel="noopener">IssueTracker ä¸Šæçš„ Feature</a></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512115048.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="IssueTracker"></p><p>è¡¨è¾¾çš„æ„æ€ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å½“åŠ è½½å¼‚æ­¥æ•°æ®æ—¶ RecyclerView çš„ä½ç½®çŠ¶æ€æ— æ³•æ¢å¤ï¼ŒAdapter åº”è¯¥æä¾›ç›¸å…³çš„è§£å†³æ–¹æ¡ˆ</p><p>æœ‰æ„æ€çš„æ˜¯ï¼Œå®ç°è¯¥åŠŸèƒ½æ—¶è¿˜é‡æ–°å®ç°äº†å‰ä¸€ä¸ªç‰ˆæœ¬çš„é€»è¾‘ï¼Œæˆ‘åœ¨ git commit log ä¸­çœ‹åˆ°äº† revert æ“ä½œ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512140140.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="revertæ“ä½œ"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512120004.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä¸ºäº†é˜²æ­¢ <code>LayoutManager#onRestore</code> æ‰§è¡Œå¤šæ¬¡ï¼Œæ²¡æœ‰é‡‡ç”¨æœ€å¼€å§‹çš„å®ç°æ–¹å¼ã€‚ä½† Yigit Boyar (è¿™ä¸ªæäº¤çš„å¼€å‘è€…) ä»ç„¶å¸Œæœ›ä½¿ç”¨æœ€å¼€å§‹çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯  <code>LayoutManager#onRestoreInstance</code> çš„çŠ¶æ€æ—¶ public ï¼Œå› æ­¤åªèƒ½é€‰å–ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512141210.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ–°çš„å®ç°æ–¹æ¡ˆ"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512141445.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ— å¥ˆä¹‹ä¸¾"></p><p>è¿‡å»ï¼Œå¼€å‘è€…ä¼šæ— æ„é—´è°ƒç”¨ <code>onRestoreInstanceState(State)</code> æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œä¸€äº›å¼€å‘è€…å·²ä½¿ç”¨å®ƒæ¥æ‰‹åŠ¨è®¾ç½®è‡ªå·±æ›´æ–°çš„çŠ¶æ€ï¼Œè¿™æ ·å³ä½¿åœ¨æ­¤çŠ¶æ€ä¹‹å‰å·²æ¢å¤ï¼Œåœ¨æ­¤å¤„ä¼ é€’çŠ¶æ€ä¹Ÿå°†å¯¼è‡´ LayoutManager æ¥æ”¶å®ƒå¹¶ç›¸åº”åœ°æ›´æ–°å…¶å†…éƒ¨çŠ¶æ€ã€‚å› æ­¤ï¼Œå³ä½¿çœ‹èµ·æ¥å¥½åƒå¾ˆå¥‡æ€ªï¼Œä¹Ÿå¿…é¡»å§‹ç»ˆè°ƒç”¨ <code>requestLayout</code> æ¥ä¿ç•™åŠŸèƒ½</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æè¿™éƒ¨åˆ†æºç ï¼Œå†…å®¹å¾ˆå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è¯¦ç»†çœ‹ä¸‹</p><p>é¦–å…ˆæ˜¯å¼•å…¥ <code>StateRestorationPolicy</code>çš„æšä¸¾</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512143600.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç„¶åéœ€è¦æä¾› <code>setStateRestorationPolicy</code> å’Œ <code>getStateRestorationPolicy</code> æ–¹æ³•ï¼Œæ­¤æ—¶æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦è¦å°† SavedState ä¼ é€’ç»™ LayoutManager</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512143459.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å‰é¢çš„ <code>setStateRestorationPolicy</code> æ–¹æ³•ä¸­ è°ƒç”¨äº† <code>notifyStateRestorationPolicyChanged</code>ï¼Œè€Œ <code>notifyStateRestorationPolicyChanged</code> ä¸ºé™æ€ç±» <code>AdapterDataObservable</code> ä¸­çš„æ–¹æ³•ï¼Œè¯¥ç±»ä¸­çš„å…¶ä»–æ–¹æ³•æˆ‘ä»¬ä¹Ÿå¾ˆç†Ÿæ‚‰ï¼Œå‡æ˜¯åˆ·æ–° Adapter ä¸­æ•°æ®çš„æ–¹æ³•ã€‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512143858.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="notifyStateRestorationPolicyChanged"></p><p>è€Œ <code>notifyStateRestorationPolicyChanged</code> ä¸­è°ƒç”¨äº† mObservers list ä¸­å…ƒç´ çš„ <code>onStateRestorationPolicyChanged</code> æ–¹æ³•ï¼Œé€šè¿‡æºç æˆ‘ä»¬å¾—çŸ¥è¯¥ list ä¸­çš„å…ƒç´ ç±»å‹ä¸º <code>AdapterDataObserver</code>ï¼Œå› æ­¤è¿˜éœ€è¦åœ¨ <code>AdapterDataObserver</code> ä¸­åŠ å…¥ <code>onStateRestorationPolicyChanged</code> æ–¹æ³•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512144501.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="onStateRestorationPolicyChanged "></p><p>è¯¥æ–¹æ³•æ˜¯ä¸ªç©ºå®ç°ï¼Œè€Œ <code>RecyclerViewDataObserver</code> é‡å†™äº†è¯¥æ–¹æ³•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512144716.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="RecyclerViewDataObserver "></p><p>é…ç½®æ¢å¤ç­–ç•¥ä»¥åŠæ¢å¤ç­–ç•¥å˜åŒ–æ—¶çš„ç›‘å¬éƒ½æœ‰äº†ï¼Œæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å¦‚æœä¹‹å‰æœ‰å¾…æ¢å¤çš„è£…åˆ™æ¢å¤ä¹‹å‰çš„çŠ¶æ€</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200512145152.png" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ¢å¤çŠ¶æ€"></p><blockquote><p>æ³¨æ„ï¼šå‘å¸ƒä¹‹å‰ <code>StateRestorationPolicy</code> å«åš <code>StateRestorationStrategy</code>ï¼Œåæ¥å‘½åä¸º <code>StateRestorationPolicy</code>ï¼Œalpha ç‰ˆæœ¬çš„åº“å¯èƒ½éšæ—¶æ›´æ”¹ API çš„å‘½åå’Œåˆ é™¤ APIï¼Œå› æ­¤æŸ¥çœ‹è¿™éƒ¨åˆ†æºç çš„åŒå­¦è¯·æ³¨æ„</p></blockquote><p>è‡³æ­¤ï¼Œç›¸å…³çš„æºç éƒ½åœ¨è¿™é‡Œäº†</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>StateRestorationPolicy</code> æä¾›äº† RecyclerView å¼‚æ­¥åŠ è½½æ•°æ®æ¢å¤æ»šåŠ¨ä½ç½®çš„è§£å†³æ–¹æ¡ˆã€‚åŸç†å°±æ˜¯é€šè¿‡é…ç½® <code>StateRestorationPolicy</code> æ¥æ”¹å˜æ¢å¤ç­–ç•¥ï¼ŒåŒæ—¶åœ¨ç­–ç•¥æ”¹å˜æ—¶è°ƒç”¨ <code>requestLayout</code> æ–¹æ³•ã€‚åœ¨ <code>dispatchLayoutStep2()</code> (è¯¥æ–¹æ³•ä¼šåœ¨ onLayout å’Œ measure æ–¹æ³•ä¸­è°ƒç”¨) æ–¹æ³•ä¸­æ¢å¤çŠ¶æ€(å¦‚æœ <code>canRestoreState()</code> è¿”å› true)</p><p><a href="https://github.com/Flywith24/Flywith24-Jetpack-Demo/tree/master/demo_recyclerview_scroll" target="_blank" rel="noopener">demo åœ°å€</a></p><p><strong>ä¸€ç‚¹æ€è€ƒï¼šæˆ‘ä»¬éƒ½çŸ¥é“ ViewPager2 æ˜¯ä½¿ç”¨ RecyclerView å®ç°çš„ï¼Œé‚£ä¹ˆå€ŸåŠ©æœ¬æ–‡ä»‹ç»çš„ API å¯ä»¥åšç‚¹ä»€ä¹ˆå—ï¼Ÿ</strong></p><p>æ¬¢è¿å„ä½å°ä¼™ä¼´åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œè¯´è¯´ä½ çš„æƒ³æ³•</p><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200508153754.jpg" src="/2020/04/09/Jetpack-Recyclerview-Scoroll/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
            <tag> RecyclerView </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹LiveDataã€‘ViewModelçš„å·¦è†€å³è‡‚ æ•°æ®é©±åŠ¨çœŸçš„é¦™</title>
      <link href="/2020/03/31/Jetpack-LiveData/"/>
      <url>/2020/03/31/Jetpack-LiveData/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>ä¹‹å‰æˆ‘ä»¬è®¨è®ºè¿‡ <a href="https://juejin.im/post/5e786d415188255e00661a4e" target="_blank" rel="noopener">ViewModel çš„èŒèƒ½è¾¹ç•Œ</a> ï¼Œå¾—ç›Šäº ViewModel çš„ç”Ÿå‘½å‘¨æœŸæ›´é•¿ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ activity é‡å»ºåå°†æ•°æ®ä¼ é€’ç»™ activity ï¼Œä¹Ÿå¯ä»¥é¿å…å†…å­˜æ³„æ¼ã€‚ä½†æ˜¯å¦‚æœä¸æ˜¯æ¯æ¬¡éœ€è¦å°±è·å–æ•°æ®ï¼Œè€Œæ˜¯å½“æ¯æ¬¡æœ‰æ–°æ•°æ®æ—¶é€šçŸ¥æˆ‘ä»¬ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p></blockquote><p>æœ¬æ–‡ä»‹ç» <code>LiveData</code> ï¼Œä¸€ä¸ª <strong>ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„ï¼Œå¯è§‚å¯Ÿçš„ï¼Œæ•°æ®æŒæœ‰è€…</strong>ã€‚åŒæ—¶è¿˜ä¼šç®€å•åˆ†æ <code>LiveData</code> çš„æºç å®ç°</p><a id="more"></a><h2 id="æˆ‘ä»¬éƒ½æ˜¯-Adapter"><a href="#æˆ‘ä»¬éƒ½æ˜¯-Adapter" class="headerlink" title="æˆ‘ä»¬éƒ½æ˜¯ Adapter"></a>æˆ‘ä»¬éƒ½æ˜¯ Adapter</h2><p>åœ¨è°ˆ <code>LiveData</code> å‰æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜</p><p><strong>Android å¼€å‘ï¼ˆäº¦æˆ–è€…è¯´å‰ç«¯å¼€å‘ï¼‰çš„æœ¬è´¨å·¥ä½œå†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>å¯¹äºåº”ç”¨å±‚ app å¼€å‘è€…ï¼Œå¼€å‘è€…çš„å·¥ä½œä¸»è¦å·¥ä½œå°±æ˜¯ Adapter </p><p>ä»€ä¹ˆæ˜¯ Adapter ï¼Œä¸‹å›¾å¯èƒ½æ¯”è¾ƒç›´è§‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200330153727.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Adapter"></p><blockquote><p>å›¾ç‰‡æ¥è‡ª google image</p></blockquote><p>æˆ‘ä»¬çš„å·¥ä½œæœ¬è´¨æ˜¯ <strong>å°†æ•°æ®è½¬æ¢æˆ UI</strong> </p><p>æ•°æ®å¯èƒ½æ¥è‡ªç½‘ç»œï¼Œæ¥è‡ªæœ¬åœ°æ•°æ®åº“ï¼Œæ¥è‡ªå†…å­˜ï¼Œè€Œ UI å¯èƒ½æ˜¯ activity æˆ– fragmentã€‚</p><h2 id="ç†æƒ³çš„æ•°æ®æ¨¡å‹"><a href="#ç†æƒ³çš„æ•°æ®æ¨¡å‹" class="headerlink" title="ç†æƒ³çš„æ•°æ®æ¨¡å‹"></a>ç†æƒ³çš„æ•°æ®æ¨¡å‹</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ° Android å¼€å‘è€…çš„æ ¸å¿ƒå·¥ä½œå°±æ˜¯å°†æ•°æ®è½¬æ¢ä¸º UI ã€‚è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒç†æƒ³çš„çŠ¶æ€æ˜¯ï¼šå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒUI è·Ÿéšå˜åŒ–ã€‚æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥å±•å¼€ï¼šå½“ UI å¯¹ç”¨æˆ·å¯è§æ—¶ï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ UI è·Ÿéšå˜åŒ–ï¼›å½“ UI å¯¹ç”¨æˆ·ä¸å¯è§æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æ•°æ®å˜åŒ–æ—¶ä»€ä¹ˆéƒ½ä¸åšï¼Œå½“ UI å†æ¬¡å¯¹ç”¨æˆ·å¯è§æ—¶æ ¹æ®æœ€æ–°çš„æ•°æ®è¿›è¡Œ UI çš„å¤„ç†ã€‚</p><p>è€Œ <code>LiveData</code> å°±æ˜¯æˆ‘ä»¬ç†æƒ³ä¸­çš„æ•°æ®æ¨¡å‹</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200330160205.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="LiveData"></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://www.youtube.com/watch?v=2rO4r-JOQtA&list=PLWz5rJ2EKKc_dskHzXdKHB2ZvAlMyFwZe&index=2&t=0s" target="_blank" rel="noopener">Android Dev Summit â€˜18-Fun with LiveData</a></p></blockquote><p> LiveData å¯ä»¥ä¸‰ä¸ªå…³é”®è¯æ¦‚æ‹¬</p><ul><li><p>lifecycle-aware</p></li><li><p>observable</p></li><li><p>data holder</p></li></ul><h3 id="observable"><a href="#observable" class="headerlink" title="observable"></a>observable</h3><p>Android ä¸­ä¸åŒçš„ç»„ä»¶æœ‰ç€ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸åŒçš„å­˜æ´»æ—¶é—´</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321140641.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ViewModel"></p><p>å› æ­¤æˆ‘ä»¬ä¸ä¼šåœ¨ <code>ViewModel</code> ä¸­æŒæœ‰ <code>Activity</code> çš„å¼•ç”¨ï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´å½“ <code>Activity</code> é‡å»ºæ—¶å†…å­˜æ³„æ¼ï¼Œç”šè‡³å‡ºç°ç©ºæŒ‡é’ˆçš„æƒ…å†µ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200330161100.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="observable"></p><p>é€šå¸¸æˆ‘ä»¬ä¼šåœ¨ <code>Activity</code> ä¸­æŒæœ‰ <code>ViewModel</code> çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå¦‚ä½•è¿›è¡ŒäºŒè€…é—´çš„é€šä¿¡ï¼Œå¦‚ä½•å‘ <code>Activity</code> å‘é€ <code>ViewModel</code> ä¸­çš„æ•°æ®ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è®© <code>Activity</code> è§‚å¯Ÿ <code>ViewModel</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200330161411.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><code>LiveData</code> æ˜¯ <code>observable</code></p><h3 id="lifecycle-aware"><a href="#lifecycle-aware" class="headerlink" title="lifecycle-aware"></a>lifecycle-aware</h3><p>å½“è§‚å¯Ÿè€…è§‚å¯Ÿç€æŸä¸ªæ•°æ®æ—¶ï¼Œè¯¥æ•°æ®å¿…é¡»ä¿ç•™å¯¹è§‚å¯Ÿè€…çš„å¼•ç”¨æ‰èƒ½è°ƒç”¨å®ƒï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>LiveData</code> è¢«è®¾è®¡æˆå¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200330162126.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å½“ activity / fragment è¢«é”€æ¯åï¼Œå®ƒä¼šè‡ªåŠ¨çš„å–æ¶ˆè®¢é˜…</p><h3 id="data-holder"><a href="#data-holder" class="headerlink" title="data holder"></a>data holder</h3><p><code>LiveData</code> ä»…æŒæœ‰ <strong>å•ä¸ªä¸”æœ€æ–°</strong> çš„æ•°æ®</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200330214220.gif" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="data holder"></p><p>ä¸Šå›¾ä¸­ï¼Œæœ€å³ä¾§æ˜¯åœ¨ <code>ViewModel</code> ä¸­çš„ <code>LiveData</code>ï¼Œå·¦ä¾§ä¸ºè§‚å¯Ÿè¿™ä¸ª <code>LiveData</code> çš„ activity / fragment ã€‚ä¸€æ—¦æˆ‘ä»¬ä¸º <code>LiveData</code> è®¾å€¼ï¼Œè¯¥å€¼ä¼šä¼ é€’åˆ° activityã€‚ç®€è€Œè¨€ä¹‹ï¼Œ<code>LiveData</code> å€¼æ”¹å˜ï¼Œactivity æ”¶åˆ°æœ€æ–°çš„å€¼çš„å˜åŒ–ã€‚ä½†æ˜¯å½“è§‚å¯Ÿè€…ä¸å†å¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆSTARTED åˆ° RESUMED ï¼‰ï¼Œæ•°æ® C ä¸ä¼šè¢«å‘é€åˆ° activity ã€‚å½“ activity å›åˆ°å‰å°ï¼Œå®ƒå°†æ”¶åˆ°æœ€æ–°çš„å€¼ï¼Œæ•°æ® Dã€‚<strong>LiveData ä»…æŒæœ‰å•ä¸ªä¸”æœ€æ–°çš„æ•°æ®</strong>ã€‚å½“ activity æ‰§è¡Œé”€æ¯æµç¨‹æ—¶ï¼Œæ­¤æ—¶çš„æ•°æ® E ä¹Ÿä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“</p><h2 id="Transformations"><a href="#Transformations" class="headerlink" title="Transformations"></a>Transformations</h2><p><code>LiveData</code> æä¾› ä¸¤ç§ transformation ï¼Œ<code>map</code> å’Œ <code>switch map</code>ã€‚å¼€å‘è€…ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„  <code>MediatorLiveData</code> </p><p>æˆ‘ä»¬éƒ½çŸ¥é“ <code>LiveData</code> å¯ä»¥ä¸º View å’Œ ViewModel æä¾›é€šä¿¡ï¼Œä½†å¦‚æœæœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶ï¼ˆä¾‹å¦‚ repository ï¼‰ä¹ŸæŒæœ‰ <code>LiveData</code>ã€‚é‚£ä¹ˆå®ƒåº”è¯¥å¦‚ä½•åœ¨ <code>ViewModel</code> ä¸­è®¢é˜…ï¼Ÿè¯¥ç»„ä»¶å¹¶æ²¡æœ‰ lifecycle </p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331090310.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä¸€æ—¦æˆ‘ä»¬çš„åº”ç”¨æ„ˆå‘å¤æ‚ï¼Œrepository å¯èƒ½ä¼šè§‚å¯Ÿæ•°æ®æº</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331090412.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>é‚£ä¹ˆ view å¦‚ä½•è·å– repository ä¸­çš„ <code>LiveData</code>ï¼Ÿ</p><h3 id="ä¸€å¯¹ä¸€çš„é™æ€è½¬æ¢ï¼ˆmapï¼‰"><a href="#ä¸€å¯¹ä¸€çš„é™æ€è½¬æ¢ï¼ˆmapï¼‰" class="headerlink" title="ä¸€å¯¹ä¸€çš„é™æ€è½¬æ¢ï¼ˆmapï¼‰"></a>ä¸€å¯¹ä¸€çš„é™æ€è½¬æ¢ï¼ˆmapï¼‰</h3><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331090941.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="one-to-one static transformation"></p><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>ViewModel</code> ä»…å°†æ•°æ®ä» repository è½¬å‘åˆ° viewï¼Œç„¶åå°†å…¶è½¬æ¢ä¸º UI Modelã€‚ æ¯å½“ repository ä¸­æœ‰æ–°æ•°æ®æ—¶ï¼Œ<code>ViewModel</code> åªéœ€ <code>map</code> </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainViewModel</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> viewModelResult = Transformations.map(repository.getDataForUser()) &#123; <span class="hljs-keyword">data</span> -&gt;<br>     convertDataToMainUIModel(<span class="hljs-keyword">data</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸º <code>LiveData</code> æºï¼ˆæ¥è‡ª repository ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè½¬æ¢å‡½æ•°ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// è¿™é‡Œçš„è½¬æ¢ä¸ºå°† X è½¬æ¢ä¸º Y</span><br><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;X, Y&gt;</span> LiveData<span class="hljs-type">&lt;X&gt;</span>.<span class="hljs-title">map</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> transform: (<span class="hljs-type">X</span>)</span></span> -&gt; Y): LiveData&lt;Y&gt; =<br>        Transformations.map(<span class="hljs-keyword">this</span>) &#123; transform(it) &#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸€å¯¹ä¸€çš„åŠ¨æ€è½¬æ¢ï¼ˆswitchMapï¼‰"><a href="#ä¸€å¯¹ä¸€çš„åŠ¨æ€è½¬æ¢ï¼ˆswitchMapï¼‰" class="headerlink" title="ä¸€å¯¹ä¸€çš„åŠ¨æ€è½¬æ¢ï¼ˆswitchMapï¼‰"></a>ä¸€å¯¹ä¸€çš„åŠ¨æ€è½¬æ¢ï¼ˆswitchMapï¼‰</h3><p>å‡å¦‚æ‚¨æ­£åœ¨è§‚å¯Ÿä¸€ä¸ªæä¾›ç”¨æˆ·çš„ç”¨æˆ·ç®¡ç†å™¨ï¼Œå¹¶ä¸”éœ€è¦æä¾›ç”¨æˆ·çš„ id æ‰èƒ½å¼€å§‹è§‚å¯Ÿ repository </p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331091954.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æ‚¨ä¸èƒ½å°†å…¶å†™åˆ° <code>ViewModel</code> åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæ­¤æ—¶ç”¨æˆ·çš„ id è¿˜ä¸å¯ç”¨</p><p>è¿™æ—¶ <code>switchMap</code> å°±æ´¾ä¸Šç”¨åœºäº†</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainViewModel</span> </span>&#123;<br>  <span class="hljs-keyword">val</span> repositoryResult = Transformations.switchMap(userManager.userId) &#123; userId -&gt;<br>     repository.getDataForUser(userId)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>switchMap</code> åœ¨å†…éƒ¨ä½¿ç”¨ <code>MediatorLiveData</code>ï¼Œå› æ­¤äº†è§£å®ƒéå¸¸é‡è¦ï¼Œå› ä¸ºå½“æ‚¨è¦ç»„åˆå¤šä¸ª <code>LiveData</code> æºæ—¶éœ€è¦ä½¿ç”¨å®ƒ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// è¿™é‡Œçš„è½¬æ¢ä¸ºå°† X è½¬æ¢ä¸º LiveData&lt;Y&gt;</span><br><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;X, Y&gt;</span> LiveData<span class="hljs-type">&lt;X&gt;</span>.<span class="hljs-title">switchMap</span><span class="hljs-params">(<br>    <span class="hljs-keyword">crossinline</span> transform: (<span class="hljs-type">X</span>)</span></span> -&gt; LiveData&lt;Y&gt;<br>): LiveData&lt;Y&gt; = Transformations.switchMap(<span class="hljs-keyword">this</span>) &#123; transform(it) &#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸€å¯¹å¤šä¾èµ–ï¼ˆMediatorLiveDataï¼‰"><a href="#ä¸€å¯¹å¤šä¾èµ–ï¼ˆMediatorLiveDataï¼‰" class="headerlink" title="ä¸€å¯¹å¤šä¾èµ–ï¼ˆMediatorLiveDataï¼‰"></a>ä¸€å¯¹å¤šä¾èµ–ï¼ˆMediatorLiveDataï¼‰</h3><p><code>MediatorLiveData</code> å…è®¸æ‚¨å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®æºæ·»åŠ åˆ°å•ä¸ªå¯è§‚å¯Ÿçš„ <code>LiveData</code> ä¸­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> liveData1: LiveData&lt;<span class="hljs-built_in">Int</span>&gt; = ...<br><span class="hljs-keyword">val</span> liveData2: LiveData&lt;<span class="hljs-built_in">Int</span>&gt; = ...<br><br><span class="hljs-keyword">val</span> result = MediatorLiveData&lt;<span class="hljs-built_in">Int</span>&gt;()<br><br>result.addSource(liveData1) &#123; value -&gt;<br>    result.setValue(value)<br>&#125;<br>result.addSource(liveData2) &#123; value -&gt;<br>    result.setValue(value)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå½“ä»»ä½•ä¸€ä¸ªæ•°æ®æºå˜åŒ–æ—¶ï¼Œresult ä¼šæ›´æ–°ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ•°æ®å¹¶ä¸æ˜¯åˆå¹¶ï¼ŒMediatorLiveData åªæ˜¯å¤„ç†é€šçŸ¥</p></blockquote><p>ä¸ºäº†å®ç°ç¤ºä¾‹ä¸­çš„è½¬æ¢ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸¤ä¸ªä¸åŒçš„ LiveData ç»„åˆä¸ºä¸€ä¸ª</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331094815.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://medium.com/androiddevelopers/livedata-beyond-the-viewmodel-reactive-patterns-using-transformations-and-mediatorlivedata-fda520ba00b7" target="_blank" rel="noopener">LiveData beyond the ViewModel â€” Reactive patterns using Transformations and MediatorLiveData</a></p></blockquote><p>ä½¿ç”¨ <code>MediatorLiveData</code> åˆå¹¶æ•°æ®çš„ä¸€ç§æ–¹æ³•æ˜¯æ·»åŠ æºå¹¶ä»¥å…¶ä»–æ–¹æ³•è®¾ç½®å€¼ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">blogpostBoilerplateExample</span><span class="hljs-params">(newUser: <span class="hljs-type">String</span>)</span></span>: LiveData&lt;UserDataResult&gt; &#123;<br><br>    <span class="hljs-keyword">val</span> liveData1 = userOnlineDataSource.getOnlineTime(newUser)<br>    <span class="hljs-keyword">val</span> liveData2 = userCheckinsDataSource.getCheckins(newUser)<br><br>    <span class="hljs-keyword">val</span> result = MediatorLiveData&lt;UserDataResult&gt;()<br><br>    result.addSource(liveData1) &#123; value -&gt;<br>        result.value = combineLatestData(liveData1, liveData2)<br>    &#125;<br>    result.addSource(liveData2) &#123; value -&gt;<br>        result.value = combineLatestData(liveData1, liveData2)<br>    &#125;<br>    <span class="hljs-keyword">return</span> result<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•°æ®çš„å®é™…ç»„åˆæ˜¯åœ¨ <code>combineLatestData</code> æ–¹æ³•ä¸­å®Œæˆçš„</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">combineLatestData</span><span class="hljs-params">(<br>        onlineTimeResult: <span class="hljs-type">LiveData</span>&lt;<span class="hljs-type">Long</span>&gt;,<br>        checkinsResult: <span class="hljs-type">LiveData</span>&lt;<span class="hljs-type">CheckinsResult</span>&gt;<br>)</span></span>: UserDataResult &#123;<br><br>    <span class="hljs-keyword">val</span> onlineTime = onlineTimeResult.value<br>    <span class="hljs-keyword">val</span> checkins = checkinsResult.value<br><br>    <span class="hljs-comment">// Don't send a success until we have both results</span><br>    <span class="hljs-keyword">if</span> (onlineTime == <span class="hljs-literal">null</span> || checkins == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> UserDataLoading()<br>    &#125;<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Check for errors and return UserDataError if any.</span><br><br>    <span class="hljs-keyword">return</span> UserDataSuccess(timeOnline = onlineTime, checkins = checkins)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥å€¼æ˜¯å¦å‡†å¤‡å¥½å¹¶å‘å‡ºç»“æœï¼ˆåŠ è½½ä¸­ï¼Œå¤±è´¥æˆ–æˆåŠŸï¼‰</p><h2 id="LiveData-çš„é”™è¯¯ç”¨æ³•"><a href="#LiveData-çš„é”™è¯¯ç”¨æ³•" class="headerlink" title="LiveData çš„é”™è¯¯ç”¨æ³•"></a>LiveData çš„é”™è¯¯ç”¨æ³•</h2><h3 id="é”™è¯¯åœ°ä½¿ç”¨-var-LiveData"><a href="#é”™è¯¯åœ°ä½¿ç”¨-var-LiveData" class="headerlink" title="é”™è¯¯åœ°ä½¿ç”¨ var LiveData"></a>é”™è¯¯åœ°ä½¿ç”¨ var LiveData</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> <span class="hljs-keyword">lateinit</span> randomNumber: LiveData&lt;<span class="hljs-built_in">Int</span>&gt;<br><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onGetNumber</span><span class="hljs-params">()</span></span> &#123;<br>   randomNumber = Transformations.map(numberGenerator.getNumber()) &#123;<br>       it<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªé‡è¦çš„é—®é¢˜éœ€è¦ç†è§£ï¼šè½¬æ¢ä¼šåœ¨è°ƒç”¨æ—¶ï¼ˆ<code>map</code> å’Œ <code>switchMap</code>ï¼‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>LiveData</code>ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒrandomNumber å…¬å¼€ç»™ View ï¼Œä½†æ˜¯æ¯æ¬¡ç”¨æˆ·å•å‡»æŒ‰é’®æ—¶éƒ½ä¼šå¯¹å…¶è¿›è¡Œé‡æ–°èµ‹å€¼ã€‚ è§‚å¯Ÿè€…åªä¼šåœ¨è®¢é˜…æ—¶æ”¶åˆ°åˆ†é…ç»™ var çš„ <code>LiveData</code> æ›´æ–°çš„ä¿¡æ¯</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// åªä¼šæ”¶åˆ°ç¬¬ä¸€æ¬¡åˆ†é…çš„å€¼</span><br>viewmodel.randomNumber.observe(<span class="hljs-keyword">this</span>, Observer &#123; number -&gt;<br>    numberTv.text = resources.getString(R.string.random_text, number)<br>&#125;)<br></code></pre></td></tr></table></figure><p>å¦‚æœ viewmodel.randomNumber <code>LiveData</code> å®ä¾‹å‘ç”Ÿæ›´æ”¹ï¼Œè¿™é‡Œæ°¸è¿œä¸ä¼šå›è°ƒã€‚è€Œä¸”è¿™é‡Œæ³„æ¼äº†ä¹‹å‰çš„ <code>LiveData</code> ï¼Œè¿™äº› <code>LiveData</code> ä¸ä¼šå†å‘é€æ›´æ–°</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331111630.gif" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä¸€è¨€ä»¥è”½ä¹‹ï¼Œ<strong>ä¸è¦åœ¨ var ä¸­ä½¿ç”¨ Livedata</strong></p><p>æ­£ç¡®ç¤ºä¾‹è§  <a href="https://github.com/Flywith24/Flywith24-Jetpack-Demo/tree/master/demo_livedata" target="_blank" rel="noopener">demo</a></p><h3 id="LiveData-ç²˜æ€§äº‹ä»¶"><a href="#LiveData-ç²˜æ€§äº‹ä»¶" class="headerlink" title="LiveData ç²˜æ€§äº‹ä»¶"></a>LiveData ç²˜æ€§äº‹ä»¶</h3><p>ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬ä½¿ç”¨ LiveData æŒæœ‰ UI æ•°æ®å’ŒçŠ¶æ€ï¼Œä½†æ˜¯å¦‚æœé€šè¿‡å®ƒæ¥å‘é€äº‹ä»¶ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚è¿™äº›é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ <a href="https://juejin.im/post/5b2b1b2cf265da5952314b63" target="_blank" rel="noopener">åœ¨è¿™</a></p><h3 id="fragment-ä¸­é”™è¯¯åœ°ä¼ å…¥-LifecycleOwner"><a href="#fragment-ä¸­é”™è¯¯åœ°ä¼ å…¥-LifecycleOwner" class="headerlink" title="fragment ä¸­é”™è¯¯åœ°ä¼ å…¥ LifecycleOwner"></a>fragment ä¸­é”™è¯¯åœ°ä¼ å…¥ LifecycleOwner</h3><p><code>androidx fragment 1.2.0</code> èµ·ï¼Œæ·»åŠ äº†æ–°çš„ Lint æ£€æŸ¥ï¼Œä»¥ç¡®ä¿æ‚¨åœ¨ä» onCreateView()ã€onViewCreated() æˆ– onActivityCreated() è§‚å¯Ÿ <code>LiveData</code> æ—¶ä½¿ç”¨ getViewLifecycleOwner()</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331152505.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331205402.gif" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="bug"></p><p>å¦‚å›¾ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª fragment ï¼ŒonCreate è§‚å¯Ÿ <code>LiveData</code>ï¼Œé€šè¿‡æ­£å¸¸çš„ç”Ÿå‘½å‘¨æœŸåˆ›å»ºäº† View ï¼Œæ¥ç€è¿›å…¥äº† resume çŠ¶æ€ã€‚æ­¤æ—¶ä½ ä½¿ç”¨äº† <code>LiveData</code>ï¼ŒUI å°†å¼€å§‹å±•ç¤ºå®ƒã€‚ä¹‹åï¼Œç”¨æˆ·ç‚¹å‡»äº†æŒ‰é’®ï¼Œç”±äºè·³è½¬äº†å¦ä¸€ä¸ª fragmentï¼Œæ‰€ä»¥è¦ detach è¯¥ fragmentï¼Œä¸€æ—¦ fragment stop æˆ‘ä»¬å°±ä¸éœ€è¦å…¶ä¸­çš„ view äº†ï¼Œå› æ­¤ destroyView ã€‚ä¹‹åç”¨æˆ·ç‚¹å‡»äº†è¿”å›æŒ‰é’®å›åˆ°äº†ä¸Šä¸€ä¸ª fragmentï¼Œç”±äºæˆ‘ä»¬å·²ç» destroyViewï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ view ï¼Œæ¥ç€è¿›å…¥æ­£å¸¸çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ­¤æ—¶ï¼Œå‡ºç°äº†ä¸€ä¸ª bug ã€‚è¿™ä¸ªæ–° View ä¸ä¼šæ¢å¤ <code>LiveData</code> çš„çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ fragment çš„ lifecycle observe çš„ <code>LiveData</code></p><p>æˆ‘ä»¬æœ‰ä¸¤ç§é€‰æ‹©ï¼Œåœ¨ onCreate æˆ–è€…åœ¨ onCreateView ä¸­ä½¿ç”¨ fragment çš„ lifecycle observe LiveData</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331171844.png" src="/2020/03/31/Jetpack-LiveData/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å‰è€…çš„ä¼˜ç‚¹æ˜¯ä¸€æ¬¡æ³¨å†Œï¼Œç¼ºç‚¹æ˜¯å½“ recreate æ—¶æœ‰bugï¼›åè€…ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿè§£å†³ recreate çš„ bugï¼Œä½†ä¼šå¯¼è‡´é‡å¤æ³¨å†Œ</p><p><strong>è¯¥é—®é¢˜çš„æ ¸å¿ƒæ˜¯ fragment æ‹¥æœ‰ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸï¼šfragment è‡ªèº«å’Œ fragment å†…éƒ¨ view çš„ç”Ÿå‘½å‘¨æœŸ</strong></p><p><code>androidx fragment 1.0</code> å’Œ <code>support library 28</code> äº† viewLifecycle</p><p><strong>å› æ­¤ï¼Œå½“éœ€è¦è§‚å¯Ÿ view ç›¸å…³çš„ LiveData ï¼Œå¯ä»¥åœ¨ onCreateView()ã€onViewCreated() æˆ– onActivityCreated()  ä¸­ LiveData observe æ–¹æ³•ä¸­ä¼ å…¥ viewLifecycleOwner è€Œä¸æ˜¯ä¼ å…¥ this</strong></p><h2 id="æºç ç»“æ„"><a href="#æºç ç»“æ„" class="headerlink" title="æºç ç»“æ„"></a>æºç ç»“æ„</h2><p>é¦–å…ˆæ¥çœ‹ <code>LiveData</code> ä¸»è¦çš„æºç ç»“æ„</p><ul><li>LiveData </li><li>MutableLiveData</li><li>Observer</li></ul><h3 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a>LiveData</h3><p><code>LiveData</code> æ˜¯å¯ä»¥åœ¨ç»™å®šç”Ÿå‘½å‘¨æœŸå†…è§‚å¯Ÿåˆ°çš„æ•°æ®æŒæœ‰è€…ç±»ã€‚ è¿™æ„å‘³ç€å¯ä»¥å°†ä¸€ä¸ª<code>Observer</code> ä¸ <code>LifecycleOwner</code> æˆå¯¹æ·»åŠ ï¼Œå¹¶ä¸”åªæœ‰åœ¨é…å¯¹çš„ <code>LifecycleOwner</code> å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œæ‰ä¼šå‘è¯¥è§‚å¯Ÿè€…é€šçŸ¥æœ‰å…³åŒ…è£…æ•°æ®çš„ä¿®æ”¹ã€‚ å¦‚æœ LifecycleOwner çš„çŠ¶æ€ä¸º <code>Lifecycle.State.STARTED</code> æˆ– <code>Lifecycle.State.RESUMED</code>ï¼Œåˆ™å°†å…¶è§†ä¸ºæ´»åŠ¨çŠ¶æ€ã€‚ é€šè¿‡ <code>observeForever</code>ï¼ˆObserverï¼‰æ·»åŠ çš„è§‚å¯Ÿè€…è¢«è§†ä¸ºå§‹ç»ˆå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå› æ­¤å°†å§‹ç»ˆæ”¶åˆ°æœ‰å…³ä¿®æ”¹çš„é€šçŸ¥ã€‚ å¯¹äºé‚£äº›è§‚å¯Ÿè€…ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>removeObserver</code>ï¼ˆObserverï¼‰</p><p>å¦‚æœç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸç§»è‡³ <code>Lifecycle.State.DESTROYED</code> çŠ¶æ€ï¼Œåˆ™æ·»åŠ äº†ç”Ÿå‘½å‘¨æœŸçš„è§‚å¯Ÿè€…å°†è¢«è‡ªåŠ¨åˆ é™¤ã€‚ è¿™å¯¹äº activity å’Œ fragment å¯ä»¥å®‰å…¨åœ°è§‚å¯Ÿ <code>LiveData</code> è€Œä¸ç”¨æ‹…å¿ƒæ³„æ¼</p><p>æ­¤å¤–ï¼Œ<code>LiveData</code> å…·æœ‰ onActive() å’Œ onInactive() æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨æ´»åŠ¨è§‚å¯Ÿè€…çš„æ•°é‡åœ¨ 0 åˆ° 1 ä¹‹é—´å˜åŒ–æ—¶å¾—åˆ°é€šçŸ¥ã€‚è¿™ä½¿ <code>LiveData</code> åœ¨æ²¡æœ‰ä»»ä½•æ´»åŠ¨è§‚å¯Ÿè€…çš„æƒ…å†µä¸‹å¯ä»¥é‡Šæ”¾å¤§é‡èµ„æºã€‚</p><p>ä¸»è¦æ–¹æ³•æœ‰ï¼š</p><ul><li>T getValue() è·å–LiveData åŒ…è£…çš„æ•°æ®</li><li>observe(LifecycleOwner owner, Observer&lt;? super T&gt; observer) è®¾ç½®è§‚å¯Ÿè€…ï¼ˆä¸»çº¿ç¨‹è°ƒç”¨ï¼‰</li><li>setValue(T value)  è®¾å€¼ï¼ˆä¸»çº¿ç¨‹è°ƒç”¨ï¼‰ï¼Œå¯è§æ€§ä¸º protected æ— æ³•ç›´æ¥ä½¿ç”¨</li><li>postValue(T value) è®¾ç½®ï¼ˆå…¶ä»–çº¿ç¨‹è°ƒç”¨ï¼‰ï¼Œå¯è§æ€§ä¸º protected æ— æ³•ç›´æ¥ä½¿ç”¨</li></ul><h3 id="MutableLiveData"><a href="#MutableLiveData" class="headerlink" title="MutableLiveData"></a>MutableLiveData</h3><p><code>LiveData</code> å®ç°ç±»ï¼Œå…¬å¼€äº† <code>setValue</code> å’Œ <code>postValue</code> æ–¹æ³•</p><h3 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h3><p>æ¥å£ï¼Œå†…éƒ¨åªæœ‰ onChanged(T t) æ–¹æ³•ï¼Œåœ¨æ•°æ®å˜åŒ–æ—¶è¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹çœ‹ <code>LiveData</code> å¦‚ä½•å®ç°å®ƒçš„ç‰¹æ€§çš„</p><ul><li><ol><li>å¦‚ä½•æ§åˆ¶åœ¨ activity æˆ– fragment æ´»åŠ¨çŠ¶æ€æ—¶æ¥æ”¶å›è°ƒï¼Œå¦åˆ™ä¸æ¥æ”¶ï¼Ÿ</li></ol></li><li><ol start="2"><li>å¦‚ä½•åœ¨ activity æˆ– fragment é”€æ¯æ—¶è‡ªåŠ¨å–æ¶ˆæ³¨å†Œè§‚å¯Ÿè€…ï¼Ÿ</li></ol></li><li><ol start="3"><li>å¦‚ä½•ä¿è¯ <code>LiveData</code> æŒæœ‰æœ€æ–°çš„æ•°æ®ï¼Ÿ</li></ol></li></ul><p>æˆ‘ä»¬æŸ¥çœ‹ <code>LiveData</code> çš„ observe æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LiveData.java</span><br><span class="hljs-meta">@MainThread</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">observe</span><span class="hljs-params">(LifecycleOwner owner, Observer&lt;? <span class="hljs-keyword">super</span> T&gt; observer)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;<br>        <span class="hljs-comment">// å¦‚æœ owner å·²ç»æ˜¯ DESTROYED çŠ¶æ€ï¼Œåˆ™å¿½ç•¥</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// ä½¿ç”¨ LifecycleBoundObserver åŒ…è£… owner å’Œ observer</span><br>    LifecycleBoundObserver wrapper = <span class="hljs-keyword">new</span> LifecycleBoundObserver(owner, observer);<br>    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);<br>    <span class="hljs-comment">// å¦‚æœå·²ç»æ·»åŠ è¿‡ç›´æ¥ return </span><br>    <span class="hljs-keyword">if</span> (existing != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>   <br>    owner.getLifecycle().addObserver(wrapper);<br>&#125;<br><br><span class="hljs-comment">// LifecycleBoundObserver.java</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LifecycleBoundObserver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObserverWrapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LifecycleEventObserver</span> </span>&#123;<br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">final</span> LifecycleOwner mOwner;<br>    LifecycleBoundObserver(LifecycleOwner owner, Observer&lt;? <span class="hljs-keyword">super</span> T&gt; observer) &#123;<br>        <span class="hljs-keyword">super</span>(observer);<br>        mOwner = owner;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æºç æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ observe æ–¹æ³•æ—¶ï¼Œå†…éƒ¨æ˜¯é€šè¿‡ <code>LifecycleBoundObserver</code> å°† owner å’Œ observer åŒ…è£¹èµ·æ¥å¹¶é€šè¿‡ <code>addObserver</code> æ–¹æ³•æ·»åŠ è§‚å¯Ÿè€…çš„ï¼Œå› è€Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ <code>LifecycleBoundObserver</code> çš„ <code>onStateChanged</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LiveData.LifecycleBoundObserver.java</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStateChanged</span><span class="hljs-params">(@NonNull LifecycleOwner source,<br>        @NonNull Lifecycle.Event event)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;<br>        <span class="hljs-comment">// è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…ï¼Œé—®é¢˜ 2 å¾—åˆ°è§£é‡Š</span><br>        removeObserver(mObserver);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    activeStateChanged(shouldBeActive());<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ä»€ä¹ˆå‘¨æœŸæ‰€æœ‰è€…å¤„äº <code>DESTROYED</code> çŠ¶æ€æ—¶ï¼Œä¼šè°ƒç”¨ <code>removeObserver</code> æ–¹æ³•ï¼Œå› æ­¤é—®é¢˜ 2  å¾—åˆ°è§£é‡Š</p><p>æˆ‘ä»¬ç»§ç»­å‘ä¸‹çœ‹ï¼Œ<code>activeStateChanged</code> æ–¹æ³•è°ƒç”¨æ—¶ä¼ å…¥äº† <code>shouldBeActive()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldBeActive</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// è‡³å°‘æ˜¯ STARTED çŠ¶æ€ è¿”å› true</span><br>    <span class="hljs-keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">activeStateChanged</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> newActive)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (newActive == mActive) &#123;<br>        <span class="hljs-comment">// ä¸ä¸Šæ¬¡å€¼ç›¸åŒï¼Œåˆ™ç›´æ¥ return ï¼ˆä¸¤æ¬¡å‡ä¸ºæ´»åŠ¨çŠ¶æ€æˆ–å‡ä¸ºéæ´»åŠ¨çŠ¶æ€ï¼‰</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    mActive = newActive;<br>    <span class="hljs-keyword">boolean</span> wasInactive = LiveData.<span class="hljs-keyword">this</span>.mActiveCount == <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// æ ¹æ® mActive ä¿®æ”¹æ´»åŠ¨çŠ¶æ€è§‚å¯Ÿè€…çš„æ•°é‡ï¼ˆåŠ  1 æˆ–å‡ 1 ï¼‰</span><br>    LiveData.<span class="hljs-keyword">this</span>.mActiveCount += mActive ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (wasInactive &amp;&amp; mActive) &#123;<br>        onActive();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (LiveData.<span class="hljs-keyword">this</span>.mActiveCount == <span class="hljs-number">0</span> &amp;&amp; !mActive) &#123;<br>        onInactive();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (mActive) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯æ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å‘é€æ•°æ®ï¼Œé—®é¢˜ 1 å¾—åˆ°è§£é‡Š</span><br>        dispatchingValue(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç‰µæ‰¯äº† <code>Lifecycle State</code> æ¯”è¾ƒçš„çŸ¥è¯†ï¼Œ<a href="https://juejin.im/post/5e8348bef265da47e02a6ce2#heading-11" target="_blank" rel="noopener">è¯¦æƒ…åœ¨è¿™</a></p><p>åªæœ‰ <code>STARTED</code> å’Œ <code>RESUMED</code> çŠ¶æ€ <code>shouldBeActive()</code> æ‰è¿”å› trueï¼Œè‡³æ­¤é—®é¢˜ 1 å¾—åˆ°è§£é‡Š</p><p><code>dispatchingValue</code> æ–¹æ³•å†…éƒ¨è°ƒç”¨äº† <code>considerNotify</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">considerNotify</span><span class="hljs-params">(ObserverWrapper observer)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!observer.mActive) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// å†æ¬¡åˆ¤æ–­ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (!observer.shouldBeActive()) &#123;<br>        observer.activeStateChanged(<span class="hljs-keyword">false</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// æ¯”è¾ƒç‰ˆæœ¬å·</span><br>    <span class="hljs-keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    observer.mLastVersion = mVersion;<br>    <span class="hljs-comment">// è°ƒç”¨æˆ‘ä»¬ä¼ å…¥çš„ mObserver çš„ onChanged æ–¹æ³•</span><br>    observer.mObserver.onChanged((T) mData);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>considerNotify</code> ä¸­æ¯”è¾ƒäº† observer çš„ç‰ˆæœ¬å·ï¼Œå¦‚æœæ˜¯æœ€æ–°çš„æ•°æ®ï¼Œç›´æ¥ return</p><p>è€Œ <code>mVersion</code> åœ¨ <code>setValue</code> æ–¹æ³•ä¸­ è¿›è¡Œæ›´æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MainThread</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setValue</span><span class="hljs-params">(T value)</span> </span>&#123;<br>    <span class="hljs-comment">// æ¯æ¬¡è®¾ç½®å¯¹ mVersion è¿›è¡Œ++</span><br>    mVersion++;<br>    mData = value;<br>    dispatchingValue(<span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤ <code>LiveData</code> æ¯æ¬¡éƒ½æŒæœ‰æœ€æ–°çš„æ•°æ®ï¼Œé—®é¢˜ 3 å¾—åˆ°è§£é‡Š</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å›åˆ°æœ¬æ–‡å¼€å¤´çš„æ€è€ƒï¼ŒAndroid å¼€å‘è€…çš„ä¸»è¦å·¥ä½œæ˜¯å°†æ•°æ®è½¬æ¢æˆ UI ï¼Œè€Œ <code>LiveData</code> æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ã€Œæ•°æ®é©±åŠ¨ã€ï¼Œå³é€šè¿‡æ”¹å˜çŠ¶æ€æ•°æ®ï¼Œæ¥é©±åŠ¨è§†å›¾æ ‘ä¸­ç»‘å®šäº†ç›¸åº”çŠ¶æ€æ•°æ®çš„æ§ä»¶é‡æ–°å‘ç”Ÿç»˜åˆ¶ã€‚Flutter å’Œæœªæ¥çš„  Jetpack Compose é‡‡ç”¨çš„éƒ½æ˜¯è¿™ç§æœºåˆ¶ã€‚ä½¿ç”¨ ViewModel + LiveDataï¼Œå¯ä»¥ <strong>å®‰å…¨åœ°åœ¨è®¢é˜…è€…çš„ç”Ÿå‘½å‘¨æœŸå†…åˆ†å‘æ­£ç¡®çš„æ•°æ®</strong>ï¼Œä½¿å¼€å‘è€…ä¸çŸ¥ä¸è§‰ä¸­å®Œæˆäº† <code>UI -&gt; ViewModel -&gt; Data</code> çš„å•å‘ä¾èµ–ã€‚</p><p><strong>æ‰€è°“æ¶æ„ï¼Œå¾ˆå¤šæ—¶å€™ä¸æ˜¯ä½¿ç”¨å®ƒèƒ½åšä»€ä¹ˆï¼Œæ›´å¤šçš„æ˜¯ä¸è¦åšä»€ä¹ˆï¼Œä½¿ç”¨å®ƒæ—¶å¼€å‘è€…èƒ½å¤Ÿå¾—åˆ°çº¦æŸï¼Œä»¥ä¾¿äº§å‡ºæ›´å¥å£®çš„ä»£ç </strong></p><p>å„ä½å°ä¼™ä¼´å¦‚æœæœ‰ä»€ä¹ˆæƒ³æ³•æ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€</p><hr><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><hr><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></li><li><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></li><li><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹Lifecycleã€‘ä¸‡ç‰©åŸºäºLifecycle é»˜é»˜æ— é—»å¤§ä½œç”¨</title>
      <link href="/2020/03/30/Jetpack-Lifecycle/"/>
      <url>/2020/03/30/Jetpack-Lifecycle/</url>
      
        <content type="html"><![CDATA[<blockquote><p> Android ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼šã€Œç”Ÿå‘½å‘¨æœŸã€ã€‚åˆšæ¯•ä¸šå»é¢è¯•ï¼Œæ€»ä¼šè¢«é—®åˆ°ã€Œå››å¤§ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€è¿™ç±»çš„é—®é¢˜ã€‚17å¹´çš„ IO å¤§ä¼šä¸Šï¼ŒGoogle æ¨å‡ºäº† Lifecycle-Aware Componentsï¼ˆç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶ï¼‰ï¼Œå¸®åŠ©å¼€å‘è€…ç»„ç»‡æ›´å¥½ï¼Œæ›´è½»é‡ï¼Œæ˜“äºç»´æŠ¤çš„ä»£ç </p></blockquote><p>æœ¬æ–‡ä»‹ç» <code>Lifecycle</code> çš„èŒè´£ä»¥åŠç®€å•åˆ†æ lifecycle å¦‚ä½•æ„ŸçŸ¥ activity å’Œ fragment ï¼Œå¸®åŠ©æ‚¨å¯¹ <code>Lifecycle</code> æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†</p><a id="more"></a><h2 id="ä¸‡ç‰©åŸºäº-Lifecycle"><a href="#ä¸‡ç‰©åŸºäº-Lifecycle" class="headerlink" title="ä¸‡ç‰©åŸºäº Lifecycle"></a>ä¸‡ç‰©åŸºäº <strong>Lifecycle</strong></h2><h3 id="æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸçš„ç—›è‹¦ä½ ä¸æ‡‚"><a href="#æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸçš„ç—›è‹¦ä½ ä¸æ‡‚" class="headerlink" title="æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸçš„ç—›è‹¦ä½ ä¸æ‡‚"></a>æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸçš„ç—›è‹¦ä½ ä¸æ‡‚</h3><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/30/1712bbbbf69f3b1e?w=2407&h=5062&f=jpeg&s=2270014" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="lifecycles"></p><blockquote><p> é²è¿…æ›¾è¯´è¿‡ï¼šä¸‡ç‰©åŸºäº Lifecycle</p></blockquote><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331214314.jpeg" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å“¦ä¸å¯¹</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200331214054.jpeg" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>Android ä¸­çš„è§†å›¾æ§åˆ¶å™¨å°±æœ‰è¿™ä¹ˆå¤šç”Ÿå‘½å‘¨æœŸçš„æƒ…å†µï¼Œæ‰€ä»¥å¤„ç†å¥½ç”Ÿå‘½å‘¨æœŸååˆ†é‡è¦ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ç”šè‡³æ˜¯ç¨‹åºå´©æºƒã€‚è¿™é‡Œå¼•ç”¨ <a href="https://developer.android.com/topic/libraries/architecture/lifecycle" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> çš„ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyLocationListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyLocationListener</span><span class="hljs-params">(Context context, Callback callback)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// è¿æ¥ç³»ç»Ÿçš„å®šä½æœåŠ¡</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// ä¸ç³»ç»Ÿçš„å®šä½æœåŠ¡æ–­å¼€è¿æ¥</span><br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> MyLocationListener myLocationListener;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(...)</span> </span>&#123;<br>        myLocationListener = <span class="hljs-keyword">new</span> MyLocationListener(<span class="hljs-keyword">this</span>, (location) -&gt; &#123;<br>            <span class="hljs-comment">// æ›´æ–° UI</span><br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onStart();<br>        myLocationListener.start();<br>        <span class="hljs-comment">//ç®¡ç†å…¶ä»–éœ€è¦å“åº” activity ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onStop();<br>        myLocationListener.stop();<br>        <span class="hljs-comment">//ç®¡ç†å…¶ä»–éœ€è¦å“åº” activity ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤ç¤ºä¾‹çœ‹èµ·æ¥ä¸é”™ï¼Œåœ¨å®é™…çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨ä»ç„¶ä¼šå“åº”ç”Ÿå‘½å‘¨æœŸçš„å½“å‰çŠ¶æ€è€Œè¿›è¡Œè¿‡å¤šçš„è°ƒç”¨æ¥ç®¡ç† UI å’Œå…¶ä»–ç»„ä»¶ã€‚ ç®¡ç†å¤šä¸ªç»„ä»¶ä¼šåœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­æ”¾ç½®å¤§é‡ä»£ç ï¼Œä¾‹å¦‚ onStart() å’Œ onStop()ï¼Œè¿™ä½¿å®ƒä»¬éš¾ä»¥ç»´æŠ¤</p><p>è€Œä¸”ï¼Œä¸èƒ½ä¿è¯ç»„ä»¶åœ¨ activity æˆ– fragment åœæ­¢ä¹‹å‰å°±å·²å¯åŠ¨ã€‚ å¦‚æœæˆ‘ä»¬éœ€è¦æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼ˆä¾‹å¦‚onStart() ä¸­çš„æŸäº›é…ç½®æ£€æŸ¥ï¼‰ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´äº‰ç”¨æƒ…å†µï¼Œå…¶ä¸­onStop() æ–¹æ³•åœ¨ onStart() ä¹‹å‰å®Œæˆï¼Œä»è€Œä½¿ç»„ä»¶çš„ç”Ÿå­˜æœŸè¶…è¿‡äº†æ‰€éœ€çš„ç”Ÿå­˜æœŸã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> MyLocationListener myLocationListener;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(...)</span> </span>&#123;<br>        myLocationListener = <span class="hljs-keyword">new</span> MyLocationListener(<span class="hljs-keyword">this</span>, location -&gt; &#123;<br>            <span class="hljs-comment">// æ›´æ–° UI</span><br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onStart();<br>        Util.checkUserStatus(result -&gt; &#123;<br>            <span class="hljs-comment">// å¦‚æœåœ¨ activity åœæ­¢åè°ƒç”¨æ­¤å›è°ƒæ€ä¹ˆåŠï¼Ÿ</span><br>            <span class="hljs-keyword">if</span> (result) &#123;<br>                myLocationListener.start();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onStop();<br>        myLocationListener.stop();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæœ‰æ‰€æœ‰çš„ç»„ä»¶ï¼Œéƒ½èƒ½æ„ŸçŸ¥å¤–éƒ¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œèƒ½åœ¨ç›¸åº”çš„æ—¶æœºé‡Šæ”¾èµ„æºï¼Œå¹¶ä¸”åœ¨é”™è¿‡ç”Ÿå‘½å‘¨æœŸæ—¶èƒ½åŠæ—¶å«åœå¼‚æ­¥çš„ä»»åŠ¡å°±å¥½äº†ï¼Œ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200326095005.gif" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘ä»¬ä¸å¦¨å…ˆæ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœå®ç°è¿™æ ·çš„æƒ³æ³•ï¼Œåº”è¯¥å¦‚ä½•åš</p><h3 id="æŒ‰ç…§æƒ¯ä¾‹çš„æ€è€ƒ"><a href="#æŒ‰ç…§æƒ¯ä¾‹çš„æ€è€ƒ" class="headerlink" title="æŒ‰ç…§æƒ¯ä¾‹çš„æ€è€ƒ"></a>æŒ‰ç…§æƒ¯ä¾‹çš„æ€è€ƒ</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ¥æ•´ç†ä¸€ä¸‹æˆ‘ä»¬çš„éœ€æ±‚</p><ul><li>å†…éƒ¨ç»„ä»¶èƒ½å¤Ÿæ„ŸçŸ¥å¤–éƒ¨çš„ç”Ÿå‘½å‘¨æœŸ</li><li>èƒ½å¤Ÿç»Ÿä¸€åœ°ç®¡ç†ï¼Œåšåˆ°ä¸€å¤„ä¿®æ”¹ï¼Œå¤„å¤„ç”Ÿæ•ˆ</li><li>èƒ½å¤ŸåŠæ—¶å«åœé”™è¿‡çš„ä»»åŠ¡</li></ul><p>é’ˆå¯¹éœ€æ±‚1ï¼Œå¯ä»¥ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå†…éƒ¨ç»„ä»¶èƒ½å¤Ÿåœ¨å¤–éƒ¨ç”Ÿå‘½å‘¨æœŸå˜åŒ–æ—¶åšå‡ºç›¸åº”</p><p>é’ˆå¯¹éœ€æ±‚2ï¼Œå¯ä»¥å°†ä¾èµ–ç»„ä»¶çš„ä»£ç ç§»å‡ºç”Ÿå‘½å‘¨æœŸæ–¹æ³•å†…ï¼Œç„¶åç§»å…¥ç»„ä»¶æœ¬èº«ï¼Œè¿™æ ·åªéœ€ä¿®æ”¹ç»„ä»¶å†…éƒ¨é€»è¾‘å³å¯</p><p>é’ˆå¯¹éœ€æ±‚3ï¼Œå¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºç§»é™¤è§‚å¯Ÿè€…</p><h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p>å…³äºå¼€å‘è€…æ¨¡å¼ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¯”è¾ƒè¯¦ç»†çš„äº†è§£æ˜¯åœ¨ <a href="https://juejin.im/user/552f20a7e4b060d72a89d87f" target="_blank" rel="noopener">æ‰”ç‰©çº¿</a> çš„ <a href="https://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="noopener">ç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£</a>ã€‚</p><blockquote><p>è§‚å¯Ÿè€…æ¨¡å¼é¢å‘çš„éœ€æ±‚æ˜¯ï¼šA å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…ï¼‰å¯¹ B å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰çš„æŸç§å˜åŒ–é«˜åº¦æ•æ„Ÿï¼Œéœ€è¦åœ¨ B å˜åŒ–çš„ä¸€ç¬é—´åšå‡ºååº”ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ–°é—»é‡Œå–œé—»ä¹è§çš„è­¦å¯ŸæŠ“å°å·ï¼Œè­¦å¯Ÿéœ€è¦åœ¨å°å·ä¼¸æ‰‹ä½œæ¡ˆçš„æ—¶å€™å®æ–½æŠ“æ•ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œè­¦å¯Ÿæ˜¯è§‚å¯Ÿè€…ï¼Œå°å·æ˜¯è¢«è§‚å¯Ÿè€…ï¼Œè­¦å¯Ÿéœ€è¦æ—¶åˆ»ç›¯ç€å°å·çš„ä¸€ä¸¾ä¸€åŠ¨ï¼Œæ‰èƒ½ä¿è¯ä¸ä¼šæ¼è¿‡ä»»ä½•ç¬é—´ã€‚ç¨‹åºçš„è§‚å¯Ÿè€…æ¨¡å¼å’Œè¿™ç§çœŸæ­£çš„ã€è§‚å¯Ÿã€ç•¥æœ‰ä¸åŒï¼Œè§‚å¯Ÿè€…ä¸éœ€è¦æ—¶åˆ»ç›¯ç€è¢«è§‚å¯Ÿè€…ï¼ˆä¾‹å¦‚ A ä¸éœ€è¦æ¯è¿‡ 2ms å°±æ£€æŸ¥ä¸€æ¬¡ B çš„çŠ¶æ€ï¼‰ï¼Œè€Œæ˜¯é‡‡ç”¨<strong>æ³¨å†Œ</strong>(Register)<strong>æˆ–è€…ç§°ä¸º</strong>è®¢é˜…<strong>(Subscribe)</strong>çš„æ–¹å¼ï¼Œå‘Šè¯‰è¢«è§‚å¯Ÿè€…ï¼šæˆ‘éœ€è¦ä½ çš„æŸæŸçŠ¶æ€ï¼Œä½ è¦åœ¨å®ƒå˜åŒ–çš„æ—¶å€™é€šçŸ¥æˆ‘ã€‚ Android å¼€å‘ä¸­ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„ä¾‹å­æ˜¯ç‚¹å‡»ç›‘å¬å™¨ <code>OnClickListener</code> ã€‚å¯¹è®¾ç½® <code>OnClickListener</code> æ¥è¯´ï¼Œ <code>View</code> æ˜¯è¢«è§‚å¯Ÿè€…ï¼Œ <code>OnClickListener</code> æ˜¯è§‚å¯Ÿè€…ï¼ŒäºŒè€…é€šè¿‡ <code>setOnClickListener()</code> æ–¹æ³•è¾¾æˆè®¢é˜…å…³ç³»ã€‚è®¢é˜…ä¹‹åç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„ç¬é—´ï¼ŒAndroid Framework å°±ä¼šå°†ç‚¹å‡»äº‹ä»¶å‘é€ç»™å·²ç»æ³¨å†Œçš„ <code>OnClickListener</code> ã€‚é‡‡å–è¿™æ ·è¢«åŠ¨çš„è§‚å¯Ÿæ–¹å¼ï¼Œæ—¢çœå»äº†åå¤æ£€ç´¢çŠ¶æ€çš„èµ„æºæ¶ˆè€—ï¼Œä¹Ÿèƒ½å¤Ÿå¾—åˆ°æœ€é«˜çš„åé¦ˆé€Ÿåº¦ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå¾—ç›Šäºæˆ‘ä»¬å¯ä»¥éšæ„å®šåˆ¶è‡ªå·±ç¨‹åºä¸­çš„è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ï¼Œè€Œè­¦å¯Ÿå”å”æ˜æ˜¾æ— æ³•è¦æ±‚å°å·ã€ä½ åœ¨ä½œæ¡ˆçš„æ—¶å€™åŠ¡å¿…é€šçŸ¥æˆ‘ã€ã€‚</p></blockquote><p>OnClickListener çš„æ¨¡å¼å¤§è‡´å¦‚ä¸‹å›¾ï¼š</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200326103024.jpg" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p>ä¸Šè¿°æè¿°åŠå›¾ç‰‡å‡æ¥è‡ª <a href="https://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="noopener">ç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£</a></p></blockquote><p><strong>å› æ­¤åœ¨ç”Ÿå‘½å‘¨æœŸç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–æ—¶å‘Šè¯‰è§‚å¯Ÿè€…ï¼Œå†…éƒ¨ç»„ä»¶å³å¯æ„ŸçŸ¥å¤–éƒ¨çš„ç”Ÿå‘½å‘¨æœŸ</strong></p><h3 id="å¼•å…¥-Lifecycle-å"><a href="#å¼•å…¥-Lifecycle-å" class="headerlink" title="å¼•å…¥ Lifecycle å"></a>å¼•å…¥ Lifecycle å</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LifecycleObserver</span> </span>&#123;<br>    <span class="hljs-meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_RESUME)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connectListener</span><span class="hljs-params">()</span> </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_PAUSE)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disconnectListener</span><span class="hljs-params">()</span> </span>&#123;<br>        ...<br>    &#125;<br>&#125;<br><br>myLifecycleOwner.getLifecycle().addObserver(<span class="hljs-keyword">new</span> MyObserver());<br></code></pre></td></tr></table></figure><h2 id="æºç ç»“æ„"><a href="#æºç ç»“æ„" class="headerlink" title="æºç ç»“æ„"></a>æºç ç»“æ„</h2><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200326134237.png" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™æ˜¯ <a href="https://developer.android.com/reference/androidx/lifecycle/Lifecycle" target="_blank" rel="noopener">Lifecycle</a>  çš„ç»“æ„ï¼ŒæŠ½è±¡ç±»ï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ªæšä¸¾ï¼Œåˆ†åˆ«ä»£è¡¨ç€ã€Œäº‹ä»¶ã€å’Œã€ŒçŠ¶æ€ã€ï¼Œæ­¤å¤–è¿˜æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼Œæ·»åŠ /ç§»é™¤è§‚å¯Ÿè€…ï¼Œè·å–å½“å‰çŠ¶æ€</p><blockquote><p><strong>æ³¨æ„ï¼Œè¿™é‡Œ State ä¸­çš„æšä¸¾é¡ºåºæ˜¯æœ‰æ„ä¹‰çš„ï¼Œåæ–‡è¯¦ç»†ä»‹ç»</strong></p></blockquote><p>å…¶å®ç°ç±»ä¸º  <a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleRegistry" target="_blank" rel="noopener">LifecycleRegistry</a> ï¼Œå¯ä»¥å¤„ç†å¤šä¸ªè§‚å¯Ÿè€…</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200326135029.png" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="LifecycleRegistry"></p><p>å…¶å†…éƒ¨æŒæœ‰å½“å‰çš„çŠ¶æ€ mState ï¼ŒLifecycleOwner ä»¥åŠè§‚å¯Ÿè€…çš„è‡ªå®šä¹‰åˆ—è¡¨ï¼ŒåŒæ—¶é‡å†™äº†çˆ¶ç±»çš„æ·»åŠ /åˆ é™¤è§‚å¯Ÿè€…çš„æ–¹æ³•</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200326135636.png" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="LifecycleOwner"></p><p><a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner" target="_blank" rel="noopener">LifecycleOwner</a> ï¼Œå…·æœ‰ Android çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®šåˆ¶ç»„ä»¶å¯ä»¥ä½¿ç”¨è¿™äº›äº‹ä»¶æ¥å¤„ç†ç”Ÿå‘½å‘¨æœŸæ›´æ”¹ï¼Œè€Œæ— éœ€åœ¨ Activity æˆ– Fragment ä¸­å®ç°ä»»ä½•ä»£ç </p><p><a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleObserver" target="_blank" rel="noopener">LifecycleObserver</a> ï¼Œå°†ä¸€ä¸ªç±»æ ‡è®°ä¸º <code>LifecycleObserver</code>ã€‚ å®ƒæ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼Œè€Œæ˜¯ä¾èµ–äº OnLifecycleEvent æ³¨è§£çš„æ–¹æ³•</p><p><a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleEventObserver" target="_blank" rel="noopener">LifecycleEventObserver</a> ï¼Œå¯ä»¥æ¥æ”¶ä»»ä½•ç”Ÿå‘½å‘¨æœŸæ›´æ”¹å¹¶å°†å…¶åˆ†æ´¾ç»™æ¥æ”¶æ–¹ã€‚</p><p><strong>å¦‚æœä¸€ä¸ªç±»å®ç°æ­¤æ¥å£å¹¶åŒæ—¶ä½¿ç”¨ OnLifecycleEventï¼Œåˆ™æ³¨è§£å°†è¢«å¿½ç•¥</strong></p><p><a href="https://developer.android.com/reference/androidx/lifecycle/DefaultLifecycleObserver" target="_blank" rel="noopener">DefaultLifecycleObserver</a> ï¼Œç”¨äºç›‘å¬ <a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner" target="_blank" rel="noopener">LifecycleOwner</a> çŠ¶æ€æ›´æ”¹çš„å›è°ƒæ¥å£ã€‚</p><p>å¦‚æœä¸€ä¸ªç±»åŒæ—¶å®ç°äº†æ­¤æ¥å£å’Œ <a href="https://developer.android.com/reference/androidx/lifecycle/LifecycleEventObserver" target="_blank" rel="noopener">LifecycleEventObserver</a>ï¼Œåˆ™å°†é¦–å…ˆè°ƒç”¨<code>DefaultLifecycleObserver</code> çš„æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨LifecycleEventObserver.onStateChangedï¼ˆLifecycleOwnerï¼ŒLifecycle.Eventï¼‰</p><blockquote><p>æ³¨æ„ï¼šä½¿ç”¨ <a href="https://developer.android.com/reference/androidx/lifecycle/DefaultLifecycleObserver" target="_blank" rel="noopener">DefaultLifecycleObserver</a> éœ€å¼•å…¥</p><p> implementation â€œandroidx.lifecycle:lifecycle-common-java8:$lifecycle_versionâ€</p></blockquote><h2 id="ç®€å•çš„æºç åˆ†æ"><a href="#ç®€å•çš„æºç åˆ†æ" class="headerlink" title="ç®€å•çš„æºç åˆ†æ"></a>ç®€å•çš„æºç åˆ†æ</h2><h3 id="activity-ç”Ÿå‘½å‘¨æœŸå¤„ç†"><a href="#activity-ç”Ÿå‘½å‘¨æœŸå¤„ç†" class="headerlink" title="activity ç”Ÿå‘½å‘¨æœŸå¤„ç†"></a>activity ç”Ÿå‘½å‘¨æœŸå¤„ç†</h3><p>é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹ <strong>androidx.activity.ComponentActivity</strong> ï¼Œè¿™ä¸ªç±»æˆ‘ä»¬è¿™ä¸ªç³»åˆ—çš„æ–‡ç« é‡Œæåˆ°å¤šæ¬¡ï¼Œç¬¬ä¸€æ¬¡æåŠæ˜¯åœ¨ <a href="https://juejin.im/post/5e738d12518825495d69cfb9#heading-2" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘ç»ä¸ä¸¢å¤±çš„çŠ¶æ€ androidx SaveState ViewModel-SaveState åˆ†æ</a> ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹ã€‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200327104836.png" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ComponentActivity"></p><p>å…¶å®ç°çš„æ¥å£å¤§å¤šæ•°æˆ‘ä»¬éƒ½å·²ç»æ¢è®¨è¿‡äº†ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹ LifecycleOwner</p><blockquote><p>ActivityResultCaller ä¸º activity 1.2.0-alpha02 æ¨å‡ºçš„ï¼Œæ—¨åœ¨ç»Ÿä¸€ onActivityResult ï¼Œè¿™é‡Œæš‚æ—¶ä¸è®¨è®ºå®ƒ</p></blockquote><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200327105352.png" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æ—¢ç„¶å®ç°äº† <code>LifecycleOwner</code> æ¥å£ï¼Œå¿…å®šé‡å†™ getLifecycle() æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// androidx.activity.ComponentActivity.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LifecycleRegistry mLifecycleRegistry = <span class="hljs-keyword">new</span> LifecycleRegistry(<span class="hljs-keyword">this</span>);<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Lifecycle <span class="hljs-title">getLifecycle</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> mLifecycleRegistry;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶è¿”å›çš„ <code>Lifecycle</code> ä¸º å®ç°ç±» <code>LifecycleRegistry</code> çš„å®ä¾‹</p><p>è€Œ activity æ“ä½œç”Ÿå‘½å‘¨æœŸæ˜¯é€šè¿‡ <code>ReportFragment</code> å¤„ç†çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// androidx.activity.ComponentActivity.java</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>    ReportFragment.injectIfNeededIn(<span class="hljs-keyword">this</span>);<br>    <span class="hljs-comment">//...</span><br>&#125;<br><br><span class="hljs-comment">// ReportFragment</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">injectIfNeededIn</span><span class="hljs-params">(Activity activity)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">29</span>) &#123;<br>        <span class="hljs-comment">// api 29 åŠä»¥ä¸Š ç›´æ¥æ³¨å†Œæ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ</span><br>        activity.registerActivityLifecycleCallbacks(<br>                <span class="hljs-keyword">new</span> LifecycleCallbacks());<br>    &#125;<br>    android.app.FragmentManager manager = activity.getFragmentManager();<br>    <span class="hljs-keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="hljs-keyword">null</span>) &#123;<br>        manager.beginTransaction().add(<span class="hljs-keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();<br>        manager.executePendingTransactions();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200327113340.png" src="/2020/03/30/Jetpack-Lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ReportFragment.java</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(@NonNull Activity activity, @NonNull Lifecycle.Event event)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">instanceof</span> LifecycleRegistryOwner) &#123;<br>        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">instanceof</span> LifecycleOwner) &#123;<br>        Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();<br>        <span class="hljs-keyword">if</span> (lifecycle <span class="hljs-keyword">instanceof</span> LifecycleRegistry) &#123;<br>            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(@NonNull Lifecycle.Event event)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="hljs-number">29</span>) &#123;<br>        dispatch(getActivity(), event);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityCreated</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onActivityCreated(savedInstanceState);<br>    dispatch(Lifecycle.Event.ON_CREATE);<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onStart();<br>    dispatch(Lifecycle.Event.ON_START);<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResume</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onResume();<br>    dispatch(Lifecycle.Event.ON_RESUME);<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPause</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onPause();<br>    dispatch(Lifecycle.Event.ON_PAUSE);<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onStop();<br>    dispatch(Lifecycle.Event.ON_STOP);<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onDestroy();<br>    dispatch(Lifecycle.Event.ON_DESTROY);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LifecycleCallbacks</span><br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LifecycleCallbacks</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Application</span>.<span class="hljs-title">ActivityLifecycleCallbacks</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPostCreated</span><span class="hljs-params">(@NonNull Activity activity,<br>            @Nullable Bundle savedInstanceState)</span> </span>&#123;<br>        dispatch(activity, Lifecycle.Event.ON_CREATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPostStarted</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>        dispatch(activity, Lifecycle.Event.ON_START);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPostResumed</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>        dispatch(activity, Lifecycle.Event.ON_RESUME);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPrePaused</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>        dispatch(activity, Lifecycle.Event.ON_PAUSE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPreStopped</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>        dispatch(activity, Lifecycle.Event.ON_STOP);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityPreDestroyed</span><span class="hljs-params">(@NonNull Activity activity)</span> </span>&#123;<br>        dispatch(activity, Lifecycle.Event.ON_DESTROY);<br>    &#125;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ activity çš„ onCreate æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº† <code>ReportFragment</code> ä¸­çš„é™æ€æ–¹æ³• <code>injectIfNeededIn()</code> ã€‚è€Œå…¶å†…éƒ¨ï¼Œ<strong>å¦‚æœ api 29 åŠä»¥ä¸Šçš„è®¾å¤‡ä¸Šç›´æ¥æ³¨å†Œæ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œä½ç‰ˆæœ¬é€šè¿‡å¯åŠ¨ ReportFragment ï¼Œå€ŸåŠ© fragment å„ä¸ªç”Ÿå‘½å‘¨æœŸæ¥å¤„ç†ç”Ÿå‘½å‘¨æœŸå›è°ƒ</strong></p><h3 id="fragment-ç”Ÿå‘½å‘¨æœŸå¤„ç†"><a href="#fragment-ç”Ÿå‘½å‘¨æœŸå¤„ç†" class="headerlink" title="fragment ç”Ÿå‘½å‘¨æœŸå¤„ç†"></a>fragment ç”Ÿå‘½å‘¨æœŸå¤„ç†</h3><p>åœ¨ fragment å†…éƒ¨ï¼Œæ¯ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹è°ƒç”¨ <code>handleLifecycleEvent</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Fragment.java</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Fragment</span><span class="hljs-params">()</span> </span>&#123;<br>    initLifecycle();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initLifecycle</span><span class="hljs-params">()</span> </span>&#123;<br>    mLifecycleRegistry = <span class="hljs-keyword">new</span> LifecycleRegistry(<span class="hljs-keyword">this</span>);<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Lifecycle <span class="hljs-title">getLifecycle</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> mLifecycleRegistry;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>&#123;<br>    onCreate(savedInstanceState);<br>mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);    <br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performStart</span><span class="hljs-params">()</span> </span>&#123;<br>    onStart();<br>    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performResume</span><span class="hljs-params">()</span> </span>&#123;<br>    onResume();<br>    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);    <br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performPause</span><span class="hljs-params">()</span> </span>&#123;<br>    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);<br>    onPause();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performStop</span><span class="hljs-params">()</span> </span>&#123;<br>    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);<br>    onStop();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performDestroy</span><span class="hljs-params">()</span> </span>&#123;<br>    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_DESTROY);<br>    onDestroy();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Lifecycle-State-å¤§å°æ¯”è¾ƒ"><a href="#Lifecycle-State-å¤§å°æ¯”è¾ƒ" class="headerlink" title="Lifecycle State å¤§å°æ¯”è¾ƒ"></a>Lifecycle State å¤§å°æ¯”è¾ƒ</h3><p><code>Lifecycle.State</code>  ä¸­æœ‰ä¸€ä¸ª <code>isAtLeast</code> æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­å½“å‰çŠ¶æ€æ˜¯å¦ä¸å°äºä¼ å…¥çš„çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Lifecycle.State</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAtLeast</span><span class="hljs-params">(@NonNull State state)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> compareTo(state) &gt;= <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æšä¸¾çš„ compareTo æ–¹æ³•å…¶å®æ˜¯æ¯”è¾ƒçš„æšä¸¾å£°æ˜çš„é¡ºåº</strong></p><p>è€Œ State çš„é¡ºåºä¸º DESTROYED -&gt; INITIALIZED -&gt; CREATED -&gt; STARTED -&gt; RESUMED</p><blockquote><p>å¦‚æœä¼ å…¥çš„ state ä¸º STARTEDï¼Œåˆ™å½“å‰çŠ¶æ€ä¸º STARTED æˆ– RESUMED æ—¶è¿”å› true ï¼Œå¦åˆ™è¿”å› false</p><p>LiveData ç¯‡ä¼šç”¨åˆ°è¿™ä¸ªçŸ¥è¯†ç‚¹</p></blockquote><h2 style="color: inherit; line-height: inherit; padding: 0px; margin: 1.6em 0px; font-weight: bold; border-bottom: 2px solid #9370DB; font-size: 1.3em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; font-weight: normal; background: #9370DB; color: rgb(255, 255, 255); padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;"> å…³äºæˆ‘</span></h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></li><li><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></li><li><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹ViewModelã€‘å³ä½¿æ‚¨ä¸ä½¿ç”¨MVVMä¹Ÿè¦äº†è§£ViewModel ViewModelçš„èŒèƒ½è¾¹ç•Œ</title>
      <link href="/2020/03/23/Jetpack-ViewModel/"/>
      <url>/2020/03/23/Jetpack-ViewModel/</url>
      
        <content type="html"><![CDATA[<p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324083031.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ç›®å½•"></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>Android å¼€å‘æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ activity å’Œ fragment ä½œä¸ºè§†å›¾æ§åˆ¶å™¨ï¼Œ å¯èƒ½è¿˜ä¼šä½¿ç”¨æœ‰ä¸€äº›ç±»å¯ä»¥å­˜å‚¨å’Œæä¾› UI æ•°æ®ï¼ˆä¾‹å¦‚MVPä¸­çš„ <code>Presenter</code> ï¼‰</p></blockquote><p>ä½†æ˜¯ å½“é…ç½®æ›´æ”¹æ—¶ï¼ˆå¦‚æ—‹è½¬å±å¹•ï¼‰ï¼Œactivity ä¼šé‡å»ºï¼Œä½†å¯¹äº UI æ•°æ®çš„æŒæœ‰è€…å‘¢ï¼Ÿ</p><ul><li>å¼€å‘è€…éœ€è¦é‡æ–°ä¿å­˜ç›¸å…³çš„ä¿¡æ¯å¹¶ä¼ é€’ç»™é‡å»ºçš„ activity ï¼Œå¦åˆ™å¼€å‘è€…å¿…é¡»å†æ¬¡è·å–æ•°æ®ï¼ˆé€šè¿‡ç½‘ç»œè¯·æ±‚æˆ–æœ¬åœ°æ•°æ®åº“ï¼‰</li><li>ç”±äº UI æ•°æ®çš„æŒæœ‰è€…çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯” activity é•¿ï¼Œå› æ­¤å¼€å‘è€…è¿˜éœ€è¦é¿å…å‡ºç°å†…å­˜æ³„æ¼çš„é—®é¢˜</li></ul><p>å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŸViewModel</p><p><strong>æœ¬æ–‡é‡ç‚¹ä»‹ç» ViewModel çš„èŒè´£ï¼ˆwhatï¼‰ä»¥åŠé‡ç‚¹åŠŸèƒ½çš„å®ç°åŸç†ï¼ˆhowï¼‰ï¼Œå³ä½¿æ‚¨ä¸ä½¿ç”¨ <code>Jetpack MVVM</code> æ¶æ„ï¼Œä¹Ÿè¦äº†è§£ä¸€ä¸‹ ViewModel</strong></p><p>ViewModel çš„åŸç†éƒ¨åˆ†è¦æ±‚æ‚¨äº†è§£ activity çš„å¯åŠ¨æµç¨‹ï¼Œè¿™éƒ¨åˆ†å†…å®¹ç½‘ä¸Šæ–‡ç« å¾ˆå¤šï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°</p><a id="more"></a><h2 id="ViewModel-çš„èŒè´£"><a href="#ViewModel-çš„èŒè´£" class="headerlink" title="ViewModel çš„èŒè´£"></a>ViewModel çš„èŒè´£</h2><p>æˆ‘å…ˆä¸Šä¸ª <a href="https://www.bilibili.com/video/av97794796/" target="_blank" rel="noopener">è§†é¢‘</a> ï¼Œè¿™ä¸ªå°å§å§è¡¨è¿°çš„æ¯”æ–‡å­—æ›´å½¢è±¡</p><p><a href="https://www.bilibili.com/video/av97794796/" target="_blank" rel="noopener"><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321135602.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></a></p><p><code>ViewModel</code> ä¸»è¦ç”¨äºå­˜å‚¨ UI æ•°æ®ä»¥åŠç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„æ•°æ®</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321140300.gif" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://android.jlelse.eu/android-architecture-components-viewmodel-e74faddf5b94" target="_blank" rel="noopener">Android Architecture Components: ViewModel</a></p></blockquote><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321140641.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ViewModelç”Ÿå‘½å‘¨æœŸ"></p><blockquote><p><code>ViewModel</code> çš„ç”Ÿå‘½å‘¨æœŸ ï¼Œå›¾ç‰‡æ¥è‡ª <a href="https://developer.android.com/topic/libraries/architecture/viewmodel#lifecycle" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p></blockquote><h3 id="ä½œä¸ºæ•°æ®æŒæœ‰è€…"><a href="#ä½œä¸ºæ•°æ®æŒæœ‰è€…" class="headerlink" title="ä½œä¸ºæ•°æ®æŒæœ‰è€…"></a>ä½œä¸ºæ•°æ®æŒæœ‰è€…</h3><p><code>ViewModel</code> èƒ½å¤Ÿå®æ—¶è¿›è¡Œé…ç½®æ›´æ”¹ã€‚ è¿™æ„å‘³ç€å³ä½¿åœ¨æ‰‹æœºæ—‹è½¬åé”€æ¯å¹¶é‡æ–°åˆ›å»º activity ä¹‹åï¼Œæ‚¨ä»ç„¶æ‹¥æœ‰ç›¸åŒçš„ <code>ViewModel</code> å’Œç›¸åŒçš„æ•°æ®ã€‚ å› æ­¤ï¼š</p><ul><li>æ‚¨æ— éœ€æ‹…å¿ƒ UI æ•°æ®æŒæœ‰è€…çš„ç”Ÿå‘½å‘¨æœŸã€‚ <code>ViewModel</code> å°†ç”±å·¥å‚è‡ªåŠ¨åˆ›å»ºï¼Œæ‚¨æ— éœ€è‡ªè¡Œåˆ›å»ºå’Œé”€æ¯</li><li>æ•°æ®å°†å§‹ç»ˆæ›´æ–°ï¼Œæ—‹è½¬æ‰‹æœºåï¼Œæ‚¨å°†è·å¾—ä¸ä»¥å‰ç›¸åŒçš„æ•°æ®ã€‚ å› æ­¤ï¼Œæ‚¨æ— éœ€æ‰‹åŠ¨å°†æ•°æ®ä¼ é€’ç»™æ–°çš„ activity å®ä¾‹æˆ–å†æ¬¡è°ƒç”¨ç½‘ç»œæˆ–æ•°æ®åº“æ¥è·å–æ•°æ®ã€‚ </li></ul><h3 id="Fragment-é—´å…±äº«æ•°æ®"><a href="#Fragment-é—´å…±äº«æ•°æ®" class="headerlink" title="Fragment é—´å…±äº«æ•°æ®"></a>Fragment é—´å…±äº«æ•°æ®</h3><p>ä¸€ä¸ª activity ä¸­çš„ä¸¤ä¸ªæˆ–æ›´å¤š fragment éœ€è¦ç›¸äº’é€šä¿¡æ˜¯å¾ˆå¸¸è§çš„ã€‚ä¾‹å¦‚æ‚¨æœ‰ä¸€ä¸ªç‰‡æ®µï¼Œç”¨æˆ·åœ¨å…¶ä¸­ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª itemï¼Œå¦ä¸€ä¸ªç‰‡æ®µæ˜¾ç¤ºäº†æ‰€é€‰ item çš„å†…å®¹ã€‚ ä¼ ç»Ÿåšæ³•ä¸¤ä¸ª fragment éƒ½éœ€è¦å®šä¹‰ä¸€äº›æ¥å£ï¼Œå¹¶ä¸”å®¿ä¸» activity å¿…é¡»å°†ä¸¤è€…ç»‘å®šåœ¨ä¸€èµ·ã€‚ æ­¤å¤–ï¼Œä¸¤ä¸ª fragment éƒ½å¿…é¡»å¤„ç†å¦ä¸€ä¸ª fragment å°šæœªåˆ›å»ºæˆ–ä¸å¯è§çš„æƒ…å†µã€‚</p><p>å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>ViewModel</code> å¯¹è±¡è§£å†³æ­¤é—®é¢˜ã€‚ è¿™äº› fragment å¯ä»¥ä½¿ç”¨ activity èŒƒå›´å†…å…±äº«ä¸€ä¸ª <code>ViewModel</code> æ¥å¤„ç†æ­¤é€šä¿¡ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SharedViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MutableLiveData&lt;Item&gt; selected = <span class="hljs-keyword">new</span> MutableLiveData&lt;Item&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">select</span><span class="hljs-params">(Item item)</span> </span>&#123;<br>        selected.setValue(item);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> LiveData&lt;Item&gt; <span class="hljs-title">getSelected</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> selected;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MasterFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Fragment</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> SharedViewModel model;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(@NonNull View view, Bundle savedInstanceState)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState);<br>        model = <span class="hljs-keyword">new</span> ViewModelProvider(requireActivity()).get(SharedViewModel.class);<br>        itemSelector.setOnClickListener(item -&gt; &#123;<br>            model.select(item);<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DetailFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Fragment</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(@NonNull View view, Bundle savedInstanceState)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState);<br>        SharedViewModel model = <span class="hljs-keyword">new</span> ViewModelProvider(requireActivity()).get(SharedViewModel.class);<br>        model.getSelected().observe(getViewLifecycleOwner(), &#123; item -&gt;<br>           <span class="hljs-comment">// Update the UI.</span><br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç”±äº ä¸¤ä¸ª fragment ä½¿ç”¨çš„éƒ½æ˜¯ activity èŒƒå›´çš„ <code>ViewModel</code> ï¼ˆ<code>ViewModelProvider</code> æ„é€ å™¨ä¼ å…¥çš„ activity ï¼‰ï¼Œå› æ­¤å®ƒä»¬è·å¾—äº†ç›¸åŒçš„ ViewModel å®ä¾‹ï¼Œè‡ªç„¶å…¶æŒæœ‰çš„æ•°æ®ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œè¿™ä¹Ÿ <strong>ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§</strong></p></blockquote><p>è¿™ç§æ–¹æ³•å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li><p>å®¿ä¸» activity æ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œï¼Œä¹Ÿæ— éœ€äº†è§£æ­¤é€šä¿¡ã€‚</p></li><li><p>é™¤ <code>SharedViewModel</code> å¤–ï¼Œfragment ä¸éœ€è¦å½¼æ­¤äº†è§£ã€‚ å¦‚æœå…¶ä¸­ä¸€ä¸ª fragment æ¶ˆå¤±äº†ï¼Œåˆ™å¦ä¸€ä¸ªç»§ç»­ç…§å¸¸å·¥ä½œã€‚</p></li><li><p>æ¯ä¸ª fragment éƒ½æœ‰å…¶è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”ä¸å—å¦ä¸€ä¸ª fragment çš„ç”Ÿå‘½å‘¨æœŸå½±å“ã€‚ å¦‚æœä¸€ä¸ª fragment æ›¿æ¢äº†å¦ä¸€ä¸ª fragmentï¼Œåˆ™ UI å¯ä»¥ç»§ç»­æ­£å¸¸å·¥ä½œè€Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ã€‚</p></li></ul><h3 id="ä»£æ›¿-Loader"><a href="#ä»£æ›¿-Loader" class="headerlink" title="ä»£æ›¿ Loader"></a>ä»£æ›¿ Loader</h3><p><code>CursorLoader</code> è¿™æ ·çš„ Loader ç±»ç»å¸¸ç”¨äºä½¿åº”ç”¨ç¨‹åº UI ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¿æŒåŒæ­¥ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ <code>ViewModel</code> å’Œå…¶ä»–ä¸€äº›ç±»æ¥æ›¿æ¢ Loaderã€‚ ä½¿ç”¨ <code>ViewModel</code> å¯å°†è§†å›¾æ§åˆ¶å™¨ä¸æ•°æ®åŠ è½½æ“ä½œåˆ†å¼€ï¼Œè¿™æ„å‘³ç€æ‚¨åœ¨ç±»ä¹‹é—´çš„å¼ºå¼•ç”¨è¾ƒå°‘ã€‚</p><p>åœ¨ä½¿ç”¨ Loader çš„ä¸€ç§å¸¸è§æ–¹æ³•ä¸­ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šä½¿ç”¨ <code>CursorLoader</code> æ¥è§‚å¯Ÿæ•°æ®åº“çš„å†…å®¹ã€‚ å½“æ•°æ®åº“ä¸­çš„å€¼æ›´æ”¹æ—¶ï¼ŒåŠ è½½ç¨‹åºä¼šè‡ªåŠ¨è§¦å‘æ•°æ®çš„é‡æ–°åŠ è½½å¹¶æ›´æ–° UI</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321144832.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://developer.android.com/topic/libraries/architecture/viewmodel#loaders" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p></blockquote><p><code>ViewModel</code> ä¸ <code>Room</code> å’Œ <code>LiveData</code> ä¸€èµ·ä½¿ç”¨ä»¥æ›¿æ¢ Loaderã€‚ <code>ViewModel</code> ç¡®ä¿æ•°æ®åœ¨è®¾å¤‡é…ç½®æ›´æ”¹åä»ç„¶å­˜åœ¨ã€‚ å½“æ•°æ®åº“å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œ<code>Room</code> ä¼šé€šçŸ¥ <code>LiveData</code> ï¼Œç„¶å <code>LiveData</code> ä¼šä½¿ç”¨ä¿®æ”¹åçš„æ•°æ®æ›´æ–° UI</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321144949.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://developer.android.com/topic/libraries/architecture/viewmodel#loaders" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p></blockquote><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><strong>ViewModel å¯ä½œä¸º UI æ•°æ®çš„æŒæœ‰è€…ï¼Œåœ¨ activity/fragment é‡å»ºæ—¶ ViewModel ä¸­çš„æ•°æ®ä¸å—å½±å“ï¼ŒåŒæ—¶å¯ä»¥é¿å…å†…å­˜æ³„æ¼</strong></li><li><strong>å¯ä»¥é€šè¿‡ ViewModel æ¥è¿›è¡Œ activity å’Œ fragment ï¼Œfragment å’Œ fragment ä¹‹é—´çš„é€šä¿¡ï¼Œæ— éœ€å…³å¿ƒé€šä¿¡çš„å¯¹æ–¹æ˜¯å¦å­˜åœ¨ï¼Œä½¿ç”¨ application èŒƒå›´çš„ ViewModel å¯ä»¥è¿›è¡Œå…¨å±€é€šä¿¡</strong></li><li><strong>å¯ä»¥ä»£æ›¿ Loader</strong></li></ul><h2 id="ViewModel-æºç åˆ†æ"><a href="#ViewModel-æºç åˆ†æ" class="headerlink" title="ViewModel æºç åˆ†æ"></a>ViewModel æºç åˆ†æ</h2><p>åˆ†ææºç æ—¶æˆ‘ä»¬å¯ä»¥ä¸è®¡è¾ƒç»†ææœ«èŠ‚ï¼Œåªåˆ†æä¸»è¦çš„é€»è¾‘å³å¯ã€‚å› æ­¤æˆ‘ä»¬æ¥æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼Œå¹¶ä»æºç ä¸­å¯»æ‰¾ç­”æ¡ˆ</p><ul><li><p>å¦‚ä½•åšåˆ° activity é‡å»ºå <code>ViewModel</code> ä»ç„¶å­˜åœ¨ï¼Ÿ</p></li><li><p>å¦‚ä½•åšåˆ° fragment é‡å»ºå <code>ViewModel</code> ä»ç„¶å­˜åœ¨ï¼Ÿ</p></li><li><p>å¦‚ä½•æ§åˆ¶ä½œç”¨åŸŸï¼Ÿï¼ˆå³ä¿è¯ç›¸åŒä½œç”¨åŸŸè·å–çš„ <code>ViewModel</code> å®ä¾‹ç›¸åŒï¼‰</p></li><li><p>å¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ</p></li></ul><p>ç»´æŒæˆ‘ä»¬ä¸€è´¯çš„é£æ ¼ï¼Œæˆ‘ä»¬å…ˆæ¥å¤§èƒ†åœ°çŒœä¸€çŒœ</p><p>å¯¹äºé—®é¢˜1 ï¼šactivity æœ‰ç€ <code>saveInstanceState</code> æœºåˆ¶ï¼Œå› æ­¤å¯èƒ½é€šè¿‡è¯¥æœºåˆ¶æ¥å¤„ç†ï¼ˆ<strong>äº‹å®è¯æ˜ä¸æ˜¯</strong>ï¼‰</p><p>å¯¹äºé—®é¢˜2ï¼šå¯èƒ½ fragment é€šè¿‡ å®¿ä¸» activity æˆ– çˆ¶ fragment çš„å¸®åŠ©æ¥ç¡®ä¿ <code>ViewModel</code> å®ä¾‹åœ¨é‡å»ºåä»ç„¶å­˜åœ¨</p><p>å¯¹äºé—®é¢˜3ï¼šå®ç°ä¸€ä¸ªç±»ä¼¼å•ä¾‹çš„æ•ˆæœï¼Œç›¸åŒä½œç”¨åŸŸè·å–çš„å¯¹è±¡æ˜¯ç›¸åŒçš„</p><p>å¯¹äºé—®é¢˜4ï¼šé¿å… <code>ViewModel</code> æŒæœ‰ view æˆ– context çš„å¼•ç”¨</p><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆäº†è§£ä¸€ä¸‹ <code>ViewModel</code> çš„ç»“æ„</p><ul><li><p><code>ViewModel</code>ï¼šæŠ½è±¡ç±»ï¼Œä¸»è¦æœ‰ clear æ–¹æ³•ï¼Œå®ƒæ˜¯ final çº§ï¼Œä¸å¯ä¿®æ”¹ï¼Œclear æ–¹æ³•ä¸­åŒ…å« onClear é’©å­ï¼Œå¼€å‘è€…å¯é‡å†™ onClear æ–¹æ³•æ¥è‡ªå®šä¹‰æ•°æ®çš„æ¸…ç©º</p></li><li><p><code>ViewModelStore</code>ï¼šå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª HashMap ä»¥ç®¡ç† <code>ViewModel</code></p></li><li><p><code>ViewModelStoreOwner</code>ï¼šæ¥å£ï¼Œ<code>ViewModelStore</code> çš„ä½œç”¨åŸŸï¼Œå®ç°ç±»ä¸º <code>ComponentActivity</code> å’Œ <code>Fragment</code>ï¼Œæ­¤å¤–è¿˜æœ‰ <code>FragmentActivity.HostCallbacks</code></p></li><li><p><code>ViewModelProvider</code>ï¼šç”¨äºåˆ›å»º <code>ViewModel</code>ï¼Œå…¶æ„é€ æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ <code>ViewModelStoreOwner</code> ï¼Œç¡®å®šäº† <code>ViewModelStore</code> çš„ä½œç”¨åŸŸï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º <code>ViewModelProvider.Factory</code>ï¼Œç”¨äºåˆå§‹åŒ– <code>ViewModel</code> å¯¹è±¡ï¼Œé»˜è®¤ä¸º <code>getDefaultViewModelProviderFactory()</code> æ–¹æ³•è·å–çš„ factory</p></li></ul><p>ç®€å•æ¥è¯´ <strong>ViewModelStoreOwner æŒæœ‰ ViewModelStore æŒæœ‰ ViewModel</strong></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321152406.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h3 id="1-å¦‚ä½•åšåˆ°-activity-é‡å»ºå-ViewModel-ä»ç„¶å­˜åœ¨ï¼Ÿ"><a href="#1-å¦‚ä½•åšåˆ°-activity-é‡å»ºå-ViewModel-ä»ç„¶å­˜åœ¨ï¼Ÿ" class="headerlink" title="1. å¦‚ä½•åšåˆ° activity é‡å»ºå ViewModel ä»ç„¶å­˜åœ¨ï¼Ÿ"></a>1. å¦‚ä½•åšåˆ° activity é‡å»ºå ViewModel ä»ç„¶å­˜åœ¨ï¼Ÿ</h3><p>åœ¨ <a href="https://juejin.im/post/5e738d12518825495d69cfb9" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘ç»ä¸ä¸¢å¤±çš„çŠ¶æ€ androidx SaveState ViewModel-SaveState åˆ†æ</a> ä¸­æˆ‘ä»¬æåˆ°äº† androidx.core.app.ComponentActivity çš„å¼•å…¥å¹¶æ¢è®¨äº†å…¶ä½œä¸ºä¸­é—´å±‚çš„ä½œç”¨</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200321155215.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æˆ‘ä»¬å·²ç»è®²è¿‡ <code>SavedStateRegistryOwner</code> å’Œ <code>OnBackPressedDispatcherOwner</code> è¿™ä¸¤ç§è§’è‰²ï¼Œè€Œä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€ä¸‹</p><p><code>ViewModelStoreOwner</code> å’Œ <code>HasDefaultViewModelProviderFactory</code> ã€‚å…¶ä¸­å‰è€…ä»£è¡¨ç€ <code>ViewModelStore</code> çš„ä½œç”¨åŸŸï¼Œåè€…æ¥æ ‡è®° <code>ViewModelStoreOwner</code> æ‹¥æœ‰é»˜è®¤çš„ <code>ViewModelProvider.Factory</code></p><p>é‚£ä¹ˆ <code>ViewModel</code> çš„é€»è¾‘è‚¯å®šå°±åœ¨è¯¥ç±»äº†</p><p><code>ComponentActivity</code> å®ç°äº† <code>ViewModelStoreOwner</code>  æ¥å£ï¼Œæ„å‘³ç€éœ€è¦é‡å†™ <code>getViewModelStore()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸º <code>ComponentActivity</code>  çš„ <code>mViewModelStore</code> å˜é‡èµ‹å€¼ã€‚<strong>activity é‡å»ºå ViewModel ä»ç„¶å­˜åœ¨ï¼Œåªè¦ä¿è¯ activity é‡å»ºå mViewModelStore å˜é‡å€¼ä¸å˜å³å¯</strong></p><p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>getViewModelStore()</code> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ViewModelStore <span class="hljs-title">getViewModelStore</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (mViewModelStore == <span class="hljs-keyword">null</span>) &#123;<br>        NonConfigurationInstances nc =<br>                (NonConfigurationInstances) getLastNonConfigurationInstance();<br>        <span class="hljs-keyword">if</span> (nc != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">//æ ¸å¿ƒï¼Œåœ¨è¯¥ä½ç½®é‡ç½® mViewModelStore</span><br>            mViewModelStore = nc.viewModelStore;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (mViewModelStore == <span class="hljs-keyword">null</span>) &#123;<br>            mViewModelStore = <span class="hljs-keyword">new</span> ViewModelStore();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mViewModelStore;<br>&#125;<br></code></pre></td></tr></table></figure><p>å³ <code>mViewModelStore</code> çš„å€¼ç”± <code>getLastNonConfigurationInstance()</code> è¿”å›çš„ <code>NonConfigurationInstances</code> å¯¹è±¡ä¸­çš„ <code>viewModelStore</code> èµ‹å€¼ï¼Œå¦‚æœæ­¤æ—¶è¿˜ä¸ºç©ºæ‰å» new ViewModelStore å¯¹è±¡ã€‚å› æ­¤æˆ‘ä»¬åªéœ€æ‰¾åˆ° </p><p><code>getLastNonConfigurationInstance</code> ä¸­çš„ <code>NonConfigurationInstances</code> åœ¨å“ªé‡Œä¿å­˜çš„å³å¯</p><p><code>getLastNonConfigurationInstance</code> ä¸ºå¹³å° activity ä¸­çš„æ–¹æ³•ï¼Œè¿”å› <code>mLastNonConfigurationInstances.activity</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getLastNonConfigurationInstance</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> mLastNonConfigurationInstances != <span class="hljs-keyword">null</span><br>            ? mLastNonConfigurationInstances.activity : <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>mLastNonConfigurationInstances</code> çš„èµ‹å€¼ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//çœç•¥å…¶ä»–å‚æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">attach</span><span class="hljs-params">(NonConfigurationInstances lastNonConfigurationInstances)</span></span>&#123;<br>mLastNonConfigurationInstances = lastNonConfigurationInstances;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>äº†è§£è¿‡ activity çš„å¯åŠ¨æµç¨‹çš„å°ä¼™ä¼´è‚¯å®šçŸ¥é“ï¼Œè¿™ä¸ª attach æ–¹æ³•æ˜¯ <code>ActivityThread</code> ä¸­çš„ <code>performLaunchActivity</code> è°ƒç”¨çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Activity <span class="hljs-title">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;<br>    Activity activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);<br>    <span class="hljs-comment">//çœç•¥å…¶ä»–å‚æ•°</span><br>    activity.attach(r.lastNonConfigurationInstances);<br>    r.lastNonConfigurationInstances = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ·±å…¥è¿½è¸ªæºç æˆ‘ä»¬æ•´ç†ä¸€ä¸‹è°ƒç”¨æµç¨‹</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200323114334.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ç”±äº <code>ActivityThread</code> ä¸­çš„ <code>ActivityClientRecord</code> ä¸å— activity é‡å»ºçš„å½±å“ï¼Œæ‰€ä»¥ activity é‡å»ºæ—¶ <code>mLastNonConfigurationInstances</code> èƒ½å¤Ÿå¾—åˆ°ä¸Šä¸€æ¬¡çš„å€¼ï¼Œä½¿å¾— <code>ViewModelStore</code> å€¼ä¸å˜ ï¼Œé—®é¢˜1å°±è§£å†³äº†</p><h3 id="2-å¦‚ä½•åšåˆ°-fragment-é‡å»ºå-ViewModel-ä»ç„¶å­˜åœ¨ï¼Ÿ"><a href="#2-å¦‚ä½•åšåˆ°-fragment-é‡å»ºå-ViewModel-ä»ç„¶å­˜åœ¨ï¼Ÿ" class="headerlink" title="2. å¦‚ä½•åšåˆ° fragment é‡å»ºå ViewModel ä»ç„¶å­˜åœ¨ï¼Ÿ"></a>2. å¦‚ä½•åšåˆ° fragment é‡å»ºå ViewModel ä»ç„¶å­˜åœ¨ï¼Ÿ</h3><p>å¯¹äºé—®é¢˜2ï¼Œæœ‰äº†ä¸Šé¢çš„æ€è·¯æˆ‘ä»¬å¯ä»¥è®¤å®š fragment é‡å»ºåå…¶å†…éƒ¨çš„ <code>getViewModelStore()</code> æ–¹æ³•è¿”å›çš„å¯¹è±¡æ˜¯ç›¸åŒçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Fragment.java</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ViewModelStore <span class="hljs-title">getViewModelStore</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> mFragmentManager.getViewModelStore(<span class="hljs-keyword">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>getViewModelStore()</code> å†…éƒ¨è°ƒç”¨çš„æ˜¯ <code>mFragmentManager</code>ï¼ˆæ™®é€šfragment å¯¹åº” activity ä¸­çš„ <code>FragmentManager</code>ï¼Œå­ fragment åˆ™å¯¹åº”çˆ¶ fragment çš„ <code>childFragmentManager</code>ï¼‰çš„ <code>getViewModelStore()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FragmentManager.java</span><br><span class="hljs-keyword">private</span> FragmentManagerViewModel mNonConfig;<br><br><span class="hljs-function">ViewModelStore <span class="hljs-title">getViewModelStore</span><span class="hljs-params">(@NonNull Fragment f)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> mNonConfig.getViewModelStore(f);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è€Œ FragmentManager ä¸­çš„ getViewModelStore ä½¿ç”¨çš„æ˜¯ mNonConfig ï¼ŒmNonConfig ç«Ÿç„¶æ˜¯ä¸ª ViewModelï¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FragmentManagerViewModel.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String, FragmentManagerViewModel&gt; mChildNonConfigs = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String, ViewModelStore&gt; mViewModelStores = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br></code></pre></td></tr></table></figure><p><code>FragmentManagerViewModel</code> ç®¡ç†ç€å†…éƒ¨çš„ <code>ViewModelStore</code> å’Œ child çš„ <code>FragmentManagerViewModel</code> ã€‚å› æ­¤ä¿è¯ mNonConfig   å€¼ä¸å˜å³èƒ½ç¡®ä¿ fragment ä¸­çš„ <code>getViewModelStore()</code>  ä¸å˜ã€‚é‚£ä¹ˆçœ‹çœ‹ mNonConfig  èµ‹å€¼çš„ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FragmentManager.java</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">attachController</span><span class="hljs-params">(@NonNull FragmentHostCallback&lt;?&gt; host, @NonNull FragmentContainer container, @Nullable <span class="hljs-keyword">final</span> Fragment parent)</span> </span>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">// åµŒå¥— fragment çš„æƒ…å†µï¼Œæœ‰çˆ¶ fragment</span><br>        mNonConfig = parent.mFragmentManager.getChildNonConfig(parent);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (host <span class="hljs-keyword">instanceof</span> ViewModelStoreOwner) &#123;<br>        <span class="hljs-comment">// host æ˜¯ FragmentActivity.HostCallbacks</span><br>        ViewModelStore viewModelStore = ((ViewModelStoreOwner) host).getViewModelStore();<br>        mNonConfig = FragmentManagerViewModel.getInstance(viewModelStore);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mNonConfig = <span class="hljs-keyword">new</span> FragmentManagerViewModel(<span class="hljs-keyword">false</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// FragmentManagerViewModel.java</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> FragmentManagerViewModel <span class="hljs-title">getInstance</span><span class="hljs-params">(ViewModelStore viewModelStore)</span> </span>&#123;<br>    ViewModelProvider viewModelProvider = <span class="hljs-keyword">new</span> ViewModelProvider(viewModelStore,<br>            FACTORY);<br>    <span class="hljs-keyword">return</span> viewModelProvider.get(FragmentManagerViewModel.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆçœ‹ fragment çš„ç›´æ¥å®¿ä¸»æ˜¯ activity ï¼ˆå³æ²¡æœ‰åµŒå¥—ï¼‰çš„æƒ…å†µï¼ŒmNonConfig ç”±<code>FragmentManagerViewModel.getInstance(viewModelStore)</code> èµ‹å€¼ï¼Œè€Œ getInstance ä¸­ä½¿ç”¨çš„æ˜¯ <code>ViewModelProvider</code> è·å– <code>ViewModel</code> ï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„åˆ†æï¼Œ<strong>åªè¦ä¿è¯ä½œç”¨åŸŸï¼ˆviewModelStoreï¼‰ç›¸åŒï¼Œå³å¯è·å–ç›¸åŒçš„ <code>ViewModel</code> å®ä¾‹</strong>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹ host çš„ getViewModelStore æ–¹æ³•ã€‚ç»è¿‡ä¸€ç•ªå¯»æ‰¾ï¼Œhost æ˜¯ <code>FragmentActivity.HostCallbacks</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FragmentActivity.java å†…éƒ¨ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HostCallbacks</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FragmentHostCallback</span>&lt;<span class="hljs-title">FragmentActivity</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">ViewModelStoreOwner</span>, <span class="hljs-title">OnBackPressedDispatcherOwner</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ViewModelStore <span class="hljs-title">getViewModelStore</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// å®¿ä¸» activity çš„ getViewModelStore</span><br>    <span class="hljs-keyword">return</span> FragmentActivity.<span class="hljs-keyword">this</span>.getViewModelStore();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>host çš„ getViewModelStore æ–¹æ³•è¿”å›çš„æ˜¯å®¿ä¸» activity çš„ <code>getViewModelStore()</code> ï¼Œè€Œ activity é‡å»ºåå…¶å†…éƒ¨çš„ <code>mViewModelStore</code> æ˜¯ä¸å˜çš„ï¼Œå› æ­¤å³ä½¿ activity é‡å»ºï¼Œå…¶å†…éƒ¨çš„ FragmentManager å¯¹è±¡å˜åŒ–ï¼Œä½† FragmentManager å†…éƒ¨çš„  FragmentManagerViewModel çš„å®ä¾‹ï¼ˆ<code>mNonConfig</code>ï¼‰ä¸å˜ï¼ŒmNonConfig.getViewModelStore ä¸å˜ï¼Œfragment çš„ <code>getViewModelStore()</code> äº¦ä¸å˜ï¼Œfragment é‡å»ºåå…¶å†…éƒ¨çš„ <code>ViewModel</code> ä»ç„¶å­˜åœ¨</p><p>å¯¹äºåµŒå¥— fragment ï¼ŒmNonConfig é€šè¿‡ parent.mFragmentManager.getChildNonConfig(parent) è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FragmentManager.java</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> FragmentManagerViewModel <span class="hljs-title">getChildNonConfig</span><span class="hljs-params">(@NonNull Fragment f)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> mNonConfig.getChildNonConfig(f);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šæ–‡æåˆ° <code>FragmentManagerViewModel</code> ç®¡ç†ç€ mChildNonConfigs Mapï¼Œå› æ­¤å­ fragment é‡ç½®åå…¶å†…éƒ¨çš„ mNonConfig å¯¹è±¡ä¹Ÿæ˜¯ç›¸åŒçš„</p><p>è‡³æ­¤é—®é¢˜ 2 å°±è§£å†³äº†</p><h3 id="3-å¦‚ä½•æ§åˆ¶ä½œç”¨åŸŸï¼Ÿ"><a href="#3-å¦‚ä½•æ§åˆ¶ä½œç”¨åŸŸï¼Ÿ" class="headerlink" title="3. å¦‚ä½•æ§åˆ¶ä½œç”¨åŸŸï¼Ÿ"></a>3. å¦‚ä½•æ§åˆ¶ä½œç”¨åŸŸï¼Ÿ</h3><p>å¯¹äºé—®é¢˜3ï¼Œæˆ‘ä»¬çŸ¥é“ <code>ViewModelStoreOwner</code> ä»£è¡¨ç€ä½œç”¨åŸŸï¼Œå…¶å†…éƒ¨å”¯ä¸€çš„æ–¹æ³•è¿”å› <code>ViewModelStore</code> å¯¹è±¡ï¼Œä¹Ÿå³ä¸åŒçš„ä½œç”¨åŸŸå¯¹åº”ä¸åŒçš„ <code>ViewModelStore</code> ï¼Œè€Œ <code>ViewModelStore</code>  å†…éƒ¨ç»´æŠ¤ç€ <code>ViewModel</code> çš„ HashMap ï¼Œå› æ­¤åªè¦ä¿è¯ç›¸åŒä½œç”¨åŸŸçš„ <code>ViewModelStore</code> å¯¹è±¡ç›¸åŒå°±èƒ½ä¿è¯ç›¸åŒä½œç”¨åŸŸè·å–åˆ°ç›¸åŒçš„ <code>ViewModel</code> å¯¹è±¡ï¼Œè€Œé—®é¢˜1æˆ‘ä»¬å·²ç»è§£é‡Šäº†é‡å»ºæ—¶å¦‚ä½•ä¿è¯ <code>ViewModelStore</code>  å¯¹è±¡ä¸å˜ã€‚</p><p>å› æ­¤é—®é¢˜3ä¹Ÿè§£å†³äº†ã€‚</p><h3 id="4-å¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ"><a href="#4-å¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ" class="headerlink" title="4. å¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ"></a>4. å¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ</h3><p>å¯¹äºé—®é¢˜4ï¼Œç”±äº <code>ViewModel</code> çš„è®¾è®¡ï¼Œä½¿å¾— activity/fragment ä¾èµ–å®ƒï¼Œè€Œ <code>ViewModel</code> ä¸ä¾èµ–è§†å›¾æ§åˆ¶å™¨ã€‚å› æ­¤åªè¦ä¸è®© <code>ViewModel</code> æŒæœ‰ context æˆ– view çš„å¼•ç”¨ï¼Œå°±ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼</p><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç®€å•çš„æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li><p><strong>activity é‡å»ºå mViewModelStore é€šè¿‡ ActivityThread çš„ä¸€ç³»åˆ—æ–¹æ³•èƒ½å¤Ÿä¿æŒä¸å˜ï¼Œä»è€Œå½“ activity é‡å»ºæ—¶ ViewModel ä¸­çš„æ•°æ®ä¸å—å½±å“</strong></p></li><li><p><strong>é€šè¿‡å®¿ä¸» activity èŒƒå›´å†…å…±äº«çš„ FragmentManagerViewModel æ¥å­˜å‚¨ fragment çš„ ViewModelStore å’Œå­fragment çš„ FragmentManagerViewModel ï¼Œè€Œ activity é‡å»ºå FragmentManagerViewModel  ä¸­çš„æ•°æ®ä¸å—å½±å“ï¼Œå› æ­¤ fragment å†…éƒ¨çš„ ViewModel çš„æ•°æ®ä¹Ÿä¸å—å½±å“</strong></p></li><li><p><strong>é€šè¿‡åŒä¸€ ViewModelStoreOwner è·å–çš„ ViewModelStore ç›¸åŒï¼Œä»è€Œä¿è¯åŒä¸€ä½œç”¨åŸŸé€šè¿‡ ViewModelProvider è·å–çš„ViewModel å¯¹è±¡æ˜¯ç›¸åŒçš„</strong></p></li><li><p><strong>é€šè¿‡å•å‘ä¾èµ–ï¼ˆè§†å›¾æ§åˆ¶å™¨æŒæœ‰ ViewModel ï¼‰æ¥è§£å†³å†…å­˜æ³„æ¼çš„é—®é¢˜</strong></p></li></ul><h2 id="ViewModel-å’Œ-onSaveInstanceState"><a href="#ViewModel-å’Œ-onSaveInstanceState" class="headerlink" title="ViewModel å’Œ onSaveInstanceState"></a>ViewModel å’Œ onSaveInstanceState</h2><p><code>ViewModel</code> å’Œ <code>onSaveInstanceState</code> çš„åŠŸèƒ½æœ‰äº›ç±»ä¼¼ï¼Œä½†å®ƒä»¬ä¹Ÿæœ‰å¾ˆå¤šå·®å¼‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200323160417.png" src="/2020/03/23/Jetpack-ViewModel/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä»å­˜å‚¨ä½ç½®ä¸Šæ¥è¯´ï¼Œ<code>ViewModel</code> æ˜¯åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤å…¶è¯»å†™é€Ÿåº¦æ›´å¿«ï¼Œä½†å½“è¿›ç¨‹è¢«ç³»ç»Ÿæ€æ­»åï¼Œ<code>ViewModel</code> ä¸­çš„æ•°æ®ä¹Ÿä¸å­˜åœ¨äº†ã€‚ä»æ•°æ®å­˜å‚¨çš„ç±»å‹ä¸Šæ¥çœ‹ï¼Œ<code>ViewModel</code> é€‚åˆå­˜å‚¨ç›¸å¯¹è¾ƒé‡çš„æ•°æ®ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚åˆ°çš„ list æ•°æ®ï¼Œè€Œ <code>onSaveInstanceState</code> é€‚åˆå­˜å‚¨è½»é‡å¯åºåˆ—åŒ–çš„æ•°æ®</p><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ <code>viewmodel-savedstate</code> åº“ï¼Œè¯¦æƒ…å‚è€ƒ <a href="https://juejin.im/post/5e738d12518825495d69cfb9#heading-10" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘ç»ä¸ä¸¢å¤±çš„çŠ¶æ€ androidx SaveState ViewModel-SaveState åˆ†æ</a></p><hr><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><hr><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></li><li><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></li><li><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹ViewModelã€‘ç»ä¸ä¸¢å¤±çš„çŠ¶æ€ androidx SaveState ViewModel-SaveState åˆ†æ</title>
      <link href="/2020/03/19/Jetpack-ViewModel-SaveState/"/>
      <url>/2020/03/19/Jetpack-ViewModel-SaveState/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>å¤§å®¶éƒ½çŸ¥é“ activity æœ‰ç€ä¸€å¥— <code>onSaveInstanceState-onRestoreInstanceState</code> çŠ¶æ€ä¿å­˜æœºåˆ¶ï¼Œæ—¨åœ¨ã€Œç³»ç»Ÿèµ„æºå›æ”¶ã€æˆ–ã€Œé…ç½®å‘ç”Ÿå˜åŒ–ã€ä¿å­˜çŠ¶æ€ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„ä½“éªŒ</p><p>åœ¨ androidx ä¸‹ï¼Œæä¾›äº† <a href="https://developer.android.com/jetpack/androidx/releases/savedstate" target="_blank" rel="noopener">SavedState</a> åº“å¸®åŠ© activity å’Œ fragment å¤„ç†çŠ¶æ€ä¿å­˜å’Œæ¢å¤</p></blockquote><p>æœ¬æ–‡é»˜è®¤æ‚¨å¯¹çŠ¶æ€ä¿å­˜æœºåˆ¶æœ‰ä¸€å®šäº†è§£ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¯·ç§»æ­¥ <a href="https://developer.android.com/topic/libraries/architecture/saving-states" target="_blank" rel="noopener">Saving UI States</a></p><p>æ­¤å¤–ï¼Œå…³äº android ä¸‹çš„è¿›ç¨‹ç®¡ç†ï¼Œæ¨è Ian Lake çš„ <a href="https://medium.com/androiddevelopers/who-lives-and-who-dies-process-priorities-on-android-cb151f39044f" target="_blank" rel="noopener">Who lives and who dies? Process priorities on Android</a></p><p>æœ¬æ–‡ä»‹ç»äº† androidx ä¸‹ <code>SavedState</code> å¦‚ä½•å¸®åŠ© activity å’Œ fragment å¤„ç†çŠ¶æ€çš„ä¿å­˜å’Œæ¢å¤ï¼ŒåŒæ—¶ä»‹ç» <code>viewmodel-savedstate</code> åº“ï¼Œä»¥åŠåœ¨å¼€å‘è¿‡ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨çŠ¶æ€ä¿å­˜çš„å§¿åŠ¿</p><a id="more"></a><h2 id="è½¯ä»¶å·¥ç¨‹ä¸­æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸­é—´å±‚è§£å†³ä¸äº†çš„"><a href="#è½¯ä»¶å·¥ç¨‹ä¸­æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸­é—´å±‚è§£å†³ä¸äº†çš„" class="headerlink" title="è½¯ä»¶å·¥ç¨‹ä¸­æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸­é—´å±‚è§£å†³ä¸äº†çš„"></a>è½¯ä»¶å·¥ç¨‹ä¸­æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸­é—´å±‚è§£å†³ä¸äº†çš„</h2><p>åœ¨åˆ†æ <a href="https://developer.android.com/jetpack/androidx/releases/savedstate" target="_blank" rel="noopener">SavedState</a> åº“ä¹‹å‰æˆ‘ä»¬éœ€è¦ç®€å•èŠä¸€èŠ <code>ComponentActivity</code></p><p>androidx activity 1.0.0 æ—¶ï¼Œ<code>ComponentActivity</code> æˆä¸ºäº† <code>FragmentActivity</code> å’Œ <code>AppCompatActivity</code> çš„åŸºç±»ã€‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318211230.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="androidx activity 1.0.0 "></p><p>ä¿—è¯è¯´ã€Œç™¾å› å¿…æœ‰æœã€ï¼Œå¸¦ç€å¼ºçƒˆçš„å¥½å¥‡å¿ƒï¼Œæˆ‘æŸ¥äº†ä¸€ä¸‹ ComponentActivity å¼•å…¥çš„åŸå› ã€‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318211823.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318211806.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å¯ä»¥çœ‹åˆ° <code>ComponentActivity</code> ç»§æ‰¿äº† androidx.core.app.ComponentActivity(åœ¨fragmentåº“ä¸­)ï¼Œå¹¶ä¸”æœ€åˆä»…å®ç°äº†<code>LifecycleOwner</code> æ¥å£</p><p>æˆ‘ä»¬åˆ›å»ºçš„ activity çš„ç»§æ‰¿å…³ç³»ç°åœ¨å˜æˆäº†è¿™æ ·ï¼š</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318213053.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>é‚£ä¹ˆå›åˆ°æœ€åˆçš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦å¼•å…¥ <code>ComponentActivity</code> ï¼Ÿå…¶å®çœ‹çœ‹ç°åœ¨ <code>ComponentActivity</code> çš„ç±»ç»“æ„ç­”æ¡ˆå°±å¾ˆæ¸…æ¥šäº†</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318213151.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><code>ComponentActivity</code> å®ç°äº†äº”ä¸ªæ¥å£ï¼Œä»£è¡¨ç€å…¶é™¤äº† activity è¿˜å……å½“ç€äº”ç§è§’è‰²ã€‚æœ¬ç€èŒèƒ½å•ä¸€åŸåˆ™ï¼Œå®˜æ–¹é€šè¿‡å»ºç«‹ä¸€ä¸ªä¸­é—´å±‚å°†éƒ¨åˆ†åŠŸèƒ½åˆ†åˆ«äº¤äºä¸“é—¨çš„ç±»æ¥è´Ÿè´£ï¼ŒOnBackPressedDispatcherOwner å°±æ˜¯æˆ‘ä»¬è®² fragment è¿”å›æ ˆï¼ˆ<a href="https://juejin.im/post/5e6bae35f265da572a0d11ad" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackä¹‹OnBackPressedDispatcherã€‘Fragment è¿”å›æ ˆé¢„å¤‡ç¯‡</a>ï¼‰æ—¶æåˆ°çš„ç»“æ„ï¼Œè€Œå…¶ä¸­çš„ <code>SavedStateRegistryOwner</code> åˆ™æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²çš„ä¸»è§’  <a href="https://developer.android.com/jetpack/androidx/releases/savedstate" target="_blank" rel="noopener">SavedState</a> ä¸­çš„æˆå‘˜</p><h2 id="SavedState"><a href="#SavedState" class="headerlink" title="SavedState"></a>SavedState</h2><p>å¼•å…¥ <a href="https://developer.android.com/jetpack/androidx/releases/savedstate" target="_blank" rel="noopener">SavedState</a> </p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">"androidx.savedstate:savedstate:1.0.0"</span><br></code></pre></td></tr></table></figure><p>å…¶å®æ‚¨ä¸éœ€è¦æ˜¾ç¤ºåœ°å£°æ˜ï¼Œå› ä¸º activity åº“å†…éƒ¨å·²ç»å¼•å…¥äº†ã€‚jetpack ç»„ä»¶ä¾èµ–å…³ç³»å¯å‚è€ƒ <a href="https://juejin.im/post/5e567ee1518825494466a938" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘Jetpack ä¸»è¦ç»„ä»¶çš„ä¾èµ–åŠä¼ é€’å…³ç³»</a></p><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„åº“</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318215718.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200318215746.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://proandroiddev.com/viewmodels-state-persistence-savedstate-54d015acad82" target="_blank" rel="noopener">Android ViewModels: State persistence â€” SavedState</a></p></blockquote><h3 id="SavedStateProvider"><a href="#SavedStateProvider" class="headerlink" title="SavedStateProvider"></a>SavedStateProvider</h3><p>ä¿å­˜çŠ¶æ€çš„ç»„ä»¶ï¼Œæ­¤çŠ¶æ€å°†åœ¨ä»¥åæ¢å¤å¹¶ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SavedStateProvider</span> </span>&#123;<br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">Bundle <span class="hljs-title">saveState</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="SavedStateRegistry"><a href="#SavedStateRegistry" class="headerlink" title="SavedStateRegistry"></a>SavedStateRegistry</h3><p>ç®¡ç† <code>SavedStateProvider</code> åˆ—è¡¨çš„ç»„ä»¶ï¼Œæ­¤æ³¨å†Œè¡¨ç»‘å®šäº†å…¶æ‰€æœ‰è€…çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå³ activity æˆ– fragmentï¼‰ã€‚æ¯æ¬¡åˆ›å»ºç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹</p><p>åˆ›å»ºæ³¨å†Œè¡¨çš„æ‰€æœ‰è€…åï¼ˆä¾‹å¦‚ï¼Œåœ¨è°ƒç”¨ activity çš„ <code>onCreate(savedInstanceState)</code> æ–¹æ³•ä¹‹åï¼‰ï¼Œå°†è°ƒç”¨å…¶ <code>performRestore(state)</code> æ–¹æ³•ï¼Œä»¥æ¢å¤ç³»ç»Ÿæ€æ­»å…¶æ‰€æœ‰è€…ä¹‹å‰ä¿å­˜çš„ä»»ä½•çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performRestore</span><span class="hljs-params">(@NonNull Lifecycle lifecycle, @Nullable Bundle savedState)</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">if</span> (savedState != <span class="hljs-keyword">null</span>) &#123;<br>        mRestoredState = savedState.getBundle(SAVED_COMPONENTS_KEY);<br>    &#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªæ³¨å†Œè¡¨çš„ <code>SavedStateProvider</code> éƒ½ç”±ç”¨äºæ³¨å†Œå®ƒçš„å”¯ä¸€å¯†é’¥æ ‡è¯†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> SafeIterableMap&lt;String, SavedStateProvider&gt; mComponents = <span class="hljs-keyword">new</span> SafeIterableMap&lt;&gt;();<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerSavedStateProvider</span><span class="hljs-params">(@NonNull String key, @NonNull SavedStateProvider provider)</span> </span>&#123;<br>    SavedStateProvider previous = mComponents.putIfAbsent(key, provider);<br>    <span class="hljs-keyword">if</span> (previous != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"SavedStateProvider with the given key is already registered"</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unregisterSavedStateProvider</span><span class="hljs-params">(@NonNull String key)</span> </span>&#123;<br>    mComponents.remove(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€æ—¦å®Œæˆæ³¨å†Œï¼Œå°±å¯ä»¥é€šè¿‡<code>consumeRestoredStateForKey(key)</code> æ¥ä½¿ç”¨ç‰¹å®šå¯†é’¥çš„è¿˜åŸçŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Bundle <span class="hljs-title">consumeRestoredStateForKey</span><span class="hljs-params">(@NonNull String key)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (mRestoredState != <span class="hljs-keyword">null</span>) &#123;<br>        Bundle result = mRestoredState.getBundle(key);<br>        <span class="hljs-comment">//è°ƒç”¨åå°±ä¼šæ¸…ç©ºï¼Œç¬¬äºŒæ¬¡è°ƒç”¨è¿”å›null</span><br>        mRestoredState.remove(key);<br>        <span class="hljs-keyword">if</span> (mRestoredState.isEmpty()) &#123;<br>            mRestoredState = <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¯·æ³¨æ„ï¼Œæ­¤æ–¹æ³•æ£€ç´¢ä¿å­˜çš„çŠ¶æ€ï¼Œç„¶åæ¸…é™¤å…¶å†…éƒ¨å¼•ç”¨ï¼Œè¿™æ„å‘³ç€ç”¨ç›¸åŒçš„é”®è°ƒç”¨å®ƒä¸¤æ¬¡å°†åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ä¸­è¿”å› null</p><p>ä¸€æ—¦æ³¨å†Œè¡¨æ¢å¤äº†å…¶ä¿å­˜çŠ¶æ€ï¼Œåˆ™ç”±æä¾›è€…å†³å®šæ˜¯å¦è¦æ±‚å…¶æ¢å¤çš„æ•°æ®ã€‚ å¦‚æœæ²¡æœ‰ï¼Œä¸‹æ¬¡æ³¨å†Œè¡¨çš„æ‰€æœ‰è€…è¢«ç³»ç»Ÿæ€æ­»æ—¶ï¼Œæœªä½¿ç”¨çš„è¿˜åŸæ•°æ®å°†å†æ¬¡ä¿å­˜åˆ°ä¿å­˜çŠ¶æ€</p></blockquote><p>å·²æ³¨å†Œçš„ provider èƒ½å¤Ÿåœ¨å…¶æ‰€æœ‰è€…è¢«ç³»ç»Ÿæ€æ­»ä¹‹å‰ä¿å­˜çŠ¶æ€ã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œå°†è°ƒç”¨å…¶ <code>Bundle saveState()</code> æ–¹æ³•ã€‚ å¯¹äºæ¯ä¸ªå·²æ³¨å†Œçš„ <code>SavedStateProvider</code>ï¼Œéƒ½å¯ä»¥åƒè¿™æ ·ä¿å­˜çŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">savedState.putBundle(savedStateProviderKey, savedStateProvider.saveState());<br></code></pre></td></tr></table></figure><p><code>performSave(outBundle)</code> æ–¹æ³•çš„æºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">performSave</span><span class="hljs-params">(@NonNull Bundle outBundle)</span> </span>&#123;<br>    Bundle components = <span class="hljs-keyword">new</span> Bundle();<br>    <br>    <span class="hljs-comment">// 1.ä¿å­˜æœªä½¿ç”¨çš„çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (mRestoredState != <span class="hljs-keyword">null</span>) &#123;<br>        components.putAll(mRestoredState);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. é€šè¿‡ SavedStateProvider ä¿å­˜çŠ¶æ€</span><br>    <span class="hljs-keyword">for</span> (Iterator&lt;Map.Entry&lt;String, SavedStateProvider&gt;&gt; it = mComponents.iteratorWithAdditions(); it.hasNext(); ) &#123;<br>        Map.Entry&lt;String, SavedStateProvider&gt; entry1 = it.next();<br>        components.putBundle(entry1.getKey(), entry1.getValue().saveState());<br>    &#125;<br>    <br>    <span class="hljs-comment">// 3. å°†bundle ä¿å­˜åˆ° outBundle å¯¹è±¡ä¸­</span><br>    outBundle.putBundle(SAVED_COMPONENTS_KEY, components);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒçŠ¶æ€ä¿å­˜å°†æ‰€æœ‰æœªä½¿ç”¨çš„çŠ¶æ€ä¸æ³¨å†Œè¡¨æä¾›çš„çŠ¶æ€åˆå¹¶ã€‚ æ­¤ outBundle æ˜¯ activity çš„ <code>onSaveInstanceState</code> ä¸­ä¼ å…¥çš„ bundle ã€‚</p><h3 id="SavedStateRegistryController"><a href="#SavedStateRegistryController" class="headerlink" title="SavedStateRegistryController"></a>SavedStateRegistryController</h3><p>ä¸€ä¸ªåŒ…è£… <code>SavedStateRegistry</code> å¹¶å…è®¸é€šè¿‡å…¶2ä¸ªä¸»è¦æ–¹æ³•å¯¹å…¶è¿›è¡Œæ§åˆ¶çš„ç»„ä»¶ï¼šperformRestore(savedState) å’Œ <code>performSave(outBundle )</code>ã€‚ è¿™ä¸¤ä¸ªæ–¹æ³•å°†å†…éƒ¨é€šè¿‡ <code>SavedStateRegistry</code> ä¸­çš„æ–¹æ³•å¤„ç† ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SavedStateRegistryController</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SavedStateRegistryOwner mOwner;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SavedStateRegistry mRegistry;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">performRestore</span><span class="hljs-params">(@Nullable Bundle savedState)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>        mRegistry.performRestore(lifecycle, savedState);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">performSave</span><span class="hljs-params">(@NonNull Bundle outBundle)</span> </span>&#123;<br>        mRegistry.performSave(outBundle);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="SavedStateRegistryOwner"><a href="#SavedStateRegistryOwner" class="headerlink" title="SavedStateRegistryOwner"></a>SavedStateRegistryOwner</h3><p>æŒæœ‰ <code>SavedStateRegistry</code> çš„ç»„ä»¶ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œandroidx åŒ…ä¸­çš„<code>ComponentActivity</code> å’Œ <code>Fragment</code> éƒ½å®ç°æ­¤æ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SavedStateRegistryOwner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LifecycleOwner</span> </span>&#123;<br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">SavedStateRegistry <span class="hljs-title">getSavedStateRegistry</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Activity-çš„çŠ¶æ€ä¿å­˜"><a href="#Activity-çš„çŠ¶æ€ä¿å­˜" class="headerlink" title="Activity çš„çŠ¶æ€ä¿å­˜"></a>Activity çš„çŠ¶æ€ä¿å­˜</h2><p>è¿™é‡Œæˆ‘ä»¬è¦æ˜ç¡®ä¸€ä»¶äº‹æƒ…ï¼Œactivity ä¿å­˜çš„çŠ¶æ€ç©¶ç«Ÿéƒ½æœ‰ä»€ä¹ˆï¼Ÿ</p><p>è¿™éƒ¨åˆ†å†…å®¹å¯ä»¥å‚è§ <a href="https://developer.android.com/guide/components/activities/activity-lifecycle.html#saras" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> </p><p>ç®€å•æ¥è¯´ï¼Œ<strong>activity çš„çŠ¶æ€ä¿å­˜åˆ†ä¸º view çŠ¶æ€å’Œæˆå‘˜çŠ¶æ€</strong></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä½¿ç”¨ Bundle å®ä¾‹çŠ¶æ€æ¥ä¿å­˜æœ‰å…³ activity å¸ƒå±€ä¸­æ¯ä¸ª View å¯¹è±¡çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œè¾“å…¥åˆ° EditText ä¸­çš„æ–‡æœ¬å€¼æˆ– recyclerview çš„æ»šåŠ¨ä½ç½®ï¼‰ã€‚ å› æ­¤ï¼Œå¦‚æœ activity å®ä¾‹è¢«é”€æ¯å¹¶é‡æ–°åˆ›å»ºï¼Œåˆ™å¸ƒå±€çŠ¶æ€å°†æ¢å¤ä¸ºä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œæ— éœ€æ‚¨æ‰§è¡Œä»»ä½•ä»£ç ã€‚ï¼ˆ<strong>æ³¨æ„ï¼Œéœ€è¦æ¢å¤çŠ¶æ€çš„ view éœ€è¦é…ç½® id</strong> ï¼‰</p><p>è¿™éƒ¨åˆ†é€»è¾‘åœ¨ activity ä¸­çš„ <code>onSaveInstanceState</code> æ–¹æ³•å†…å®ç°</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319115543.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="onSaveInstanceState "></p><blockquote><p>ä¸åŒå¹³å° <code>onSaveInstanceState</code>  æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºç¨æœ‰ä¸åŒï¼Œandroid P ä¹‹å‰ <code>onSaveInstanceState</code> æ‰§è¡Œåœ¨ <code>onStop</code> ä¹‹å‰ï¼Œä½†ä¸é™äºåœ¨ <code>onPause</code> ä¹‹å‰æˆ–ä¹‹åã€‚android P åŠä¹‹åè¯¥æ–¹æ³•åœ¨ <code>onStop</code> åæ‰§è¡Œ</p></blockquote><p>å‰é¢æˆ‘ä»¬æåˆ° <code>ComponentActivity</code> å®ç°äº† <code>SavedStateRegistryOwner</code> ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ activity å¦‚ä½•åˆ©ç”¨è¯¥åº“æ¥å®ç°çŠ¶æ€çš„ä¿å­˜ä¸æ¢å¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ComponentActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">androidx</span>.<span class="hljs-title">core</span>.<span class="hljs-title">app</span>.<span class="hljs-title">ComponentActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SavedStateRegistryOwner</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SavedStateRegistryController mSavedStateRegistryController = SavedStateRegistryController.create(<span class="hljs-keyword">this</span>);<br>  <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>        mSavedStateRegistryController.performRestore(savedInstanceState);<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>  <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSaveInstanceState</span><span class="hljs-params">(@NonNull Bundle outState)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>        <span class="hljs-comment">//è¿™é‡Œå…ˆè°ƒç”¨çˆ¶ç±»çš„ onSaveInstanceState ä¿å­˜ view çŠ¶æ€</span><br>        <span class="hljs-keyword">super</span>.onSaveInstanceState(outState);<br>        mSavedStateRegistryController.performSave(outState);<br>    &#125;<br>  <br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> SavedStateRegistry <span class="hljs-title">getSavedStateRegistry</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mSavedStateRegistryController.getSavedStateRegistry();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å†…éƒ¨æŒæœ‰ <code>SavedStateRegistryController</code> çš„å®ä¾‹ <code>mSavedStateRegistryController</code> ï¼Œåœ¨ activity çš„ <code>onCreate</code> æ–¹æ³•ä¸­ é€šè¿‡ controller çš„ <code>performRestore</code> æ–¹æ³•æ¥æŸ¥è¯¢å·²ä¿å­˜çš„çŠ¶æ€ï¼Œåœ¨ <code>onSaveInstanceState</code> ä¸­ ä½¿ç”¨ controller  çš„ <code>performSave</code> æ–¹æ³•æ¥ä¿å­˜çŠ¶æ€</p><p><strong>é™¤äº† view çŠ¶æ€å’Œæˆå‘˜çŠ¶æ€ï¼Œactivity è¿˜è´Ÿè´£ä¿å­˜å…¶å†…éƒ¨çš„ fragment çš„çŠ¶æ€</strong>ã€‚<code>FragmentActivity</code> çš„ <code>onSaveInstanceState</code> æ–¹æ³•æœ‰å¯¹å…¶å†…éƒ¨ fragment çš„çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œå¹¶åœ¨ onCreate æ–¹æ³•ä¸­å¯¹å·²ä¿å­˜çš„ fragment è¿›è¡Œæ¢å¤ã€‚è¿™è§£é‡Šäº†å¦‚æœæ“ä½œä¸å½“ä¼šå¯¼è‡´ fragment é‡å çš„é—®é¢˜</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319140343.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319140801.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h2 id="Fragment-çš„çŠ¶æ€ä¿å­˜"><a href="#Fragment-çš„çŠ¶æ€ä¿å­˜" class="headerlink" title="Fragment çš„çŠ¶æ€ä¿å­˜"></a>Fragment çš„çŠ¶æ€ä¿å­˜</h2><p>androidx fragment ä½¿ç”¨ <code>FragmentStateManager</code> æ¥å¤„ç† fragment çš„çŠ¶æ€ä¿å­˜</p><p>å…¶å†…éƒ¨æœ‰å››ä¸ªä¿å­˜ç›¸å…³çš„æ–¹æ³•</p><ul><li><code>saveState</code></li><li><code>saveBasicState</code></li><li><code>saveViewState</code></li><li><code>saveInstanceState</code></li></ul><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319142729.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="FragmentStateManager"></p><p>å…¶è°ƒç”¨é“¾ä¸º activity é€šè¿‡ <code>FragmentController</code> é—´æ¥ è°ƒç”¨ <code>FragmentManager</code> çš„ <code>saveAllState</code>ï¼Œæ¥ç€ä¾æ¬¡è°ƒç”¨åé¢çš„save æ–¹æ³•</p><p>Fragment çš„çŠ¶æ€ä¿å­˜å¯åˆ†ä¸º view çŠ¶æ€ï¼Œæˆå‘˜çŠ¶æ€ï¼Œchild fragment çŠ¶æ€</p><p>å…³äº view çŠ¶æ€ , <code>FragmentStateManager</code> æä¾›äº† <code>saveViewSate</code> æ–¹æ³•ï¼Œå®ƒçš„è°ƒç”¨æœ‰ä¸¤å¤„ï¼š</p><ol><li>åœ¨ activity æˆ–çˆ¶ fragment è§¦å‘çŠ¶æ€ä¿å­˜æ—¶è°ƒç”¨ï¼Œå³ä¸Šè¿°æµç¨‹</li><li>åœ¨ fragment å³å°†è¿›å…¥ <code>onDestroyView</code> ç”Ÿå‘½å‘¨æœŸæ—¶è°ƒç”¨ï¼Œå…¶ä½ç½®åœ¨ <code>FragmentManager</code> moveToState æ–¹æ³•å†…éƒ¨ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆåŠ å…¥è¿”å›æ ˆçš„ replace æ“ä½œåœ¨è¿”å›æ—¶ view çŠ¶æ€å¯ä»¥è‡ªåŠ¨æ¢å¤</li></ol><p>å…³äºæˆå‘˜çŠ¶æ€ï¼Œç”± activity ä¸­çš„çŠ¶æ€æœºåˆ¶å¤„ç†ï¼Œå³ä¸ŠèŠ‚å†…å®¹</p><p>å…³äº child  fragment çŠ¶æ€ï¼Œfragment çš„ <code>onCreate</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>restoreChildFragmentState</code> æ¥æ¢å¤ child  fragment çš„çŠ¶æ€ï¼Œå¹¶åœ¨ <code>FragmentStateManager</code>  ä¸­çš„ <code>saveBasicState</code> æ–¹æ³•ä¸­ è°ƒç”¨ <code>performSaveInstanceState</code> æ¥ä¿å­˜ child  fragment çš„çŠ¶æ€</p><h2 id="Viewmodel-SavedState"><a href="#Viewmodel-SavedState" class="headerlink" title="Viewmodel-SavedState"></a>Viewmodel-SavedState</h2><p>2020-01-22ï¼Œ<code>ViewModel-SavedState 1.0.0</code> æ­£å¼ç‰ˆå‘å¸ƒï¼Œ02-05 å‘å¸ƒäº† <code>2.2.0</code> æ­£å¼ç‰ˆ</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-viewmodel-savedstate:2.2.0"</span><br></code></pre></td></tr></table></figure><blockquote><p>æ‚¨ä¸éœ€è¦æ‰‹åŠ¨å¼•å…¥è¯¥åº“ï¼Œå› ä¸º fragment åº“ä»¥åŠå†…éƒ¨å¼•å…¥è¯¥åº“</p></blockquote><p><code>Jetpack MVVM</code> ä¸‹ UI State é€šå¸¸è¢« <code>ViewModel</code> æŒæœ‰å¹¶å­˜å‚¨ï¼Œå› æ­¤è¯¥æ¨¡å—å‡ºç°äº†ï¼Œé…ç½®è¯¥æ¨¡å—åï¼Œ<code>ViewModel</code> å¯¹è±¡å°†é€šè¿‡å…¶æ„é€ å‡½æ•°æ¥æ”¶ <code>SavedStateHandle</code> å¯¹è±¡ï¼ˆé”®å€¼æ˜ å°„ï¼‰ï¼Œå¯è®©æ‚¨ä¿å­˜çŠ¶æ€å¹¶æŸ¥è¯¢å·²ä¿å­˜çš„çŠ¶æ€ã€‚ è¿™äº›å€¼å°†åœ¨ç³»ç»Ÿç»ˆæ­¢è¿›ç¨‹åç»§ç»­å­˜åœ¨ï¼Œå¹¶å¯ä»¥é€šè¿‡åŒä¸€å¯¹è±¡ä½¿ç”¨ã€‚</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319165450.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ViewModel-SavedState"></p><blockquote><p>å›¾ç‰‡æ¥è‡ª <a href="https://proandroiddev.com/viewmodels-state-persistence-savedstate-54d015acad82" target="_blank" rel="noopener">Android ViewModels: State persistence â€” SavedState</a></p></blockquote><h3 id="SavedStateHandle"><a href="#SavedStateHandle" class="headerlink" title="SavedStateHandle"></a>SavedStateHandle</h3><p>å†…éƒ¨æŒæœ‰å·²ä¿å­˜çŠ¶æ€ key-value çš„ mapï¼Œå…è®¸è¯»å–å’Œå†™å…¥çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€åœ¨åº”ç”¨è¿›ç¨‹è¢«æ€æ­»åä»ç„¶å­˜åœ¨</p><p><code>SavedStateHandle</code> é€šè¿‡ <code>ViewModel</code> çš„æ„é€ å™¨ä¼ å…¥ï¼Œä¸‹é¢æ˜¯å…¶ä¸»è¦çš„ä¸»è¦çš„å‡ ä¸ªæ–¹æ³•</p><ul><li>T get(String key)</li><li>MutableLiveData<t> getLiveData(String key)</t></li><li>void set(String key, T value)</li></ul><p><code>SavedStateHandle</code> è¿˜åŒ…å« <code>SavedStateProvider</code> çš„å®ä¾‹ï¼Œç”¨äºå¸®åŠ© <code>ViewModel</code> çš„ owner ä¿å­˜çŠ¶æ€</p><h3 id="AbstractSavedStateViewModelFactory"><a href="#AbstractSavedStateViewModelFactory" class="headerlink" title="AbstractSavedStateViewModelFactory"></a>AbstractSavedStateViewModelFactory</h3><p>ä¸€ä¸ªå®ç° <code>ViewModelFactory.KeyedFactory</code> çš„ <code>ViewModel Factory</code>ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªä¸å®ä¾‹åŒ–çš„è¯·æ±‚çš„ ViewModel å…³è”çš„ <code>SavedStateHandle</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractSavedStateViewModelFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModelProvider</span>.<span class="hljs-title">KeyedFactory</span> </span>&#123;<br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SavedStateRegistry mSavedStateRegistry;<br>  <br>    <span class="hljs-comment">// Default state used when the saved state is empty</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Bundle mDefaultArgs;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> &lt;T extends ViewModel&gt; <span class="hljs-function">T <span class="hljs-title">create</span><span class="hljs-params">(@NonNull String key, @NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;<br>        <span class="hljs-comment">// è¯»å–ä¿å­˜çš„çŠ¶æ€</span><br>        Bundle restoredState = mSavedStateRegistry.consumeRestoredStateForKey(key);<br>      <br>        <span class="hljs-comment">// åˆ›å»ºä¿å­˜çŠ¶æ€çš„ handle</span><br>        SavedStateHandle handle = SavedStateHandle.createHandle(restoredState, mDefaultArgs);<br>        <br>        <span class="hljs-comment">// ... </span><br>      <br>        <span class="hljs-comment">// åˆ›å»º viewModel</span><br>        T viewmodel = create(key, modelClass, handle);<br>      <br>        <span class="hljs-comment">// ... </span><br><br>        <span class="hljs-keyword">return</span> viewmodel;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="SavedStateViewModelFactory"><a href="#SavedStateViewModelFactory" class="headerlink" title="SavedStateViewModelFactory"></a>SavedStateViewModelFactory</h3><p><code>AbstractSavedStateViewModelFactory</code> çš„å…·ä½“å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SavedStateViewModelFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractSavedStateVMFactory</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SavedStateViewModelFactory</span><span class="hljs-params">(@NonNull Application application,<br>            @NonNull SavedStateRegistryOwner owner)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(application, owner, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SavedStateViewModelFactory</span><span class="hljs-params">(@NonNull Application application, @NonNull SavedStateRegistryOwner owner, @Nullable Bundle defaultArgs)</span> </span>&#123;<br>        mSavedStateRegistry = owner.getSavedStateRegistry();<br>        mLifecycle = owner.getLifecycle();<br>        mDefaultArgs = defaultArgs;<br>        mApplication = application;<br>        mFactory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);<br>    &#125;<br>    <br><span class="hljs-keyword">public</span> &lt;T extends ViewModel&gt; <span class="hljs-function">T <span class="hljs-title">create</span><span class="hljs-params">(@NonNull String key, @NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;<br>        <span class="hljs-keyword">boolean</span> isAndroidViewModel = AndroidViewModel.class.isAssignableFrom(modelClass);<br>        Constructor&lt;T&gt; constructor;<br>        <span class="hljs-keyword">if</span> (isAndroidViewModel) &#123;<br>            constructor = findMatchingConstructor(modelClass, ANDROID_VIEWMODEL_SIGNATURE);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            constructor = findMatchingConstructor(modelClass, VIEWMODEL_SIGNATURE);<br>        &#125;<br>        <span class="hljs-comment">// doesn't need SavedStateHandle</span><br>        <span class="hljs-keyword">if</span> (constructor == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> mFactory.create(modelClass);<br>        &#125;<br><br>        SavedStateHandleController controller = SavedStateHandleController.create(<br>                mSavedStateRegistry, mLifecycle, key, mDefaultArgs);        <br>        T viewmodel;<br>        <span class="hljs-keyword">if</span> (isAndroidViewModel) &#123;<br>            viewmodel = constructor.newInstance(mApplication, controller.getHandle());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            viewmodel = constructor.newInstance(controller.getHandle());<br>        &#125;<br>        viewmodel.setTagIfAbsent(TAG_SAVED_STATE_HANDLE_CONTROLLER, controller);<br>        <span class="hljs-keyword">return</span> viewmodel;<br>        <span class="hljs-comment">//...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319174431.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ViewModelProvider(<span class="hljs-keyword">this</span>).get(MyViewModel::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br></code></pre></td></tr></table></figure><p>åœ¨ activity ä¸­åˆ›å»º ViewModel å®ä¾‹ï¼Œä¼ å…¥ this ï¼ˆ<code>SavedStateRegistryOwner</code> ï¼‰ä½œä¸ºå‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥è®¿é—®å…¶ <code>SavedStateRegistry</code>ï¼Œå¦‚æœæ²¡æœ‰ä¼ å…¥ factory ä¼šé€šè¿‡ activity é‡å†™çš„ <code>getDefaultViewModelProviderFactory</code> æ–¹æ³•æ¥è·å–é»˜è®¤çš„ factory ã€‚ç„¶å factory å°†ä½¿ç”¨ä¿å­˜çš„çŠ¶æ€ï¼Œ å°†å…¶åŒ…è£…åœ¨ <code>SavedStateHandle</code> ä¸­ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ ViewModelã€‚ ViewModel å¯ä»¥è¯»å–å’Œå†™å…¥è¯¥ handle</p><p>å½“ activity çš„ <code>onSaveInstanceState(outState)</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œå…¶ <code>SavedStateRegistry</code> çš„ <code>performSave(outState)</code> æ–¹æ³•å°†è¢«æ‰§è¡Œï¼Œå…¶å†…éƒ¨çš„æ‰€æœ‰ <code>SavedStateProvider</code> çš„ <code>saveState</code> æ–¹æ³•å‡è¢«æ‰§è¡Œï¼Œä¸€æ—¦æ‰§è¡Œå®Œæ¯•ï¼Œ<code>outState</code> å°±åŒ…å«äº†å·²ä¿å­˜çš„çŠ¶æ€</p><p>å½“ app è¢«é‡å¯åï¼Œactivity å’Œæ–°çš„ registry  å°†è¢«åˆ›å»ºï¼Œactivity çš„ <code>onCreate(savedInstanceState)</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œç„¶å registry çš„ <code>performRestore(savedInstanceState)</code> å°†è¢«è°ƒç”¨ä»¥ä¾¿æ¢å¤ä¹‹å‰ä¿å­˜çš„çŠ¶æ€</p><h2 id="çŠ¶æ€ä¿å­˜çš„æ­£ç¡®å§¿åŠ¿"><a href="#çŠ¶æ€ä¿å­˜çš„æ­£ç¡®å§¿åŠ¿" class="headerlink" title="çŠ¶æ€ä¿å­˜çš„æ­£ç¡®å§¿åŠ¿"></a>çŠ¶æ€ä¿å­˜çš„æ­£ç¡®å§¿åŠ¿</h2><p><code>ViewModel</code> æ„é€ å™¨åŠ å…¥ <code>SavedStateHandle</code> å‚æ•°ï¼Œå¹¶å°†æƒ³è¦ä¿å­˜çš„æ•°æ®ä½¿ç”¨è¯¥ handle ä¿å­˜</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WithSavedStateViewModel</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> state: SavedStateHandle) : ViewModel() &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> key = <span class="hljs-string">"key"</span><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setValue</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span> = state.<span class="hljs-keyword">set</span>(key, value)<br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span></span>: LiveData&lt;String&gt; = state.getLiveData(key)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ— éœ€é‡å†™ <code>onSaveInstanceState/onRestoreInstanceState</code>  æ–¹æ³•</strong></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319231231.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200319231451.png" src="/2020/03/19/Jetpack-ViewModel-SaveState/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œç¤ºæ„å›¾"></p><p><a href="https://github.com/Flywith24/Flywith24-Jetpack-Demo" target="_blank" rel="noopener">Demo åœ°å€</a></p><blockquote><p>SavedState ä»…é€‚åˆä¿å­˜è½»é‡çº§çš„æ•°æ®ï¼Œé‡é‡çº§æ“ä½œè¯·è€ƒè™‘æŒspï¼Œæ•°æ®åº“ç­‰æŒä¹…åŒ–æ–¹æ¡ˆ</p></blockquote><hr><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><hr><p>æˆ‘æ˜¯ <a href="http://www.yangyunzhao.com" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></li><li><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></li><li><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹Fragmentã€‘ä»æºç çš„è§’åº¦çœ‹Fragment è¿”å›æ ˆ</title>
      <link href="/2020/03/16/Jetpack-fragment-back-stack/"/>
      <url>/2020/03/16/Jetpack-fragment-back-stack/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p><a href="https://juejin.im/post/5e6bae35f265da572a0d11ad" target="_blank" rel="noopener">ä¸Šä¸€ç¯‡</a> æˆ‘ä»¬ä»‹ç»äº† <code>OnBackPressedDispather</code> ï¼Œé‚£ä¹ˆä»Šå¤©æˆ‘ä»¬æ¥æ­£å¼åœ°ä»æºç çš„è§’åº¦çœ‹çœ‹ fragment çš„è¿”å›æ ˆå§ã€‚ç”±äºå…¶ä¸»æµç¨‹å’Œç”Ÿå‘½å‘¨æœŸå·®ä¸å¤šï¼Œå› æ­¤æœ¬æ–‡å°†è¯¦ç»†åœ°åˆ†æè¿”å›æ ˆç›¸å…³çš„æºç ï¼Œå¹¶æ’å…¥å¤§é‡æºç ã€‚å»ºè®®å°†ç”Ÿå‘½å‘¨æœŸæµç¨‹ç†Ÿæ‚‰åé˜…è¯»æœ¬æ–‡ã€‚æ–‡æœ«æä¾›å•è¿”å›æ ˆå’Œå¤šè¿”å›æ ˆçš„ <a href="https://github.com/Flywith24/Flywith24-Fragment-Demo" target="_blank" rel="noopener">demo</a></p></blockquote><p>å¦‚æœæ‚¨å¯¹ activity å¯¹ä»»åŠ¡æ ˆå’Œè¿”å›æ ˆä¸æ˜¯å¾ˆäº†è§£ï¼Œå¯ä»¥ç§»æ­¥  <a href="https://medium.com/androiddevelopers/tasks-and-the-back-stack-dbb7c3b0f6d4" target="_blank" rel="noopener">Tasks and the Back Stack</a></p><a id="more"></a><h2 id="å°é—®å·ä½ æ˜¯å¦æœ‰å¾ˆå¤šæœ‹å‹ï¼Ÿ"><a href="#å°é—®å·ä½ æ˜¯å¦æœ‰å¾ˆå¤šæœ‹å‹ï¼Ÿ" class="headerlink" title="å°é—®å·ä½ æ˜¯å¦æœ‰å¾ˆå¤šæœ‹å‹ï¼Ÿ"></a>å°é—®å·ä½ æ˜¯å¦æœ‰å¾ˆå¤šæœ‹å‹ï¼Ÿ</h2><p>åœ¨åˆ†ææºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ€è€ƒå‡ ä¸ªé—®é¢˜ã€‚</p><ul><li>è¿”å›æ ˆä¸­çš„å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>è°æ¥ç®¡ç† fragment çš„è¿”å›æ ˆï¼Ÿ</li><li>å¦‚ä½•è¿”å›ï¼Ÿ</li></ul><h3 id="è¿”å›æ ˆä¸­çš„å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#è¿”å›æ ˆä¸­çš„å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="è¿”å›æ ˆä¸­çš„å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿ"></a>è¿”å›æ ˆä¸­çš„å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>è¿”å›æ ˆï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ä¸ªæ ˆç»“æ„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ææ¸…æ¥šï¼Œè¿™ä¸ªæ ˆç»“æ„åˆ°åº•å­˜çš„æ˜¯ä»€ä¹ˆã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä½¿ç”¨ fragment çš„è¿”å›æ ˆéœ€è¦è°ƒç”¨ <code>addToBackStack(&quot;&quot;)</code> æ–¹æ³•</p><p>åœ¨ <a href="https://juejin.im/post/5e67523551882549003d2c4f" target="_blank" rel="noopener">ä»æºç è§’åº¦çœ‹ Fragment ç”Ÿå‘½å‘¨æœŸ</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº† FragmentTransaction ï¼Œå®ƒæ˜¯ä¸€ä¸ªã€Œäº‹åŠ¡ã€çš„æ¨¡å‹ï¼Œäº‹åŠ¡å¯ä»¥å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚æ‰€ä»¥å½“è§¦å‘è¿”å›æ“ä½œæ—¶ï¼Œå°±æ˜¯å°†ä¹‹å‰æäº¤çš„äº‹åŠ¡è¿›è¡Œå›æ»šã€‚</p><p><code>FragmentTransaction</code> çš„å®ç°ç±»ä¸º <code>BackStackRecord</code> ï¼Œæ‰€ä»¥ <strong>fragment çš„è¿”å›æ ˆå…¶å®å­˜æ”¾çš„å°±æ˜¯ BackStackRecord</strong> </p><p>ä½œä¸ºè¿”å›æ ˆçš„å…ƒç´ ï¼ŒBackStackRecord å®ç°äº†FragmentManager.BackStackEntry æ¥å£</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf0e912bd4?w=748&h=171&f=png&s=27904" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="BackStackRecord"></p><p>ä» <code>BackStackRecord</code> çš„å®šä¹‰æˆ‘ä»¬å¯ä»¥å‘ç° <code>BackStackRecord</code> æœ‰ä¸‰ç§èº«ä»½</p><ul><li>ç»§æ‰¿äº† <code>FragmentTransaction</code>ï¼Œå³æ˜¯äº‹åŠ¡ï¼Œä¿å­˜äº†æ•´ä¸ªäº‹åŠ¡çš„å…¨éƒ¨æ“ä½œ</li><li>å®ç°äº† <code>FragmentManager.BackStackEntry</code> ï¼Œä½œä¸ºå›é€€æ ˆçš„å…ƒç´ </li><li>å®ç°äº†<code>OpGenerator</code> ï¼Œå¯ä»¥ç”Ÿæˆ <code>BackStackRecord</code> åˆ—è¡¨ï¼Œåæ–‡è¯¦ç»†ä»‹ç»</li></ul><h3 id="è°æ¥ç®¡ç†-fragment-çš„è¿”å›æ ˆï¼Ÿ"><a href="#è°æ¥ç®¡ç†-fragment-çš„è¿”å›æ ˆï¼Ÿ" class="headerlink" title="è°æ¥ç®¡ç† fragment çš„è¿”å›æ ˆï¼Ÿ"></a>è°æ¥ç®¡ç† fragment çš„è¿”å›æ ˆï¼Ÿ</h3><p>æˆ‘ä»¬å·²ç»çŸ¥é“ fragment çš„è¿”å›æ ˆå…¶å®å­˜æ”¾çš„æ˜¯ BackSrackRecord , é‚£ä¹ˆè°æ¥ç®¡ç† fragment çš„è¿”å›æ ˆï¼Ÿ</p><p><code>FragmentManager</code> ç”¨äºç®¡ç† fragment ï¼Œæ‰€ä»¥ <strong>fragment è¿”å›æ ˆä¹Ÿåº”è¯¥ç”± FragmentManager ç®¡ç†</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//FragmentManager.java</span><br>ArrayList&lt;BackStackRecord&gt; mBackStack;<br></code></pre></td></tr></table></figure><p>å…¶å®è§¦å‘ fragment çš„è¿”å›é€»è¾‘æœ‰ä¸¤ç§é€”å¾„</p><ul><li><p>å¼€å‘ä¸»åŠ¨è°ƒç”¨ fragment çš„è¿”å›æ–¹æ³•</p></li><li><p>ç”¨æˆ·æŒ‰è¿”å›é”®è§¦å‘</p></li></ul><p>åæ–‡æˆ‘ä»¬ä¼šä»è¿™ä¸¤ä¸ªè§’åº¦åˆ†æä¸€ä¸‹ fragment ä¸­çš„è¿”å›æ ˆé€»è¾‘ç©¶ç«Ÿæ˜¯æ€æ ·çš„</p><h3 id="å¦‚ä½•è¿”å›ï¼Ÿ"><a href="#å¦‚ä½•è¿”å›ï¼Ÿ" class="headerlink" title="å¦‚ä½•è¿”å›ï¼Ÿ"></a>å¦‚ä½•è¿”å›ï¼Ÿ</h3><p>æˆ‘ä»¬å·²ç»çŸ¥é“è¿”å›æ ˆä¸­çš„å…ƒç´ æ˜¯ <code>BackStackRecord</code> ï¼Œä¹Ÿæ¸…æ¥šäº†æ˜¯ <code>FragmentManager</code> æ¥ç®¡ç†è¿”å›æ ˆã€‚é‚£ä¹ˆå¦‚æœè®©æˆ‘ä»¬æ¥å®ç°ã€Œè¿”å›ã€é€»è¾‘ï¼Œåº”è¯¥å¦‚ä½•åšï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬è¦æ¸…æ¥šæ‰€è°“çš„ã€Œè¿”å›ã€æ˜¯å¯¹äº‹åŠ¡çš„å›æ»šï¼Œå³ <strong>å¯¹ commit äº‹åŠ¡çš„å†…éƒ¨é€»è¾‘æ‰§è¡Œç›¸åº”çš„ã€Œé€†æ“ä½œã€</strong>ã€‚</p><p>ä¾‹å¦‚</p><p>addFragmentâ†â†’removeFragment</p><p>showFragmentâ†â†’hideFragment</p><p>attachFragmentâ†â†’detachFragment</p><p>æœ‰çš„å°ä¼™ä¼´å¯èƒ½ä¼šç–‘æƒ‘ replace å‘¢ï¼Ÿ</p><p><code>expandReplaceOps</code> æ–¹æ³•ä¼šæŠŠ replace æ›¿æ¢(ç›®æ ‡ fragment å·²ç»è¢« add )æˆç›¸åº”çš„ remove å’Œ add ä¸¤ä¸ªæ“ä½œï¼Œæˆ–è€…(ç›®æ ‡ fragment æ²¡æœ‰è¢« add )åªæ›¿æ¢æˆ add æ“ä½œ</p><h2 id="popBackStack-ç³»åˆ—æ–¹æ³•"><a href="#popBackStack-ç³»åˆ—æ–¹æ³•" class="headerlink" title="popBackStack ç³»åˆ—æ–¹æ³•"></a>popBackStack ç³»åˆ—æ–¹æ³•</h2><p><code>FragmentManager</code> ä¸­æä¾›äº†<code>popBackStack</code> ç³»åˆ—æ–¹æ³•</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf0f7fecec?w=523&h=207&f=png&s=41693" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="popBackStackç³»åˆ—æ–¹æ³•"></p><p>æ˜¯å¦è§‰å¾—å¾ˆçœ¼ç†Ÿï¼Ÿæäº¤äº‹åŠ¡ä¹Ÿæœ‰ç±»ä¼¼çš„apiï¼Œcommit ç³»åˆ—æ–¹æ³•</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf0f5fe236?w=425&h=116&f=png&s=19768" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="commitç³»åˆ—æ–¹æ³•"></p><p>è¿™é‡Œåˆ†åˆ«æä¾›äº†åŒæ­¥å’Œå¼‚æ­¥çš„æ–¹æ³•ï¼Œå¯èƒ½æœ‰è¯»è€…ä¼šç–‘æƒ‘ï¼ŒåŒæ ·æ˜¯å¯¹äº‹åŠ¡çš„æ“ä½œï¼Œä¸€ä¸ªä¸ºæäº¤ï¼Œä¸€ä¸ªä¸ºå›æ»šï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªå°è£…åˆ°äº† <code>FragmentManager</code> ä¸­ï¼Œä¸€ä¸ªå´åœ¨ <code>FragmentTransaction</code> ä¸­ã€‚æ—¢ç„¶éƒ½æ˜¯å¯¹äº‹åŠ¡çš„æ“ä½œï¼Œåº”è¯¥éƒ½æ”¾åœ¨FragmentManager ä¸­ã€‚æˆ‘è®¤ä¸ºå¯èƒ½ä¸ºäº†apiä½¿ç”¨çš„æ–¹ä¾¿ï¼Œä½¿å¾— <code>FragmentManager</code> å¼€å¯äº‹åŠ¡çš„é“¾å¼è°ƒç”¨ä¸€æ°”å‘µæˆã€‚å„ä½æœ‰ä»€ä¹ˆæƒ³æ³•æ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ã€‚</p><p>è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹ popBackStack(String name, int flag)</p><p>name ä¸º addToBackStack(String name) çš„å‚æ•°ï¼Œé€šè¿‡ name èƒ½æ‰¾åˆ°å›é€€æ ˆçš„ç‰¹å®šå…ƒç´ ï¼Œflagå¯ä»¥ä¸º 0 æˆ–è€…<code>FragmentManager.POP_BACK_STACK_INCLUSIVE</code>ï¼Œ0 è¡¨ç¤ºåªå¼¹å‡ºè¯¥å…ƒç´ ä»¥ä¸Šçš„æ‰€æœ‰å…ƒç´ ï¼Œ<code>POP_BACK_STACK_INCLUSIVE</code> è¡¨ç¤ºå¼¹å‡ºåŒ…å«è¯¥å…ƒç´ åŠä»¥ä¸Šçš„æ‰€æœ‰å…ƒç´ ã€‚è¿™é‡Œè¯´çš„å¼¹å‡ºæ‰€æœ‰å…ƒç´ åŒ…å«å›é€€è¿™äº›äº‹åŠ¡ã€‚å¦‚æœè¿™ä¹ˆè¯´æ¯”è¾ƒæŠ½è±¡çš„è¯ï¼Œçœ‹å›¾</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//flag ä¼ å…¥0ï¼Œå¼¹å‡º â™¥2 ä¸Šçš„æ‰€æœ‰å…ƒç´ </span><br>childFragmentManager.popBackStack(<span class="hljs-string">"â™¥"</span>, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf111e4eca?w=544&h=968&f=gif&s=332027" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="flagä¸º0"></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//flag ä¸º POP_BACK_STACK_INCLUSIVE å¼¹å‡ºåŒ…æ‹¬è¯¥å…ƒç´ åŠåŠä»¥ä¸Šçš„å…ƒç´ </span><br>childFragmentManager.popBackStack(<span class="hljs-string">"â™¥"</span>,  androidx.fragment.app.FragmentManager.POP_BACK_STACK_INCLUSIVE)<br></code></pre></td></tr></table></figure><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf11573c7e?w=544&h=968&f=gif&s=307357" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="flagä¸º1"></p><h2 id="èµ°è¿›æºç "><a href="#èµ°è¿›æºç " class="headerlink" title="èµ°è¿›æºç "></a>èµ°è¿›æºç </h2><h3 id="1-popBackStack-é€»è¾‘"><a href="#1-popBackStack-é€»è¾‘" class="headerlink" title="1. popBackStack() é€»è¾‘"></a>1. popBackStack() é€»è¾‘</h3><p>åœ¨åˆ†æè¿”å›æ ˆæºç ä¹‹å‰æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ FragmentManager æäº¤äº‹åŠ¡åˆ° fragment å„ä¸ªç”Ÿå‘½å‘¨æœŸçš„æµç¨‹</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf128028ab?w=1137&h=1745&f=png&s=148227" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å¼‚æ­¥"></p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf3c14d698?w=1078&h=1232&f=png&s=120922" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="commitNow"></p><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ popBackStack çš„æºç </p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf3e264529?w=1111&h=744&f=png&s=152765" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="popBackStackæºç "></p><p>ç­‰ç­‰ï¼Œè¿™ä¸ª enqueueAction æœ‰äº›çœ¼ç†Ÿâ€¦</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf4261e2a2?w=582&h=144&f=png&s=16887" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="commit"></p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf43057f36?w=792&h=404&f=png&s=74980" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="commitInternal"></p><p>çœ‹æ¥æäº¤äº‹åŠ¡å’Œå›æ»šäº‹åŠ¡çš„æµç¨‹åŸºæœ¬æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯ä¼ é€’çš„ action ä¸åŒ</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf463c7504?w=818&h=722&f=png&s=108117" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="enqueueAction"></p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/16/170df028ee01dd57?w=1081&h=713&f=png&s=131939" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="OpGenerator"></p><p>ç”±æºç å¯çŸ¥ï¼Œ<code>OpGenerator</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å†…åªæœ‰ä¸€ä¸ª <code>generateOps</code> æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆäº‹åŠ¡åˆ—è¡¨ä»¥åŠå¯¹åº”çš„è¯¥äº‹åŠ¡æ˜¯å¦æ˜¯å¼¹å‡ºçš„ã€‚æœ‰ä¸¤ä¸ªå®ç°ç±»</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf5579b571?w=1319&h=139&f=png&s=46323" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="OpGeneratorå®ç°ç±»"></p><p>ç”±æ­¤å¯è§ commit è°ƒç”¨çš„ä¸º <code>BackStackRecord</code> çš„ <code>generateOps</code> æ–¹æ³•ï¼Œ<code>popBackStack</code> è°ƒç”¨çš„æ˜¯ <code>PopBackStackState</code> ä¸­çš„  <code>generateOps</code> </p><p>å‰è€…çš„é€»è¾‘å¾ˆç®€å•ï¼Œå‘ records list ä¸­æ·»åŠ æ•°æ®ï¼Œ isRecordPop list å…¨éƒ¨ä¼ å…¥ false</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">records.add(<span class="hljs-keyword">this</span>);<br>isRecordPop.add(<span class="hljs-keyword">false</span>);<br></code></pre></td></tr></table></figure><p>åè€…çš„é€»è¾‘ç¨å¾®å¤æ‚äº›ï¼Œå…¶å†…éƒ¨è°ƒç”¨äº† <code>popBackStackState</code> æ–¹æ³•</p><p>å¦‚æœæ˜¯ <code>popBackStack</code> æ–¹æ³• ï¼Œåˆ™å°† <code>FragmentManager</code> çš„è¿”å›æ ˆåˆ—è¡¨ï¼ˆ<code>mBackStack</code>ï¼‰çš„æ ˆé¡¶ç§»é™¤ï¼Œ <code>isRecordPop</code> list å…¨éƒ¨ä¼ å…¥ true</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">int</span> last = mBackStack.size() - <span class="hljs-number">1</span>;<br>records.add(mBackStack.remove(last));<br>isRecordPop.add(<span class="hljs-keyword">true</span>);<br></code></pre></td></tr></table></figure><p>å¦‚æœä¼ å…¥çš„ name æˆ– id æœ‰å€¼ï¼Œä¸” flag ä¸º 0ï¼Œåˆ™æ‰¾åˆ°è¿”å›æ ˆï¼ˆå€’åºéå†ï¼‰ä¸­ç¬¬ä¸€ä¸ªç¬¦åˆ name æˆ– id çš„ä½ç½®ï¼Œå¹¶å°†è¯¥ä½ç½®ä¸Šæ–¹çš„æ‰€æœ‰ <code>BackStackRecord</code> å¹¶æ·»åŠ åˆ° <code>record</code> list ä¸­ï¼ŒåŒæ—¶ <code>isRecordPop</code> list å…¨éƒ¨ä¼ å…¥ true</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">index = mBackStack.size() - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">while</span> (index &gt;= <span class="hljs-number">0</span>) &#123;<br>    BackStackRecord bss = mBackStack.get(index);<br>    <span class="hljs-keyword">if</span> (name != <span class="hljs-keyword">null</span> &amp;&amp; name.equals(bss.getName())) &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (id &gt;= <span class="hljs-number">0</span> &amp;&amp; id == bss.mIndex) &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    index--;<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = mBackStack.size() - <span class="hljs-number">1</span>; i &gt; index; i--) &#123;<br>  records.add(mBackStack.remove(i));<br>  isRecordPop.add(<span class="hljs-keyword">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¼ å…¥çš„ name æˆ– id æœ‰å€¼ï¼Œä¸” flag ä¸º <code>POP_BACK_STACK_INCLUSIVE</code>ï¼Œåˆ™åœ¨ä¸Šä¸€æ¡è·å–ä½ç½®çš„åŸºç¡€ä¸Šç»§ç»­éå†ï¼Œç›´è‡³æ ˆåº•æˆ–è€…é‡åˆ°ä¸åŒ¹é…çš„è·³å‡ºå¾ªç¯ï¼Œæ¥ç€å‡ºæ ˆæ‰€æœ‰ <code>BackStackRecord</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//index æ“ä½œä¸ä¸Šæ–¹ç›¸åŒï¼Œå…ˆæ‰¾åˆ°è¿”å›æ ˆï¼ˆå€’åºéå†ï¼‰ä¸­ç¬¬ä¸€ä¸ªç¬¦åˆ name æˆ– id çš„ä½ç½®</span><br><span class="hljs-keyword">if</span> ((flags &amp; POP_BACK_STACK_INCLUSIVE) != <span class="hljs-number">0</span>) &#123;<br>    index--;<br>    <span class="hljs-comment">// ç»§ç»­éå† mBackStack ç›´è‡³æ ˆåº•æˆ–è€…é‡åˆ°ä¸åŒ¹é…çš„è·³å‡ºå¾ªç¯</span><br>    <span class="hljs-keyword">while</span> (index &gt;= <span class="hljs-number">0</span>) &#123;<br>        BackStackRecord bss = mBackStack.get(index);<br>        <span class="hljs-keyword">if</span> ((name != <span class="hljs-keyword">null</span> &amp;&amp; name.equals(bss.getName()))<br>                || (id &gt;= <span class="hljs-number">0</span> &amp;&amp; id == bss.mIndex)) &#123;<br>            index--;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//åç»­å‡ºæ ˆé€»è¾‘ä¸ä¸Šæ–¹ç›¸åŒ</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥é…åˆä¸Šé¢çš„åŠ¨å›¾ç†è§£</p><p>å…¥æ ˆå’Œå‡ºæ ˆåç»­çš„é€»è¾‘å¤§ä½“æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯æ ¹æ® isPop çš„æ­£è´Ÿå‡ºç°äº†åˆ†æ”¯ï¼Œå‡ºæ ˆè°ƒç”¨çš„æ˜¯ executePopOps</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/16/170df06c04191fff?w=972&h=682&f=png&s=132928" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>ä¸Šæ–‡æˆ‘ä»¬æœ‰æåˆ°ï¼Œã€Œè¿”å›ã€é€»è¾‘å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œæäº¤äº‹åŠ¡å†…éƒ¨æ“ä½œé€»è¾‘çš„ã€Œé€†æ“ä½œã€</p><p>é‚£ä¹ˆæ¥ä¸‹çš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼Œæ ¹æ®ä¸åŒçš„ mCmd æ‰§è¡Œç›¸åº”çš„é€†æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">executePopOps</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> moveToState)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> opNum = mOps.size() - <span class="hljs-number">1</span>; opNum &gt;= <span class="hljs-number">0</span>; opNum--) &#123;<br>        <span class="hljs-keyword">final</span> Op op = mOps.get(opNum);<br>        Fragment f = op.mFragment;<br>        <span class="hljs-keyword">switch</span> (op.mCmd) &#123;<br>            <span class="hljs-keyword">case</span> OP_ADD:<br>                mManager.removeFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_REMOVE:<br>                mManager.addFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_HIDE:<br>                mManager.showFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_SHOW:<br>                mManager.hideFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_DETACH:<br>                mManager.attachFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_ATTACH:<br>                mManager.detachFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_SET_PRIMARY_NAV:<br>                mManager.setPrimaryNavigationFragment(<span class="hljs-keyword">null</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_UNSET_PRIMARY_NAV:<br>                mManager.setPrimaryNavigationFragment(f);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OP_SET_MAX_LIFECYCLE:<br>                mManager.setMaxLifecycle(f, op.mOldMaxState);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Unknown cmd: "</span> + op.mCmd);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!mReorderingAllowed &amp;&amp; op.mCmd != OP_REMOVE &amp;&amp; f != <span class="hljs-keyword">null</span>) &#123;<br>            mManager.moveFragmentToExpectedState(f);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!mReorderingAllowed &amp;&amp; moveToState) &#123;<br>        mManager.moveToState(mManager.mCurState, <span class="hljs-keyword">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åé¢çš„é€»è¾‘å°±å®Œå…¨ä¸€æ ·äº†</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf65e331c7?w=1137&h=1585&f=png&s=127564" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="popBackStack"></p><h3 id="2-fragment-æ˜¯æ€æ ·æ‹¦æˆª-activity-çš„è¿”å›é€»è¾‘çš„ï¼Ÿ"><a href="#2-fragment-æ˜¯æ€æ ·æ‹¦æˆª-activity-çš„è¿”å›é€»è¾‘çš„ï¼Ÿ" class="headerlink" title="2. fragment æ˜¯æ€æ ·æ‹¦æˆª activity çš„è¿”å›é€»è¾‘çš„ï¼Ÿ"></a>2. fragment æ˜¯æ€æ ·æ‹¦æˆª activity çš„è¿”å›é€»è¾‘çš„ï¼Ÿ</h3><p>åœ¨ <a href="https://juejin.im/post/5e6bae35f265da572a0d11ad" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackä¹‹OnBackPressedDispatcherã€‘Fragment è¿”å›æ ˆé¢„å¤‡ç¯‡</a> ä¸€æ–‡ä¸­æˆ‘ä»¬ä»‹ç»äº† <code>OnBackPressedDispatcher</code> </p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf6fd444f6?w=1138&h=544&f=png&s=96482" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ComponetActivity"></p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf70da7341?w=642&h=512&f=png&s=71452" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>activity çš„ <code>onBackPressed</code> çš„é€»è¾‘ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ¤æ–­æ‰€æœ‰æ³¨å†Œçš„ <code>OnBackPressedCallback</code> æ˜¯å¦æœ‰ enabled çš„ï¼Œå¦‚æœæœ‰åˆ™æ‹¦æˆªï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘ï¼›</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/16/170df0d07750776b?w=801&h=765&f=png&s=137606" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="fragment æ‹¦æˆªè¿”å›é€»è¾‘"></p><p>å¦åˆ™ç€æ‰§è¡Œ mFallbackOnBackPressed.run() ï¼Œå…¶å†…éƒ¨é€»è¾‘ä¸ºè°ƒç”¨ ComponentActivity çˆ¶ç±»çš„ <code>onBackPressed</code> æ–¹æ³•</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf7443eb77?w=715&h=275&f=png&s=39938" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><strong>æ‰€ä»¥æˆ‘ä»¬åªéœ€çœ‹ mOnBackPressedCallbacksï¼ˆArrayDeque&lt;OnBackPressedCallbackï¼‰ æ˜¯æ€æ ·è¢«æ·»åŠ çš„ä»¥åŠ isEnabled ä½•æ—¶èµ‹å€¼ä¸º true</strong></p><p>ç»è¿‡æŸ¥æ‰¾æˆ‘ä»¬å‘ç°å®ƒæ˜¯åœ¨ FragmentManager çš„ attachController è°ƒç”¨ <code>addCallback</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">mOnBackPressedDispatcher.addCallback(owner,mOnBackPressedCallback)<br></code></pre></td></tr></table></figure><p>è¿›è€Œæ‰§è¡Œäº†</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/16/170df099d16ae502?w=1000&h=425&f=png&s=75605" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt><br><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf7c970039?w=822&h=233&f=png&s=41860" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è€Œ <code>mOnBackPressedCallback</code> åœ¨åˆå§‹åŒ–æ—¶ enabled èµ‹å€¼ä¸º false </p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf8362798b?w=954&h=194&f=png&s=42041" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="mOnBackPressedCallback"></p><p><code>isEnadbled</code> ä¼šåœ¨è¿”å›æ ˆæ•°é‡å¤§äº 0 ä¸”å…¶ mParent ä¸º <code>PrimaryNavigation</code> æ—¶èµ‹å€¼ä¸ºtrue</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf9805eb1e?w=796&h=555&f=png&s=94237" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è€Œè¿”å›æ ˆï¼ˆ<code>mBackStack</code>ï¼‰çš„èµ‹å€¼åœ¨ <code>BackStackRecord</code> çš„ <code>generateOps</code> æ–¹æ³•ä¸­ï¼Œä¸”æ˜¯å¦æ·»åŠ åˆ°è¿”å›æ ˆç”± <code>mAddToBackStack</code> è¿™ä¸ªå¸ƒå°”ç±»å‹çš„å±æ€§æ§åˆ¶</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/16/170df0f5d77e3c7f?w=891&h=544&f=png&s=94633" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf9a0dfa56?w=548&h=215&f=png&s=28095" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><strong>mAddToBackStack çš„èµ‹å€¼åœ¨ addToBackStack æ–¹æ³•ä¸­ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•è°ƒç”¨ addToBackStack æ–¹æ³•å°±èƒ½å°†äº‹åŠ¡åŠ å…¥è¿”å›æ ˆ</strong></p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeaf9eb75bde?w=841&h=306&f=png&s=47458" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><blockquote><p> æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œfragment æ‹¦æˆª activity è¿”å›æ ˆæ˜¯é€šè¿‡ <code>OnBackPressedDispatcher</code> å®ç°çš„ï¼Œå¦‚æœå¼€å¯äº‹åŠ¡è°ƒç”¨äº† <code>addToBackStack</code> æ–¹æ³•ï¼Œåˆ™ <code>mOnBackPressedCallback</code> çš„ <code>isEnabled</code> å±æ€§ä¼šèµ‹å€¼ä¸º trueï¼Œè¿›è€Œèµ·åˆ°æ‹¦æˆª activity è¿”å›é€»è¾‘çš„ä½œç”¨ã€‚æ‹¦æˆªåæ‰§è¡Œ <code>popBackStackImmediate</code> æ–¹æ³•</p><p>è€Œ popBackStackç³»åˆ—æ–¹æ³•ä¼šè°ƒç”¨ popBackStackState æ„é€  <code>records</code> å’Œ <code>isRecordPop</code> åˆ—è¡¨ï¼Œ<code>isRecordPop</code> çš„å†…éƒ¨å…ƒç´ çš„å€¼å‡ä¸ºtrue åç»­æµç¨‹å’Œæäº¤äº‹åŠ¡æ˜¯ä¸€æ ·çš„ï¼Œæ ¹æ® <code>isRecordPop</code> å€¼çš„ä¸åŒé€‰æ‹©æ‰§è¡Œ <code>executePopOps</code> æˆ– <code>executeOps</code> æ–¹æ³•</p></blockquote><h2 id="å•è¿”å›æ ˆå’Œå¤šè¿”å›æ ˆçš„å®ç°"><a href="#å•è¿”å›æ ˆå’Œå¤šè¿”å›æ ˆçš„å®ç°" class="headerlink" title="å•è¿”å›æ ˆå’Œå¤šè¿”å›æ ˆçš„å®ç°"></a>å•è¿”å›æ ˆå’Œå¤šè¿”å›æ ˆçš„å®ç°</h2><p><a href="https://medium.com/@ianhlake" target="_blank" rel="noopener">Ian Lake</a> åœ¨ <a href="https://www.youtube.com/watch?v=RS1IACnZLy4" target="_blank" rel="noopener">Fragments: Past, Present, and Future (Android Dev Summit â€˜19)</a> </p><p>æœ‰æåˆ°æœªæ¥ä¼šæä¾›å¤šè¿”å›æ ˆçš„ api</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/15/170deeafa780da77?w=1844&h=948&f=png&s=634511" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>é‚£ä¹ˆä»¥ç°æœ‰çš„ api å¦‚ä½•å®ç°å¤šè¿”å›æ ˆå‘¢ï¼Ÿ</p><p>é¦–å…ˆæˆ‘è¦å¼„æ¸…æ¥šæ€æ ·æ‰ä¼šæœ‰å¤šè¿”å›æ ˆï¼Œæ ¹æ®ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“ <code>FragmentManager</code> å†…éƒ¨æŒæœ‰<code>mBackStack</code> listï¼Œè¿™å¯¹åº”ç€ä¸€ä¸ªè¿”å›æ ˆï¼Œ<strong>å¦‚æœæƒ³è¦å®ç°å¤šè¿”å›æ ˆï¼Œåˆ™éœ€è¦å¤šä¸ª FragmentManager</strong>ï¼Œè€Œå¤š <code>FragmentManager</code> åˆ™å¯¹åº”å¤šä¸ª fragment</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªå®¿ä¸» frament ä½œä¸ºå¯¼èˆª fragment è¿™æ ·å°±å¯ä»¥ç”¨ä¸åŒçš„å®¿ä¸» fragment çš„ ç‹¬ç«‹çš„<code>FragmentManager</code> åˆ†åˆ«ç®¡ç†å„è‡ªçš„è¿”å›æ ˆï¼Œå¦‚æœè¿™æ ·è¯´æ¯”è¾ƒæŠ½è±¡ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/16/170defa88bc0e5f9?w=488&h=750&f=gif&s=4633102" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å›¾ä¸­æœ‰å››ä¸ªè¿”å›æ ˆï¼Œå…¶ä¸­æœ€å¤–éƒ¨æœ‰ä¸€ä¸ªå®¿ä¸» fragment ï¼Œå†…éƒ¨æœ‰å››ä¸ªè´Ÿè´£å¯¼èˆªçš„ fragment ç®¡ç†å…¶å†…éƒ¨çš„è¿”å›æ ˆï¼Œå¤–éƒ¨çš„å®¿ä¸»è´Ÿè´£åè°ƒå„ä¸ªè¿”å›æ ˆä¸ºç©ºåå¦‚ä½•åˆ‡æ¢è‡³å…¶ä»–è¿”å›æ ˆ</p><p>å•è¿”å›æ ˆå°±å¾ˆå®¹æ˜“äº†ï¼Œæˆ‘ä»¬åªéœ€åœ¨åŒä¸€ä¸ª <code>FragmentManager</code> ä¸Šæ·»åŠ è¿”å›æ ˆå³å¯</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200312175950" src="/2020/03/16/Jetpack-fragment-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¯¦æƒ…å‚ç…§ <a href="https://github.com/Flywith24/Flywith24-Fragment-Demo" target="_blank" rel="noopener">demo</a></p><hr><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><hr><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackã€‘Fragmentè¿”å›æ ˆé¢„å¤‡ç¯‡ OnBackPressedDispatcher</title>
      <link href="/2020/03/14/Jetpack-OnBackPressedDispatcher/"/>
      <url>/2020/03/14/Jetpack-OnBackPressedDispatcher/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¿™ä¸¤å¤©åœ¨å‡†å¤‡å†™ fragment è¿”å›æ ˆçš„æ–‡ç« ï¼Œä½†æ˜¯å‘ç°å¿…é¡»å…ˆä»‹ç»ä¸€ä¸‹ OnBackPressedDispatcher ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ç¯‡ä»‹ç» what çš„æ–‡ç« ï¼Œå–œæ¬¢ä¸€æ‰‹èµ„æ–™çš„å¯ä»¥ç§»æ­¥ <a href="https://developer.android.google.cn/reference/kotlin/androidx/activity/OnBackPressedDispatcher" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p></blockquote><a id="more"></a><h2 id="ç³»åˆ—æ–‡ç« "><a href="#ç³»åˆ—æ–‡ç« " class="headerlink" title="ç³»åˆ—æ–‡ç« "></a>ç³»åˆ—æ–‡ç« </h2><blockquote><p><a href="https://juejin.im/post/5e567ee1518825494466a938" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘Jetpack ä¸»è¦ç»„ä»¶çš„ä¾èµ–åŠä¼ é€’å…³ç³»</a><br></p><p><a href="https://juejin.im/post/5e5a0c316fb9a07cd248d29e" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackã€‘AdroidXä¸‹ä½¿ç”¨Activityå’ŒFragmentçš„å˜åŒ–</a><br></p><p><a href="https://juejin.im/post/5e5cd8686fb9a07cbc269d10" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackä¹‹Fragmentã€‘ä½ çœŸçš„ä¼šç”¨Fragmentå—ï¼ŸFragmentå¸¸è§é—®é¢˜ä»¥åŠandroidxä¸‹Fragmentçš„ä½¿ç”¨æ–°å§¿åŠ¿</a><br></p><p><a href="https://juejin.im/post/5e67523551882549003d2c4f" target="_blank" rel="noopener">ã€èƒŒä¸ŠJetpackä¹‹Fragmentã€‘ä»æºç è§’åº¦çœ‹ Fragment ç”Ÿå‘½å‘¨æœŸ AndroidX Fragment1.2.2æºç åˆ†æ</a></p></blockquote><h2 id="When"><a href="#When" class="headerlink" title="When"></a>When</h2><p><code>OnBackPressedDispatcher</code> åœ¨ <code>androidx activity 1.0.0</code> åŠ å…¥ï¼Œæ—¨åœ¨å¤„ç†è¿”å›é€»è¾‘ã€‚æ‚¨ä¸ä»…å¯ä»¥è·å¾—åœ¨ <code>Activity</code> ä¹‹å¤–å¤„ç†è¿”å›é”®çš„ä¾¿æ·æ–¹å¼ã€‚ æ ¹æ®æ‚¨çš„éœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨ä»»æ„ä½ç½®å®šä¹‰ <code>OnBackPressedCallback</code>ï¼Œä½¿å…¶å¯å¤ç”¨ï¼Œæˆ–æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¶æ„è¿›è¡Œä»»ä½•æ“ä½œã€‚ æ‚¨ä¸å†éœ€è¦é‡å†™<code>Activity</code> ä¸­çš„ <code>onBackPressed</code> æ–¹æ³•ï¼Œä¹Ÿä¸å¿…æä¾›è‡ªå·±çš„æŠ½è±¡çš„æ¥å®ç°éœ€æ±‚çš„ä»£ç ã€‚</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/14/170d4a399942581f?w=1778&h=1246&f=png&s=339228" src="/2020/03/14/Jetpack-OnBackPressedDispatcher/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="OnBackPressedDispatcher"></p><h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p><code>ComponentActivity</code> æ˜¯ <code>FragmentActivity</code> å’Œ <code>AppCompatActivity</code> çš„åŸºç±»ï¼Œå®ƒä½¿æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨å…¶ <code>OnBackPressedDispatcher</code>ï¼ˆå¯ä»¥é€šè¿‡è°ƒç”¨ <code>getOnBackPressedDispatcher()</code> ï¼‰æ¥æ§åˆ¶è¿”å›æŒ‰é’®çš„è¡Œä¸ºã€‚</p><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/3/14/170d4a9d225a9575?w=2168&h=1150&f=png&s=238889" src="/2020/03/14/Jetpack-OnBackPressedDispatcher/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ComponentActivity-onBackPressed"></p><p><code>OnBackPressedDispatcher</code> æ§åˆ¶å¦‚ä½•å°†è¿”å›æŒ‰é’®äº‹ä»¶åˆ†é…ç»™ä¸€ä¸ªæˆ–å¤šä¸ª<code>OnBackPressedCallback</code> å¯¹è±¡ã€‚ <code>OnBackPressedCallback</code> çš„æ„é€ å‡½æ•°å°†å¸ƒå°”å€¼ç”¨äºåˆå§‹å¯ç”¨çŠ¶æ€ã€‚ ä»…å½“å¯ç”¨äº†å›è°ƒï¼ˆå³ <code>isEnabled()</code> è¿”å›trueï¼‰æ—¶ï¼Œè°ƒåº¦ç¨‹åºæ‰ä¼šè°ƒç”¨å›è°ƒçš„<code>handleOnBackPressed()</code> æ¥å¤„ç†è¿”å›æŒ‰é’®äº‹ä»¶ã€‚ æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ <code>setEnabled()</code> æ¥æ›´æ”¹å¯ç”¨çŠ¶æ€ã€‚</p><p>å›è°ƒæ˜¯é€šè¿‡ <code>addCallback</code> æ–¹æ³•æ·»åŠ çš„ã€‚ å¼ºçƒˆå»ºè®®ä½¿ç”¨é‡‡ç”¨ LifecycleOwner çš„<code>addCallback()</code> æ–¹æ³•ã€‚ è¿™æ ·å¯ä»¥ç¡®ä¿ä»…åœ¨ LifecycleOwner ä¸º Lifecycle.State.STARTED æ—¶æ‰æ·»åŠ <code>OnBackPressedCallback</code>ã€‚ å½“å…³è”çš„ LifecycleOwner è¢«é”€æ¯æ—¶ï¼Œè¯¥ activity ä¼šåˆ é™¤å·²æ³¨å†Œçš„å›è°ƒï¼Œä»¥é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå¹¶ä½¿å…¶é€‚ç”¨äºå¯¿å‘½æ¯”è¯¥ <code>activity</code> çŸ­çš„ <code>fragment</code> æˆ–å…¶ä»–ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br><br>        <span class="hljs-comment">//æ­¤ callback ä»…å½“ MyFragment è‡³å°‘æ˜¯ Started çŠ¶æ€ä¸‹è°ƒç”¨</span><br>        <span class="hljs-keyword">val</span> callback = requireActivity().onBackPressedDispatcher.addCallback(<span class="hljs-keyword">this</span>) &#123;<br>            <span class="hljs-comment">//æ‹¦æˆªè¿”å›äº‹ä»¶</span><br>        &#125;<br><br>        <span class="hljs-comment">//æ­¤ callback å¯ä»¥åœ¨è¿™é‡Œæˆ–è€…ä¸Šé¢çš„ lambda ä¸­å¼€å¯å’Œå…³é—­</span><br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‚¨å¯ä»¥é€šè¿‡ <code>addCallback()</code> æä¾›å¤šä¸ªå›è°ƒã€‚ è¿™æ ·åšæ—¶ï¼Œå°†æŒ‰ç…§æ·»åŠ å›è°ƒçš„ç›¸åé¡ºåºè°ƒç”¨å›è°ƒï¼Œå³æœ€åæ·»åŠ çš„å›è°ƒæ˜¯ç¬¬ä¸€ä¸ªç»™äºˆå¤„ç†è¿”å›æŒ‰é’®äº‹ä»¶çš„æœºä¼šçš„å›è°ƒã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä¾æ¬¡æ·»åŠ äº†ä¸‰ä¸ªåˆ†åˆ«åä¸º1ã€2å’Œ3çš„å›è°ƒï¼Œåˆ™å°†åˆ†åˆ«ä»¥3ã€2å’Œ1çš„é¡ºåºè°ƒç”¨å®ƒä»¬ã€‚</p><p>å›è°ƒéµå¾ªâ€œè´£ä»»é“¾â€æ¨¡å¼ã€‚ ä»…å½“æœªå¯ç”¨å‰ä¸€ä¸ªå›è°ƒæ—¶ï¼Œæ‰è°ƒç”¨é“¾ä¸­çš„æ¯ä¸ªå›è°ƒã€‚ è¿™æ„å‘³ç€åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œä»…å½“æœªå¯ç”¨å›è°ƒ3æ—¶ï¼Œæ‰ä¼šè°ƒç”¨å›è°ƒ2ã€‚ ä»…å½“æœªå¯ç”¨å›è°ƒ2æ—¶ï¼Œæ‰è°ƒç”¨å›è°ƒ1ï¼Œä¾æ­¤ç±»æ¨ã€‚</p><p>è¯·æ³¨æ„ï¼Œé€šè¿‡ <code>addCallback()</code> æ·»åŠ å›è°ƒæ—¶ï¼Œç›´åˆ° LifecycleOwner è¿›å…¥Lifecycle.State.STARTED çŠ¶æ€ï¼Œæ‰å°†å›è°ƒæ·»åŠ åˆ°è´£ä»»é“¾ä¸­ã€‚</p><p>å¼ºçƒˆå»ºè®®æ›´æ”¹ <code>OnBackPressedCallback</code> çš„å¯ç”¨çŠ¶æ€ä»¥è¿›è¡Œä¸´æ—¶æ›´æ”¹(å³æ›´æ”¹ isEnabled çš„å€¼)ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¿æŒä¸Šè¿°é¡ºåºï¼Œå¦‚æœæ‚¨åœ¨å¤šä¸ªä¸åŒçš„åµŒå¥—ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…ä¸Šæ³¨å†Œäº†å›è°ƒï¼Œè¿™å°¤å…¶é‡è¦ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœè¦å®Œå…¨åˆ é™¤ <code>OnBackPressedCallback</code>ï¼Œåˆ™åº”è°ƒç”¨ remove()ã€‚ ä½†æ˜¯ï¼Œè¿™é€šå¸¸ä¸æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºåœ¨é”€æ¯å…³è”çš„ <code>LifecycleOwner</code> æ—¶ä¼šè‡ªåŠ¨åˆ é™¤å…¶å›è°ƒã€‚</p><h2 id="Activity-onBackPressed"><a href="#Activity-onBackPressed" class="headerlink" title="Activity onBackPressed()"></a>Activity onBackPressed()</h2><p>å¦‚æœæ‚¨ä½¿ç”¨ <code>onBackPressed()</code> å¤„ç†è¿”å›æŒ‰é’®äº‹ä»¶ï¼Œå»ºè®®æ‚¨æ”¹ç”¨ <code>OnBackPressedCallback</code> ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ— æ³•è¿›è¡Œæ­¤æ›´æ”¹ï¼Œåˆ™é€‚ç”¨ä»¥ä¸‹è§„åˆ™ï¼š</p><ul><li><p>å½“æ‚¨è°ƒç”¨ <code>super.onBackPressed()</code> æ—¶ï¼Œå°†é€šè¿‡ <code>addCallback</code> æ³¨å†Œçš„æ‰€æœ‰å›è°ƒã€‚</p></li><li><p>æ— è®º <code>OnBackPressedCallback</code> çš„ä»»ä½•æ³¨å†Œå®ä¾‹ï¼Œå§‹ç»ˆä¼šè°ƒç”¨ <code>onBackPressed</code>ã€‚</p></li></ul><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>å…³äº fragment è¿”å›æ ˆçš„ demo å·²ç»å†™å¥½äº†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ <a href="https://github.com/Flywith24/Flywith24-Fragment-Demo" target="_blank" rel="noopener">åœ¨è¿™</a> æ‰¾åˆ°å®ƒã€‚</p><p>æˆ‘ä»¬ä¸‹ä¸€ç¯‡å†è§ã€‚</p><hr><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><hr><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹Fragmentã€‘ä»æºç è§’åº¦çœ‹Fragmentçš„å¯åŠ¨æµç¨‹åŠç”Ÿå‘½å‘¨æœŸ åŸºäºAndroidX Fragment1.2.2</title>
      <link href="/2020/03/10/Jetpack-fragment-lifecycle/"/>
      <url>/2020/03/10/Jetpack-fragment-lifecycle/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¬”è€…çœ‹è¿‡ä¸å°‘æºç åˆ†æç±»çš„æ–‡ç« ï¼ŒåŠ¨è¾„è´´ä¸Šå¤§æ®µä»£ç ï¼Œè¿™ç§æ–¹å¼å¾ˆå®¹æ˜“æ‰“æ–­è¯»è€…çš„æ€è·¯ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™çœ‹è¿‡è¿™ç±»æ–‡ç« æ„Ÿå¹å¥½æ–‡å¥½æ–‡ï¼Œå´æ„Ÿè§‰ä»€ä¹ˆéƒ½æ²¡è®°ä½ï¼Œäº¦æˆ–è€…é»˜é»˜åŠ å…¥æ”¶è—å´ä¸çŸ¥ä½•æ—¶èƒ½å»ç»†å¿ƒåœ°ç ”è¯»ã€‚</p><p>æ‰€ä»¥æœ¬æ–‡ä¸ä¼šè¿‡å¤šä»‹ç»æºç çš„ç»†èŠ‚ï¼Œæ›´å¤šåœ°æ˜¯æŠ›ç –å¼•ç‰ï¼Œå¦‚æœæ‚¨çœ‹è¿‡æœ¬æ–‡åèƒ½å¤Ÿè·Ÿç€æœ¬æ–‡çš„æ€è·¯è‡ªå·±ç¿»ä¸€ä¸‹æºç ç›¸ä¿¡æ‚¨å°±ä¸ä¼šæœ‰æˆ‘ä¸Šè¿°çš„ä½“éªŒäº†ã€‚</p><p>æœ¬æ–‡é»˜è®¤æ‚¨å·²å¯¹ fragment çš„ç”Ÿå‘½å‘¨æœŸæœ‰æ‰€äº†è§£ï¼Œå¹¶æ¸…æ¥šfragmentçš„ç¼˜èµ·ä¸èŒè´£ã€‚è¿™éƒ¨åˆ†åŸºç¡€å†…å®¹å¯ç§»æ­¥ <a href="https://developer.android.com/guide/components/fragments" target="_blank" rel="noopener">fragment å®˜æ–¹æ–‡æ¡£</a> </p><p><strong>ä¹Ÿå³æœ¬æ–‡ä¸ä¼šä»‹ç» â€œwhatâ€ï¼Œè€Œæ˜¯ä»‹ç» â€œhowâ€ å¹¶ä¸”æ¢è®¨ä¸€ä¸‹ â€œwhyâ€</strong></p></blockquote><a id="more"></a><p>è¿™é‡Œè´´ä¸€ä¸‹ androidx fragment æºç åœ°å€</p><p><a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-master-dev/fragment/" target="_blank" rel="noopener">androidx fragment å®˜æ–¹æºç åœ°å€</a></p><p>æœ¬æ–‡åŸºäº androidx fragment 1.2.2 æºç åˆ†æ</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">"androidx.fragment:fragment-ktx:1.2.2"</span><br></code></pre></td></tr></table></figure><p>æœ¬æ–‡ä¸»è¦ä»‹ç»fragmentçš„å¯åŠ¨æµç¨‹ï¼Œå…¶ä»–å†…å®¹ä¾‹å¦‚è¿”å›æ ˆï¼Œä¼šåç»­æ›´æ–°ï¼Œæ•¬è¯·å…³æ³¨ã€‚æ¬¢è¿åœ¨è¯„è®ºåŒºä¸‹è®¨è®ºã€‚<a href="https://github.com/Flywith24/Flywith24-Fragment-Demo" target="_blank" rel="noopener">æœ¬æ–‡demo</a></p><p>æ—¢ç„¶æˆ‘ä»¬éƒ½çŸ¥é“ â€œwhatâ€ï¼Œä¸å¦¨æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹ â€œhowâ€</p><h2 id="åˆ†æå‰çš„æ€è€ƒ"><a href="#åˆ†æå‰çš„æ€è€ƒ" class="headerlink" title="åˆ†æå‰çš„æ€è€ƒ"></a>åˆ†æå‰çš„æ€è€ƒ</h2><p>è¯·å¤§å®¶æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“fragment çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸å…¶å®¿ä¸» activity çš„ç”Ÿå‘½å‘¨æœŸæ¯æ¯ç›¸å…³çš„ï¼Œä¹Ÿå³ activity çš„æ¯æ¬¡ç”Ÿå‘½å‘¨æœŸå›è°ƒéƒ½ä¼šå¼•å‘æ¯ä¸ªfragmentçš„ç±»ä¼¼å›è°ƒã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœè®©æˆ‘ä»¬æ¥å®ç°è¿™æ ·çš„æ“ä½œï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ</p><blockquote><p> çŒœæµ‹ï¼šåœ¨activityæ¯ä¸ªç”Ÿå‘½å‘¨æœŸçš„èŠ‚ç‚¹ï¼Œå»æ“ä½œfragmentï¼Œè®©å…¶æ‰§è¡Œç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</p></blockquote><p>æ€è·¯æœ‰äº†ï¼Œä¸‹é¢è¿›è¡Œä¸€äº›ç»†èŠ‚çš„ç¡®è®¤ã€‚</p><ol><li>activity è¦èƒ½æ“ä½œ fragmentï¼Œfragment äº¦å¯æ“ä½œ fragmentï¼Œæ‰€ä»¥éœ€è¦æŠ½è±¡å‡ºä¸€ä¸ªç®¡ç† fragment çš„æ¨¡å‹</li><li>activity æ“ä½œ fragment çš„ä¸€ç³»åˆ—åŠ¨ä½œï¼Œåº”è¯¥æ˜¯äº’ä¸ºå¯é€†ä¸€ç»„æ“ä½œã€‚ä¾‹å¦‚æ·»åŠ  fragment åï¼Œä¹Ÿåº”èƒ½ç§»é™¤ fragment</li><li>activity å¯¹ fragment çš„æ¯ç»„æ“ä½œä¸åº”æ˜¯å•ä¸€çš„ï¼Œä¾‹å¦‚å¯ä»¥åœ¨ä¸€æ¬¡æ“ä½œä¸­åœ¨ activity ä¸åŒä½ç½®æ·»åŠ ä¸¤ä¸ª fragmentï¼ŒåŒæ—¶è¯¥æ“ä½œè¿˜åº”æ»¡è¶³ 2 ï¼Œå…·æœ‰å¯é€†æ€§</li></ol><p>å¯¹äºç¬¬ä¸€æ¡ï¼Œæˆ‘ä»¬æŠ½è±¡å‡ºä¸€ä¸ªå¯ä»¥ç®¡ç† fragment çš„æ¨¡å‹ï¼ŒåŠ å…¥ä¸Šä¸‹çº§çš„å…³ç³»ï¼Œå³ activity å¯ç®¡ç†å…¶å†…éƒ¨çš„ fragmentï¼Œfragment äº¦å¯ç®¡ç†å…¶å†…éƒ¨çš„ fragmentã€‚å› æ­¤ fragment åŒæ—¶å……å½“ç€ç®¡ç†è€…ä¸è¢«ç®¡ç†è€…ä¸¤ç§è§’è‰²</p><p>å¯¹äºåä¸¤æ¡ï¼Œç›¸ä¿¡åœ¨å¤§å­¦å­¦è¿‡æ•°æ®åº“çš„äººä¼šæƒ³åˆ°ä¸€ç§ç»“æ„ï¼š<strong>äº‹åŠ¡ï¼ˆTransactionï¼‰</strong></p><blockquote><p> äº‹åŠ¡æ˜¯æŒ‡ä¸€ç»„åŸå­æ€§çš„æ“ä½œï¼Œè¿™äº›æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œè¦ä¹ˆå…¨å®Œæˆï¼Œè¦ä¹ˆå…¨ä¸å®Œæˆï¼Œå®Œæˆåå¯ä»¥å›æ»šåˆ°å®Œæˆå‰çš„çŠ¶æ€</p></blockquote><p>å› æ­¤ï¼Œfragment ä¸­ä¸¤ä¸ªæœ€é‡è¦çš„æ¦‚å¿µå‡ºç°äº†ï¼Œ<code>FragmentManager</code> å’Œ <code>FragmentTransaction</code></p><p><code>FragmentManager</code>  å°è£…ç€å¯¹ fragment æ“ä½œçš„å„ç§æ–¹æ³•ï¼Œ<code>addFragment</code> <code>removeFragment</code> ç­‰ç­‰ï¼Œè€Œ <code>FragmentActivity</code> é€šè¿‡ <code>FragmentController</code> æ¥æ“ä½œ <code>FragmentManager</code>  </p><p><code>FragmentTransaction</code> å°è£…å¯¹ fragment å®¹å™¨è¿›è¡Œçš„ fragment æ“ä½œï¼Œä¾‹å¦‚åœ¨å®¹å™¨1å†…æ·»åŠ ä¸€ä¸ª fragmentï¼ŒåŒæ—¶åœ¨å®¹å™¨2å†…æ›¿æ¢fragmentã€‚</p><p>å®ƒä»¬å‡ä¸ºæŠ½è±¡ç±»ï¼Œéœ€è¦å…·ä½“çš„å®ç°ç±»ã€‚</p><p><code>FragmentManager</code> çš„å®ç°ç±»ä¸º <code>FragmentManagerImpl</code>ï¼Œå…¶å†…éƒ¨é€»è¾‘å·²å…¨éƒ¨ç§»è‡³ <code>FragmentManager</code>  ä¸­ï¼Œæ˜¯ä¸ªç©ºå®ç°ã€‚</p><p><code>FragmentTransaction</code> çš„å®ç°ç±»ä¸º <code>BackStackRecord</code> ï¼Œå…¶å†…éƒ¨å¼•ç”¨äº† <code>FragmentManager</code> çš„å®ä¾‹ ï¼ŒåŒæ—¶é‡å†™äº†çˆ¶ç±»çš„ å››ä¸ª <code>commit</code> ç›¸å…³çš„æ–¹æ³•ã€‚</p><h2 id="çœ‹ä¼¼æœ€ç®€å•çš„å¯åŠ¨æµç¨‹"><a href="#çœ‹ä¼¼æœ€ç®€å•çš„å¯åŠ¨æµç¨‹" class="headerlink" title="çœ‹ä¼¼æœ€ç®€å•çš„å¯åŠ¨æµç¨‹"></a>çœ‹ä¼¼æœ€ç®€å•çš„å¯åŠ¨æµç¨‹</h2><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€éƒ¨åˆ†ä»£ç ï¼Œå¹³æ—¶åœ¨activityä¸­æˆ‘ä»¬æ˜¯è¿™æ ·å¡«å……ä¸€ä¸ªfragmentçš„</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>       <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>       <span class="hljs-comment">//é¿å…æ—‹è½¬å±å¹•ç­‰åœºæ™¯ fragment é‡å çš„é—®é¢˜</span><br>       <span class="hljs-keyword">if</span> (savedInstanceState == <span class="hljs-literal">null</span>) &#123;<br>           supportFragmentManager<span class="hljs-comment">//æ­¥éª¤1</span><br>               .beginTransaction()<span class="hljs-comment">//æ­¥éª¤2</span><br>               .add(R.id.container, BlankFragment.newInstance())<span class="hljs-comment">//æ­¥éª¤3</span><br>               .commitNow()<span class="hljs-comment">//æ­¥éª¤4</span><br>       &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>æ­¥éª¤1ï¼Œå®ä¾‹åŒ– <code>FragmentManagerImpl</code> å¯¹è±¡ (å†…éƒ¨ç»å†äº†ä¸€äº›è½¬æ¢ï¼Œè¯¦æƒ…å‚è§æºç æˆ–æŸ¥çœ‹demoæ³¨é‡Š)</p></li><li><p>æ­¥éª¤2ï¼Œå®ä¾‹åŒ– <code>BackStackRecord</code>å¯¹è±¡ï¼Œå¹¶åœ¨æ„é€ å™¨ä¸­ä¼ å…¥ <code>FragmentManager</code> å®ä¾‹</p></li><li><p>æ­¥éª¤3ï¼Œè°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼Œå¯¹ fragment å®¹å™¨è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œæœ¬ä¾‹è¡¨ç¤ºåœ¨ id ä¸º <code>container</code> å®¹å™¨å†…æ·»åŠ  <code>BlankFragment</code></p></li><li><p>æ­¥éª¤4ï¼Œæäº¤äº‹åŠ¡ï¼Œäº¤äº <code>FragmentManager</code> å¤„ç†</p></li></ul><p>åœ¨ terminal æ•²å…¥ <code>adb shell setprop log.tag.FragmentManager VERBOSE</code> å¯å¼€å¯<code>FragmentManager</code>çš„æ—¥å¿—åŠŸèƒ½ï¼Œè¿‡æ»¤ <code>FragmentManager</code> ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084150.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å•fragmentå¯åŠ¨æ—¥å¿—"></p><p>ç»¿è‰²éƒ¨åˆ†ä¸ºç¬”è€…æ‰‹åŠ¨æ·»åŠ çš„logï¼Œç°è‰²å’Œè“è‰²éƒ¨åˆ†ä¸º fragment æºç ä¸­çš„log</p><p>æ ¹æ®æ—¥å¿—æ˜¾ç¤ºçš„æµç¨‹ï¼Œæˆ‘ä»¬çš„çŒœæµ‹çœ‹ä¼¼æ˜¯æ­£ç¡®çš„ï¼Œâ€œåœ¨ activity æ¯ä¸ªç”Ÿå‘½å‘¨æœŸçš„èŠ‚ç‚¹ï¼Œå»æ“ä½œ fragment ï¼Œè®©å…¶æ‰§è¡Œç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•â€</p><p>å…¶å®è¿™é‡Œæ˜¯æœ‰å¹²æ‰°çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨activity çš„ <code>onCreate</code> æ–¹æ³•é‡Œ åˆ›å»ºå¹¶æäº¤ <code>FragmentTransaction</code> ï¼Œå¦‚æœåœ¨ <code>onResume</code> é‡Œè°ƒç”¨å‘¢ï¼Ÿ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084240.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å•fragmentå¯åŠ¨æ—¥å¿—2"></p><p>WTFï¼</p><p>æˆ–è®¸ï¼Œæˆ‘ä»¬çš„çŒœæµ‹æœ‰é—®é¢˜ï¼Ÿçœ‹ä¼¼è°ƒç”¨ <code>commitNow</code> å fragment çš„ç”Ÿå‘½æµç¨‹æ˜¯è‡ªå‘è¿›è¡Œçš„</p><p>é‚£å¦‚æœæˆ‘ä»¬æŠŠè°ƒç”¨æŒªåˆ° <code>onPause</code> å‘¢ï¼Ÿ</p><p>æ‰“å¼€ activity å¹¶æŒ‰ä¸‹ home é”®</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084122.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å•fragmentå¯åŠ¨æ—¥å¿—-onPause"></p><p>æˆ‘çŸ¥é“å¥½å¥‡çš„è¯»è€…ä¼šå°è¯•åœ¨ <code>onStop</code> ä¸­å°è¯•ä¸€ä¸‹ï¼Œæœ‰æƒŠå–œã€‚æ‰‹åŠ¨æ»‘ç¨½ã€‚</p><p>ä»è¿™å‡ æ®µæ—¥å¿—ä¸Šæ¥çœ‹ï¼Œfragment åœ¨æäº¤äº‹åŠ¡åä¼šè‡ªå‘è¿›å…¥è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼Œè€Œå½“å…¶å®¿ä¸» activity  ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–æ—¶ï¼Œfragment çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿè·Ÿéšå˜åŒ–ã€‚</p><p>å¦‚æœè¿™ä¹ˆè¯´æ¯”è¾ƒæŠ½è±¡çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åœ¨ onPause ä¸­æ˜¾ç¤ºfragment çš„æ—¥å¿—ï¼Œå½“ Fragment è¿›å…¥ onStart ç”Ÿå‘½å‘¨æœŸåï¼Œå¦‚æœæ˜¯æ­£å¸¸æµç¨‹åº”è¯¥è¿›å…¥ onResumeï¼Œä½†ç”±äºæŒ‰ä¸‹ home é”® activityè¿›å…¥onStopï¼Œfragment ä¹Ÿè¿›å…¥äº† onStop çŠ¶æ€</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å°†ä¹‹å‰çš„çŒœæµ‹è¿›è¡Œæ‰©å±•ï¼š</p><blockquote><ol><li>åœ¨activityæ¯ä¸ªç”Ÿå‘½å‘¨æœŸçš„èŠ‚ç‚¹ï¼Œå»æ“ä½œfragmentï¼Œè®©å…¶æ‰§è¡Œç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</li><li>FragmentTransaction  è¢«æäº¤å fragment ä¼šè¿›å…¥è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼Œä½†å— 1 çº¦æŸ</li></ol></blockquote><p>é‚£ä¹ˆæˆ‘ä»¬çš„æºç è§£è¯»å°±ä»ä¸¤ä¸ªæ–¹å‘å…¥æ‰‹</p><h2 id="Activity-æ“ä½œ-Fragment-ç”Ÿå‘½å‘¨æœŸ"><a href="#Activity-æ“ä½œ-Fragment-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Activity æ“ä½œ Fragment ç”Ÿå‘½å‘¨æœŸ"></a>Activity æ“ä½œ Fragment ç”Ÿå‘½å‘¨æœŸ</h2><p>activity æ˜¯é€šè¿‡ <code>FragmentController</code>  æ“ä½œ  <code>FragmentManager</code>  è¿›è€Œæ“ä½œ fragment çš„ã€‚</p><p>å…·ä½“ç‚¹å°±æ˜¯åœ¨ activity å„ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹é€šè¿‡è°ƒç”¨ <code>FragmentController</code> ä¸­çš„å„ä¸ª <code>dispatch-</code> æ–¹æ³•è¿›è€Œè°ƒç”¨ <code>FragmentManager</code> ä¸­çš„å„ä¸ª <code>dispatch-</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//FragmentActivity.java</span><br><span class="hljs-keyword">final</span> FragmentController mFragments = FragmentController.createController(<span class="hljs-keyword">new</span> HostCallbacks());<br><br><span class="hljs-comment">//ä»¥ä¸‹ä»£ç çœç•¥éƒ¨åˆ†é€»è¾‘</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;<br>    mFragments.dispatchCreate();<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span> </span>&#123;<br>    mFragments.dispatchStart();<br>&#125;<br><br><span class="hljs-comment">//onResume å½»åº•æ‰§è¡Œå®Œæ¯•çš„å›è°ƒ</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPostResume</span><span class="hljs-params">()</span> </span>&#123;<br>    mFragments.dispatchResume();<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPause</span><span class="hljs-params">()</span> </span>&#123;<br>    mFragments.dispatchPause();<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span> </span>&#123;<br>    mFragments.dispatchStop();<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>.onDestroy();<br>    mFragments.dispatchDestroy();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·çŒœæµ‹ 1 å°±è¢«è¯å®äº†</p><p><strong>activity ä¼šåœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹é€šè¿‡ <code>FragmentController</code> é—´æ¥è°ƒç”¨ <code>FragmentManager</code>  ä¸­çš„ å„ç§ <code>dispatch-</code> æ–¹æ³•ï¼Œè¿›è€Œå½±å“ fragment çš„ç”Ÿå‘½å‘¨æœŸ</strong></p><p>é‚£ä¹ˆåµŒå¥— fragment å‘¢ï¼Ÿ</p><p>åµŒå¥— fragment ä¹Ÿåº”è¯¥æ˜¯å®¿ä¸»ä½¿ç”¨ <code>FragmentManager</code>  ä¸­çš„å„ç§ <code>dispatch-</code> æ–¹æ³•ï¼ŒåŸºäºè¿™ä¸ªæƒ³æ³•æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ <code>FragmentManager</code>  ä¸­ <code>dispatch-</code> æ–¹æ³•çš„è°ƒç”¨</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084349.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="dispatch-æ–¹æ³•çš„å¼•ç”¨"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸¤å¤„è°ƒç”¨ï¼Œç¬¬äºŒå¤„ä¸ºactivity é€šè¿‡ <code>FragmentController</code> é—´æ¥è°ƒç”¨ï¼Œç¬¬ä¸€å¤„ä½¿ç”¨çš„æ˜¯ <code>mChildFragmentManager</code></p><p><strong>è¿™é‡Œå¼•å‡º fragment ä¸­å¦å¤–ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼Œ<code>getParentFragmentManager()</code> å’Œ <code>getChildFragmentManager()</code></strong></p><blockquote><p>æ³¨æ„ï¼š<code>requireFragmentManager()</code> å’Œ <code>getFragmentManager</code> å·²å¼ƒç”¨</p></blockquote><p><code>getChildFragmentManager()</code>è·å–çš„æ˜¯fragment ä¸­çš„ <code>mChildFragmentManager</code></p><p><code>getParentFragmentManager()</code> è·å–çš„æ˜¯fragment ä¸­çš„ <code>mFragmentManager</code></p><p><code>mChildFragmentManager</code> ä¸ºfragmentå†…éƒ¨çš„ <code>fragmentManager</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Private fragment manager for child fragments inside of this one.</span><br><span class="hljs-meta">@NonNull</span><br>FragmentManager mChildFragmentManager = <span class="hljs-keyword">new</span> FragmentManagerImpl();<br></code></pre></td></tr></table></figure><p><code>mFragmentManager</code> ç¨æ˜¾å¤æ‚ï¼Œ</p><ol><li>å¦‚æœ fragment çš„ç›´æ¥å®¿ä¸»æ˜¯ activity ï¼Œåˆ™è¿”å›çš„æ˜¯ activity ä¸­çš„<code>getSupportFragmentManager()</code> è¿”å›çš„ <code>fragmentManager</code></li><li>å¦‚æœ fragment çš„ç›´æ¥å®¿ä¸»æ˜¯ fragmentï¼Œå³è¯¥ fragment æ˜¯å…¶ä»– fragment çš„å­ fragmentï¼Œåˆ™è¿”å›çš„æ˜¯å…¶çˆ¶ fragment çš„ <code>getChildFragmentManager</code></li></ol><p><strong>æ‰€ä»¥ åµŒå¥—fragment çš„ç”Ÿå‘½å‘¨æœŸæ˜¯çˆ¶ fragment åœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ä¸Šé€šè¿‡ <code>mChildFragmentManager</code> è°ƒç”¨ <code>dispatch-</code>  ä»¥å½±å“å…¶å­ fragment çš„ç”Ÿå‘½å‘¨æœŸ</strong></p><p>è¿™æ ·æˆ‘ä»¬ç¬¬ä¸€éƒ¨åˆ†çš„è§£è¯»å°±å‘Šä¸€æ®µè½äº†, è¿™é‡Œç‚¹åˆ°ä¸ºæ­¢,ä¸€äº›ç»†èŠ‚éœ€è¦æ‚¨è‡ªå·±äº²è‡ªçœ‹çœ‹æºç </p><h2 id="Fragment-çš„ç”Ÿå‘½å‘¨æœŸè‡ªæ²»"><a href="#Fragment-çš„ç”Ÿå‘½å‘¨æœŸè‡ªæ²»" class="headerlink" title="Fragment çš„ç”Ÿå‘½å‘¨æœŸè‡ªæ²»"></a>Fragment çš„ç”Ÿå‘½å‘¨æœŸè‡ªæ²»</h2><p>åœ¨ <code>çœ‹ä¼¼æœ€ç®€å•çš„å¯åŠ¨æµç¨‹</code> ä¸€èŠ‚ä¸­æˆ‘ä»¬åˆ†åˆ«åœ¨ activity çš„ onCreate ï¼ŒonResumeï¼ŒonPause ä¸­åˆ†åˆ«å¼€å¯å¹¶æäº¤äº‹åŠ¡ï¼Œæ¥è§‚å¯Ÿ fragment çš„ç”Ÿå‘½å‘¨æœŸæ—¥å¿—ã€‚</p><p>åœ¨æ²¡æœ‰ activity å¹²æ‰°çš„æƒ…å†µä¸‹ï¼Œfragment çš„ç”Ÿå‘½å‘¨æœŸæ˜¯è‡ªæ²»çš„ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­æ€è€ƒä¸€ä¸ªé—®é¢˜</p><p>Fragment çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¦‚ä½•ä¸€ç¯æ‰£ä¸€ç¯çš„æ‰§è¡Œçš„ï¼Ÿ</p><p>ä»ä¸Šé¢çš„æ—¥å¿—ï¼Œæˆ‘ä»¬çœ‹åˆ°å¾ˆå¤š â€œmoveto-â€ çš„æ—¥å¿—ï¼Œ</p><p><strong>æˆ‘ä»¬å¯ä»¥ç»§ç»­å¤§èƒ†åœ°çŒœæµ‹ï¼Œä¸€ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ç»“æŸåè°ƒç”¨è¿›å…¥å¦ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹çš„æ–¹æ³•</strong></p><p>åŸºäºè¿™ä¸ªçŒœæµ‹ï¼Œæˆ‘ä»¬ç¡®è®¤ä¸€äº›ç»†èŠ‚</p><p>fragment åº”è¯¥æœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œå®ƒå¯èƒ½è‡ªå·±ç®¡ç†å†…éƒ¨çš„çŠ¶æ€ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰å°è£…ç€çŠ¶æ€è½¬ç§»çš„é€»è¾‘çš„ä¸“é—¨ç®¡ç†çŠ¶æ€çš„æŠ½è±¡</p><p>è¿™é‡Œå¼•å‡ºå¦å¤–ä¸€ä¸ªæ¦‚å¿µ <code>FragmentStateManager</code></p><p><code>FragmentStateManager</code> ä¸­æŒæœ‰ fragment çš„å¼•ç”¨ <code>mFragment</code> ä»¥åŠ <code>FragmentManager</code> çš„çŠ¶æ€ <code>mFragmentManagerState</code></p><p>è¿™é‡Œfragmentçš„çŠ¶æ€å€¼ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> INITIALIZING = -<span class="hljs-number">1</span>;    <span class="hljs-comment">// Not yet attached.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ATTACHED = <span class="hljs-number">0</span>;         <span class="hljs-comment">// Attached to the host.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CREATED = <span class="hljs-number">1</span>;          <span class="hljs-comment">// Created.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ACTIVITY_CREATED = <span class="hljs-number">2</span>; <span class="hljs-comment">// Fully created, not started.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> STARTED = <span class="hljs-number">3</span>;          <span class="hljs-comment">// Created and started, not resumed.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> RESUMED = <span class="hljs-number">4</span>;          <span class="hljs-comment">// Created started and resumed.</span><br></code></pre></td></tr></table></figure><p><code>FragmentStateManager</code> è¿˜å°è£…ç€ fragment çŠ¶æ€è½¬ç§»çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">activityCreated</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (FragmentManager.isLoggingEnabled(Log.DEBUG)) &#123;<br>        Log.d(TAG, <span class="hljs-string">"moveto ACTIVITY_CREATED: "</span> + mFragment);<br>    &#125;<br>    mFragment.performActivityCreated(mFragment.mSavedFragmentState);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (FragmentManager.isLoggingEnabled(Log.DEBUG)) &#123;<br>        Log.d(TAG, <span class="hljs-string">"moveto STARTED: "</span> + mFragment);<br>    &#125;<br>    mFragment.performStart();<br>&#125;<br></code></pre></td></tr></table></figure><p>fragment ç”Ÿå‘½å‘¨æœŸè‡ªæ²»çš„æ ¸å¿ƒé€»è¾‘å°è£…åœ¨ <code>FragmentManager</code> ä¸­çš„ <code>void moveToState(@NonNull Fragment f, int newState)</code>  å†…ï¼Œä¸»è¦ä»£ç ä¸º(ç²¾ç®€å)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">moveToState</span><span class="hljs-params">(@NonNull Fragment f, <span class="hljs-keyword">int</span> newState)</span> </span>&#123;<br>    FragmentStateManager fragmentStateManager = mFragmentStore.getFragmentStateManager(f.mWho);<br><br>    newState = Math.min(newState, fragmentStateManager.computeMaxState());<br>    <span class="hljs-keyword">if</span> (f.mState &lt;= newState) &#123;<br>        <span class="hljs-keyword">switch</span> (f.mState) &#123;<br>            <span class="hljs-keyword">case</span> Fragment.INITIALIZING:<br>                <span class="hljs-keyword">if</span> (newState &gt; Fragment.INITIALIZING) &#123;<br>                    fragmentStateManager.attach(mHost, <span class="hljs-keyword">this</span>, mParent);<br>                &#125;<br>            <span class="hljs-keyword">case</span> Fragment.ATTACHED:<br>                <span class="hljs-keyword">if</span> (newState &gt; Fragment.ATTACHED) &#123;<br>                    fragmentStateManager.create();<br>                &#125;<br>            <span class="hljs-keyword">case</span> Fragment.CREATED:<br>                <span class="hljs-keyword">if</span> (newState &gt; Fragment.INITIALIZING) &#123;<br>                    fragmentStateManager.ensureInflatedView();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (newState &gt; Fragment.CREATED) &#123;<br>                    fragmentStateManager.createView(mContainer);<br>                    fragmentStateManager.activityCreated();<br>                    fragmentStateManager.restoreViewState();<br>                &#125;<br>            <span class="hljs-keyword">case</span> Fragment.ACTIVITY_CREATED:<br>                <span class="hljs-keyword">if</span> (newState &gt; Fragment.ACTIVITY_CREATED) &#123;<br>                    fragmentStateManager.start();<br>                &#125;<br>            <span class="hljs-keyword">case</span> Fragment.STARTED:<br>                <span class="hljs-keyword">if</span> (newState &gt; Fragment.STARTED) &#123;<br>                    fragmentStateManager.resume();<br>                &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šè¿™é‡Œçš„switch æ²¡æœ‰ break</p></blockquote><p>ç»†å¿ƒçš„è¯»è€…å¯èƒ½å‘ç°äº†ï¼Œfragment ä¸­çš„çŠ¶æ€æ€ä¹ˆåªåˆ° resume ï¼Œåç»­çš„çŠ¶æ€å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ <code>FragmentManager</code> ä¸­çš„ <code>dispatchPause</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dispatchPause</span><span class="hljs-params">()</span> </span>&#123;<br>    dispatchStateChange(Fragment.STARTED);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ dispatch äº† <code>STARTED</code> çš„çŠ¶æ€ï¼Ÿå…¶å®åˆšåˆš <code>moveToState</code> æ–¹æ³•æˆ‘ç²¾ç®€æ‰äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œç•™ä¸‹çš„åªæœ‰ <code>f.mState &lt;= newState</code> çš„é€»è¾‘ï¼Œå³ <strong>dispatch çš„æ–°çŠ¶æ€å¤§äºç­‰äºå½“å‰çš„çŠ¶æ€</strong></p><p>è€Œç°åœ¨dispatch çš„æ–°çŠ¶æ€æ¯”å½“å‰çŠ¶æ€å€¼å°ï¼Œåˆ™èµ°äº†ä¸‹é¢çš„é€»è¾‘ï¼Œä¾‹å¦‚å½“å‰çŠ¶æ€ä¸º RESUMED ï¼Œæ–°ä¼ é€’çš„çŠ¶æ€ä¸º STARTEDï¼Œæ‰§è¡Œäº† <code>fragmentStateManager.pause();</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">moveToState</span><span class="hljs-params">(@NonNull Fragment f, <span class="hljs-keyword">int</span> newState)</span> </span>&#123;<br>    FragmentStateManager fragmentStateManager = mFragmentStore.getFragmentStateManager(f.mWho);<br><br>    newState = Math.min(newState, fragmentStateManager.computeMaxState());<br>    <span class="hljs-keyword">if</span> (f.mState &lt;= newState) &#123;<br>    <span class="hljs-comment">//çœç•¥...   </span><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f.mState &gt; newState) &#123;<br>        <span class="hljs-keyword">switch</span> (f.mState) &#123;<br>            <span class="hljs-keyword">case</span> Fragment.RESUMED:<br>                <span class="hljs-keyword">if</span> (newState &lt; Fragment.RESUMED) &#123;<br>                    fragmentStateManager.pause();<br>                &#125;<br>                <br>            <span class="hljs-keyword">case</span> Fragment.STARTED:<br>                <span class="hljs-keyword">if</span> (newState &lt; Fragment.STARTED) &#123;<br>                    fragmentStateManager.stop();<br>                &#125;<br>                <br>            <span class="hljs-keyword">case</span> Fragment.ACTIVITY_CREATED:<br>                <span class="hljs-keyword">if</span> (newState &lt; Fragment.ACTIVITY_CREATED) &#123;<br>                    <span class="hljs-keyword">if</span> (isLoggingEnabled(Log.DEBUG)) &#123;<br>                        Log.d(TAG, <span class="hljs-string">"movefrom ACTIVITY_CREATED: "</span> + f);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (f.mView != <span class="hljs-keyword">null</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (mHost.onShouldSaveFragmentState(f) &amp;&amp; f.mSavedViewState == <span class="hljs-keyword">null</span>) &#123;<br>                            fragmentStateManager.saveViewState();<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (mExitAnimationCancellationSignals.get(f) == <span class="hljs-keyword">null</span>) &#123;<br>                        destroyFragmentView(f);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        f.setStateAfterAnimating(newState);<br>                    &#125;<br>                &#125;<br>            <span class="hljs-keyword">case</span> Fragment.CREATED:<br>                <span class="hljs-keyword">if</span> (newState &lt; Fragment.CREATED) &#123;<br>                    <span class="hljs-keyword">boolean</span> beingRemoved = f.mRemoving &amp;&amp; !f.isInBackStack();<br>                    <span class="hljs-keyword">if</span> (beingRemoved || mNonConfig.shouldDestroy(f)) &#123;<br>                        makeInactive(fragmentStateManager);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (f.mTargetWho != <span class="hljs-keyword">null</span>) &#123;<br>                            Fragment target = findActiveFragment(f.mTargetWho);<br>                            <span class="hljs-keyword">if</span> (target != <span class="hljs-keyword">null</span> &amp;&amp; target.getRetainInstance()) &#123;<br>                                f.mTarget = target;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (mExitAnimationCancellationSignals.get(f) != <span class="hljs-keyword">null</span>) &#123;<br>                        f.setStateAfterAnimating(newState);<br>                        newState = Fragment.CREATED;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        fragmentStateManager.destroy(mHost, mNonConfig);<br>                    &#125;<br>                &#125;<br>            <span class="hljs-keyword">case</span> Fragment.ATTACHED:<br>                <span class="hljs-keyword">if</span> (newState &lt; Fragment.ATTACHED) &#123;<br>                    fragmentStateManager.detach(mNonConfig);<br>                &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šè¿™é‡Œçš„switch è¿˜æ˜¯æ²¡æœ‰ break</p></blockquote><p>è¿™é‡Œæœ‰ä¸ªç»†èŠ‚ï¼Œç”±äºactivityæ²¡æœ‰ onDestroyView çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥ <code>FragmentController</code> ä¸­çš„ <code>dispatchDestroyView</code> æ˜¯æ²¡æœ‰è°ƒç”¨çš„</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084417.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="dispatchOnDestroyView"></p><p> åœ¨ activity ä¸­çš„ destroy æ–¹æ³•ä¸­é€šè¿‡ <code>fragmentController</code> è°ƒç”¨äº† <code>dispatchDestroy</code> å†…éƒ¨è°ƒç”¨ <code>dispatchStateChange(Fragment.INITIALIZING)</code> ï¼Œè€Œæ­¤æ—¶çš„fragment çš„ mState ä¸º <code>ACTIVITY_CREATED</code>ï¼Œæ‰€ä»¥ <code>moveToState</code> æ–¹æ³•ä¼šèµ°åˆ° <code>ACTIVITY_CREATED</code> çš„ case å¹¶æ‰§è¡Œåˆ°åº•</p><p>è¿™æ · fragment æœ€ç®€å•åœºæ™¯çš„ç”Ÿå‘½å‘¨æœŸå°±ç»“æŸäº†</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬åšä¸€ä¸ªæ€»ç»“ï¼šactivity å’Œ fragment ä¼šåœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹é€šè¿‡è¢«è°ƒç”¨ fragment çš„ <code>parentFragmentManager</code>ï¼ˆæˆ–è€…è¯´çˆ¶ fragment çš„ <code>childFragmentManager</code> å’Œ activity çš„ <code>supportFragmentManager</code>ï¼‰ä¸­çš„å„ç§ <code>dispatch-</code> æ–¹æ³•ä»¥å½±å“å­ fragment çš„ ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶å­ fragment ä¹Ÿæ‹¥æœ‰è‡ªå·±ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨é“¾ï¼ˆä»çŠ¶æ€Aè½¬ç§»è‡³çŠ¶æ€Bï¼‰</p><p>ä¸å¾—ä¸è¯´ fragment çš„å¾ˆå¤š API å¹¶ä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œä» androidx fragment çš„æ›´æ–°é¢‘ç‡ä¹Ÿå¯ä»¥çœ‹å‡ºã€‚æ¯”å¦‚ fragment ä¸­çš„ view å’Œ fragmentæœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ä¸€è‡´çš„ï¼Œå­˜åœ¨onDestroyView ä½† fragmentæ²¡æœ‰é”€æ¯çš„æƒ…å†µ</p><p><a href="https://medium.com/@ianhlake" target="_blank" rel="noopener">Ian Lake</a> åœ¨ <a href="https://www.youtube.com/watch?v=RS1IACnZLy4" target="_blank" rel="noopener">Fragments: Past, Present, and Future (Android Dev Summit â€˜19)</a> ä¸­æåˆ°æœªæ¥å®˜æ–¹ä¼šå°†äºŒè€…åˆå¹¶ï¼Œå±Šæ—¶ fragment çš„ä½¿ç”¨ä¼šæ›´åŠ ç®€æ´</p><p>è¿™é‡Œå¼•ç”¨ <a href="https://medium.com/androiddevelopers/the-android-lifecycle-cheat-sheet-part-iii-fragments-afc87d4f37fd" target="_blank" rel="noopener">The Android Lifecycle cheat sheet â€” part III : Fragments</a> æ–‡ä¸­çš„å›¾ç‰‡ ï¼Œå’Œæˆ‘ç”»çš„commit <code>FragmentTransaction</code>  çš„è„‘å›¾ï¼ˆç•¥ç®€é™‹ï¼‰ï¼Œå¸®æ‚¨æ›´å¥½çš„ç†è§£</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084444.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt=" [The Android Lifecycle cheat sheet â€” part III : Fragments](https://medium.com/androiddevelopers/the-android-lifecycle-cheat-sheet-part-iii-fragments-afc87d4f37fd)"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200324084515.png" src="/2020/03/10/Jetpack-fragment-lifecycle/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="fragmentè„‘å›¾"></p><p>å¼ºçƒˆå»ºè®®æ‚¨è‡ªå·±äº²è‡ªçœ‹ä¸€çœ‹æºç ï¼Œä¸ç„¶å°±å˜ä¸ºæˆ‘æ–‡ç« å¼€å¤´æ—¶è¯´çš„çŠ¶æ€äº†ã€‚</p><hr><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><hr><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackä¹‹Fragmentã€‘ä½ çœŸçš„ä¼šç”¨Fragmentå—ï¼ŸFragmentå¸¸è§é—®é¢˜ä»¥åŠandroidxä¸‹Fragmentçš„ä½¿ç”¨æ–°å§¿åŠ¿</title>
      <link href="/2020/03/02/Jetpack-fragment/"/>
      <url>/2020/03/02/Jetpack-fragment/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨ <code>Android Jetpack</code> ç»„ä»¶ä¸­ï¼Œ<code>fragment</code>ä½œä¸ºè§†å›¾æ§åˆ¶å™¨ä¹‹ä¸€å æœ‰å¾ˆé‡è¦çš„ä½ç½®ã€‚ä½†ç”±äºå…¶bugä¼—å¤šï¼Œæš—å‘æ— æ•°ï¼Œä»¥è‡³äº Square æœ‰è¿™æ ·ä¸€ç¯‡åšå®¢ï¼š<a href="https://developer.squareup.com/blog/advocating-against-android-fragments/" target="_blank" rel="noopener">Advocating Against Android Fragments</a>ã€‚githubä¸Šçš„ <a href="https://github.com/YoKeyword/Fragmentation" target="_blank" rel="noopener">Fragmentation</a> æœ‰ç€ 9.4k çš„starã€‚</p><p>è€Œç°åœ¨ï¼Œ<code>androidx fragment</code> ç¨³å®šç‰ˆå·²æ¥åˆ° 1.2.2ï¼Œè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹<code>fragment</code>æœ‰å“ªäº›å¸¸è§é—®é¢˜ä»¥åŠæœ‰å“ªäº›ä½¿ç”¨<code>fragment</code>çš„æ–°å§¿åŠ¿</p></blockquote><a id="more"></a><h2 id="Fragment-å¸¸è§çš„é—®é¢˜"><a href="#Fragment-å¸¸è§çš„é—®é¢˜" class="headerlink" title="Fragment å¸¸è§çš„é—®é¢˜"></a>Fragment å¸¸è§çš„é—®é¢˜</h2><ul><li><p>getSupportFragmentManager ï¼Œ getParentFragmentManager å’Œ getChildFragmentManager</p></li><li><p>FragmentStateAdapter å’Œ FragmentPagerAdapter</p></li><li><p>add å’Œ replace </p></li><li><p>observe LiveDataæ—¶ä¼ å…¥ this è¿˜æ˜¯ viewLifecycleOwner</p></li><li><p>ä½¿ç”¨ simpleName ä½œä¸º fragment çš„ tag æœ‰ä½•é£é™©ï¼Ÿ</p></li><li><p>åœ¨ BottomBarNavigation å’Œ drawer ä¸­å¦‚ä½•ä½¿ç”¨Fragmentå¤šæ¬¡æ·»åŠ ï¼Ÿ</p></li><li><p>è¿”å›æ ˆ</p></li></ul><h3 id="getSupportFragmentManager-getParentFragmentManagerå’ŒgetChildFragmentManager"><a href="#getSupportFragmentManager-getParentFragmentManagerå’ŒgetChildFragmentManager" class="headerlink" title="getSupportFragmentManager , getParentFragmentManagerå’ŒgetChildFragmentManager"></a>getSupportFragmentManager , getParentFragmentManagerå’ŒgetChildFragmentManager</h3><blockquote><p><code>FragmentManager</code>æ˜¯ <code>androidx.fragment.app</code>(å·²å¼ƒç”¨çš„ä¸è€ƒè™‘)ä¸‹çš„æŠ½è±¡ç±»ï¼Œåˆ›å»ºç”¨äº æ·»åŠ ï¼Œç§»é™¤ï¼Œæ›¿æ¢ <code>fragment</code> çš„äº‹åŠ¡ï¼ˆ<code>transaction</code>ï¼‰  </p></blockquote><p>é¦–å…ˆè¦ç¡®è®¤ä¸€ä»¶äº‹ï¼Œ<code>getSupportFragmentManager()</code>æ˜¯ <code>FragmentActivity</code>ä¸‹çš„æ–¹æ³•</p><p><code>getParentFragmentManager</code> å’Œ <code>getChildFragmentManager</code> æ˜¯ <code>androidx.fragment.app.Fragment</code> ä¸‹çš„æ–¹æ³•ï¼Œ<strong>å…¶ä¸­  <code>androidx.fragment 1.2.0</code> å <code>getFragmentManager</code> ä¸  <code>requireFragmentManager</code> å·²å¼ƒç”¨</strong></p><p>æ˜ç¡®äº†è¿™ä»¶äº‹ï¼Œæ¥ä¸‹æ¥çš„å°±å¾ˆæ¸…æ™°äº†</p><ul><li><code>getSupportFragmentManager</code>ä¸ <code>activity</code>å…³è”ï¼Œå¯ä»¥å°†å…¶è§†ä¸º <code>activity</code> çš„ <code>FragmentManager</code></li><li><code>getChildFragmentManager</code> ä¸ <code>fragment</code>å…³è”ï¼Œå¯ä»¥å°†å…¶è§†ä¸º<code>fragment</code>çš„<code>FragmentManager</code></li><li><code>getParentFragmentManager</code>æƒ…å†µç¨å¾®å¤æ‚ï¼Œæ­£å¸¸æƒ…å†µè¿”å›çš„æ˜¯è¯¥<code>fragment</code> ä¾é™„çš„<code>activity</code>çš„<code>FragmentManager</code>ã€‚å¦‚æœè¯¥fragmentæ˜¯å¦ä¸€ä¸ª<code>fragment</code> çš„å­ <code>fragment</code>ï¼Œåˆ™è¿”å›çš„æ˜¯å…¶çˆ¶<code>fragment</code>çš„ <code>getChildFragmentManager</code></li></ul><p>å¦‚æœè¿™ä¹ˆè¯´è¿˜ä¸æ˜ç™½çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªå®è·µã€‚</p><p>åˆ›å»ºä¸€ä¸ª <code>activity</code>,ä¸€ä¸ªçˆ¶<code>fragment</code> ï¼Œä¸€ä¸ªå­<code>fragment</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// activity</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span></span>(R.layout.activity_main) &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>        supportFragmentManager.commit &#123;<br>            add&lt;ParentFragment&gt;(R.id.content)<br>        &#125;<br>        Log.i(<span class="hljs-string">"MyActivity"</span>, <span class="hljs-string">"supportFragmentManager <span class="hljs-variable">$supportFragmentManager</span>"</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParentFragment</span> : <span class="hljs-type">Fragment</span></span>(R.layout.fragment_parent) &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)<br>        childFragmentManager.commit &#123;<br>            add&lt;ChildFragment&gt;(R.id.content)<br>        &#125;<br>        Log.i(<span class="hljs-string">"ParentFragment"</span>, <span class="hljs-string">"parentFragmentManager <span class="hljs-variable">$parentFragmentManager</span>"</span>)<br>        Log.i(<span class="hljs-string">"ParentFragment"</span>, <span class="hljs-string">"childFragmentManager <span class="hljs-variable">$childFragmentManager</span>"</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChildFragment</span> : <span class="hljs-type">Fragment</span></span>(R.layout.fragment_child) &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)<br>        Log.i(<span class="hljs-string">"ChildFragment"</span>, <span class="hljs-string">"parentFragmentManager <span class="hljs-variable">$parentFragmentManager</span>"</span>)<br>        Log.i(<span class="hljs-string">"ChildFragment"</span>, <span class="hljs-string">"childFragmentManager <span class="hljs-variable">$childFragmentManager</span>"</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs undefined">//log<br>I/MyActivity: supportFragmentManager FragmentManager&#123;825dcef in HostCallbacks&#123;14a13fc&#125;&#125;&#125;<br>I/ParentFragment: parentFragmentManager FragmentManager&#123;825dcef in HostCallbacks&#123;14a13fc&#125;&#125;&#125;<br>I/ParentFragment: childFragmentManager FragmentManager&#123;df5de83 in ParentFragment&#123;7cdd800&#125;&#125;&#125;<br>I/ChildFragment: parentFragmentManager FragmentManager&#123;df5de83 in ParentFragment&#123;7cdd800&#125;&#125;&#125;<br>I/ChildFragment: childFragmentManager FragmentManager&#123;aba9afb in ChildFragment&#123;5cea718&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤</p><ul><li><p>åœ¨ <code>activity</code> ä¸­ä½¿ç”¨ <code>ViewPager</code>ï¼Œ<code>BottomSheetFragment</code> å’Œ<code>DialogFragment</code> æ—¶ï¼Œéƒ½åº”ä½¿ç”¨ <code>getSupportFragmentManager</code></p></li><li><p>åœ¨<code>fragment</code> ä¸­ä½¿ç”¨ <code>ViewPager</code> æ—¶åº”è¯¥ä½¿ç”¨<code>getChildFragmentManager</code></p></li></ul><p>é”™è¯¯çš„åœ¨ <code>fragment</code> ä¸­ä½¿ç”¨ <code>activity</code> çš„ <code>FragmentManager</code> ä¼šå¼•å‘å†…å­˜æ³„éœ²ã€‚ ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå‡å¦‚æ‚¨çš„fragmentä¸­æœ‰ä¸€äº›ä¾é  <code>ViewPager</code> ç®¡ç†çš„å­ <code>fragment</code>ï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº› <code>fragment</code>  éƒ½åœ¨ <code>activity</code> ä¸­ï¼Œå› ä¸ºæ‚¨ä½¿ç”¨çš„æ˜¯<code>activity</code> çš„<code>FragmentManager</code> ã€‚ ç°åœ¨ï¼Œå¦‚æœå…³é—­æ‚¨çš„çˆ¶<code>fragment</code>ï¼Œå®ƒå°†è¢«å…³é—­ï¼Œä½†ä¸ä¼šè¢«é”€æ¯ï¼Œå› ä¸ºæ‰€æœ‰å­<code>fragment</code>éƒ½å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸”å®ƒä»¬ä»åœ¨å†…å­˜ä¸­ï¼Œä»è€Œå¯¼è‡´æ³„æ¼ã€‚ å®ƒä¸ä»…ä¼šæ³„æ¼çˆ¶<code>fragment</code>ï¼Œè¿˜ä¼šæ³„æ¼æ‰€æœ‰å­<code>fragment</code>ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ— æ³•ä»å †å†…å­˜ä¸­æ¸…é™¤ã€‚ </p><h3 id="FragmentStateAdapter-å’Œ-FragmentPagerAdapter"><a href="#FragmentStateAdapter-å’Œ-FragmentPagerAdapter" class="headerlink" title="FragmentStateAdapter å’Œ FragmentPagerAdapter"></a>FragmentStateAdapter å’Œ FragmentPagerAdapter</h3><p><code>FragmentPagerAdapter</code>å°†æ•´ä¸ª <code>fragment</code>å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœ<code>ViewPager</code>ä¸­ä½¿ç”¨äº†å¤§é‡  <code>fragment</code>ï¼Œåˆ™å¯èƒ½å¯¼è‡´å†…å­˜å¼€é”€å¢åŠ ã€‚ <code>FragmentStatePagerAdapter</code>ä»…å­˜å‚¨ç‰‡æ®µçš„<code>savedInstanceState</code>ï¼Œå¹¶åœ¨å¤±å»ç„¦ç‚¹æ—¶é”€æ¯æ‰€æœ‰  <code>fragment</code>ã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹å¸¸è§çš„ä¸¤ä¸ªé—®é¢˜</p><h4 id="1-åˆ·æ–°ViewPagerä¸ç”Ÿæ•ˆ"><a href="#1-åˆ·æ–°ViewPagerä¸ç”Ÿæ•ˆ" class="headerlink" title="1. åˆ·æ–°ViewPagerä¸ç”Ÿæ•ˆ"></a>1. åˆ·æ–°ViewPagerä¸ç”Ÿæ•ˆ</h4><p><code>ViewPager</code> ä¸­çš„ <code>fragment</code> æ˜¯é€šè¿‡ <code>activity</code>æˆ– <code>fragment</code>çš„ <code>FragmentManager</code> ç®¡ç†çš„ï¼Œ<code>FragmentManager</code> åŒ…å«äº†<code>viewpager</code>çš„æ‰€æœ‰<code>fragment</code>çš„å®ä¾‹</p><p>å› æ­¤ï¼Œå½“<code>ViewPager</code>æ²¡æœ‰åˆ·æ–°æ—¶ï¼Œå®ƒåªæ˜¯<code>FragmentManager</code>ä»ä¿ç•™çš„æ—§ <code>fragment</code> å®ä¾‹ã€‚ æ‚¨éœ€è¦æ‰¾å‡ºä¸ºä»€ä¹ˆ<code>FragmentManger</code>æŒæœ‰<code>fragment</code>å®ä¾‹çš„åŸå› ã€‚</p><h4 id="2-åœ¨Viewpagerä¸­è®¿é—®å½“å‰fragment"><a href="#2-åœ¨Viewpagerä¸­è®¿é—®å½“å‰fragment" class="headerlink" title="2. åœ¨Viewpagerä¸­è®¿é—®å½“å‰fragment"></a>2. åœ¨Viewpagerä¸­è®¿é—®å½“å‰fragment</h4><p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬é‡åˆ°çš„ä¸€ä¸ªéå¸¸æ™®éçš„é—®é¢˜ã€‚ å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨ <code>adapter</code> å†…éƒ¨åˆ›å»º <code>fragment</code> çš„æ•°ç»„åˆ—è¡¨ï¼Œæˆ–è€…å°è¯•ä½¿ç”¨æŸäº›æ ‡ç­¾è®¿é—®<code>fragment</code>ã€‚ ä¸è¿‡è¿˜æœ‰å¦ä¸€ç§é€‰æ‹©ã€‚ <code>FragmentStateAdapter</code> å’Œ<code>FragmentPagerAdapter</code>éƒ½æä¾›æ–¹æ³•<code>setPrimaryItem</code>ã€‚ å¯ä»¥ç”¨æ¥è®¾ç½®å½“å‰<code>fragment</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"> <span class="hljs-keyword">var</span> fragment: ChildFragment? = <span class="hljs-literal">null</span><br> <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setPrimaryItem</span><span class="hljs-params">(container: <span class="hljs-type">ViewGroup</span>, position: <span class="hljs-type">Int</span>, any: <span class="hljs-type">Any</span>)</span></span> &#123;<br>   <span class="hljs-keyword">if</span> (getChildFragment() != any)<br>   fragment = any <span class="hljs-keyword">as</span> ChildFragment<br>   <span class="hljs-keyword">super</span>.setPrimaryItem(container, position, any)<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getChildFragment</span><span class="hljs-params">()</span></span>: ChildFragment? = fragment<br><br><span class="hljs-comment">//use</span><br>mAapter.getChildFragment()<br></code></pre></td></tr></table></figure><h3 id="add-å’Œ-replace-å¦‚ä½•é€‰æ‹©ï¼Ÿ"><a href="#add-å’Œ-replace-å¦‚ä½•é€‰æ‹©ï¼Ÿ" class="headerlink" title="add å’Œ replace å¦‚ä½•é€‰æ‹©ï¼Ÿ"></a>add å’Œ replace å¦‚ä½•é€‰æ‹©ï¼Ÿ</h3><p>åœ¨æˆ‘ä»¬çš„<code>activity</code>ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œå…¶ä¸­è£…æœ‰<code>fragment</code>ã€‚</p><p><code>add</code>åªä¼šå°†ä¸€ä¸ª<code>fragment</code>æ·»åŠ åˆ°å®¹å™¨ä¸­ã€‚ å‡è®¾æ‚¨å°†<code>FragmentA</code>å’Œ<code>FragmentB</code>æ·»åŠ åˆ°å®¹å™¨ä¸­ã€‚ å®¹å™¨å°†å…·æœ‰<code>FragmentA</code>å’Œ<code>FragmentB</code>ï¼Œå¦‚æœå®¹å™¨æ˜¯<code>FrameLayout</code>ï¼Œåˆ™å°†<code>fragment</code>ä¸€ä¸ªæ·»åŠ åœ¨å¦ä¸€ä¸ªä¹‹ä¸Šã€‚</p><p><code>replace</code>å°†ç®€å•åœ°æ›¿æ¢å®¹å™¨é¡¶éƒ¨çš„ä¸€ä¸ª<code>fragment</code>ï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘åˆ›å»ºäº† <code>FragmentC</code>å¹¶ <code>replace</code> é¡¶éƒ¨çš„ <code>FragmentB</code>ï¼Œåˆ™<code>FragmentB</code>å°†è¢«ä»å®¹å™¨ä¸­åˆ é™¤ï¼ˆæ‰§è¡Œ<code>onDestroy</code>ï¼Œé™¤éæ‚¨è°ƒç”¨<code>addToBackStack</code>ï¼Œä»…æ‰§è¡Œ<code>onDestroyView</code>ï¼‰ï¼Œè€Œ<code>FragmentC</code>å°†ä½äºé¡¶éƒ¨ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ <code>replace</code>åˆ é™¤ç°æœ‰<code>fragment</code>å¹¶æ·»åŠ ä¸€ä¸ªæ–°<code>fragment</code>ã€‚ è¿™æ„å‘³ç€å½“æ‚¨æŒ‰ä¸‹è¿”å›æŒ‰é’®æ—¶ï¼Œå°†åˆ›å»ºè¢«æ›¿æ¢çš„<code>fragment</code>ï¼Œå¹¶è°ƒç”¨å…¶<code>onCreateView</code>ã€‚ å¦ä¸€æ–¹é¢ï¼Œ<code>add</code>ä¿ç•™ç°æœ‰<code>fragment</code>ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ–°<code>fragment</code>ï¼Œè¿™æ„å‘³ç€ç°æœ‰<code>fragment</code>å°†å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸”å®ƒä»¬ä¸ä¼šå¤„äº â€œpausedâ€ çŠ¶æ€ã€‚ å› æ­¤ï¼ŒæŒ‰ä¸‹è¿”å›æŒ‰é’®æ—¶ï¼Œç°æœ‰<code>fragment</code>ï¼ˆæ·»åŠ æ–°<code>fragment</code>ä¹‹å‰çš„<code>fragment</code>ï¼‰ä¸ä¼šè°ƒç”¨<code>onCreateView</code>ã€‚ å°±<code>fragment</code>çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è€Œè¨€ï¼Œåœ¨<code>replace</code>çš„æƒ…å†µä¸‹å°†è°ƒç”¨<code>onPause</code>ï¼Œ<code>onResume</code>ï¼Œ<code>onCreateView</code>å’Œå…¶ä»–ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œåœ¨<code>add</code>çš„æƒ…å†µä¸‹åˆ™ä¸ä¼šã€‚</p><p>å¦‚æœä¸éœ€è¦é‡æ–°è®¿é—®å½“å‰<code>fragment</code>å¹¶ä¸”ä¸å†éœ€è¦å½“å‰<code>fragment</code>ï¼Œè¯·ä½¿ç”¨<code>replace</code>ã€‚ å¦å¤–ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨æœ‰å†…å­˜é™åˆ¶ï¼Œè¯·è€ƒè™‘ä½¿ç”¨<code>replace</code>ã€‚</p><h3 id="observe-LiveDataæ—¶ä¼ å…¥-this-è¿˜æ˜¯-viewLifecycleOwner"><a href="#observe-LiveDataæ—¶ä¼ å…¥-this-è¿˜æ˜¯-viewLifecycleOwner" class="headerlink" title="observe LiveDataæ—¶ä¼ å…¥ this è¿˜æ˜¯ viewLifecycleOwner"></a>observe LiveDataæ—¶ä¼ å…¥ this è¿˜æ˜¯ viewLifecycleOwner</h3><p><code>androidx fragment 1.2.0</code> èµ·ï¼Œæ·»åŠ äº†æ–°çš„ Lint æ£€æŸ¥ï¼Œä»¥ç¡®ä¿æ‚¨åœ¨ä» <code>onCreateView()</code>ã€<code>onViewCreated()</code> æˆ– <code>onActivityCreated()</code> è§‚å¯Ÿ <code>LiveData</code> æ—¶ä½¿ç”¨ <code>getViewLifecycleOwner()</code></p><h3 id="ä½¿ç”¨-simpleName-ä½œä¸º-fragment-çš„-tag-æœ‰ä½•é£é™©ï¼Ÿ"><a href="#ä½¿ç”¨-simpleName-ä½œä¸º-fragment-çš„-tag-æœ‰ä½•é£é™©ï¼Ÿ" class="headerlink" title="ä½¿ç”¨ simpleName ä½œä¸º fragment çš„ tag æœ‰ä½•é£é™©ï¼Ÿ"></a>ä½¿ç”¨ simpleName ä½œä¸º fragment çš„ tag æœ‰ä½•é£é™©ï¼Ÿ</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨calssçš„<code>simpleName</code> ä½œä¸º<code>fragment</code> çš„tag</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">supportFragmentManager.commit &#123;<br>replace(R.id.content,MyFragment.newInstance(<span class="hljs-string">"Fragment"</span>),<br>            MyFragment::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>.<span class="hljs-title">simpleName</span>)</span><br>    addToBackStack(<span class="hljs-literal">null</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·åšä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯â€¦</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> fragment = supportFragmentManager.findFragmentByTag(tag)<br></code></pre></td></tr></table></figure><p>è¿™æ ·è·å–åˆ°çš„fragmentå¯èƒ½ä¸æ˜¯æƒ³è¦çš„ç»“æœã€‚</p><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åŠ å…¥æœ‰ä¸¤ä¸ª fragmentï¼Œç»è¿‡æ··æ·†ï¼Œå®ƒä»¬å˜æˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs undefined">com.mypackage.FragmentA â†’ com.mypackage.c.a<br>com.mypackage.FragmentB â†’ com.mypackage.c.a.a<br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ··æ·†äº† full nameï¼Œå¦‚æœæ˜¯simpleName å‘¢ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs undefined">com.mypackage.FragmentA â†’ a<br>com.mypackage.FragmentB â†’ a<br></code></pre></td></tr></table></figure><p>WTFï¼</p><p><strong>æ‰€ä»¥åœ¨è®¾ç½®tagæ—¶å°½é‡ç”¨å…¨åæˆ–è€…å¸¸é‡</strong></p><h3 id="åœ¨-BottomBarNavigation-å’Œ-drawer-ä¸­å¦‚ä½•ä½¿ç”¨Fragmentå¤šæ¬¡æ·»åŠ ï¼Ÿ"><a href="#åœ¨-BottomBarNavigation-å’Œ-drawer-ä¸­å¦‚ä½•ä½¿ç”¨Fragmentå¤šæ¬¡æ·»åŠ ï¼Ÿ" class="headerlink" title="åœ¨ BottomBarNavigation å’Œ drawer ä¸­å¦‚ä½•ä½¿ç”¨Fragmentå¤šæ¬¡æ·»åŠ ï¼Ÿ"></a>åœ¨ BottomBarNavigation å’Œ drawer ä¸­å¦‚ä½•ä½¿ç”¨Fragmentå¤šæ¬¡æ·»åŠ ï¼Ÿ</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>BottomBarNavigation</code>å’Œ <code>NavigationDrawer</code>æ—¶ï¼Œé€šå¸¸ä¼šçœ‹åˆ°è¯¸å¦‚<code>fragment</code> é‡å»ºæˆ–å¤šæ¬¡æ·»åŠ ç›¸åŒ<code>fragment</code>ä¹‹ç±»çš„é—®é¢˜ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>show / hide</code> è€Œä¸æ˜¯ <code>add</code> æˆ– <code>replace</code>ã€‚</p><h3 id="è¿”å›æ ˆ"><a href="#è¿”å›æ ˆ" class="headerlink" title="è¿”å›æ ˆ"></a>è¿”å›æ ˆ</h3><p>å¦‚æœæ‚¨æƒ³åœ¨<code>fragment</code>çš„ä¸€ç³»åˆ—è·³è½¬ä¸­æŒ‰è¿”å›é”®è¿”å›ä¸Šä¸€ä¸ª<code>fragment</code>ï¼Œåº”è¯¥åœ¨<code>commit</code> <code>transaction</code>ä¹‹å‰è°ƒç”¨<code>addToBackStack</code>æ–¹æ³•</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//ä½¿ç”¨è¯¥æ‰©å±• androidx.fragment:fragment-ktx:1.2.0 ä»¥ä¸Š</span><br>parentFragmentManager.commit &#123;<br>addToBackStack(<span class="hljs-literal">null</span>)<br>  add&lt;SecondFragment&gt;(R.id.content)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Fragmentçš„ä½¿ç”¨æ–°å§¿åŠ¿"><a href="#Fragmentçš„ä½¿ç”¨æ–°å§¿åŠ¿" class="headerlink" title="Fragmentçš„ä½¿ç”¨æ–°å§¿åŠ¿"></a>Fragmentçš„ä½¿ç”¨æ–°å§¿åŠ¿</h2><ul><li><p>fragment-ktx æœ‰å“ªäº›å¥½ç”¨çš„æ‰©å±•å‡½æ•°</p></li><li><p>fragment ä¹‹é—´å’Œä¸ activity é€šä¿¡</p></li><li><p>ä½¿ç”¨ FragmentContainerView ä½œä¸º fragment å®¹å™¨</p></li><li><p>FragmentFactory çš„ä½¿ç”¨</p></li><li><p>Fragment è¿”å›é”®æ‹¦æˆª</p></li><li><p>Fragment ä½¿ç”¨ ViewBinding</p></li><li><p>Fragment ä½¿ç”¨ ViewPager2</p></li><li><p>ä¸éœ€è¦é‡å†™ onCreateView äº†ï¼Ÿ</p></li><li><p>ä½¿ç”¨require_()æ–¹æ³•</p></li></ul><h3 id="fragment-ktx-æœ‰å“ªäº›å¥½ç”¨çš„æ‰©å±•å‡½æ•°"><a href="#fragment-ktx-æœ‰å“ªäº›å¥½ç”¨çš„æ‰©å±•å‡½æ•°" class="headerlink" title="fragment-ktx æœ‰å“ªäº›å¥½ç”¨çš„æ‰©å±•å‡½æ•°"></a>fragment-ktx æœ‰å“ªäº›å¥½ç”¨çš„æ‰©å±•å‡½æ•°</h3><h4 id="1-FragmentManagerKt"><a href="#1-FragmentManagerKt" class="headerlink" title="1. FragmentManagerKt"></a>1. FragmentManagerKt</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//before</span><br>supportFragmentManager<br>    .beginTransaction()<br>    .add(R.id.content,Fragment1())<br>    .commit()<br><br><span class="hljs-comment">//after</span><br>supportFragmentManager.commit &#123;<br>add&lt;Fragment1&gt;(R.id.content)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-FragmentViewModelLazyKt"><a href="#2-FragmentViewModelLazyKt" class="headerlink" title="2. FragmentViewModelLazyKt"></a>2. FragmentViewModelLazyKt</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//before</span><br><span class="hljs-comment">//å…±äº«èŒƒå›´activity</span><br><span class="hljs-keyword">val</span> mViewMode1l = ViewModelProvider(requireActivity()).<span class="hljs-keyword">get</span>(UpdateAppViewModel::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br><span class="hljs-comment">//å…±äº«èŒƒå›´fragment å†…éƒ¨</span><br><span class="hljs-keyword">val</span> mViewMode1l = ViewModelProvider(<span class="hljs-keyword">this</span>).<span class="hljs-keyword">get</span>(UpdateAppViewModel::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br><br><span class="hljs-comment">//after</span><br><span class="hljs-comment">//å…±äº«èŒƒå›´activity</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mViewModel <span class="hljs-keyword">by</span> activityViewModels&lt;MyViewModel&gt;()<br><span class="hljs-comment">//å…±äº«èŒƒå›´fragment å†…éƒ¨</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mViewModel <span class="hljs-keyword">by</span> viewModel&lt;MyViewModel&gt;()<br></code></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„ï¼šViewModelProviders.of(this).get(MyViewModel.class); çš„æ–¹å¼å·²å¼ƒç”¨</strong> </p><p><strong><code>lifecycle-extensions</code> ä¾èµ–åŒ…å·²å¼ƒç”¨</strong></p></blockquote><h3 id="fragment-ä¹‹é—´å’Œä¸-activity-é€šä¿¡"><a href="#fragment-ä¹‹é—´å’Œä¸-activity-é€šä¿¡" class="headerlink" title="fragment ä¹‹é—´å’Œä¸ activity é€šä¿¡"></a>fragment ä¹‹é—´å’Œä¸ activity é€šä¿¡</h3><p>fragment å’Œ fragmentä¹‹é—´ï¼Œfragment å’Œ activity ä¹‹é—´çš„é€šä¿¡æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œandroid jetpack æ¨èæˆ‘ä»¬ä½¿ç”¨ ViewModel + LiveData å¤„ç†</p><p>åŒä¸€ä¸ªactivity å†…çš„ fragment ä¹‹é—´é€šä¿¡ï¼Œå¯ä»¥ä½¿ç”¨ä½œç”¨èŒƒå›´ä¸ºactivityçš„ViewModelï¼Œactivityä¸ fragmenté€šä¿¡åŒç†ã€‚è¯¦æƒ…å¯ç§»æ­¥ <a href="https://developer.android.com/jetpack/docs/guide" target="_blank" rel="noopener">Androidå®˜æ–¹åº”ç”¨æ¶æ„æŒ‡å—</a></p><h3 id="ä½¿ç”¨-FragmentContainerView-ä½œä¸º-fragment-å®¹å™¨"><a href="#ä½¿ç”¨-FragmentContainerView-ä½œä¸º-fragment-å®¹å™¨" class="headerlink" title="ä½¿ç”¨ FragmentContainerView ä½œä¸º fragment å®¹å™¨"></a>ä½¿ç”¨ FragmentContainerView ä½œä¸º fragment å®¹å™¨</h3><p>è¿‡å»æˆ‘ä»¬ä½¿ç”¨ <code>FrameLayout</code> ä½œä¸º <code>Fragment</code> çš„å®¹å™¨ï¼Œåœ¨ <code>AndroidX Fragment 1.2.0</code> åï¼Œå¯ä»¥ä½¿ç”¨ <code>FragmentContainerView</code> ä»£æ›¿ <code>Fragment</code> ã€‚</p><p>å®ƒä¿®å¤äº†ä¸€äº›åŠ¨ç”» zè½´ç´¢å¼•é¡ºåºé—®é¢˜å’Œçª—å£æ’å…¥è°ƒåº¦ï¼Œè¿™æ„å‘³ç€ä¸¤ä¸ª<code>fragment</code>ä¹‹é—´çš„é€€å‡ºå’Œè¿›å…¥è¿‡æ¸¡ä¸ä¼šäº’ç›¸é‡å ã€‚ä½¿ç”¨<code>FragmentContainerView</code>å°†å…ˆå¼€å¯é€€å‡ºåŠ¨ç”»ç„¶åæ‰æ˜¯è¿›å…¥åŠ¨ç”»ã€‚</p><p><code>FragmentContainerView</code>  æ˜¯ä¸“é—¨ä¸º fragmentè®¾è®¡çš„è‡ªå®šä¹‰Viewï¼Œå®ƒç»§æ‰¿è‡ª FrameLayout</p><p><code>android:name</code> å±æ€§å…è®¸æ‚¨æ·»åŠ <code>fragment</code>ï¼Œ<code>android:tag</code> å±æ€§å¯ä»¥ä¸º<code>fragment</code>è®¾ç½®tag</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.fragment.app.FragmentContainerView</span><br>       <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span><br>       <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span><br>       <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/fragment_container_view"</span><br>       <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>       <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span><br>       <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.example.MyFragment"</span><br>       <span class="hljs-attr">android:tag</span>=<span class="hljs-string">"my_tag"</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">androidx.fragment.app.FragmentContainerView</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="FragmentFactory-çš„ä½¿ç”¨"><a href="#FragmentFactory-çš„ä½¿ç”¨" class="headerlink" title="FragmentFactory çš„ä½¿ç”¨"></a>FragmentFactory çš„ä½¿ç”¨</h3><p>è¿‡å»ï¼Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨å…¶é»˜è®¤çš„ç©ºæ„é€ å‡½æ•°å®ä¾‹åŒ–Fragmentå®ä¾‹ã€‚ è¿™æ˜¯å› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¾‹å¦‚é…ç½®æ›´æ”¹å’Œåº”ç”¨ç¨‹åºçš„æµç¨‹é‡æ–°åˆ›å»ºï¼Œç³»ç»Ÿéœ€è¦é‡æ–°åˆå§‹åŒ–ã€‚ å¦‚æœä¸æ˜¯é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œç³»ç»Ÿå°†ä¸çŸ¥é“å¦‚ä½•é‡æ–°åˆå§‹åŒ–Fragmentå®ä¾‹ã€‚</p><p>åˆ›å»ºFragmentFactoryæ¥è§£å†³æ­¤é™åˆ¶ã€‚ é€šè¿‡å‘å…¶æä¾›å®ä¾‹åŒ–Fragmentæ‰€éœ€çš„å¿…è¦å‚æ•°/ä¾èµ–å…³ç³»ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç³»ç»Ÿåˆ›å»ºFragmentå®ä¾‹ã€‚</p><p>è¿‡å»æˆ‘ä»¬å®ä¾‹åŒ–fragmentå¹¶ä¼ é€’å‚æ•°ä¼šä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„ä»£ç </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> arg: String<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>        arguments?.getString(ARG) ?: <span class="hljs-string">""</span><br>    &#125;<br>    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newInstance</span><span class="hljs-params">(arg: <span class="hljs-type">String</span>)</span></span> =<br>            MyFragment().apply &#123;<br>                arguments = Bundle().apply &#123;<br>                    putString(ARG, arg)<br>                &#125;<br>            &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//use</span><br><span class="hljs-keyword">val</span> fragment = MyFragment.newInstance(<span class="hljs-string">"my argument"</span>)<br></code></pre></td></tr></table></figure><p>å¦‚æœæ‚¨çš„Fragmentæœ‰ä¸€ä¸ªéç©ºçš„æ„é€ å‡½æ•°ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªFragmentFactoryæ¥å¤„ç†å®ƒçš„åˆå§‹åŒ–ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragmentFactory</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> arg: String) : FragmentFactory() &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">instantiate</span><span class="hljs-params">(classLoader: <span class="hljs-type">ClassLoader</span>, className: <span class="hljs-type">String</span>)</span></span>: Fragment &#123;<br>        <span class="hljs-keyword">if</span> (className == MyFragment::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>.<span class="hljs-title">name</span>) </span>&#123;<br>            <span class="hljs-keyword">return</span> MyFragment(arg)<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.instantiate(classLoader, className)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>fragment</code>ç”±<code>FragmentManager</code> ç®¡ç†ï¼Œå› æ­¤å¾ˆè‡ªç„¶ï¼Œ<code>FragmentFactory</code>éœ€è¦æ·»åŠ åˆ°<code>FragmentManager</code>æ‰èƒ½ä½¿ç”¨ã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™æŠŠ<code>FragmentFactory</code> æ·»åŠ åˆ°<code>FragmentManager</code>å‘¢ï¼Ÿ</p><p><strong>çˆ¶ç±»è°ƒç”¨ <code>Activity#onCreate()</code>  å’Œ <code>Fragment#onCreate()</code>ä¹‹å‰</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HostActivity</span> : <span class="hljs-type">AppCompatActivity</span></span>() &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> customFragmentFactory = CustomFragmentFactory(Dependency())<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        supportFragmentManager.fragmentFactory = customFragmentFactory<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParentFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> customFragmentFactory = CustomFragmentFactory(Dependency())<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        childFragmentManager.fragmentFactory = customFragmentFactory<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ‚¨çš„<code>Fragment</code>å…·æœ‰é»˜è®¤çš„ç©ºæ„é€ å‡½æ•°ï¼Œåˆ™æ— éœ€ä½¿ç”¨<code>FragmentFactory</code>ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„<code>Fragment</code>åœ¨å…¶æ„é€ å‡½æ•°ä¸­æ¥å—å‚æ•°ï¼Œåˆ™å¿…é¡»ä½¿ç”¨<code>FragmentFactory</code>ï¼Œå¦åˆ™å°†æŠ›å‡º<code>Fragment.InstantiationException</code>ï¼Œå› ä¸ºå°†ä½¿ç”¨çš„é»˜è®¤<code>FragmentFactory</code>å°†ä¸çŸ¥é“å¦‚ä½•å®ä¾‹åŒ–<code>Fragment</code>çš„å®ä¾‹ã€‚</p><h3 id="Fragment-è¿”å›é”®æ‹¦æˆª"><a href="#Fragment-è¿”å›é”®æ‹¦æˆª" class="headerlink" title="Fragment è¿”å›é”®æ‹¦æˆª"></a>Fragment è¿”å›é”®æ‹¦æˆª</h3><p>æœ‰æ—¶å€™ï¼Œæ‚¨éœ€è¦é˜»æ­¢ç”¨æˆ·è¿”å›ä¸Šä¸€çº§ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦åœ¨ <code>Activity</code> ä¸­é‡å†™ <code>onBackPressed()</code> æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œå½“æ‚¨ä½¿ç”¨ <code>Fragment</code> æ—¶ï¼Œæ²¡æœ‰ç›´æ¥çš„æ–¹æ³•æ¥æ‹¦æˆªè¿”å›ã€‚ åœ¨ <code>Fragment</code> ç±»ä¸­æ²¡æœ‰å¯ç”¨çš„ <code>onBackPressed()</code> æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢åŒæ—¶å­˜åœ¨å¤šä¸ª <code>Fragment</code> æ—¶å‘ç”Ÿæ„å¤–è¡Œä¸ºã€‚</p><p>ä½†æ˜¯ï¼Œä» <code>AndroidX</code> <code>Activity 1.0.0</code> å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>OnBackPressedDispatcher</code> åœ¨æ‚¨å¯ä»¥è®¿é—®è¯¥ <code>Activity</code> çš„ä»£ç çš„ä»»ä½•ä½ç½®ï¼ˆä¾‹å¦‚ï¼Œåœ¨ <code>Fragment</code> ä¸­ï¼‰æ³¨å†Œ <code>OnBackPressedCallback</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttach</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> &#123;<br>    <span class="hljs-keyword">super</span>.onAttach(context)<br>    <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : OnBackPressedCallback(<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOnBackPressed</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">// Do something</span><br>      &#125;<br>    &#125;<br>    requireActivity().onBackPressedDispatcher.addCallback(<span class="hljs-keyword">this</span>, callback)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Fragment-ä½¿ç”¨-ViewBinding"><a href="#Fragment-ä½¿ç”¨-ViewBinding" class="headerlink" title="Fragment ä½¿ç”¨ ViewBinding"></a>Fragment ä½¿ç”¨ ViewBinding</h3><p><code>Android Studio 3.6.0</code> åæä¾›äº† <code>ViewBindind</code>çš„æ”¯æŒï¼Œå®Œæ•´ä½¿ç”¨æµç¨‹å‚è§ <a href="https://juejin.im/post/5e4806f3e51d4526c550a2ef" target="_blank" rel="noopener">[è¯‘]æ·±å…¥ç ”ç©¶ViewBinding åœ¨ include, merge, adapter, fragment, activity ä¸­ä½¿ç”¨</a></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomeFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentHomeBinding? = <span class="hljs-literal">null</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span>: View? &#123;<br>        _binding = FragmentHomeBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)<br>        <span class="hljs-keyword">return</span> binding.root<br>    &#125;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> &#123;<br>        _binding = <span class="hljs-literal">null</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Fragment-ä½¿ç”¨-ViewPager2"><a href="#Fragment-ä½¿ç”¨-ViewPager2" class="headerlink" title="Fragment ä½¿ç”¨ ViewPager2"></a>Fragment ä½¿ç”¨ ViewPager2</h3><p><code>ViewPager</code>ä½¿ç”¨äº†ä¸‰ä¸ª<code>adapter</code>çš„æŠ½è±¡ç±»ï¼Œè€Œ<code>ViewPager2</code>ä¸­åªæœ‰ä¸¤ä¸ª</p><ul><li>ViewPager ä¸­ä½¿ç”¨ <code>PagerAdaper</code>ï¼ŒViewPager2 ä¸­ä½¿ç”¨ <strong><code>Recyclerview.Adapter</code></strong></li><li>ViewPager ä¸­ä½¿ç”¨ <code>FragmentPagerAdapter</code> ï¼ŒViewPager2ä¸­ä½¿ç”¨ <strong><code>FragmentStateAdapter</code></strong></li><li>ViewPager ä¸­ä½¿ç”¨ <code>FragmentStatePagerAdapter</code> ï¼ŒViewPager2ä¸­ä½¿ç”¨ <strong><code>FragmentStateAdapter</code></strong></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// A simple ViewPager adapter class for paging through fragments</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScreenSlidePagerAdapter</span></span>(fm: FragmentManager) : FragmentStatePagerAdapter(fm) &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = NUM_PAGES<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: Fragment = ScreenSlidePageFragment()<br>&#125;<br><br><span class="hljs-comment">// An equivalent ViewPager2 adapter class</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScreenSlidePagerAdapter</span></span>(fa: FragmentActivity) : FragmentStateAdapter(fa) &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = NUM_PAGES<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createFragment</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: Fragment = ScreenSlidePageFragment()<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>TabLayout</code>çš„å˜åŒ–ï¼Œ<code>TabLayout</code> å·²ä»<code>ViewPager2</code>ä¸­è§£è€¦ï¼Œå¦‚æœä½¿ç”¨<code>TabLayout</code>ï¼Œéœ€è¦å¼•å…¥ä¾èµ–</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy">implementation <span class="hljs-string">"com.google.android.material:material:1.1.0"</span><br></code></pre></td></tr></table></figure><p>å¯¹äº<code>ViewPager2</code> ï¼Œ<code>TabLayout</code>å¸ƒå±€åº”ä¸<code>ViewPager2</code>åœ¨åŒä¸€çº§åˆ«</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- A ViewPager element with a TabLayout --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">androidx.viewpager.widget.ViewPager</span><br>    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span><br>    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/pager"</span><br>    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.tabs.TabLayout</span><br>        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/tab_layout"</span><br>        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">androidx.viewpager.widget.ViewPager</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- A ViewPager2 element with a TabLayout --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span><br>    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span><br>    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.tabs.TabLayout</span><br>        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/tab_layout"</span><br>        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.viewpager2.widget.ViewPager2</span><br>        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/pager"</span><br>        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span><br>        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"0dp"</span><br>        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>ViewPager</code>æ—¶ï¼Œ<code>TabLayout</code>ä¸<code>ViewPager</code>è”åŠ¨éœ€è¦è°ƒç”¨ <code>setupWithViewPager</code>ï¼Œå¹¶é‡å†™<code>getPageTitle</code>æ–¹æ³•ï¼Œè€Œ<code>ViewPager2</code>æ”¹ä¸ºä½¿ç”¨<code>TabLayoutMediator</code>å¯¹è±¡</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// Integrating TabLayout with ViewPager</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CollectionDemoFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>    ...<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">val</span> tabLayout = view.findViewById(R.id.tab_layout)<br>        tabLayout.setupWithViewPager(viewPager)<br>    &#125;<br>    ...<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoCollectionPagerAdapter</span></span>(fm: FragmentManager) : FragmentStatePagerAdapter(fm) &#123;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>  = <span class="hljs-number">4</span><br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPageTitle</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: CharSequence &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"OBJECT <span class="hljs-subst">$&#123;(position + <span class="hljs-number">1</span>)&#125;</span>"</span><br>    &#125;<br>    ...<br>&#125;<br><br><span class="hljs-comment">// Integrating TabLayout with ViewPager2</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CollectionDemoFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>    ...<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">val</span> tabLayout = view.findViewById(R.id.tab_layout)<br>        TabLayoutMediator(tabLayout, viewPager) &#123; tab, position -&gt;<br>            tab.text = <span class="hljs-string">"OBJECT <span class="hljs-subst">$&#123;(position + <span class="hljs-number">1</span>)&#125;</span>"</span><br>        &#125;.attach()<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸éœ€è¦é‡å†™-onCreateView-äº†ï¼Ÿ"><a href="#ä¸éœ€è¦é‡å†™-onCreateView-äº†ï¼Ÿ" class="headerlink" title="ä¸éœ€è¦é‡å†™ onCreateView äº†ï¼Ÿ"></a>ä¸éœ€è¦é‡å†™ onCreateView äº†ï¼Ÿ</h3><p><code>androidx fragment 1.1.0</code> åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å°† <code>layoutId</code> ä½œä¸ºå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œè¿™æ ·å°±æ— éœ€é‡å†™ <code>onCreateView</code> æ–¹æ³•äº†</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span></span>(R.layout.my_activity)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragmentActivity</span>: <span class="hljs-type">FragmentActivity</span></span>(R.layout.my_fragment_activity)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>(R.layout.my_fragment)<br></code></pre></td></tr></table></figure><h3 id="ä½¿ç”¨require-æ–¹æ³•"><a href="#ä½¿ç”¨require-æ–¹æ³•" class="headerlink" title="ä½¿ç”¨require_()æ–¹æ³•"></a>ä½¿ç”¨require_()æ–¹æ³•</h3><p><code>androidx fragment 1.2.2</code> èµ·ï¼Œæ–°å¢äº†ä¸€é¡¹lintæ£€æŸ¥ï¼Œ<code>fragment</code> å»ºè®®ä½¿ç”¨å…³è”çš„<code>require_()</code>æ–¹æ³•è·å–æ›´å¤šæè¿°æ€§é”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ä½¿ç”¨<code>checkNotNull(get_())</code>ï¼Œ<code>requireNonNull(get_())</code> æˆ–<code>get()ï¼</code> é€‚ç”¨äºæ‰€æœ‰åŒ…å« get å’Œ require Fragment API</p><p>ä¾‹å¦‚ï¼šä½¿ç”¨ <code>requireActivity()</code> æ›¿ä»£ <code>getActivity()</code></p>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackã€‘Jetpack ä¸»è¦ä¾èµ–å…³ç³»</title>
      <link href="/2020/03/01/Jetpack-dependencies/"/>
      <url>/2020/03/01/Jetpack-dependencies/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨å­¦ä¹ å’Œä½¿ç”¨ <code>jetpack</code> ç»„ä»¶æ—¶ï¼Œæ€»æ˜¯è¢«å…¶ gradle ä¾èµ–æçš„æ™•å¤´è½¬å‘ï¼Œæ•…åœ¨æ­¤æ•´ç† <code>jetpack</code> ä¸»è¦ç»„ä»¶çš„ä¾èµ–ï¼ŒåŠä¼ é€’å…³ç³»</p></blockquote><a id="more"></a><ul><li><a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-master-dev" target="_blank" rel="noopener"><code>jetpcak</code> ç»„ä»¶æºç åœ°å€</a></li><li>æŸ¥è¯¢ <code>jetpcak</code> ç»„ä»¶ ç‰ˆæœ¬: <a href="https://maven.google.com/web/index.html" target="_blank" rel="noopener">Googleâ€™s Maven Repository</a></li><li>æŸ¥çœ‹ä¾èµ–æ ‘ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ<code>./gradlew :app:dependencies</code></li></ul><p><strong>å¯ç›´æ¥è·³è¿‡åç»­å†…å®¹å‰å¾€æœ€åä¸€èŠ‚æŸ¥çœ‹æ€»ç»“</strong></p><p>å…³äº <code>androidx</code>ä¸‹ <code>fragment/activity</code>çš„å˜åŒ–ï¼Œå¯æŸ¥çœ‹è¯¥æ–‡, <a href="https://juejin.im/post/5e5a0c316fb9a07cd248d29e" target="_blank" rel="noopener">ã€è¯‘ã€‘AdroidXä¸‹ä½¿ç”¨Activityå’ŒFragmentçš„å˜åŒ–</a></p><h3 id="Appcompat"><a href="#Appcompat" class="headerlink" title="Appcompat"></a>Appcompat</h3><h4 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>    <span class="hljs-keyword">def</span> appcompat_version = <span class="hljs-string">"1.1.0"</span><br><br>    implementation <span class="hljs-string">"androidx.appcompat:appcompat:$appcompat_version"</span><br>    <span class="hljs-comment">// For loading and tinting drawables on older versions of the platform</span><br>    implementation <span class="hljs-string">"androidx.appcompat:appcompat-resources:$appcompat_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¾èµ–æ ‘"><a href="#ä¾èµ–æ ‘" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507093256.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h4 id="ä¼ é€’ä¾èµ–"><a href="#ä¼ é€’ä¾èµ–" class="headerlink" title="ä¼ é€’ä¾èµ–"></a>ä¼ é€’ä¾èµ–</h4><p><code>androidx.annotation:annotation:1.1.0</code></p><p><code>androidx.core:core:1.1.0</code></p><p><code>androidx.cursoradapter:cursoradapter:1.0.0</code></p><p><code>androidx.fragment:fragment:1.1.0</code></p><p><code>androidx.appcompat:appcompat-resources:1.1.0</code></p><p><code>androidx.drawerlayout:drawerlayout:1.0.0</code></p><p><code>androidx.collection:collection:1.0.0</code></p><blockquote><p><strong><code>appcompat</code> ä¸­é»˜è®¤å¼•å…¥äº† <code>fragment</code> åº“ï¼Œå¦‚æœæƒ³ä½¿ç”¨æ›´æ–°ç‰ˆæœ¬çš„ <code>fragment</code> åº“ï¼Œå¯ä»¥å•ç‹¬å¼•ç”¨</strong></p></blockquote><blockquote><p><a href="https://android.googlesource.com/platform/frameworks/support/+/b0b973c9bc89f9ad3efe3c06e41b72957f032a99/appcompat/build.gradle" target="_blank" rel="noopener">appcompat build.gradle æºç åœ°å€</a></p></blockquote><h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><h4 id="å¼•å…¥-1"><a href="#å¼•å…¥-1" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>    <span class="hljs-keyword">def</span> fragment_version = <span class="hljs-string">"1.2.2"</span><br><br>    <span class="hljs-comment">// Java language implementation</span><br>    implementation <span class="hljs-string">"androidx.fragment:fragment:$fragment_version"</span><br>    <span class="hljs-comment">// Kotlin</span><br>    implementation <span class="hljs-string">"androidx.fragment:fragment-ktx:$fragment_version"</span><br>    <span class="hljs-comment">// Testing Fragments in Isolation</span><br>    implementation <span class="hljs-string">"androidx.fragment:fragment-testing:$fragment_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>âš ï¸ Note: The Kotlin dependant libraries of this version (fragment-ktx,fragment-testing) target Java 8 programming language bytecode. <a href="https://developer.android.com/studio/write/java8-support" target="_blank" rel="noopener">Please read Use Java 8 language features to learn how to use it in your project.</a></p></blockquote><h4 id="ä¾èµ–æ ‘-1"><a href="#ä¾èµ–æ ‘-1" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507093455.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h4 id="ä¼ é€’ä¾èµ–-1"><a href="#ä¼ é€’ä¾èµ–-1" class="headerlink" title="ä¼ é€’ä¾èµ–"></a>ä¼ é€’ä¾èµ–</h4><p><code>org.jetbrains.kotlin:kotlin-stdlib:1.3.50</code></p><p><code>androidx.activity:activity-ktx:1.1.0</code></p><p><code>androidx.core:core-ktx:1.1.0</code></p><p><code>androidx.collection:collection-ktx:1.1.0</code></p><p><code>androidx.lifecycle:lifecycle-livedata-core-ktx:2.2.0</code></p><p><code>androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0</code></p><blockquote><p><strong><code>fragment</code> åº“é»˜è®¤å¼•å…¥äº† <code>activity</code> <code>core-ktx</code> <code>lifecycle-livedata-core-ktx</code> <code>lifecycle-viewmodel-ktx</code> åº“</strong>  </p><p><a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-master-dev/fragment/fragment-ktx/build.gradle" target="_blank" rel="noopener">fragment build.grdle æºç åœ°å€</a></p></blockquote><h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><h4 id="å¼•å…¥-2"><a href="#å¼•å…¥-2" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>    <span class="hljs-keyword">def</span> activity_version = <span class="hljs-string">"1.1.0"</span><br><br>    <span class="hljs-comment">// Java language implementation</span><br>    implementation <span class="hljs-string">"androidx.activity:activity:$activity_version"</span><br>    <span class="hljs-comment">// Kotlin</span><br>    implementation <span class="hljs-string">"androidx.activity:activity-ktx:$activity_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>âš ï¸ Note: The Kotlin dependant libraries of this version (activity-ktx) target Java 8 programming language bytecode. <a href="https://developer.android.com/studio/write/java8-support" target="_blank" rel="noopener">Please read Use Java 8 language features to learn how to use it in your project.</a></p></blockquote><h4 id="ä¾èµ–æ ‘-2"><a href="#ä¾èµ–æ ‘-2" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507093743.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h4 id="ä¾èµ–ä¼ é€’"><a href="#ä¾èµ–ä¼ é€’" class="headerlink" title="ä¾èµ–ä¼ é€’"></a>ä¾èµ–ä¼ é€’</h4><p><code>org.jetbrains.kotlin:kotlin-stdlib:1.3.50</code></p><p><code>androidx.core:core-ktx:1.1.0</code></p><p><code>androidx.lifecycle:lifecycle-runtime-ktx:2.2.0</code></p><p><code>androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0</code></p><blockquote><p><a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-master-dev/activity/activity-ktx/build.gradle" target="_blank" rel="noopener">activity build.gradle æºç åœ°å€</a></p></blockquote><h3 id="Core"><a href="#Core" class="headerlink" title="Core"></a>Core</h3><h4 id="å¼•å…¥-3"><a href="#å¼•å…¥-3" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>    <span class="hljs-keyword">def</span> core_version = <span class="hljs-string">"1.2.0"</span><br><br>    <span class="hljs-comment">// Java language implementation</span><br>    implementation <span class="hljs-string">"androidx.core:core:$core_version"</span><br>    <span class="hljs-comment">// Kotlin</span><br>    implementation <span class="hljs-string">"androidx.core:core-ktx:$core_version"</span><br><br>    <span class="hljs-comment">// To use RoleManagerCompat</span><br>    implementation <span class="hljs-string">"androidx.core:core-role:1.0.0-alpha01"</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¾èµ–æ ‘-3"><a href="#ä¾èµ–æ ‘-3" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507093859.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><h3 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h3><h4 id="å¼•å…¥-4"><a href="#å¼•å…¥-4" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>    <span class="hljs-keyword">def</span> lifecycle_version = <span class="hljs-string">"2.2.0"</span><br>    <span class="hljs-keyword">def</span> arch_version = <span class="hljs-string">"2.1.0"</span><br><br>    <span class="hljs-comment">// ViewModel</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-viewmodel-ktx:$lifecycle_version"</span><br>    <span class="hljs-comment">// LiveData</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-livedata-ktx:$lifecycle_version"</span><br>    <span class="hljs-comment">// Lifecycles only (without ViewModel or LiveData)</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version"</span><br><br>    <span class="hljs-comment">// Saved state module for ViewModel</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-viewmodel-savedstate:$lifecycle_version"</span><br><br>    <span class="hljs-comment">// Annotation processor</span><br>    kapt <span class="hljs-string">"androidx.lifecycle:lifecycle-compiler:$lifecycle_version"</span><br>    <span class="hljs-comment">// alternately - if using Java8, use the following instead of lifecycle-compiler</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-common-java8:$lifecycle_version"</span><br><br>    <span class="hljs-comment">// optional - helpers for implementing LifecycleOwner in a Service</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-service:$lifecycle_version"</span><br><br>    <span class="hljs-comment">// optional - ProcessLifecycleOwner provides a lifecycle for the whole application process</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-process:$lifecycle_version"</span><br><br>    <span class="hljs-comment">// optional - ReactiveStreams support for LiveData</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-reactivestreams-ktx:$lifecycle_version"</span><br><br>    <span class="hljs-comment">// optional - Test helpers for LiveData</span><br>    testImplementation <span class="hljs-string">"androidx.arch.core:core-testing:$arch_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li>âš ï¸ <strong><code>lifecycle-extensions</code> å·²åºŸå¼ƒï¼Œå¦‚æœä½¿ç”¨ <code>LifecycleService</code> è¯·ä¾èµ– <code>lifecycle-service</code>ï¼›å¦‚æœä½¿ç”¨ <code>ProcessLifecycleOwner</code> è¯·ä¾èµ– <code>lifecycle-process</code>ã€‚<code>lifecycle-extensionsl</code>ä¸ä¼šæœ‰2.3.0ç‰ˆæœ¬</strong></li><li><strong>2.1.0 å <code>ViewModelProviders.of()</code> è¢«åºŸå¼ƒã€‚æ‚¨å¯ä»¥åœ¨ <code>FragmentActivity</code> æˆ–è€… <code>Fragment</code> ä½¿ç”¨ <code>ViewModelProvider(ViewModelStoreOwner)</code> æ„é€ å™¨æ¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚ï¼ˆ<code>Fragment</code> åº“ 1.2.0ä»¥ä¸Šï¼‰</strong></li></ul></blockquote><h4 id="ä¾èµ–æ ‘-4"><a href="#ä¾èµ–æ ‘-4" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507094042.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="livedata"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507094223.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="viewmodel"></p><h3 id="Navigation"><a href="#Navigation" class="headerlink" title="Navigation"></a>Navigation</h3><h4 id="å¼•å…¥-5"><a href="#å¼•å…¥-5" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>  <span class="hljs-keyword">def</span> nav_version = <span class="hljs-string">"2.3.0-alpha02"</span><br><br>  <span class="hljs-comment">// Java language implementation</span><br>  implementation <span class="hljs-string">"androidx.navigation:navigation-fragment:$nav_version"</span><br>  implementation <span class="hljs-string">"androidx.navigation:navigation-ui:$nav_version"</span><br><br>  <span class="hljs-comment">// Kotlin</span><br>  implementation <span class="hljs-string">"androidx.navigation:navigation-fragment-ktx:$nav_version"</span><br>  implementation <span class="hljs-string">"androidx.navigation:navigation-ui-ktx:$nav_version"</span><br><br>  <span class="hljs-comment">// Dynamic Feature Module Support</span><br>  implementation <span class="hljs-string">"androidx.navigation:navigation-dynamic-features-fragment:$nav_version"</span><br><br>  <span class="hljs-comment">// Testing Navigation</span><br>  androidTestImplementation <span class="hljs-string">"androidx.navigation:navigation-testing:$nav_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¾èµ–æ ‘-5"><a href="#ä¾èµ–æ ‘-5" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507094643.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="navigation"></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507094711.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="navigation-ui"></p><h3 id="Paging"><a href="#Paging" class="headerlink" title="Paging"></a>Paging</h3><h4 id="å¼•å…¥-6"><a href="#å¼•å…¥-6" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>  <span class="hljs-keyword">def</span> paging_version = <span class="hljs-string">"2.1.1"</span><br><br>  implementation <span class="hljs-string">"androidx.paging:paging-runtime:$paging_version"</span> <span class="hljs-comment">// For Kotlin use paging-runtime-ktx</span><br><br>  <span class="hljs-comment">// alternatively - without Android dependencies for testing</span><br>  testImplementation <span class="hljs-string">"androidx.paging:paging-common:$paging_version"</span> <span class="hljs-comment">// For Kotlin use paging-common-ktx</span><br><br>  <span class="hljs-comment">// optional - RxJava support</span><br>  implementation <span class="hljs-string">"androidx.paging:paging-rxjava2:$paging_version"</span> <span class="hljs-comment">// For Kotlin use paging-rxjava2-ktx</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¾èµ–æ ‘-6"><a href="#ä¾èµ–æ ‘-6" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507094857.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="paging"></p><h3 id="Room"><a href="#Room" class="headerlink" title="Room"></a>Room</h3><h4 id="å¼•å…¥-7"><a href="#å¼•å…¥-7" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies &#123;<br>  <span class="hljs-keyword">def</span> room_version = <span class="hljs-string">"2.2.4"</span><br><br>  implementation <span class="hljs-string">"androidx.room:room-runtime:$room_version"</span><br>  annotationProcessor <span class="hljs-string">"androidx.room:room-compiler:$room_version"</span> <span class="hljs-comment">// For Kotlin use kapt instead of annotationProcessor</span><br><br>  <span class="hljs-comment">// optional - Kotlin Extensions and Coroutines support for Room</span><br>  implementation <span class="hljs-string">"androidx.room:room-ktx:$room_version"</span><br><br>  <span class="hljs-comment">// optional - RxJava support for Room</span><br>  implementation <span class="hljs-string">"androidx.room:room-rxjava2:$room_version"</span><br><br>  <span class="hljs-comment">// optional - Guava support for Room, including Optional and ListenableFuture</span><br>  implementation <span class="hljs-string">"androidx.room:room-guava:$room_version"</span><br><br>  <span class="hljs-comment">// Test helpers</span><br>  testImplementation <span class="hljs-string">"androidx.room:room-testing:$room_version"</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>âš ï¸ Note: For Kotlin-based apps, make sure you use kapt instead of annotationProcessor. You should also add the kotlin-kapt plugin.</p></blockquote><h4 id="ä¾èµ–æ ‘-7"><a href="#ä¾èµ–æ ‘-7" class="headerlink" title="ä¾èµ–æ ‘"></a>ä¾èµ–æ ‘</h4><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200507094945.png" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="room"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="ç‰ˆæœ¬è¯´æ˜"><a href="#ç‰ˆæœ¬è¯´æ˜" class="headerlink" title="ç‰ˆæœ¬è¯´æ˜"></a>ç‰ˆæœ¬è¯´æ˜</h4><blockquote><p><code>androidx</code>åº“éµå¾ªä¸¥æ ¼çš„è¯­ä¹‰ç‰ˆæœ¬æ§åˆ¶ã€‚ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ 1.0.1-beta02ï¼‰åŒ…å«ä¸‰ä¸ªæ•°å­—ï¼Œåˆ†åˆ«ä»£è¡¨ major çº§åˆ«ã€minor çº§åˆ«å’Œé—®é¢˜ä¿®å¤çº§åˆ«ã€‚é¢„å‘å¸ƒç‰ˆæœ¬ä¹Ÿæœ‰ä¸€ä¸ªåç¼€ï¼Œç”¨äºæŒ‡å®šé¢„å‘å¸ƒé˜¶æ®µï¼ˆAlpha ç‰ˆã€Beta ç‰ˆã€å€™é€‰ç‰ˆæœ¬ï¼‰å’Œç‰ˆæœ¬å·ï¼ˆ01ã€02 ç­‰ï¼‰ã€‚</p></blockquote><p>åº“çš„æ¯ä¸ªç‰ˆæœ¬éƒ½è¦ç»å†ä¸‰ä¸ªé¢„å‘å¸ƒé˜¶æ®µï¼Œæ‰èƒ½æˆä¸ºç¨³å®šç‰ˆæœ¬ã€‚å„é¢„å‘å¸ƒé˜¶æ®µçš„æ ‡å‡†å¦‚ä¸‹ï¼š</p><p><strong>Alpha ç‰ˆ</strong></p><ul><li>Alpha ç‰ˆåŠŸèƒ½ç¨³å®šï¼Œä½†åŠŸèƒ½å¯èƒ½ä¸å®Œæ•´ã€‚</li><li>åœ¨ç‰ˆæœ¬å¤„äº Alpha ç‰ˆçŠ¶æ€æ—¶ï¼Œå¯ä»¥æ·»åŠ ã€ç§»é™¤æˆ–æ›´æ”¹ APIã€‚</li></ul><p><strong>Beta ç‰ˆ</strong></p><ul><li>Beta ç‰ˆåŠŸèƒ½ç¨³å®šï¼Œå¹¶ä¸”å…·æœ‰åŠŸèƒ½å®Œæ•´çš„ API Surfaceã€‚<br>å®ƒä»¬å¯ä»¥æŠ•å…¥å®é™…ä½¿ç”¨ï¼Œä½†å¯èƒ½åŒ…å«é”™è¯¯ã€‚</li><li>Beta ç‰ˆæ— æ³•ä½¿ç”¨å®éªŒæ€§ç¼–è¯‘å™¨åŠŸèƒ½ï¼ˆä¾‹å¦‚ @UseExperimentalï¼‰ã€‚</li><li>å…¶ä»–åº“çš„ä¾èµ–é¡¹å¿…é¡»ä¸º Beta ç‰ˆã€RC ç‰ˆæˆ–ç¨³å®šç‰ˆã€‚ä¸å…è®¸ä½¿ç”¨ Alpha ç‰ˆä¾èµ–é¡¹ã€‚</li></ul><p><strong>å€™é€‰ç‰ˆæœ¬ (RC)</strong></p><ul><li>å€™é€‰ç‰ˆæœ¬æ˜¯æœªæ¥çš„ç¨³å®šç‰ˆã€‚</li><li>æ­¤ç‰ˆæœ¬å¯èƒ½åŒ…å«åœ¨æœ€åä¸€åˆ»æä¾›çš„é‡è¦ä¿®å¤ã€‚</li><li>æ­¤ç‰ˆæœ¬çš„ API Surface æ— æ³•æ›´æ”¹ã€‚</li><li>å…¶ä»–åº“çš„ä¾èµ–é¡¹åªèƒ½æ˜¯ RC ç‰ˆæˆ–ç¨³å®šç‰ˆã€‚</li></ul><p>ä¸€ä¸ªåº“å¯ä»¥åŒæ—¶å…·æœ‰å¤šä¸ªç‰ˆæœ¬ã€‚æ¯ä¸ªç‰ˆæœ¬éƒ½å…·æœ‰ä¸åŒçš„å‘å¸ƒé˜¶æ®µã€‚ä¾‹å¦‚ï¼Œè™½ç„¶ androidx.activity çš„ç¨³å®šç‰ˆå¯ä»¥æ˜¯ 1.0.0ï¼Œä½†ä¹Ÿå¯èƒ½è¿˜æœ‰ 1.1.0-beta02 ç‰ˆæœ¬ä»¥åŠ 2.0.0-alpha01 ç‰ˆæœ¬ã€‚</p><h4 id="kotlin-åç¨‹çš„ä½¿ç”¨"><a href="#kotlin-åç¨‹çš„ä½¿ç”¨" class="headerlink" title="kotlin åç¨‹çš„ä½¿ç”¨"></a>kotlin åç¨‹çš„ä½¿ç”¨</h4><blockquote><p><code>ViewModel</code> <code>LiveData</code> <code>Activity</code> <code>Fragment</code> <code>Service</code>ç­‰å‡å¯ä½¿ç”¨åç¨‹</p></blockquote><ul><li>å¯¹äº <code>ViewModelScope</code>ï¼Œè¯·ä½¿ç”¨ <code>androidx.lifecycle:lifecycle-viewmodel-ktx:2.1.0-beta01</code> æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</li><li>å¯¹äº <code>LifecycleScope</code>ï¼Œè¯·ä½¿ç”¨ <code>androidx.lifecycle:lifecycle-runtime-ktx:2.2.0-alpha01</code> æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</li><li>å¯¹äº <code>liveData</code>ï¼Œè¯·ä½¿ç”¨ <code>androidx.lifecycle:lifecycle-livedata-ktx:2.2.0-alpha01</code> æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚ </li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyViewModel</span>: <span class="hljs-type">ViewModel</span></span>() &#123;<br>    <span class="hljs-keyword">init</span> &#123;<br>        viewModelScope.launch &#123;<br>            <span class="hljs-comment">// Coroutine that will be canceled when the ViewModel is cleared.</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)<br>        viewLifecycleOwner.lifecycleScope.launch &#123;<br>            <span class="hljs-keyword">val</span> params = TextViewCompat.getTextMetricsParams(textView)<br>            <span class="hljs-keyword">val</span> precomputedText = withContext(Dispatchers.Default) &#123;<br>                PrecomputedTextCompat.create(longTextContent, params)<br>            &#125;<br>            TextViewCompat.setPrecomputedText(textView, precomputedText)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> user: LiveData&lt;User&gt; = liveData &#123;<br>    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = database.loadUser() <span class="hljs-comment">// loadUser is a suspend function.</span><br>    emit(<span class="hljs-keyword">data</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¾èµ–å…³ç³»"><a href="#ä¾èµ–å…³ç³»" class="headerlink" title="ä¾èµ–å…³ç³»"></a>ä¾èµ–å…³ç³»</h4><ul><li><p>å¸¦æœ‰<code>-ktx</code>çš„åº“æ‹¥æœ‰ <code>kotlin</code> çš„ç‰¹æ€§ï¼Œæœ‰å¾ˆå¤šå¸¸ç”¨çš„æ‰©å±•å‡½æ•°</p></li><li><p>å¸¦æœ‰<code>-ktx</code>çš„åº“ä¾èµ– java ç‰ˆæœ¬ï¼Œ å¸¦æœ‰<code>-ktx</code>å’Œ java ç‰ˆæœ¬å„è‡ªå•ç‹¬ä½¿ç”¨å³å¯</p></li><li><p><code>appcompat</code> åº“åŒ…å« <code>fragmnet</code>,<code>fragment</code> åŒ…å« <code>activity</code> ï¼Œå½“ä½ å¼•å…¥<code>androidx</code> <code>appcompat</code> åº“ä¾¿å¯ä»¥ä½¿ç”¨<code>androidx</code> <code>fragment</code> å’Œ <code>androidx</code> <code>activity</code></p></li><li><p>å—é™äº<code>appcompat</code> ç¨³å®šç‰ˆçš„æ›´æ–°é€Ÿåº¦ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å•ç‹¬ä½¿ç”¨<code>androidx</code> <code>fragment</code>/<code>activity</code></p></li><li><p><code>AppCompatActivity</code> ç»§æ‰¿è‡ª <code>FragmentActivity</code>ï¼Œ <code>AppCompatActivity</code>å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>fragment</code></p></li><li><p><code>DataBinding</code> <code>ViewBinding</code> ä¾èµ–äº <code>android build gradle</code> æ’ä»¶ ,æ— éœ€å¼•å…¥å…¶ä»–ä¾èµ–</p></li><li><p><code>androidx</code> <code>fragment</code>/<code>activity</code>ä¸‹å‡ä¾èµ–çš„<code>ViewModel</code>å’Œ <code>LiveData</code>ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨</p></li><li><p>ä½¿ç”¨<code>ViewModel</code>å’Œ <code>LiveData</code>å®Œæ•´åŠŸèƒ½éœ€è¦å•ç‹¬å¼•å…¥ï¼Œå®ƒä»¬éƒ½æ˜¯<code>lifecycle</code>å¤§å®¶æ—ä¸‹çš„</p></li><li><p><code>lifecycle-extensions</code> å·²åºŸå¼ƒï¼Œä¸è¦ä½¿ç”¨å®ƒäº†</p></li><li><p>å¦‚æœæƒ³ä½¿ç”¨å®ç°<code>LifecycleOwner</code> çš„ <code>Service</code> ï¼Œéœ€è¦å¼•å…¥ <code>lifecycle-service</code></p></li></ul><h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Flywith24</a>ï¼Œæˆ‘çš„åšå®¢å†…å®¹å·²ç»åˆ†ç±»æ•´ç† <a href="https://github.com/Flywith24/BlogList" target="_blank" rel="noopener">åœ¨è¿™é‡Œ</a>ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ Watch å¯ä»¥åŠæ—¶è·å–æˆ‘çš„æ–‡ç« æ›´æ–°å“¦ ğŸ˜‰</p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://xiaozhuanlan.com/detail" target="_blank" rel="noopener">å°ä¸“æ </a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul><p><img class="lazyload" data-original="https://user-gold-cdn.xitu.io/2020/6/26/172ee567fb4fbf7e?w=1954&h=624&f=jpeg&s=115362" src="/2020/03/01/Jetpack-dependencies/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€èƒŒä¸ŠJetpackã€‘AdroidXä¸‹ä½¿ç”¨Activityå’ŒFragmentçš„å˜åŒ–</title>
      <link href="/2020/02/29/Jetpack-androidx-activity-fragment/"/>
      <url>/2020/02/29/Jetpack-androidx-activity-fragment/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åŸæ–‡ï¼š<a href="https://medium.com/@miloszlewandowski/how-androidx-changes-the-way-we-work-with-activities-and-fragments-73b88d157678" target="_blank" rel="noopener">How AndroidX changes the way we work with Activities and Fragments</a></p><p>ä½œè€…ï¼š<a href="https://medium.com/@miloszlewandowski" target="_blank" rel="noopener">MiÅ‚osz Lewandowski</a></p><p>è¯‘è€…ï¼š<a href="http://www.yangyunzhao.com/" target="_blank" rel="noopener">Fly_with24</a></p></blockquote><p>è¿‡å»çš„ä¸€æ®µæ—¶é—´ï¼Œ<code>AndroidX</code> è½¯ä»¶åŒ…ä¸‹çš„ <code>Activity/Fragmet</code> çš„ API å‘ç”Ÿäº†å¾ˆå¤šå˜åŒ–ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•æå‡Android çš„å¼€å‘æ•ˆç‡ä»¥åŠå¦‚ä½•é€‚åº”å½“ä¸‹æµè¡Œçš„ç¼–ç¨‹è§„åˆ™å’Œæ¨¡å¼ã€‚</p><p>æœ¬æ–‡ä¸­æè¿°çš„æ‰€æœ‰åŠŸèƒ½ç°åœ¨éƒ½å¯ä»¥åœ¨ç¨³å®šçš„ <code>AndroidX</code> è½¯ä»¶åŒ…ä¸­ä½¿ç”¨ï¼Œå®ƒä»¬åœ¨å»å¹´å‡å·²å‘å¸ƒæˆ–ç§»è‡³ç¨³å®šç‰ˆæœ¬ã€‚</p><a id="more"></a><h3 id="åœ¨æ„é€ å™¨ä¸­ä¼ å…¥å¸ƒå±€-ID"><a href="#åœ¨æ„é€ å™¨ä¸­ä¼ å…¥å¸ƒå±€-ID" class="headerlink" title="åœ¨æ„é€ å™¨ä¸­ä¼ å…¥å¸ƒå±€ ID"></a>åœ¨æ„é€ å™¨ä¸­ä¼ å…¥å¸ƒå±€ ID</h3><p>ä» <code>AndroidX</code>  <code>AppCompat 1.1.0</code> å’Œ <code>Fragment 1.1.0</code> ( è¯‘è€…æ³¨ï¼šAppCompat åŒ…å« Fragmentï¼Œä¸” Fragment åŒ…å« Activityï¼Œè¯¦æƒ…è§<a href="https://juejin.im/post/5e567ee1518825494466a938" target="_blank" rel="noopener">ã€æ•´ç†ã€‘Jetpack ä¸»è¦ç»„ä»¶çš„ä¾èµ–åŠä¼ é€’å…³ç³»</a> )å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å°† <code>layoutId</code> ä½œä¸ºå‚æ•°çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span></span>(R.layout.my_activity)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragmentActivity</span>: <span class="hljs-type">FragmentActivity</span></span>(R.layout.my_fragment_activity)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>(R.layout.my_fragment)<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•å¯ä»¥å‡å°‘ <code>Activity/Fragment</code> ä¸­æ–¹æ³•é‡å†™çš„æ•°é‡ï¼Œå¹¶ä½¿ç±»æ›´å…·å¯è¯»æ€§ã€‚ æ— éœ€åœ¨ <code>Activity</code> ä¸­é‡å†™ <code>onCreate()</code> å³å¯è°ƒç”¨ <code>setContentView()</code> æ–¹æ³•ã€‚ å¦å¤–ï¼Œæ— éœ€æ‰‹åŠ¨åœ¨<code>Fragment</code> ä¸­é‡å†™ <code>onCreateView</code> å³å¯æ‰‹åŠ¨è°ƒç”¨ <code>Inflater</code> æ¥æ‰©å±•è§†å›¾ã€‚</p><h3 id="æ‰©å±•-Activity-Fragment-çš„çµæ´»æ€§"><a href="#æ‰©å±•-Activity-Fragment-çš„çµæ´»æ€§" class="headerlink" title="æ‰©å±• Activity/Fragment çš„çµæ´»æ€§"></a>æ‰©å±• <code>Activity/Fragment</code> çš„çµæ´»æ€§</h3><p>å€ŸåŠ© <code>AndroidX</code> æ–°çš„ API ï¼Œå¯ä»¥å‡å°‘åœ¨ <code>Activity/Fragment</code> å¤„ç†æŸäº›åŠŸèƒ½çš„æƒ…å†µã€‚é€šå¸¸ï¼Œæ‚¨å¯ä»¥è·å–æä¾›æŸäº›åŠŸèƒ½çš„å¯¹è±¡å¹¶å‘å…¶æ³¨å†Œæ‚¨çš„å¤„ç†é€»è¾‘ï¼Œè€Œä¸æ˜¯é‡å†™ <code>Activity / Fragment</code> ä¸­çš„æ–¹æ³•ã€‚ è¿™æ ·ï¼Œæ‚¨ç°åœ¨å¯ä»¥åœ¨å±å¹•ä¸Šç»„æˆå‡ ä¸ªç‹¬ç«‹çš„ç±»ï¼Œè·å¾—æ›´é«˜çš„çµæ´»æ€§ï¼Œå¤ç”¨ä»£ç ï¼Œå¹¶ä¸”é€šå¸¸åœ¨ä¸å¼•å…¥è‡ªå·±çš„æŠ½è±¡çš„æƒ…å†µä¸‹ï¼Œå¯¹ä»£ç ç»“æ„å…·æœ‰æ›´å¤šæ§åˆ¶ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹è¿™åœ¨ä¸¤ä¸ªç¤ºä¾‹ä¸­å¦‚ä½•å·¥ä½œã€‚</p><h4 id="1-OnBackPressedDispatcher"><a href="#1-OnBackPressedDispatcher" class="headerlink" title="1. OnBackPressedDispatcher"></a>1. OnBackPressedDispatcher</h4><p>æœ‰æ—¶ï¼Œæ‚¨éœ€è¦é˜»æ­¢ç”¨æˆ·è¿”å›ä¸Šä¸€çº§ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦åœ¨ <code>Activity</code> ä¸­é‡å†™ <code>onBackPressed()</code> æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œå½“æ‚¨ä½¿ç”¨ <code>Fragment</code> æ—¶ï¼Œæ²¡æœ‰ç›´æ¥çš„æ–¹æ³•æ¥æ‹¦æˆªè¿”å›ã€‚ åœ¨ <code>Fragment</code> ç±»ä¸­æ²¡æœ‰å¯ç”¨çš„ <code>onBackPressed()</code> æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢åŒæ—¶å­˜åœ¨å¤šä¸ª <code>Fragment</code> æ—¶å‘ç”Ÿæ„å¤–è¡Œä¸ºã€‚</p><p>ä½†æ˜¯ï¼Œä» <code>AndroidX</code> <code>Activity 1.0.0</code> å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>OnBackPressedDispatcher</code> åœ¨æ‚¨å¯ä»¥è®¿é—®è¯¥ <code>Activity</code> çš„ä»£ç çš„ä»»ä½•ä½ç½®ï¼ˆä¾‹å¦‚ï¼Œåœ¨ <code>Fragment</code> ä¸­ï¼‰æ³¨å†Œ <code>OnBackPressedCallback</code>ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragment</span> : <span class="hljs-type">Fragment</span></span>() &#123;<br>  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttach</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> &#123;<br>    <span class="hljs-keyword">super</span>.onAttach(context)<br>    <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : OnBackPressedCallback(<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOnBackPressed</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">// Do something</span><br>      &#125;<br>    &#125;<br>    requireActivity().onBackPressedDispatcher.addCallback(<span class="hljs-keyword">this</span>, callback)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‚¨å¯èƒ½ä¼šåœ¨è¿™é‡Œæ³¨æ„åˆ°å¦å¤–ä¸¤ä¸ªæœ‰ç”¨çš„åŠŸèƒ½ï¼š</p><ul><li><code>OnBackPressedCallback</code> çš„æ„é€ å‡½æ•°ä¸­çš„å¸ƒå°”ç±»å‹çš„å‚æ•°æœ‰åŠ©äºæ ¹æ®å½“å‰çŠ¶æ€åŠ¨æ€ æ‰“å¼€/å…³é—­æŒ‰ä¸‹çš„è¡Œä¸º</li><li><code>addCallback()</code> æ–¹æ³•çš„å¯é€‰ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>LifecycleOwner</code>ï¼Œä»¥ç¡®ä¿ä»…åœ¨æ‚¨çš„ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œ<code>Fragment</code>ï¼‰è‡³å°‘å¤„äº <code>STARTED</code> çŠ¶æ€æ—¶æ‰ä½¿ç”¨å›è°ƒã€‚</li></ul><p>é€šè¿‡ä½¿ç”¨ <code>OnBackPressedDispatcher</code> ï¼Œæ‚¨ä¸ä»…å¯ä»¥è·å¾—åœ¨ <code>Activity</code> ä¹‹å¤–å¤„ç†è¿”å›é”®çš„ä¾¿æ·æ–¹å¼ã€‚ æ ¹æ®æ‚¨çš„éœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨ä»»æ„ä½ç½®å®šä¹‰ <code>OnBackPressedCallback</code>ï¼Œä½¿å…¶å¯å¤ç”¨ï¼Œæˆ–æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¶æ„è¿›è¡Œä»»ä½•æ“ä½œã€‚ æ‚¨ä¸å†éœ€è¦é‡å†™<code>Activity</code> ä¸­çš„ <code>onBackPressed</code> æ–¹æ³•ï¼Œä¹Ÿä¸å¿…æä¾›è‡ªå·±çš„æŠ½è±¡çš„æ¥å®ç°éœ€æ±‚çš„ä»£ç ã€‚</p><h4 id="2-SavedStateRegistry"><a href="#2-SavedStateRegistry" class="headerlink" title="2. SavedStateRegistry"></a>2. SavedStateRegistry</h4><p>å¦‚æœæ‚¨å¸Œæœ› <code>Activity</code> åœ¨ç»ˆæ­¢å¹¶é‡å¯åæ¢å¤ä¹‹å‰çš„çŠ¶æ€ï¼Œåˆ™å¯èƒ½è¦ä½¿ç”¨ <code>saved state</code> åŠŸèƒ½ã€‚ è¿‡å»ï¼Œæ‚¨éœ€è¦åœ¨ <code>Activity</code> ä¸­é‡å†™ä¸¤ä¸ªæ–¹æ³•ï¼š<code>onSaveInstanceState</code> å’Œ <code>onRestoreInstanceState</code>ã€‚ æ‚¨è¿˜å¯ä»¥åœ¨ <code>onCreate</code> æ–¹æ³•ä¸­è®¿é—®æ¢å¤çš„çŠ¶æ€ã€‚ åŒæ ·ï¼Œåœ¨ <code>Fragment</code> ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>onSaveInstanceState</code> æ–¹æ³•ï¼ˆå¹¶ä¸”å¯ä»¥åœ¨ <code>onCreate</code>ï¼Œ<code>onCreateView</code> å’Œ<code>onActivityCreated</code>æ–¹æ³•ä¸­æ¢å¤çŠ¶æ€ï¼‰ã€‚</p><p>ä» <code>AndroidX</code>  <code>SavedState 1.0.0</code>ï¼ˆå®ƒæ˜¯ <code>AndroidX</code> <code>Activity</code> å’Œ <code>AndroidX</code>  <code>Fragment</code> å†…éƒ¨çš„ä¾èµ–ã€‚è¯‘è€…æ³¨ï¼šæ‚¨ä¸éœ€è¦å•ç‹¬å£°æ˜å®ƒï¼‰å¼€å§‹ï¼Œæ‚¨å¯ä»¥è®¿é—® <code>SavedStateRegistry</code>ï¼Œå®ƒä½¿ç”¨äº†ä¸å‰é¢æè¿°çš„ <code>OnBackPressedDispatcher</code> ç±»ä¼¼çš„æœºåˆ¶ï¼šæ‚¨å¯ä»¥ä» <code>Activity / Fragment</code> ä¸­è·å– <code>SavedStateRegistry</code>ï¼Œç„¶å æ³¨å†Œæ‚¨çš„ <code>SavedStateProvider</code>ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span></span>() &#123;<br><br>  <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MY_SAVED_STATE_KEY = <span class="hljs-string">"my_saved_state"</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> SOME_VALUE_KEY = <span class="hljs-string">"some_value"</span><br>  &#125;<br>    <br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> someValue: String<br>    <br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> savedStateProvider = SavedStateRegistry.SavedStateProvider &#123;    <br>    Bundle().apply &#123;<br>      putString(SOME_VALUE_KEY, someValue)<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> &#123;    <br>    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>    savedStateRegistry<br>      .registerSavedStateProvider(MY_SAVED_STATE_KEY, savedStateProvider)<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">someMethod</span><span class="hljs-params">()</span></span> &#123;<br>    someValue = savedStateRegistry<br>      .consumeRestoredStateForKey(MY_SAVED_STATE_KEY)<br>      ?.getString(SOME_VALUE_KEY)<br>      ?: <span class="hljs-string">""</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æ‚¨æ‰€è§ï¼Œ<code>SavedStateRegistry</code> å¼ºåˆ¶æ‚¨å°†å¯†é’¥ç”¨äºæ•°æ®ã€‚ è¿™æ ·å¯ä»¥é˜²æ­¢æ‚¨çš„æ•°æ®è¢« attach åˆ°åŒä¸€ä¸ª <code>Activity/Fragment</code>çš„å¦ä¸€ä¸ª <code>SavedStateProvider</code> ç ´åã€‚ å°±åƒåœ¨ <code>OnBackPressedDispatcher</code> ä¸­ä¸€æ ·ï¼Œæ‚¨å¯ä»¥ä¾‹å¦‚å°† <code>SavedStateProvider</code> æå–åˆ°å¦ä¸€ä¸ªç±»ï¼Œé€šè¿‡ä½¿ç”¨æ‰€éœ€çš„ä»»ä½•é€»è¾‘ä½¿å…¶ä¸æ•°æ®ä¸€èµ·ä½¿ç”¨ï¼Œä»è€Œåœ¨åº”ç”¨ç¨‹åºä¸­å®ç°æ¸…æ™°çš„ä¿å­˜çŠ¶æ€è¡Œä¸ºã€‚</p><p>æ­¤å¤–ï¼Œå¦‚æœæ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ <code>ViewModel</code>ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ <code>AndroidX</code>  <code>ViewModel-SavedState</code> ä½¿ä½ çš„<code>ViewModel</code> å¯ä»¥ä¿å­˜å…¶çŠ¶æ€ã€‚ ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä» <code>AndroidX</code>  <code>Activity 1.1.0</code> å’Œ <code>AndroidX</code> <code>Fragment 1.2.0</code> å¼€å§‹ï¼Œå¯ç”¨ <code>SavedState</code> çš„<code>SavedStateViewModelFactory</code> æ˜¯åœ¨è·å– <code>ViewModel</code> çš„æ‰€æœ‰æ–¹å¼ä¸­ä½¿ç”¨çš„é»˜è®¤å·¥å‚ï¼šå§”æ‰˜ <code>ViewModelProvider</code> æ„é€ å‡½æ•°å’Œ <code>ViewModelProviders.of()</code> æ–¹æ³•ã€‚</p><h3 id="FragmentFactory"><a href="#FragmentFactory" class="headerlink" title="FragmentFactory"></a>FragmentFactory</h3><p><code>Fragment</code> æœ€å¸¸æåŠçš„é—®é¢˜ä¹‹ä¸€æ˜¯ä¸èƒ½ä½¿ç”¨å¸¦æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ <code>Dagger2</code> è¿›è¡Œä¾èµ–é¡¹æ³¨å…¥ï¼Œåˆ™æ— æ³•ä½¿ç”¨ <code>Inject</code> æ³¨è§£ <code>Fragment</code> æ„é€ å‡½æ•°å¹¶æŒ‡å®šå‚æ•°ã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‡å®š <code>FragmentFactory</code> ç±»æ¥å‡å°‘ <code>Fragment</code> åˆ›å»ºè¿‡ç¨‹ä¸­çš„ç±»ä¼¼é—®é¢˜ã€‚ é€šè¿‡åœ¨ <code>FragmentManager</code> ä¸­æ³¨å†Œ <code>FragmentFactory</code>ï¼Œå¯ä»¥é‡å†™å®ä¾‹åŒ– <code>Fragment</code> çš„é»˜è®¤æ–¹æ³•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFragmentFactory</span> : <span class="hljs-type">FragmentFactory</span></span>() &#123;<br><br>  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">instantiate</span><span class="hljs-params">(classLoader: <span class="hljs-type">ClassLoader</span>, className: <span class="hljs-type">String</span>)</span></span>: Fragment &#123;<br>    <span class="hljs-comment">// Call loadFragmentClass() to obtain the Class object</span><br>    <span class="hljs-keyword">val</span> fragmentClass = loadFragmentClass(classLoader, className)<br>     <br>    <span class="hljs-comment">// Now you can use className/fragmentClass to determine your prefered way </span><br>    <span class="hljs-comment">// of instantiating the Fragment object and just do it here.</span><br>        <br>    <span class="hljs-comment">// Or just call regular FragmentFactory to instantiate the Fragment using</span><br>    <span class="hljs-comment">// no arguments constructor</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.instantiate(classLoader, className)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æ‚¨æ‰€è§ï¼Œè¯¥APIéå¸¸é€šç”¨ï¼Œå› æ­¤æ‚¨å¯ä»¥æ‰§è¡Œæƒ³è¦åˆ›å»º <code>Fragment</code> å®ä¾‹çš„æ‰€æœ‰æ“ä½œã€‚ å›åˆ° <code>Dagger2</code> ç¤ºä¾‹ï¼Œä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æ³¨å…¥<code>FragmentFactory Provider &lt;Fragment&gt;</code> å¹¶ä½¿ç”¨å®ƒæ¥è·å– <code>Fragment</code> å¯¹è±¡ã€‚</p><h3 id="æµ‹è¯•-Fragment"><a href="#æµ‹è¯•-Fragment" class="headerlink" title="æµ‹è¯• Fragment"></a>æµ‹è¯• Fragment</h3><p>ä»<code>AndroidX</code>  <code>Fragment 1.1.0</code> å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>Fragment</code> æµ‹è¯•ç»„ä»¶æä¾› <code>FragmentScenario</code> ç±»ï¼Œè¯¥ç±»å¯ä»¥å¸®åŠ©åœ¨æµ‹è¯•ä¸­å®ä¾‹åŒ– <code>Fragment</code> å¹¶è¿›è¡Œå•ç‹¬æµ‹è¯•ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// To launch a Fragment with a user interface:</span><br><span class="hljs-keyword">val</span> scenario = launchFragmentInContainer&lt;FirstFragment&gt;()<br>        <br><span class="hljs-comment">// To launch a headless Fragment:</span><br><span class="hljs-keyword">val</span> scenario = launchFragment&lt;FirstFragment&gt;()<br>        <br><span class="hljs-comment">// To move the fragment to specific lifecycle state:</span><br>scenario.moveToState(CREATED)<br><br><span class="hljs-comment">// Now you can e.g. perform actions using Espresso:</span><br>onView(withId(R.id.refresh)).perform(click())<br><br><span class="hljs-comment">// To obtain a Fragment instance:</span><br>scenario.onFragment &#123; fragment -&gt;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="More-Kotlin"><a href="#More-Kotlin" class="headerlink" title="More Kotlin!"></a>More Kotlin!</h3><p>å¾ˆé«˜å…´çœ‹åˆ° <code>-ktx</code> <code>AndroidX</code> è½¯ä»¶åŒ…ä¸­æä¾›äº†è®¸å¤šæœ‰ç”¨çš„ <code>Kotlin</code> æ‰©å±•æ–¹æ³•ï¼Œå¹¶ä¸”å®šæœŸæ·»åŠ äº†æ–°çš„æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œåœ¨<code>AndroidX</code> <code>Fragment-KTX 1.2.0</code> ä¸­ï¼Œä½¿ç”¨ç‰‡æ®µåŒ–ç±»å‹çš„æ‰©å±•åå¯ç”¨äº <code>FragmentTransaction</code> ä¸Šçš„ <code>replace()</code> æ–¹æ³•ã€‚ å°†å…¶ä¸ <code>commit()</code> æ‰©å±•æ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// Before</span><br>supportFragmentManager<br>  .beginTransaction()<br>  .add(R.id.container, MyFragment::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>, <span class="hljs-type">null)</span></span><br>  .commit()<br><br><span class="hljs-comment">// After</span><br>supportFragmentManager.commit &#123;<br>  replace&lt;MyFragment&gt;(R.id.container)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="FragmentContainerView"><a href="#FragmentContainerView" class="headerlink" title="FragmentContainerView"></a>FragmentContainerView</h3><p>ä¸€ä»¶å°è€Œé‡è¦çš„äº‹æƒ…ã€‚ å¦‚æœæ‚¨å°† <code>FrameLayout</code> ç”¨ä½œ <code>Fragment</code> çš„å®¹å™¨ï¼Œåˆ™åº”æ”¹ç”¨ <code>FragmentContainerView</code> ã€‚ å®ƒä¿®å¤äº†ä¸€äº›åŠ¨ç”» zè½´ç´¢å¼•é¡ºåºé—®é¢˜å’Œçª—å£æ’å…¥è°ƒåº¦ã€‚ ä» <code>AndroidX</code> <code>Fragment 1.2.0</code> å¼€å§‹å¯ä»¥ä½¿ç”¨ <code>FragmentContainerView</code>ã€‚</p><hr><h3 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h3><hr><p>æˆ‘æ˜¯ <a href="https://flywith24.gitee.io/" target="_blank" rel="noopener">Fly_with24</a></p><ul><li><p><a href="https://juejin.im/user/57c7f6870a2b58006b1cfd6c" target="_blank" rel="noopener">æ˜é‡‘</a></p></li><li><p><a href="https://www.jianshu.com/u/3d5ad6043d66" target="_blank" rel="noopener">ç®€ä¹¦</a></p></li><li><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">Github</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Jetpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> androidx </tag>
            
            <tag> Jetpack </tag>
            
            <tag> MVVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€é‡å­¦Androidè¯»ä¹¦ç¬”è®°ã€‘Activityçš„ä»»åŠ¡æ ˆä¸è¿”å›æ ˆ</title>
      <link href="/2019/11/29/relearn-task-back-stack/"/>
      <url>/2019/11/29/relearn-task-back-stack/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è®¢é˜… <a href="https://xiaozhuanlan.com/topic/9074561823" target="_blank" rel="noopener">é‡å­¦å®‰å“</a> å¾ˆä¹…äº†ï¼Œæœ€è¿‘åœ¨æ•´ç†è¯»ä¹¦ç¬”è®°ï¼Œåœ¨æ­¤è®°å½•ä¹‹ã€‚</p><p>åœ¨æ­¤éš†é‡æ¨èè¿™ä½å¤§ä½¬ KunMinX</p><p>æœ¬æ–‡è®°å½•Activityä»»åŠ¡æ ˆä¸è¿”å›æ ˆç›¸å…³å†…å®¹çš„ç–‘é—®ä¸æ¢ç´¢</p></blockquote><a id="more"></a><p>è¯¥ä¸“æ çš„ä»£ç åœ°å€ï¼š <a href="https://github.com/KunMinX/Relearn-Android" target="_blank" rel="noopener">https://github.com/KunMinX/Relearn-Android</a> </p><h4 id="ç–‘æƒ‘äº§ç”Ÿ"><a href="#ç–‘æƒ‘äº§ç”Ÿ" class="headerlink" title="ç–‘æƒ‘äº§ç”Ÿ"></a>ç–‘æƒ‘äº§ç”Ÿ</h4><p>æ ¹æ®å¤§ä½¬çš„ä»£ç ä»¥åŠæ–‡ç« æè¿°ï¼Œæœ‰ä¸ªåœ°æ–¹è®©æˆ‘å¾ˆç–‘æƒ‘ã€‚</p><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/%E9%97%AE%E9%A2%98.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="é—®é¢˜"></p><p>æˆ‘è¿™é‡Œæ²¡æœ‰è¿‡æ»¤å½“å‰ä½¿ç”¨çš„appï¼Œæ‰€ä»¥app1å’Œapp2äº§ç”Ÿçš„æ—¥å¿—éƒ½æ˜¾ç¤ºäº†å‡ºæ¥ã€‚</p><p>å¤§ä½¬åœ¨è¯„è®ºåŒºå…³äºæ­¤çš„å›ç­”</p><blockquote><p><a href="https://xiaozhuanlan.com/u/kunminx" target="_blank" rel="noopener">KunMinX</a></p><p>#40</p><p><a href="https://xiaozhuanlan.com/topic/7812045693#reply2" target="_blank" rel="noopener">#2æ¥¼</a> <a href="https://xiaozhuanlan.com/u/2711412979" target="_blank" rel="noopener"><em>@</em>Sky63</a><br>å¤§æ¦‚æ˜ç™½ä½ æåˆ°çš„ã€é€ æˆå›°æ‰°çš„åœ°æ–¹äº†ã€‚<br>D å’Œ C æ˜¯ç”± app1 å¯åŠ¨ï¼Œåœ¨ IDE ä¸­å¯é€šè¿‡ app1 çš„è§†è§’è§‚å¯Ÿåˆ°ã€‚åŒç†ï¼Œå½“ app2 çš„ B å”¤èµ· D æ—¶ï¼Œä½ åœ¨å›é€€ D çš„æ—¶å€™èƒ½åœ¨ app2 å’Œ app1 çš„è§†è§’ä¸­åŒæ—¶è§‚å¯Ÿåˆ° D çš„é”€æ¯ã€‚è€Œç´§éšå…¶åå†å›é€€ä¸€æ¬¡ï¼Œ ä¾¿èƒ½åœ¨ app1 ä¸­è§‚å¯Ÿåˆ° C è¢«é”€æ¯ã€‚å†ä¸‹ä¸€æ¬¡æ‰è½®åˆ° app2 ä¸­ B è¢«é”€æ¯ã€‚</p></blockquote><p>ä½†æ˜¯æ ¹æ®æˆ‘æ“ä½œçœ‹åˆ°çš„ç°è±¡ï¼ŒDçš„é”€æ¯ä¸æ˜¯åœ¨ä¸åŒappè§†è§’è§‚å¯Ÿåˆ°çš„åŒä¸€æ¬¡é”€æ¯ã€‚é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹å‡ºä¸¤æ¬¡é”€æ¯æ˜¯æœ‰æ—¶é—´å·®çš„ï¼Œè€Œä¸”ç»è¿‡æˆ‘çš„äºŒæ¬¡ç¡®è®¤ï¼Œçš„ç¡®æ˜¯å…³é—­ä¸¤æ¬¡ç•Œé¢æ‰å‡ºç°äº†ä¸¤æ¬¡é”€æ¯Logã€‚</p><h4 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h4><p>é€šè¿‡ <code>adb shell</code> ä¸­çš„ <code>dumpsys activity activities</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹ activity æ ˆä¿¡æ¯ï¼Œæ•…æˆ‘æˆªå–äº†ç›¸å…³çš„è¾“å‡ºï¼Œä»¥ä¸‹å †æ ˆä¿¡æ¯å‡ç»è¿‡ç²¾ç®€ã€‚</p><h5 id="1-app1-ä¾æ¬¡æ‰“å¼€-SingleTaskOne-SingleTaskTwo"><a href="#1-app1-ä¾æ¬¡æ‰“å¼€-SingleTaskOne-SingleTaskTwo" class="headerlink" title="1. app1 ä¾æ¬¡æ‰“å¼€ SingleTaskOne SingleTaskTwo"></a>1. <code>app1</code> ä¾æ¬¡æ‰“å¼€ <code>SingleTaskOne</code> <code>SingleTaskTwo</code></h5><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log1.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log1"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs json">âœ  Relearn-Android (master) adb shell<br>sagit:/ $ dumpsys activity activities<br>ACTIVITY MANAGER ACTIVITIES (dumpsys activity activities)<br>Display #0 (activities from top to bottom):<br><br>  Stack #2: type=standard mode=fullscreen<br>    Task id #3<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;4920da #3 A=com.kunminx.task.c U=0 StackId=2 sz=2&#125;<br>        Run #1: ActivityRecord&#123;93c0c72 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>        Run #0: ActivityRecord&#123;999111 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t3&#125;<br><br>    mResumedActivity: ActivityRecord&#123;93c0c72 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>    mLastPausedActivity: ActivityRecord&#123;999111 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t3&#125;<br><br>  Stack #1: type=standard mode=fullscreen<br>    Task id #2<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;d91b3e8 #2 A=com.kunminx.relearn_android U=0 StackId=1 sz=2&#125;<br>        Run #1: ActivityRecord&#123;8b59240 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t2&#125;<br>        Run #0: ActivityRecord&#123;d76e9a5 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.TestMainActivity t2&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;8b59240 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t2&#125;<br><br>  Stack #0: type=home mode=fullscreen<br><br>    Task id #1<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;94a7a01 #1 I=com.miui.home/.launcher.Launcher U=0 StackId=0 sz=1&#125;<br>        Run #0: ActivityRecord&#123;7d6409 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;7d6409 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>  ResumedActivity:ActivityRecord&#123;<br>93c0c72u0com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>  <br>  mFocusedStack=ActivityStack&#123;<br>  3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks<br>  &#125; <br>  mLastFocusedStack=ActivityStack&#123;<br>  3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks<br>  &#125;<br>  mCurTaskIdForUser=&#123;0=3&#125;<br>  mUserStackInFront=&#123;&#125;<br>  displayId=0 stacks=3<br>   mHomeStack=ActivityStack&#123;<br>   76ebae7 stackId=0 type=home mode=fullscreen visible=false translucent=true, 1 tasks<br>   &#125;<br>  isHomeRecentsComponent=false  KeyguardController:<br>    mKeyguardShowing=false<br>    mAodShowing=false<br>    mKeyguardGoingAway=false<br>    mOccluded=false<br>    mDismissingKeyguardActivity=null<br>    mDismissalRequested=false<br>    mVisibilityTransactionDepth=0<br>  LockTaskController<br>    mLockTaskModeState=NONE<br>    mLockTaskModeTasks=<br>    mLockTaskPackages (userId:packages)=<br>      u0:[]<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶çœ‹åˆ°å †æ ˆé¡ºåºä¸ºï¼š<strong>Stack #2 -&lt; Stack #1 -&lt; Stack #0</strong> å…¶ä¸­ <code>Stack #0</code> ä¸º <code>launcher</code></p><p>è·å–ç„¦ç‚¹çš„ <code>ActivityStack</code>ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">mFocusedStack=ActivityStack&#123;<br>  3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125; <br>mLastFocusedStack=ActivityStack&#123;<br>  3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br></code></pre></td></tr></table></figure><h5 id="2-æŒ‰ä¸‹HOMEé”®ï¼Œæ‰“å¼€-app2-ä¾æ¬¡æ‰“å¼€-StandardOneActivity-StandardTwoActivity"><a href="#2-æŒ‰ä¸‹HOMEé”®ï¼Œæ‰“å¼€-app2-ä¾æ¬¡æ‰“å¼€-StandardOneActivity-StandardTwoActivity" class="headerlink" title="2. æŒ‰ä¸‹HOMEé”®ï¼Œæ‰“å¼€ app2 ä¾æ¬¡æ‰“å¼€ StandardOneActivity StandardTwoActivity"></a>2. æŒ‰ä¸‹HOMEé”®ï¼Œæ‰“å¼€ <code>app2</code> ä¾æ¬¡æ‰“å¼€ <code>StandardOneActivity</code> <code>StandardTwoActivity</code></h5><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log2.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log2"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs json">Display #0 (activities from top to bottom):<br><br>  Stack #3: type=standard mode=fullscreen<br>    Task id #4<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;718157f #4 A=com.kunminx.relearn_android_2 U=0 StackId=3 sz=4&#125;<br>        Run #3: ActivityRecord&#123;137a584 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t4&#125;<br>        Run #2: ActivityRecord&#123;648188e u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t4&#125;<br>        Run #1: ActivityRecord&#123;f39ebe9 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t4&#125;<br>        Run #0: ActivityRecord&#123;f02fff8 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.TestMainActivity t4&#125;<br><br>    mResumedActivity: ActivityRecord&#123;137a584 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t4&#125;<br>    mLastPausedActivity: ActivityRecord&#123;648188e u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t4&#125;<br><br>  Stack #0: type=home mode=fullscreen<br>    Task id #1<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;2094d95 #1 I=com.miui.home/.launcher.Launcher U=0 StackId=0 sz=1&#125;<br>        Run #0: ActivityRecord&#123;a7fed1a u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;a7fed1a u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>  Stack #2: type=standard mode=fullscreen<br>    Task id #3<br>    <br>    Running activities (most recent first):<br>      TaskRecord&#123;9d79eaa #3 A=com.kunminx.task.c U=0 StackId=2 sz=2&#125;<br>        Run #1: ActivityRecord&#123;15d3e09 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>        Run #0: ActivityRecord&#123;20d177c u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t3&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;15d3e09 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br><br>  Stack #1: type=standard mode=fullscreen<br>  isSleeping=false<br>  mBounds=Rect(0, 0 - 0, 0)<br><br>    Task id #2<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;e526e38 #2 A=com.kunminx.relearn_android U=0 StackId=1 sz=2&#125;<br>        Run #1: ActivityRecord&#123;19055b2 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t2&#125;<br>        Run #0: ActivityRecord&#123;5a647a6 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.TestMainActivity t2&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;19055b2 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t2&#125;<br><br>  ResumedActivity: ActivityRecord&#123;137a584 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t4&#125;<br><br>  mFocusedStack=ActivityStack&#123;<br>      dfe2e11 stackId=3 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125; <br>mLastFocusedStack=ActivityStack&#123;<br>    dfe2e11 stackId=3 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>  mCurTaskIdForUser=&#123;0=4&#125;<br>  mUserStackInFront=&#123;&#125;<br>  displayId=0 stacks=4<br>   mHomeStack=ActivityStack&#123;968fb76 stackId=0 type=home mode=fullscreen visible=false translucent=true, 1 tasks&#125;<br>  isHomeRecentsComponent=false  KeyguardController:<br>    mKeyguardShowing=false<br>    mAodShowing=false<br>    mKeyguardGoingAway=false<br>    mOccluded=false<br>    mDismissingKeyguardActivity=null<br>    mDismissalRequested=false<br>    mVisibilityTransactionDepth=0<br>  LockTaskController<br>    mLockTaskModeState=NONE<br>    mLockTaskModeTasks=<br>    mLockTaskPackages (userId:packages)=<br>      u0:[]<br></code></pre></td></tr></table></figure><p><strong>è¿™é‡Œçš„å †æ ˆé¡ºåºä¸º Stack #3 -&lt; Stack #0 -&lt; Stack #2 -&lt; Stack #1</strong></p><p><code>Stack #0</code> ä¸ºhome ï¼Œè¿™é‡Œååº”å‡ºç‚¹å‡»homeé”®ï¼Œæ‰“å¼€app2 çš„æ“ä½œã€‚æ­¤æ—¶ <code>Stack #3</code> ä¸­æœ‰ 4 ä¸ª <code>ActivityRecord</code></p><p>å½“å‰è·å–ç„¦ç‚¹çš„ <code>ActivityStack</code> </p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">  mFocusedStack=ActivityStack&#123;<br>      dfe2e11 stackId=3 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125; <br>mLastFocusedStack=ActivityStack&#123;<br>    dfe2e11 stackId=3 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>  mCurTaskIdForUser=&#123;0=4&#125;<br></code></pre></td></tr></table></figure><h5 id="3-æ¥ä¸‹æ¥å¯åŠ¨-SingleTaskTwoActivity"><a href="#3-æ¥ä¸‹æ¥å¯åŠ¨-SingleTaskTwoActivity" class="headerlink" title="3. æ¥ä¸‹æ¥å¯åŠ¨ SingleTaskTwoActivity"></a>3. æ¥ä¸‹æ¥å¯åŠ¨ <code>SingleTaskTwoActivity</code></h5><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log3.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log3"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs json">sagit:/ $ dumpsys activity activities<br>ACTIVITY MANAGER ACTIVITIES (dumpsys activity activities)<br>Display #0 (activities from top to bottom):<br><br>  Stack #2: type=standard mode=fullscreen<br>    Task id #3<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;4920da #3 A=com.kunminx.task.c U=0 StackId=2 sz=3&#125;<br>        Run #2: ActivityRecord&#123;55f799d u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>        Run #1: ActivityRecord&#123;93c0c72 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>        Run #0: ActivityRecord&#123;999111 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t3&#125;<br><br>    mResumedActivity: ActivityRecord&#123;55f799d u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br><br>  Stack #3: type=standard mode=fullscreen<br>    Task id #4<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;f14a51a #4 A=com.kunminx.relearn_android_2 U=0 StackId=3 sz=4&#125;<br>        Run #3: ActivityRecord&#123;1838862 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t4&#125;<br>        Run #2: ActivityRecord&#123;bdb3180 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t4&#125;<br>        Run #1: ActivityRecord&#123;7b21450 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t4&#125;<br>        Run #0: ActivityRecord&#123;ff57abb u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.TestMainActivity t4&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;1838862 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t4&#125;<br><br>  Stack #0: type=home mode=fullscreen<br>    Task id #1<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;94a7a01 #1 I=com.miui.home/.launcher.Launcher U=0 StackId=0 sz=1&#125;<br>        Run #0: ActivityRecord&#123;7d6409 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;7d6409 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>  Stack #1: type=standard mode=fullscreen<br><br>    Task id #2<br>        <br>    Running activities (most recent first):<br>      TaskRecord&#123;d91b3e8 #2 A=com.kunminx.relearn_android U=0 StackId=1 sz=2&#125;<br>        Run #1: ActivityRecord&#123;8b59240 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t2&#125;<br>        Run #0: ActivityRecord&#123;d76e9a5 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.TestMainActivity t2&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;8b59240 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t2&#125;<br><br>  ResumedActivity: ActivityRecord&#123;55f799d u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br><br>  mFocusedStack=ActivityStack&#123;<br>    3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125; <br>  mLastFocusedStack=ActivityStack&#123;<br>    3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>  mCurTaskIdForUser=&#123;0=4&#125;<br><br>  mUserStackInFront=&#123;&#125;<br>  displayId=0 stacks=4<br>   mHomeStack=ActivityStack&#123;<br>       76ebae7 stackId=0 type=home mode=fullscreen visible=false translucent=true, 1 tasks&#125;<br>  isHomeRecentsComponent=false  KeyguardController:<br>    mKeyguardShowing=false<br>    mAodShowing=false<br>    mKeyguardGoingAway=false<br>    mOccluded=false<br>    mDismissingKeyguardActivity=null<br>    mDismissalRequested=false<br>    mVisibilityTransactionDepth=0<br>  LockTaskController<br>    mLockTaskModeState=NONE<br>    mLockTaskModeTasks=<br>    mLockTaskPackages (userId:packages)=<br>      u0:[]<br></code></pre></td></tr></table></figure><p><strong>å½“å‰çš„å †æ ˆé¡ºåº Stack #2 -&lt; Stack #3 -&lt; Stack #0 -&lt;Stack #1</strong></p><p>å½“å‰è·å–ç„¦ç‚¹çš„ <code>ActivityStack</code> </p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">mFocusedStack=ActivityStack&#123;<br>  3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125; <br>mLastFocusedStack=ActivityStack&#123;<br>  3a870a6 stackId=2 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>mCurTaskIdForUser=&#123;0=4&#125;<br></code></pre></td></tr></table></figure><p><code>Stack #2</code> ä¸­ <code>TaskRecord</code>ä¿¡æ¯ä¸º</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">TaskRecord&#123;4920da #3 A=com.kunminx.task.c U=0 StackId=2 sz=3&#125;<br>  Run #2: ActivityRecord&#123;55f799d u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>  Run #1: ActivityRecord&#123;93c0c72 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t3&#125;<br>  Run #0: ActivityRecord&#123;999111 u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t3&#125;<br></code></pre></td></tr></table></figure><h4 id="è§£æƒ‘"><a href="#è§£æƒ‘" class="headerlink" title="è§£æƒ‘"></a>è§£æƒ‘</h4><p><strong>å…³é”®çš„åœ°æ–¹æ¥äº†</strong></p><p>çš„ç¡®æœ‰ä¸¤ä¸ª <code>SingleTaskTwoActivity</code> çš„ <code>ActivityRecord</code> ï¼Œæ ˆé¡¶çš„å±äº <code>app2</code> ç¬¬äºŒä¸ªå±äº <code>app1</code></p><p>ç”±æ­¤çœ‹å‡ºè¿™ä¸¤ä¸ª<code>ActivityRecord</code> ä¸æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œ <code>app2</code> å¯åŠ¨çš„ <code>SingleTaskTwoActivity</code> åº”è¯¥æ˜¯ <code>app2</code> è‡ªå·±çš„activity</p><p>åºŸè¯ä¸è¯´ï¼Œç¿»ä»£ç ï¼è¿™é‡Œæˆªå–äº† <code>BaseTaskActivity</code> ä¸­çš„éƒ¨åˆ†ä»£ç ï¼Œ<code>app1</code> å’Œ <code>app2</code>ä¸­çš„ <code>activity</code> éƒ½ç»§æ‰¿äº†<code>BaseTaskActivity</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span><span class="hljs-params">(View v)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> i = v.getId();<br>        <span class="hljs-keyword">if</span> (i == R.id.btn_standard_one) &#123;<br>            Intent intent = <span class="hljs-keyword">new</span> Intent(<span class="hljs-keyword">this</span>, StandardOneActivity.class);<br>            startActivityWithCheck(intent);<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == R.id.btn_standard_two) &#123;<br>            Intent intent = <span class="hljs-keyword">new</span> Intent(<span class="hljs-keyword">this</span>, StandardTwoActivity.class);<br>            startActivityWithCheck(intent);<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == R.id.btn_singletask_one) &#123;<br>            Intent intent = <span class="hljs-keyword">new</span> Intent(<span class="hljs-keyword">this</span>, SingleTaskOneActivity.class);<br>            startActivityWithCheck(intent);<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == R.id.btn_singletask_two) &#123;<br>            Intent intent = <span class="hljs-keyword">new</span> Intent(<span class="hljs-keyword">this</span>, SingleTaskTwoActivity.class);<br>            startActivityWithCheck(intent);<br><br>            <span class="hljs-comment">//ä»¥ä¸‹æµ‹è¯•ç»“æœè¯å®ï¼š</span><br>            <span class="hljs-comment">//1.åœ¨ App2 ä¸­å¯åŠ¨ App1 çš„ standard Activityï¼Œä»ç„¶éµå®ˆ standard çš„ç‰¹ç‚¹ï¼šåœ¨å¯åŠ¨å®ƒçš„ Activity æ‰€åœ¨çš„ä»»åŠ¡ä¸­å¯åŠ¨ï¼Œä¹Ÿå³è·Ÿéš App2ã€‚</span><br>            <span class="hljs-comment">//2.åœ¨ App2 ä¸­å¯åŠ¨ App1 çš„ singleTop Activityï¼Œè·ŸéšçŠ¶å†µåŒ standardã€‚</span><br>            <span class="hljs-comment">//3.åœ¨ App2 ä¸­å¯åŠ¨ App1 çš„ singleTask Activityï¼Œä»ç„¶å¤„äº App1 çš„ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸è·Ÿéš App2ã€‚</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == R.id.btn_singletask_a) &#123;<br>            Intent intent = <span class="hljs-keyword">new</span> Intent();<br>            ComponentName name = <span class="hljs-keyword">new</span> ComponentName(<br>                    <span class="hljs-string">"com.kunminx.relearn_android"</span>,<br>                    <span class="hljs-string">"com.kunminx.relearn_android.SingleTaskAActivity"</span>);<br>            intent.setComponent(name);<br>            startActivityWithCheck(intent);<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i == R.id.btn_singletask_b) &#123;<br>            Intent intent = <span class="hljs-keyword">new</span> Intent();<br>            ComponentName name = <span class="hljs-keyword">new</span> ComponentName(<br>                    <span class="hljs-string">"com.kunminx.relearn_android"</span>,<br>                    <span class="hljs-string">"com.kunminx.relearn_android.SingleTaskBActivity"</span>);<br>            intent.setComponent(name);<br>            startActivityWithCheck(intent);<br><br>        &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè¿™é‡Œ <code>app2</code> å¯åŠ¨<code>SingleTaskTwoActivity</code> çš„ç¡®æ˜¯è‡ªå·±çš„ <code>activity</code></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200616181623.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200616181658.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><strong>é‚£ä¹ˆå®ƒä¸ºä»€ä¹ˆå’Œ<code>app1</code> ä¸­çš„  <code>SingleTaskTwoActivity</code>  æ˜¯åŒä¸€ä¸ª <code>TaskRecord</code> å‘¢ï¼Ÿ</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span><br>    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".test03_task_test.SingleTaskOneActivity"</span><br>    <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">"singleTask"</span><br>    <span class="hljs-attr">android:taskAffinity</span>=<span class="hljs-string">"com.kunminx.task.c"</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span><br>    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".test03_task_test.SingleTaskTwoActivity"</span><br>    <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">"singleTask"</span><br>    <span class="hljs-attr">android:taskAffinity</span>=<span class="hljs-string">"com.kunminx.task.c"</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>å®ƒä»¬æœ‰ç€å…±åŒçš„ <code>taskAffinity</code>ã€‚è‡³æ­¤ï¼Œæˆ‘çš„ç–‘æƒ‘å·²ç»å¾—åˆ°äº†ç­”æ¡ˆã€‚</p><h4 id="æ‹“å±•"><a href="#æ‹“å±•" class="headerlink" title="æ‹“å±•"></a>æ‹“å±•</h4><p>æˆ‘è¯•äº†ä»¥ä¸‹ <code>app2</code> ä¸­å¯åŠ¨ <code>app1</code> ä¸­çš„Activityçš„æƒ…å†µ</p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200616181712.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="https://gitee.com/flywith24/Album/raw/master/img/20200616181808.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><code>app1</code> ä¾æ¬¡å¯åŠ¨ <code>StandardOneActivity</code> -&lt; <code>SingleTaskOneActivity</code>  -&lt; <code>SingleTaskTwoActivity</code>  -&lt; <code>SingleTaskAActivity</code></p><p>å…¶ä¸­ <code>SingleTaskOneActivity</code>  ä¸ <code>SingleTaskTwoActivity</code> è®¾ç½®äº†ç›¸åŒçš„ <code>taskAffinity</code> ,<code>StandardOneActivity</code> <code>ä¸ SingleTaskAActivity</code> æœªè®¾ç½® <code>taskAffinity</code></p><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log4.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log4"></p><p>æ¥ç€æŒ‰ HOME é”®ï¼Œæ‰“å¼€ <code>app2</code> ï¼Œä¾æ¬¡æ‰“å¼€ <code>StandardOneActivity</code> -&lt; <code>StandardOneActivity</code> -&lt; <code>StandardTwoActivity</code></p><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log5.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log5"></p><p>æ­¤æ—¶å †æ ˆä¿¡æ¯</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs json">âœ  Relearn-Android (master) adb shell<br>sagit:/ $ dumpsys activity activities<br>ACTIVITY MANAGER ACTIVITIES (dumpsys activity activities)<br>Display #0 (activities from top to bottom):<br><br>  Stack #3: type=standard mode=fullscreen<br>  isSleeping=false<br>  mBounds=Rect(0, 0 - 0, 0)<br>    Task id #48<br><br>    Running activities (most recent first):<br>      TaskRecord&#123;3b07175 #48 A=com.kunminx.relearn_android_2 U=0 StackId=3 sz=4&#125;<br>        Run #3: ActivityRecord&#123;9cdafc6 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t48&#125;<br>        Run #2: ActivityRecord&#123;83db884 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t48&#125;<br>        Run #1: ActivityRecord&#123;71254 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t48&#125;<br>        Run #0: ActivityRecord&#123;7c135cf u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.TestMainActivity t48&#125;<br><br>    mResumedActivity: ActivityRecord&#123;9cdafc6 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t48&#125;<br>    mLastPausedActivity: ActivityRecord&#123;83db884 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t48&#125;<br><br>  Stack #0: type=home mode=fullscreen<br>    Running activities (most recent first):<br>      TaskRecord&#123;185017b #1 I=com.miui.home/.launcher.Launcher U=0 StackId=0 sz=1&#125;<br>        Run #0: ActivityRecord&#123;9fd4f88 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;9fd4f88 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>  Stack #1: type=standard mode=fullscreen<br>    Task id #46<br>    Running activities (most recent first):<br>      TaskRecord&#123;c374b98 #46 A=com.kunminx.relearn_android U=0 StackId=1 sz=3&#125;<br>        Run #2: ActivityRecord&#123;5afc3da u0 com.kunminx.relearn_android/.SingleTaskAActivity t46&#125;<br>        Run #1: ActivityRecord&#123;bb0363c u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t46&#125;<br>        Run #0: ActivityRecord&#123;510711c u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.TestMainActivity t46&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;5afc3da u0 com.kunminx.relearn_android/.SingleTaskAActivity t46&#125;<br><br>  Stack #2: type=standard mode=fullscreen<br>    Task id #47<br>    Running activities (most recent first):<br>      TaskRecord&#123;3387d6 #47 A=com.kunminx.task.c U=0 StackId=2 sz=2&#125;<br>        Run #1: ActivityRecord&#123;6375a1b u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t47&#125;<br>        Run #0: ActivityRecord&#123;e9850ca u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t47&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;6375a1b u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t47&#125;<br><br>  ResumedActivity: ActivityRecord&#123;9cdafc6 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t48&#125;<br><br>  mFocusedStack=ActivityStack&#123;ed83a57 stackId=3 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>  mLastFocusedStack=ActivityStack&#123;ed83a57 stackId=3 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>  mCurTaskIdForUser=&#123;0=48&#125;<br><br>  mUserStackInFront=&#123;&#125;<br>  displayId=0 stacks=4<br>   mHomeStack=ActivityStack&#123;a218944 stackId=0 type=home mode=fullscreen visible=false translucent=true, 1 tasks&#125;<br>  isHomeRecentsComponent=false  KeyguardController:<br>    mKeyguardShowing=false<br>    mAodShowing=false<br>    mKeyguardGoingAway=false<br>    mOccluded=false<br>    mDismissingKeyguardActivity=null<br>    mDismissalRequested=false<br>    mVisibilityTransactionDepth=0<br>  LockTaskController<br>    mLockTaskModeState=NONE<br>    mLockTaskModeTasks=<br>    mLockTaskPackages (userId:packages)=<br>      u0:[]<br></code></pre></td></tr></table></figure><p>æœ€ååœ¨ <code>app2</code> ä¸­å¯åŠ¨  <code>app1</code> çš„ <code>SingleTaskAActivity</code> </p><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log6.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log6"></p><p>æ­¤æ—¶å †æ ˆä¿¡æ¯</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs json">âœ  Relearn-Android (master) adb shell<br>sagit:/ $ dumpsys activity activities<br>ACTIVITY MANAGER ACTIVITIES (dumpsys activity activities)<br>Display #0 (activities from top to bottom):<br><br>  Stack #1: type=standard mode=fullscreen<br>    Task id #46<br>    Running activities (most recent first):<br>      TaskRecord&#123;c374b98 #46 A=com.kunminx.relearn_android U=0 StackId=1 sz=3&#125;<br>        Run #2: ActivityRecord&#123;5afc3da u0 com.kunminx.relearn_android/.SingleTaskAActivity t46&#125;<br>        Run #1: ActivityRecord&#123;bb0363c u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t46&#125;<br>        Run #0: ActivityRecord&#123;510711c u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.TestMainActivity t46&#125;<br><br>    mResumedActivity: ActivityRecord&#123;5afc3da u0 com.kunminx.relearn_android/.SingleTaskAActivity t46&#125;<br><br>  Stack #3: type=standard mode=fullscreen<br>    Task id #48<br>    Running activities (most recent first):<br>      TaskRecord&#123;3b07175 #48 A=com.kunminx.relearn_android_2 U=0 StackId=3 sz=4&#125;<br>        Run #3: ActivityRecord&#123;9cdafc6 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t48&#125;<br>        Run #2: ActivityRecord&#123;83db884 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t48&#125;<br>        Run #1: ActivityRecord&#123;71254 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardOneActivity t48&#125;<br>        Run #0: ActivityRecord&#123;7c135cf u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.TestMainActivity t48&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;9cdafc6 u0 com.kunminx.relearn_android_2/com.kunminx.basicfacttesting.test03_task_test.StandardTwoActivity t48&#125;<br><br>  Stack #0: type=home mode=fullscreen<br>    Task id #1<br>    Running activities (most recent first):<br>      TaskRecord&#123;185017b #1 I=com.miui.home/.launcher.Launcher U=0 StackId=0 sz=1&#125;<br>        Run #0: ActivityRecord&#123;9fd4f88 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;9fd4f88 u0 com.miui.home/.launcher.Launcher t1&#125;<br><br>  Stack #2: type=standard mode=fullscreen<br>    Task id #47<br>    Running activities (most recent first):<br>      TaskRecord&#123;3387d6 #47 A=com.kunminx.task.c U=0 StackId=2 sz=2&#125;<br>        Run #1: ActivityRecord&#123;6375a1b u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t47&#125;<br>        Run #0: ActivityRecord&#123;e9850ca u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskOneActivity t47&#125;<br><br>    mLastPausedActivity: ActivityRecord&#123;6375a1b u0 com.kunminx.relearn_android/com.kunminx.basicfacttesting.test03_task_test.SingleTaskTwoActivity t47&#125;<br><br>  ResumedActivity: ActivityRecord&#123;5afc3da u0 com.kunminx.relearn_android/.SingleTaskAActivity t46&#125;<br><br>  mFocusedStack=ActivityStack&#123;50922c2 stackId=1 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br>  mLastFocusedStack=ActivityStack&#123;50922c2 stackId=1 type=standard mode=fullscreen visible=true translucent=false, 1 tasks&#125;<br><br>  mCurTaskIdForUser=&#123;0=48&#125;<br>  mUserStackInFront=&#123;&#125;<br>  displayId=0 stacks=4<br>   mHomeStack=ActivityStack&#123;a218944 stackId=0 type=home mode=fullscreen visible=false translucent=true, 1 tasks&#125;<br>  isHomeRecentsComponent=false  KeyguardController:<br>    mKeyguardShowing=false<br>    mAodShowing=false<br>    mKeyguardGoingAway=false<br>    mOccluded=false<br>    mDismissingKeyguardActivity=null<br>    mDismissalRequested=false<br>    mVisibilityTransactionDepth=0<br>  LockTaskController<br>    mLockTaskModeState=NONE<br>    mLockTaskModeTasks=<br>    mLockTaskPackages (userId:packages)=<br>      u0:[]<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ <code>app1</code> çš„ <code>taskid</code> 46 çš„<code>TaskRecord</code> è½¬ç§»åˆ°äº† æ ˆé¡¶</p><p>æ¥ä¸‹æ¥è¿”å›é”€æ¯çš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ã€‚</p><p><img class="lazyload" data-original="%E3%80%90%E9%87%8D%E5%AD%A6Android%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%E3%80%91Activity%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88%E4%B8%8E%E8%BF%94%E5%9B%9E%E6%A0%88/log7.png" src="/2019/11/29/relearn-task-back-stack/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="log7"></p><p>æœ€åé€€åˆ° <code>launcher</code> ç•Œé¢</p><p><strong><code>app1</code> çš„ <code>TaskRecord</code> è½¬ç§»åˆ°äº† <code>app2</code> çš„è¿”å›æ ˆä¸­</strong></p>]]></content>
      
      
      <categories>
          
          <category> app </category>
          
      </categories>
      
      
        <tags>
            
            <tag> app </tag>
            
            <tag> é‡å­¦Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€æµæ°´è´¦ã€‘Xposedæ¨¡å—å¼€å‘</title>
      <link href="/2019/08/30/Xposed/"/>
      <url>/2019/08/30/Xposed/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å†™åšå®¢æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œä½†æ˜¯å†™çš„äººæ°´å¹³å‚å·®ä¸é½ï¼Œæˆ‘è§è¿‡æœ€æç¬‘çš„å°±æ˜¯åšæ–‡çš„å†…å®¹æ˜¯å…¶ä»–åšå®¢çš„é“¾æ¥ã€‚æœ¬ç€ä¸è¯¯äººå­å¼Ÿçš„åŸåˆ™ï¼Œæˆ‘å†™åšå®¢ä¸€å‘å¾ˆå…‹åˆ¶ã€‚æµæ°´è´¦ç³»åˆ—æ˜¯æˆ‘å¹³æ—¶çš„ä¸€äº›è®°å½•ï¼Œæ˜¯ <code>how to</code> ç±»å‹çš„æ–‡ç« ï¼Œç½‘ä¸Šç›¸å…³çš„èµ„æ–™ä¸€æœä¸€å¤§æŠŠï¼Œä»…ä¾›è‡ªå·±è®°å½•æŸ¥æ‰¾ã€‚</p><p>æœ¬ç¯‡åšå®¢æ˜¯è®°å½•ä¸€äº›å­¦ä¹  <code>Xposed</code>æ¨¡å—å¼€å‘æ—¶çŸ¥è¯†çš„æ•´ç†ã€‚</p></blockquote><a id="more"></a><h3 id="å¼€å‘å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#å¼€å‘å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="å¼€å‘å‰çš„å‡†å¤‡å·¥ä½œ"></a>å¼€å‘å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>æŸ¥çœ‹ <a href="https://github.com/rovo89/XposedBridge/wiki/Using-the-Xposed-Framework-API" target="_blank" rel="noopener">Xposed-Framework-API</a> æ ¹æ®æ–‡æ¡£è¿›è¡Œé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">repositories &#123;<br>    jcenter();<br>&#125;<br><br>dependencies &#123;<br>    compileOnly <span class="hljs-string">'de.robv.android.xposed:api:82'</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>AndroidManifest.xml</code> ä¸­ <code>application</code> æ ‡ç­¾ä¸‹åŠ å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!-- åº”ç”¨ä¸ºæ¨¡å— --&gt;<br>&lt;meta-data<br>    android:name=<span class="hljs-string">"xposedmodule"</span><br>    android:value=<span class="hljs-string">"true"</span> /&gt;<br>&lt;!-- ç‰ˆæœ¬ä¿¡æ¯ è¯¥ç‰ˆæœ¬å·ä¸å¼•ç”¨çš„ä¾èµ–ç‰ˆæœ¬ç›¸åŒ--&gt;<br>&lt;meta-data<br>    android:name=<span class="hljs-string">"xposedminversion"</span><br>    android:value=<span class="hljs-string">"82"</span> /&gt;<br>&lt;!-- æ¨¡å—æè¿° --&gt;<br>&lt;meta-data<br>    android:name=<span class="hljs-string">"xposeddescription"</span><br>    android:value=<span class="hljs-string">"Xposed Test"</span> /&gt;<br></code></pre></td></tr></table></figure><p>åˆ›å»º <code>Hook</code> ç±»ï¼Œè¯¥ç±»æ˜¯ <code>Xposed</code> çš„å…¥å£ç±»ï¼Œç”¨äºæ‹¦æˆªåŠ è½½çš„ <code>package</code> ï¼Œå®ç° <code>IXposedHookLoadPackage</code> æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yyz.xposedtest;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IXposedHookLoadPackage</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleLoadPackage</span><span class="hljs-params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> hooké€»è¾‘  </span><br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>src/main</code> ç›®å½•ä¸‹åˆ›å»ºassetsç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸­åˆ›å»º <code>xposed_ini</code> tæ–‡ä»¶ï¼Œå†™å…¥ä¸Šé¢åˆ›å»ºçš„ <code>Xposed</code> çš„å…¥å£ç±»ï¼Œå¦‚ä¸‹ï¼š</p><p><img class="lazyload" data-original="%E3%80%90%E6%B5%81%E6%B0%B4%E8%B4%A6%E3%80%91Xposed%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/%E5%85%A5%E5%8F%A3.png" src="/2019/08/30/Xposed/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Xposedæ¨¡å—å…¥å£"></p><h3 id="XposedHelpers-å¸¸ç”¨æ–¹æ³•"><a href="#XposedHelpers-å¸¸ç”¨æ–¹æ³•" class="headerlink" title="XposedHelpers å¸¸ç”¨æ–¹æ³•"></a>XposedHelpers å¸¸ç”¨æ–¹æ³•</h3><h3 id="findAndHookMethod"><a href="#findAndHookMethod" class="headerlink" title="findAndHookMethod"></a>findAndHookMethod</h3><blockquote><p>Look up a method and hook it. The last argument must be the callback for the hook.</p></blockquote><p>æœ€åä¸€ä¸ªå‚æ•°ä¸»è¦æœ‰ä¸¤ç§</p><p><code>XC_MethodHook</code> åœ¨åŸæœ‰æ–¹æ³•é€»è¾‘ä¸Šæ·»åŠ é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åœ¨åŸæœ‰æ–¹æ³•é€»è¾‘ä¸Šæ·»åŠ é€»è¾‘</span><br><span class="hljs-comment">/**<br> * 1. åŒ…å 2. classLoader 3. æ–¹æ³•å 4. å‚æ•°ç±»å‹ï¼ˆæ²¡æœ‰åˆ™ä¸æ·»åŠ ï¼‰ 5.Callback<br> */</span><br>XposedHelpers.findAndHookMethod(<span class="hljs-string">"cn.bcbook.kaixuetest.MainActivity"</span>,<br>        lpparam.classLoader, <span class="hljs-string">"printViewId"</span>, View.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                <span class="hljs-keyword">super</span>.beforeHookedMethod(param);<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                <span class="hljs-keyword">super</span>.afterHookedMethod(param);<br>                Log.i(<span class="hljs-string">"yyz"</span>, <span class="hljs-string">"afterHookedMethod hook success!"</span>);<br>            &#125;<br>        &#125;);<br></code></pre></td></tr></table></figure><p><code>XC_MethodReplacement</code> æ›¿æ¢åŸæœ‰æ–¹æ³•é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æ›¿æ¢åŸæœ‰æ–¹æ³•</span><br>XposedHelpers.findAndHookMethod(<span class="hljs-string">"cn.bcbook.kaixuetest.MainActivity"</span>,<br>        lpparam.classLoader, <span class="hljs-string">"printViewId"</span>, View.class, <span class="hljs-keyword">new</span> XC_MethodReplacement() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">replaceHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                Log.i(<span class="hljs-string">"yyz"</span>, <span class="hljs-string">"hook success!"</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;);<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Xposed </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æµæ°´è´¦ </tag>
            
            <tag> Hook </tag>
            
            <tag> Xposed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€æµæ°´è´¦ã€‘iptables å¸¸ç”¨æŒ‡ä»¤</title>
      <link href="/2019/08/29/iptabels/"/>
      <url>/2019/08/29/iptabels/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å†™åšå®¢æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œä½†æ˜¯å†™çš„äººæ°´å¹³å‚å·®ä¸é½ï¼Œæˆ‘è§è¿‡æœ€æç¬‘çš„å°±æ˜¯åšæ–‡çš„å†…å®¹æ˜¯å…¶ä»–åšå®¢çš„é“¾æ¥ã€‚æœ¬ç€ä¸è¯¯äººå­å¼Ÿçš„åŸåˆ™ï¼Œæˆ‘å†™åšå®¢ä¸€å‘å¾ˆå…‹åˆ¶ã€‚æµæ°´è´¦ç³»åˆ—æ˜¯æˆ‘å¹³æ—¶çš„ä¸€äº›è®°å½•ï¼Œæ˜¯ <code>how to</code> ç±»å‹çš„æ–‡ç« ï¼Œç½‘ä¸Šç›¸å…³çš„èµ„æ–™ä¸€æœä¸€å¤§æŠŠï¼Œä»…ä¾›è‡ªå·±è®°å½•æŸ¥æ‰¾ã€‚</p><p>è¯¥æ–‡æ€»ç»“äº† <code>iptables</code> å¸¸ç”¨çš„æŒ‡ä»¤ã€‚<code>iptables</code> è¯¦ç»†å†…å®¹è¯·çœ‹åŒå°å¤§ä½¬ <a href="http://www.zsythink.net/archives/tag/iptables/page/2/" target="_blank" rel="noopener">iptables è¯¦è§£ç³»åˆ—</a></p></blockquote><a id="more"></a><h2 id="è§„åˆ™æŸ¥è¯¢"><a href="#è§„åˆ™æŸ¥è¯¢" class="headerlink" title="è§„åˆ™æŸ¥è¯¢"></a>è§„åˆ™æŸ¥è¯¢</h2><h3 id="æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„è§„åˆ™"><a href="#æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„è§„åˆ™" class="headerlink" title="æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„è§„åˆ™"></a>æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„è§„åˆ™</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -t filter -L<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>-t</code> é€‰é¡¹ï¼ŒæŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œä½¿ç”¨ <code>-L</code> é€‰é¡¹ï¼ŒæŸ¥çœ‹-té€‰é¡¹å¯¹åº”çš„è¡¨çš„è§„åˆ™ï¼Œ <code>-L</code> é€‰é¡¹çš„æ„æ€æ˜¯ï¼Œåˆ—å‡ºè§„åˆ™ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°å‘½ä»¤çš„å«ä¹‰ä¸ºåˆ—å‡ºfilterè¡¨çš„æ‰€æœ‰è§„åˆ™ã€‚</p><p><code>filter</code> å¯æ›¿æ¢ä¸º <code>raw</code> <code>mangle</code> <code>nat</code></p><p>å¦‚æœä»…æŸ¥çœ‹ <code>filter</code> å¯ä»¥çœç•¥ <code>-t filter</code> ï¼Œå½“æ²¡æœ‰ä½¿ç”¨ <code>-t</code> é€‰é¡¹æŒ‡å®šè¡¨æ—¶ï¼Œé»˜è®¤ä¸ºæ“ä½œ <code>filter</code> è¡¨ï¼Œå³ <code>iptables -L</code> è¡¨ç¤ºåˆ—å‡º <code>filter</code> è¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™ã€‚</p><h3 id="æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„æŒ‡å®šé“¾çš„è§„åˆ™"><a href="#æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„æŒ‡å®šé“¾çš„è§„åˆ™" class="headerlink" title="æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„æŒ‡å®šé“¾çš„è§„åˆ™"></a>æŸ¥çœ‹æŒ‡å®šè¡¨ä¸­çš„æŒ‡å®šé“¾çš„è§„åˆ™</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -L INPUT<br></code></pre></td></tr></table></figure><p>åªæŸ¥çœ‹ <code>filter</code> è¡¨ä¸­ <code>INPUT</code> é“¾çš„è§„åˆ™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -vL INPUT<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>-v</code> æŸ¥çœ‹æ›´å¤šï¼Œæ›´è¯¦ç»†çš„ä¿¡æ¯</p><h3 id="ä¸è®©ipè¿›è¡Œåè§£"><a href="#ä¸è®©ipè¿›è¡Œåè§£" class="headerlink" title="ä¸è®©ipè¿›è¡Œåè§£"></a>ä¸è®©ipè¿›è¡Œåè§£</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -nvL<br></code></pre></td></tr></table></figure><p><code>iptables</code> é»˜è®¤è¿›è¡Œäº†åç§°è§£æï¼Œä½†æ˜¯åœ¨è§„åˆ™éå¸¸å¤šçš„æƒ…å†µä¸‹å¦‚æœè¿›è¡Œåç§°è§£æï¼Œæ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚ä½¿ç”¨ <code>-n</code> é€‰é¡¹ï¼Œè¡¨ç¤ºä¸å¯¹ <code>ip</code> åœ°å€è¿›è¡Œåç§°åè§£ï¼Œç›´æ¥æ˜¾ç¤º <code>ip</code> åœ°å€</p><p>åªæŸ¥çœ‹æŸä¸ªé“¾çš„è§„åˆ™ï¼Œå¹¶ä¸”ä¸è®© <code>ip</code> è¿›è¡Œåè§£ï¼Œ<code>iptables -nvL INPUT</code></p><h3 id="æ˜¾ç¤ºè§„åˆ™ç¼–å·"><a href="#æ˜¾ç¤ºè§„åˆ™ç¼–å·" class="headerlink" title="æ˜¾ç¤ºè§„åˆ™ç¼–å·"></a>æ˜¾ç¤ºè§„åˆ™ç¼–å·</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables --line-number -nvL INPUT<br>æˆ–<br>iptables --line -nvL INPUT<br></code></pre></td></tr></table></figure><h2 id="è§„åˆ™ç®¡ç†"><a href="#è§„åˆ™ç®¡ç†" class="headerlink" title="è§„åˆ™ç®¡ç†"></a>è§„åˆ™ç®¡ç†</h2><h3 id="æ·»åŠ è§„åˆ™"><a href="#æ·»åŠ è§„åˆ™" class="headerlink" title="æ·»åŠ è§„åˆ™"></a>æ·»åŠ è§„åˆ™</h3><p><font color="#ff0000">æ³¨æ„ï¼šæ·»åŠ è§„åˆ™æ—¶ï¼Œè§„åˆ™çš„é¡ºåºéå¸¸é‡è¦</font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> åœ¨æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„å°¾éƒ¨æ·»åŠ ä¸€æ¡è§„åˆ™ï¼Œ-Aé€‰é¡¹è¡¨ç¤ºåœ¨å¯¹åº”é“¾çš„æœ«å°¾æ·»åŠ è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -A é“¾å åŒ¹é…æ¡ä»¶ -j åŠ¨ä½œ<br>ç¤ºä¾‹ï¼šiptables -t filter -A OUTPUT -s 192.168.10.225 -j DROP<br><span class="hljs-meta"><br>#</span> åœ¨æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„é¦–éƒ¨æ·»åŠ ä¸€æ¡è§„åˆ™ï¼Œ-Ié€‰å‹è¡¨ç¤ºåœ¨å¯¹åº”é“¾çš„å¼€å¤´æ·»åŠ è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -I é“¾å åŒ¹é…æ¡ä»¶ -j åŠ¨ä½œ<br>ç¤ºä¾‹ï¼š iptables -t filter -I OUTPUT -s 192.168.10.225 -j ACCEPT<br><span class="hljs-meta"><br>#</span> åœ¨æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„æŒ‡å®šä½ç½®æ·»åŠ ä¸€æ¡è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -I é“¾å è§„åˆ™åºå· åŒ¹é…æ¡ä»¶ -j åŠ¨ä½œ<br>ç¤ºä¾‹ï¼š iptables -t filter -I OUTPUT 3 -s 192.168.10.225 -j REJECT<br><span class="hljs-meta"><br>#</span> è®¾ç½®æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ï¼ˆé»˜è®¤åŠ¨ä½œï¼‰ï¼Œå¹¶éæ·»åŠ è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -P é“¾å åŠ¨ä½œ<br>ç¤ºä¾‹ï¼šiptables -t filter -P FORWARD ACCEPT<br></code></pre></td></tr></table></figure><h3 id="åˆ é™¤è§„åˆ™"><a href="#åˆ é™¤è§„åˆ™" class="headerlink" title="åˆ é™¤è§„åˆ™"></a>åˆ é™¤è§„åˆ™</h3><p><font color="ff0000">æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰ä¿å­˜è§„åˆ™ï¼Œåˆ é™¤è§„åˆ™æ—¶è¯·æ…é‡</font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> æŒ‰ç…§è§„åˆ™åºå·åˆ é™¤è§„åˆ™ï¼Œåˆ é™¤æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„æŒ‡å®šè§„åˆ™ï¼Œ-Dé€‰é¡¹è¡¨ç¤ºåˆ é™¤å¯¹åº”é“¾ä¸­çš„è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -D é“¾å è§„åˆ™åºå·<br>ç¤ºä¾‹ï¼šiptables -t filter -D INPUT 3<br><span class="hljs-meta"><br>#</span> æŒ‰ç…§å…·ä½“çš„åŒ¹é…æ¡ä»¶ä¸åŠ¨ä½œåˆ é™¤è§„åˆ™ï¼Œåˆ é™¤æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„æŒ‡å®šè§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -D é“¾å åŒ¹é…æ¡ä»¶ -j åŠ¨ä½œ<br>ç¤ºä¾‹ï¼šiptables -t filter -D INPUT -s 192.168.10.225 -j DROP<br><span class="hljs-meta"><br>#</span> åˆ é™¤æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œ-Fé€‰é¡¹è¡¨ç¤ºæ¸…ç©ºå¯¹åº”é“¾ä¸­çš„è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -F é“¾å<br>ç¤ºä¾‹ï¼šiptables -t filter -F INPUT<br><span class="hljs-meta"><br>#</span> åˆ é™¤æŒ‡å®šè¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -F<br>ç¤ºä¾‹ï¼šiptables -t filter -F OUTPUT<br></code></pre></td></tr></table></figure><h3 id="ä¿®æ”¹è§„åˆ™"><a href="#ä¿®æ”¹è§„åˆ™" class="headerlink" title="ä¿®æ”¹è§„åˆ™"></a>ä¿®æ”¹è§„åˆ™</h3><p><font color="ff0000">æ³¨æ„ï¼šå¦‚æœä½¿ç”¨-Ré€‰é¡¹ä¿®æ”¹è§„åˆ™ä¸­çš„åŠ¨ä½œï¼Œé‚£ä¹ˆå¿…é¡»æŒ‡æ˜åŸè§„åˆ™ä¸­çš„åŸåŒ¹é…æ¡ä»¶ï¼Œä¾‹å¦‚æºipï¼Œç›®æ ‡ipç­‰</font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> ä¿®æ”¹æŒ‡å®šè¡¨ä¸­æŒ‡å®šé“¾çš„æŒ‡å®šè§„åˆ™ï¼Œ-Ré€‰é¡¹è¡¨ç¤ºä¿®æ”¹å¯¹åº”é“¾ä¸­çš„è§„åˆ™ï¼Œä½¿ç”¨-Ré€‰é¡¹æ—¶è¦åŒæ—¶æŒ‡å®šå¯¹åº”çš„é“¾ä»¥åŠè§„åˆ™å¯¹åº”çš„åºå·ï¼Œå¹¶ä¸”è§„åˆ™ä¸­åŸæœ¬çš„åŒ¹é…æ¡ä»¶ä¸å¯çœç•¥<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -R é“¾å è§„åˆ™åºå· è§„åˆ™åŸæœ¬çš„åŒ¹é…æ¡ä»¶ -j åŠ¨ä½œ<br>ç¤ºä¾‹ï¼šiptables -t filter -R INPUT 3 -s 192.168.10.225 -j ACCEPT<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹è¡¨ç¤ºä¿®æ”¹ <code>filter</code> è¡¨ä¸­ <code>INPUT</code> é“¾çš„ç¬¬3æ¡è§„åˆ™ï¼Œå°†è¿™æ¡è§„åˆ™çš„åŠ¨ä½œä¿®æ”¹ä¸º <code>ACCEPT</code> ï¼Œ <code>-s</code>  <code>192.168.10.225</code> ä¸ºè¿™æ¡è§„åˆ™ä¸­åŸæœ¬çš„åŒ¹é…æ¡ä»¶ï¼Œå¦‚æœçœç•¥æ­¤åŒ¹é…æ¡ä»¶ï¼Œä¿®æ”¹åçš„è§„åˆ™ä¸­çš„æºåœ°å€å¯èƒ½ä¼šå˜ä¸º <code>0.0.0.0/0</code></p><p>å…¶ä»–ä¿®æ”¹è§„åˆ™çš„æ–¹æ³•ï¼šå…ˆé€šè¿‡ç¼–å·åˆ é™¤è§„åˆ™ï¼Œå†åœ¨åŸç¼–å·ä½ç½®æ·»åŠ ä¸€æ¡è§„åˆ™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> ä¿®æ”¹æŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ï¼ˆé»˜è®¤åŠ¨ä½œï¼‰ï¼Œå¹¶éä¿®æ”¹è§„åˆ™<br>å‘½ä»¤è¯­æ³•ï¼šiptables -t è¡¨å -P é“¾å åŠ¨ä½œ<br>ç¤ºä¾‹ï¼šiptables -t filter -P FORWARD ACCEPT<br></code></pre></td></tr></table></figure><h3 id="ä¿å­˜è§„åˆ™"><a href="#ä¿å­˜è§„åˆ™" class="headerlink" title="ä¿å­˜è§„åˆ™"></a>ä¿å­˜è§„åˆ™</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> ä¿å­˜è§„åˆ™å‘½ä»¤ï¼Œè¡¨ç¤ºå°†iptablesè§„åˆ™ä¿å­˜è‡³/etc/sysconfig/iptablesæ–‡ä»¶ä¸­<br>service iptables save<br></code></pre></td></tr></table></figure><h2 id="åŒ¹é…æ¡ä»¶"><a href="#åŒ¹é…æ¡ä»¶" class="headerlink" title="åŒ¹é…æ¡ä»¶"></a>åŒ¹é…æ¡ä»¶</h2><h3 id="åŸºæœ¬åŒ¹é…æ¡ä»¶"><a href="#åŸºæœ¬åŒ¹é…æ¡ä»¶" class="headerlink" title="åŸºæœ¬åŒ¹é…æ¡ä»¶"></a>åŸºæœ¬åŒ¹é…æ¡ä»¶</h3><p><code>-s</code> ç”¨äºåŒ¹é…æŠ¥æ–‡çš„æºåœ°å€,å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªæºåœ°å€ï¼Œæ¯ä¸ª <code>ip</code> ä¹‹é—´ç”¨é€—å·éš”å¼€ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªç½‘æ®µ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.111,192.168.10.225Â -jÂ DROP<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.0/24Â -jÂ ACCEPT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ !Â -sÂ 192.168.10.0/24Â -jÂ ACCEPT<br></code></pre></td></tr></table></figure><p><code>-d</code> ç”¨äºåŒ¹é…æŠ¥æ–‡çš„ç›®æ ‡åœ°å€,å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªç›®æ ‡åœ°å€ï¼Œæ¯ä¸ª <code>ip</code> ä¹‹é—´ç”¨é€—å·éš”å¼€ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªç½‘æ®µ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.10.111,192.168.10.225Â -jÂ DROP<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -dÂ 192.168.10.0/24Â -jÂ ACCEPT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ !Â -dÂ 192.168.10.0/24Â -jÂ ACCEPT<br></code></pre></td></tr></table></figure><p><code>-p</code> ç”¨äºåŒ¹é…æŠ¥æ–‡çš„åè®®ç±»å‹,å¯ä»¥åŒ¹é…çš„åè®®ç±»å‹ <code>tcp</code> ã€<code>udp</code> ã€<code>udplite</code> ã€<code>icmp</code> ã€<code>esp</code> ã€<code>ah</code> ã€<code>sctp</code> ç­‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -t filter -I INPUT -p tcp -s 192.168.10.146 -j ACCEPT<br>iptables -t filter -I INPUT ! -p udp -s 192.168.10.146 -j ACCEPT<br></code></pre></td></tr></table></figure><h3 id="æ‰©å±•åŒ¹é…æ¡ä»¶"><a href="#æ‰©å±•åŒ¹é…æ¡ä»¶" class="headerlink" title="æ‰©å±•åŒ¹é…æ¡ä»¶"></a>æ‰©å±•åŒ¹é…æ¡ä»¶</h3><ol><li><p><code>tcp</code> æ‰©å±•æ¨¡å—</p><p><code>-p tcp -m tcp --sport</code> ç”¨äºåŒ¹é… <code>tcp</code> åè®®æŠ¥æ–‡çš„æºç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨å†’å·æŒ‡å®šä¸€ä¸ªè¿ç»­çš„ç«¯å£èŒƒå›´<br><code>-p tcp -m tcp --dport</code> ç”¨äºåŒ¹é… <code>tcp</code> åè®®æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨å†’å·æŒ‡å®šä¸€ä¸ªè¿ç»­çš„ç«¯å£èŒƒå›´</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.10.225Â -pÂ tcpÂ -mÂ tcpÂ --sportÂ 22Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ tcpÂ --dportÂ 22:25Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ tcpÂ --dportÂ :22Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ tcpÂ --dportÂ 80:Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.10.225Â -pÂ tcpÂ -mÂ tcpÂ !Â --sportÂ 22Â -jÂ ACCEPT<br></code></pre></td></tr></table></figure></li><li><p><code>multiport</code> æ‰©å±•æ¨¡å—</p><p><code>-p tcp -m multiport --sports</code> ç”¨äºåŒ¹é…æŠ¥æ–‡çš„æºç«¯å£ï¼Œå¯ä»¥æŒ‡å®šç¦»æ•£çš„å¤šä¸ªç«¯å£å·,ç«¯å£ä¹‹é—´ç”¨â€é€—å·â€éš”å¼€<br><code>-p udp -m multiport --dports</code> ç”¨äºåŒ¹é…æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£ï¼Œå¯ä»¥æŒ‡å®šç¦»æ•£çš„å¤šä¸ªç«¯å£å·ï¼Œç«¯å£ä¹‹é—´ç”¨â€é€—å·â€éš”å¼€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -dÂ 192.168.10.225Â -pÂ udpÂ -mÂ multiportÂ --sportsÂ 137,138Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ multiportÂ --dportsÂ 22,80Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ multiportÂ !Â --dportsÂ 22,80Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ multiportÂ --dportsÂ 80:88Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -sÂ 192.168.10.225Â -pÂ tcpÂ -mÂ multiportÂ --dportsÂ 22,80:88Â -jÂ REJECT<br></code></pre></td></tr></table></figure></li></ol><ol start="3"><li><p><code>udp</code> æ¨¡å—</p><p><code>--sport</code> åŒ¹é… <code>udp</code> æŠ¥æ–‡çš„æºåœ°å€<br><code>--dport</code> åŒ¹é… <code>udp</code> æŠ¥æ–‡çš„ç›®æ ‡åœ°å€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> å¯ä»¥ç»“åˆmultiportæ¨¡å—æŒ‡å®šå¤šä¸ªç¦»æ•£çš„ç«¯å£<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ udpÂ -mÂ udpÂ --dportÂ 137Â -jÂ ACCEPT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ udpÂ -mÂ udpÂ --dportÂ 137:157Â -jÂ ACCEPT<br></code></pre></td></tr></table></figure></li></ol><ol start="4"><li><p><code>icmp</code> æ¨¡å—</p><p><code>--icmp-type</code> åŒ¹é… <code>icmp</code> æŠ¥æ–‡çš„å…·ä½“ç±»å‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ -mÂ icmpÂ --icmp-typeÂ 8/0Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ --icmp-typeÂ 8Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ icmpÂ -mÂ icmpÂ --icmp-typeÂ 0/0Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -pÂ icmpÂ --icmp-typeÂ 0Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ --icmp-typeÂ "echo-request"Â -jÂ REJECT<br></code></pre></td></tr></table></figure></li></ol><ol start="5"><li><p><code>iprange</code> æ¨¡å—</p><p><code>--src-range</code> æŒ‡å®šè¿ç»­çš„æºåœ°å€èŒƒå›´<br><code>--dst-range</code> æŒ‡å®šè¿ç»­çš„ç›®æ ‡åœ°å€èŒƒå›´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -mÂ iprangeÂ --src-rangeÂ 192.168.10.127-192.168.10.146Â -jÂ DROP<br>iptablesÂ -tÂ filterÂ -IÂ OUTPUTÂ -mÂ iprangeÂ --dst-rangeÂ 192.168.10.127-192.168.10.146Â -jÂ DROP<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -mÂ iprangeÂ !Â --src-rangeÂ 192.168.10.127-192.168.10.146Â -jÂ DROP<br></code></pre></td></tr></table></figure></li><li><p><code>stirng</code> æ¨¡å—</p><p><code>--algo</code> æŒ‡å®šå¯¹åº”çš„åŒ¹é…ç®—æ³•ï¼Œå¯ç”¨ç®—æ³•ä¸º <code>bm</code> ã€<code>kmp</code>ï¼Œæ­¤é€‰é¡¹ä¸ºå¿…éœ€é€‰é¡¹ã€‚<br><code>--string</code> æŒ‡å®šéœ€è¦åŒ¹é…çš„å­—ç¬¦ä¸²</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ --sportÂ 80Â -mÂ stringÂ --algoÂ bmÂ --stringÂ "baidu"Â -jÂ REJECT<br>iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ tcpÂ --sportÂ 80Â -mÂ stringÂ --algoÂ bmÂ --stringÂ "baidu"Â -jÂ REJECT<br></code></pre></td></tr></table></figure></li></ol><ol start="7"><li><p><code>time</code> æ¨¡å— </p><p><code>--timestart</code> ç”¨äºæŒ‡å®šæ—¶é—´èŒƒå›´çš„å¼€å§‹æ—¶é—´ï¼Œä¸å¯å–å<br><code>--timestop</code> ç”¨äºæŒ‡å®šæ—¶é—´èŒƒå›´çš„ç»“æŸæ—¶é—´ï¼Œä¸å¯å–å<br><code>--weekdays</code> ç”¨äºæŒ‡å®šâ€æ˜ŸæœŸå‡ â€ï¼Œå¯å–å<br><code>--monthdays</code> ç”¨äºæŒ‡å®šâ€å‡ å·â€ï¼Œå¯å–å<br><code>--datestart</code> ç”¨äºæŒ‡å®šæ—¥æœŸèŒƒå›´çš„å¼€å§‹æ—¥æœŸï¼Œä¸å¯å–å<br><code>--datestop</code> ç”¨äºæŒ‡å®šæ—¥æœŸèŒƒå›´çš„ç»“æŸæ—¶é—´ï¼Œä¸å¯å–å</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -t filter -I OUTPUT -p tcp --dport 80 -m time --timestart 09:00:00 --timestop 19:00:00 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 443 -m time --timestart 09:00:00 --timestop 19:00:00 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 80  -m time --weekdays 6,7 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 80  -m time --monthdays 22,23 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 80  -m time ! --monthdays 22,23 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 80  -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays 6,7 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 80  -m time --weekdays 5 --monthdays 22,23,24,25,26,27,28 -j REJECT<br>iptables -t filter -I OUTPUT -p tcp --dport 80  -m time --datestart 2017-12-24 --datestop 2017-12-27 -j REJECT<br></code></pre></td></tr></table></figure></li></ol><ol start="8"><li><p><code>connlimit</code> æ¨¡å—</p><p><code>--connlimit-above</code> å•ç‹¬ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œè¡¨ç¤ºé™åˆ¶æ¯ä¸ª <code>ip</code> çš„é“¾æ¥æ•°é‡ã€‚<br><code>--connlimit-mask</code>  æ­¤é€‰é¡¹ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨ <code>--connlimit-above</code> é€‰é¡¹æ—¶ï¼Œé…åˆæ­¤é€‰é¡¹ï¼Œåˆ™å¯ä»¥é’ˆå¯¹â€æŸç±» <code>ip</code> æ®µå†…çš„ä¸€å®šæ•°é‡çš„ <code>ip</code> â€œè¿›è¡Œè¿æ¥æ•°é‡çš„é™åˆ¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -IÂ INPUTÂ -pÂ tcpÂ --dportÂ 22Â -mÂ connlimitÂ --connlimit-aboveÂ 2Â -jÂ REJECT<br>iptablesÂ -IÂ INPUTÂ -pÂ tcpÂ --dportÂ 22Â -mÂ connlimitÂ --connlimit-aboveÂ 20Â --connlimit-maskÂ 24Â -jÂ REJECT<br>iptablesÂ -IÂ INPUTÂ -pÂ tcpÂ --dportÂ 22Â -mÂ connlimitÂ --connlimit-aboveÂ 10Â --connlimit-maskÂ 27Â -jÂ REJECT<br></code></pre></td></tr></table></figure></li></ol><ol start="9"><li><p><code>limit</code> æ¨¡å—</p><p><code>--limit-burst</code> æ­¤é€‰é¡¹ç”¨äºæŒ‡å®šä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œçš„æœ€å¤§æ•°é‡<br><code>--limit</code> æ­¤é€‰é¡¹ç”¨äºæŒ‡å®šä»¤ç‰Œæ¡¶ä¸­ç”Ÿæˆæ–°ä»¤ç‰Œçš„é¢‘ç‡ï¼Œå¯ç”¨æ—¶é—´å•ä½æœ‰secondã€minute ã€hourã€day</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptablesÂ -tÂ filterÂ -IÂ INPUTÂ -pÂ icmpÂ -mÂ limitÂ --limit-burstÂ 3Â --limitÂ 10/minuteÂ -jÂ ACCEPT<br>iptablesÂ -tÂ filterÂ -AÂ INPUTÂ -pÂ icmpÂ -jÂ REJECT<br></code></pre></td></tr></table></figure></li></ol><h2 id="è‡ªå®šä¹‰é“¾"><a href="#è‡ªå®šä¹‰é“¾" class="headerlink" title="è‡ªå®šä¹‰é“¾"></a>è‡ªå®šä¹‰é“¾</h2><h3 id="åˆ›å»ºè‡ªå®šä¹‰é“¾"><a href="#åˆ›å»ºè‡ªå®šä¹‰é“¾" class="headerlink" title="åˆ›å»ºè‡ªå®šä¹‰é“¾"></a>åˆ›å»ºè‡ªå®šä¹‰é“¾</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> åœ¨filterè¡¨ä¸­åˆ›å»ºyyzè‡ªå®šä¹‰é“¾<br>iptables -N yyz<br></code></pre></td></tr></table></figure><h3 id="å¼•ç”¨è‡ªå®šä¹‰é“¾"><a href="#å¼•ç”¨è‡ªå®šä¹‰é“¾" class="headerlink" title="å¼•ç”¨è‡ªå®šä¹‰é“¾"></a>å¼•ç”¨è‡ªå®šä¹‰é“¾</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> åœ¨OUTPUTé“¾ä¸­å¼•ç”¨åˆšæ‰åˆ›å»ºçš„è‡ªå®šä¹‰é“¾<br>iptables -I OUTPUT -j yyz<br></code></pre></td></tr></table></figure><h3 id="é‡å‘½åè‡ªå®šä¹‰é“¾"><a href="#é‡å‘½åè‡ªå®šä¹‰é“¾" class="headerlink" title="é‡å‘½åè‡ªå®šä¹‰é“¾"></a>é‡å‘½åè‡ªå®šä¹‰é“¾</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> å°†yyzè‡ªå®šä¹‰é“¾é‡å‘½åä¸ºtest<br>iptabels -E yyz test<br></code></pre></td></tr></table></figure><h3 id="åˆ é™¤è‡ªå®šä¹‰é“¾"><a href="#åˆ é™¤è‡ªå®šä¹‰é“¾" class="headerlink" title="åˆ é™¤è‡ªå®šä¹‰é“¾"></a>åˆ é™¤è‡ªå®šä¹‰é“¾</h3><p>åˆ é™¤è‡ªå®šä¹‰é“¾éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</p><ol><li>è‡ªå®šä¹‰é“¾ä¸­æ²¡æœ‰è¢«å¼•ç”¨</li><li>è‡ªå®šä¹‰é“¾ä¸­æ²¡æœ‰ä»»ä½•è§„åˆ™</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span> åˆ é™¤å¼•ç”¨è®¡æ•°ä¸º0ä¸”ä¸åŒ…å«ä»»ä½•è§„åˆ™çš„testé“¾<br>iptabels -X test<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ROM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROM </tag>
            
            <tag> framework </tag>
            
            <tag> æµæ°´è´¦ </tag>
            
            <tag> iptables </tag>
            
            <tag> ç½‘ç»œé»‘ç™½åå• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€æµæ°´è´¦ã€‘è®°å½•Frameworkå¼€å‘çš„å¸¸ç”¨æŒ‡ä»¤</title>
      <link href="/2019/08/16/Framework-Option/"/>
      <url>/2019/08/16/Framework-Option/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å†™åšå®¢æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œä½†æ˜¯å†™çš„äººæ°´å¹³å‚å·®ä¸é½ï¼Œæˆ‘è§è¿‡æœ€æç¬‘çš„å°±æ˜¯åšæ–‡çš„å†…å®¹æ˜¯å…¶ä»–åšå®¢çš„é“¾æ¥ã€‚æœ¬ç€ä¸è¯¯äººå­å¼Ÿçš„åŸåˆ™ï¼Œæˆ‘å†™åšå®¢ä¸€å‘å¾ˆå…‹åˆ¶ã€‚æµæ°´è´¦ç³»åˆ—æ˜¯æˆ‘å¹³æ—¶çš„ä¸€äº›è®°å½•ï¼Œæ˜¯ <code>how to</code> ç±»å‹çš„æ–‡ç« ï¼Œç½‘ä¸Šç›¸å…³çš„èµ„æ–™ä¸€æœä¸€å¤§æŠŠï¼Œä»…ä¾›è‡ªå·±è®°å½•æŸ¥æ‰¾ã€‚</p><p>æœ¬ç¯‡åšå®¢æ˜¯è®°å½•ä¸€äº›å­¦ä¹  <code>framework</code> å¼€å‘æ—¶çŸ¥è¯†çš„æ•´ç†ã€‚</p></blockquote><a id="more"></a><h3 id="æºç å…¨ç›˜ç¼–è¯‘æŒ‡ä»¤"><a href="#æºç å…¨ç›˜ç¼–è¯‘æŒ‡ä»¤" class="headerlink" title="æºç å…¨ç›˜ç¼–è¯‘æŒ‡ä»¤"></a>æºç å…¨ç›˜ç¼–è¯‘æŒ‡ä»¤</h3><ol><li><code>source build/envsetup.sh</code></li><li>è¾“å…¥ <code>lunch</code> åŒæ—¶é€‰æ‹©æ¬²ç¼–è¯‘çš„æºç </li><li>ç¼–è¯‘æŒ‡ä»¤ï¼š<code>make -j32 2&gt;&amp;1 | tee build_20190717_1724.log</code></li><li>ç¼–è¯‘åoutç›®å½•å¯æŸ¥çœ‹ç¼–è¯‘å‡ºçš„é•œåƒ</li></ol><p>å‰ä¸¤æ­¥æ‰§è¡Œå®Œæ¯•å³å¯æ‰§è¡Œ <code>mmm</code> ç­‰å‘½ä»¤ï¼Œä½¿ç”¨ <code>make clean</code>å¯ä»¥åœ¨ç¼–è¯‘å‰cleanæºç ï¼Œè¯¥æ“ä½œä¼šå¯¼è‡´ç¼–è¯‘æ—¶é—´è¾¹é•¿ã€‚</p><h3 id="ROMçƒ§å½•ï¼ˆmtkï¼‰"><a href="#ROMçƒ§å½•ï¼ˆmtkï¼‰" class="headerlink" title="ROMçƒ§å½•ï¼ˆmtkï¼‰"></a>ROMçƒ§å½•ï¼ˆmtkï¼‰</h3><ol><li>æ‰“å¼€ <code>flash_tool.exe</code></li><li>é€‰æ‹©æºç çš„é…ç½®æ–‡ä»¶</li><li>åˆ‡æ¢ä¸‹è½½/å…¨éƒ¨æ ¼å¼åŒ–å’Œä¸‹</li><li>ç‚¹å‡»ä¸‹è½½ï¼ŒåŒæ—¶å°†å·²å…³æœºçš„è®¾å¤‡è¿æ¥ç”µè„‘</li><li>ç­‰å¾…çº¢æ¡ï¼Œç»¿æ¡ï¼Œé»„æ¡èµ°å®Œçƒ§å½•æˆåŠŸ</li></ol><h3 id="ROMå†™å·"><a href="#ROMå†™å·" class="headerlink" title="ROMå†™å·"></a>ROMå†™å·</h3><ol><li>æ‰“å¼€ <code>SN Writer.exe</code></li><li>ç‚¹å‡» <code>System Config</code> é…ç½®æ¬²å†™å“ªäº›å·ï¼Œç‚¹å‡»AP_DBè¿›è¡Œé…ç½®æ–‡ä»¶ï¼Œç‚¹å‡» <code>Save</code></li><li>ç‚¹å‡» <code>Start</code> å°†å…³æœºçš„è®¾å¤‡è¿å…¥ç”µè„‘</li></ol><h3 id="æºç æ£€å‡º"><a href="#æºç æ£€å‡º" class="headerlink" title="æºç æ£€å‡º"></a>æºç æ£€å‡º</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">repo-local init -u git://&#123;ip&#125;/shupai_android7.1/manifests.git &amp;&amp; repo-local sync -j8 &amp;&amp; repo-local start --all master<br></code></pre></td></tr></table></figure><p>{ip} ä½¿ç”¨æºç åœ°å€æ›¿æ¢</p><h3 id="å¼€æœºåŠ¨ç”»"><a href="#å¼€æœºåŠ¨ç”»" class="headerlink" title="å¼€æœºåŠ¨ç”»"></a>å¼€æœºåŠ¨ç”»</h3><p><code>/system/media/</code></p><h3 id="é‡æ–°æ‰“åŒ…-System-ç”Ÿæˆé•œåƒ"><a href="#é‡æ–°æ‰“åŒ…-System-ç”Ÿæˆé•œåƒ" class="headerlink" title="é‡æ–°æ‰“åŒ… System ç”Ÿæˆé•œåƒ"></a>é‡æ–°æ‰“åŒ… <code>System</code> ç”Ÿæˆé•œåƒ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">make -j8 snod<br></code></pre></td></tr></table></figure><h3 id="å¯¹-Settings-éƒ¨åˆ†çš„ä¿®æ”¹"><a href="#å¯¹-Settings-éƒ¨åˆ†çš„ä¿®æ”¹" class="headerlink" title="å¯¹ Settings éƒ¨åˆ†çš„ä¿®æ”¹"></a>å¯¹ <code>Settings</code> éƒ¨åˆ†çš„ä¿®æ”¹</h3><ol><li>ç§»é™¤æŸé¡¹ï¼ˆremovePreferenceæ–¹æ³•ï¼‰</li><li>ç¦ç”¨æŸé¡¹ ï¼ˆé…ç½®enabledå±æ€§ï¼‰</li><li>éšè— <code>Settings</code> ä¸»ç•Œé¢é€‰é¡¹ï¼š<code>TileUtils</code></li></ol><h3 id="ä¸‰å¤§é‡‘åˆšé”®"><a href="#ä¸‰å¤§é‡‘åˆšé”®" class="headerlink" title="ä¸‰å¤§é‡‘åˆšé”®"></a>ä¸‰å¤§é‡‘åˆšé”®</h3><ol><li><code>HOME</code> å’Œ  <code>BACK</code><br><code>PhoneWindowManager</code> ç±» <code>interceptKeyBeforeDispatching</code> æ–¹æ³•<br>ä¿®æ”¹ <code>KEYCODE_HOME</code>  <code>KEYCODE_BACK</code> case ä¸­çš„é€»è¾‘ </li><li><code>RECENT</code><br><code>src/com/android/systemui/recents/RecentsImpl</code> ç±» <code>startRecentsActivity</code> æ–¹æ³•</li></ol><h3 id="é¢„è£…åº”ç”¨"><a href="#é¢„è£…åº”ç”¨" class="headerlink" title="é¢„è£…åº”ç”¨"></a>é¢„è£…åº”ç”¨</h3><p><code>device/mediatek/common device.mk</code></p><h3 id="å…³æœº-é‡å¯æ“ä½œ"><a href="#å…³æœº-é‡å¯æ“ä½œ" class="headerlink" title="å…³æœº é‡å¯æ“ä½œ"></a>å…³æœº é‡å¯æ“ä½œ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">base/services/core/java/com/android/server/policy/GloablActions PowerAction<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ROM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROM </tag>
            
            <tag> framework </tag>
            
            <tag> æµæ°´è´¦ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤šä¸ªé¡¹ç›®æ·»åŠ ä¾èµ–åŒä¸€ä¸ªæ¨¡å—</title>
      <link href="/2019/04/13/multi-project-one-module/"/>
      <url>/2019/04/13/multi-project-one-module/</url>
      
        <content type="html"><![CDATA[<blockquote><p>android Studio  ä¸­çš„é¡¹ç›®åœ¨æ­£å¸¸å¼•ç”¨moduleçš„æ—¶å€™æ˜¯ç”¨å¤åˆ¶åˆ°é¡¹ç›®ä¸­çš„æ–¹å¼è¿›è¡Œï¼Œå•ä¸ªé¡¹ç›®è°ƒç”¨è¿˜èƒ½é€‚ç”¨ï¼Œä½†æ˜¯å¦‚æœå¤šä¸ªé¡¹ç›®è¦å¼•ç”¨åŒä¸€ä¸ªmoduleçš„æ—¶å€™ï¼Œå¦‚æœmoduleä¸­è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆæ¯ä¸ªé¡¹ç›®ä¸­çš„moduleéƒ½è¦è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·å¢åŠ äº†å·¥ä½œé‡ï¼Œå¹¶ä¸”å®¹æ˜“å‡ºç°bug</p><p>å› æ­¤æˆ‘ä»¬éœ€è¦å¼•ç”¨module ï¼Œè€Œä¸æ˜¯å¤åˆ¶moduleï¼Œå®ç°æ–¹æ³•å¦‚ä¸‹</p></blockquote><a id="more"></a><p>æ–°å»ºé¡¹ç›® <code>TestBase</code>ï¼Œåœ¨å…¶ <code>app build.gradle</code> ä¸­å°† <code>apply plugin: &#39;com.android.application&#39;</code> æ”¹ä¸º<code>apply plugin: &#39;com.android.library&#39;</code> åˆ é™¤<code>applicationId</code> é…ç½®é¡¹ï¼Œå°†<code>module</code>åä¿®æ”¹ä¸º<code>baselib</code>ã€‚</p><p>æ–°å»ºé¡¹ç›® <code>TestA</code> åœ¨å…¶<code>settings.gradle</code> æ–‡ä»¶ä¸­åŠ å…¥ä¸‹åˆ—ä»£ç ã€‚</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">include</span> <span class="hljs-string">':app'</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">':baselib'</span><br><span class="hljs-keyword">project</span>(<span class="hljs-string">':baselib'</span>).projectDir=<span class="hljs-keyword">new</span> <span class="hljs-keyword">File</span>(<span class="hljs-string">"../TestBase"</span>, <span class="hljs-string">'baselib'</span>)<br></code></pre></td></tr></table></figure><p>å¼•ç”¨ä¾èµ–æ—¶æ­£å¸¸å¼•ç”¨å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">implementation project(&apos;:baselib&apos;)<br></code></pre></td></tr></table></figure><p>åŒæ­¥<code>gradle</code> ï¼Œæ­¤æ—¶æˆ‘ä»¬å‘ç°<code>baselib</code>å‡ºç°åœ¨<code>TestA</code>é¡¹ç›®ä¸­ã€‚</p><p><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/TestA%E7%9B%AE%E5%BD%95.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="TestAç›®å½•.png"></p><p>æ‰“å¼€<code>TestA</code> é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬å‘ç°äº† <code>baselib</code> æ–‡ä»¶å¤¹ï¼Œä¸‹é¢åªæœ‰ä¸€ä¸ª<code>baselib.iml</code>æ–‡ä»¶</p><p><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/TesA%E5%8E%9F%E7%9B%AE%E5%BD%95.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="TesAåŸç›®å½•.png"></p><p>åœ¨<code>baselib</code>ä¸­åŠ å…¥<code>Utils</code> å·¥å…·ç±»</p><p><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/baselib.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="baselib.png"></p><p>åˆ‡æ¢åˆ°<code>TestBase</code>ä¸­æŸ¥çœ‹ï¼Œä»£ç æ˜¯ç›¸åŒçš„ã€‚</p><p><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/baselib.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="TestBaseç›®å½•.png"></p><p>è¿™æ ·å°±è¾¾åˆ°äº†<code>baselib</code>è¢«ä¿®æ”¹åæ‰€æœ‰å¼•ç”¨<code>baselib</code>çš„é¡¹ç›®ä¼šåŒæ­¥å˜åŒ–ã€‚</p><h4 id="git-åŒæ­¥ç®¡ç†"><a href="#git-åŒæ­¥ç®¡ç†" class="headerlink" title="git åŒæ­¥ç®¡ç†"></a>git åŒæ­¥ç®¡ç†</h4><blockquote><p>ä¸Šè¿°æ“ä½œéƒ½æ˜¯åŸºäºæœ¬åœ°çš„ï¼Œé‚£ä¹ˆå¦‚ä½•åŠ å…¥gitç®¡ç†å‘¢</p></blockquote><p>å°†<code>TestA</code>å’Œ<code>TestBase</code>åˆ†åˆ«ä¼ è‡³<code>github</code></p><p>åœ¨<code>TestA</code>é¡¹ç›®ä¸­æ‰“å¼€<code>settings</code>ï¼Œæ‰¾åˆ°å¦‚ä¸‹ä½ç½®å¹¶å°†<code>TestBase</code>åŠ å…¥åˆ°<code>git</code>ç®¡ç†</p><p><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/%E6%B7%BB%E5%8A%A0git.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ·»åŠ git.png"></p><p>ç„¶åå°±å¯ä»¥åŒæ­¥ç®¡ç†è¿™ä¸¤ä¸ªé¡¹ç›®å•¦<br><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/%E5%90%8C%E6%AD%A5%E7%AE%A1%E7%90%86.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="åŒæ­¥ç®¡ç†.png"><br><img class="lazyload" data-original="%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96%E5%90%8C%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97/gitlog.png" src="/2019/04/13/multi-project-one-module/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="git log.png"></p><p>å‚è€ƒï¼š<br><a href="https://www.jianshu.com/p/47156a6be8ce" target="_blank" rel="noopener">https://www.jianshu.com/p/47156a6be8ce</a><br><a href="https://blog.csdn.net/saintcs/article/details/78567612" target="_blank" rel="noopener">https://blog.csdn.net/saintcs/article/details/78567612</a></p>]]></content>
      
      
      <categories>
          
          <category> app </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android Studio </tag>
            
            <tag> app </tag>
            
            <tag> gradle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Macä¸‹Androidåç¼–è¯‘åˆæ¢</title>
      <link href="/2017/07/06/Mac-decompile/"/>
      <url>/2017/07/06/Mac-decompile/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å·¥ä½œç¬¬å››å¤©ï¼Œè¢«è¦æ±‚å­¦ä¹ é€†å‘å¼€å‘æ–¹é¢çš„çŸ¥è¯†ï¼Œäºæ˜¯å…ˆå°†è‡ªå·±ä¹‹å‰å†™çš„æœªç»æ··æ·†çš„apkåç¼–è¯‘ï¼Œè®°å½•ä¹‹ã€‚</p></blockquote><p><a href="http://blog.csdn.net/wj_november/article/details/51527286" target="_blank" rel="noopener">æ„Ÿè°¢è¯¥åšæ–‡æä¾›çš„æ€è·¯</a></p><a id="more"></a><h3 id="1-å·¥å…·å‡†å¤‡"><a href="#1-å·¥å…·å‡†å¤‡" class="headerlink" title="1. å·¥å…·å‡†å¤‡"></a>1. å·¥å…·å‡†å¤‡</h3><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-569189364ef992cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å·¥å…·"></p><p>éœ€è¦çš„ä¸‰ä»¶å¥—ï¼Œ<a href="http://download.csdn.net/detail/wj_november/9657372" target="_blank" rel="noopener">ä¸‹è½½è¯·æˆ³</a></p><ol><li>AndroidCrackTool ç”¨äºåç¼–è¯‘apkæ–‡ä»¶<br>ä¸ç›´æ¥è§£å‹apkä¸åŒï¼Œç”¨è¯¥å·¥å…·è·å¾—çš„æ–‡ä»¶èµ„æºå¯ä»¥ç›´æ¥æ‰“å¼€é˜…è¯»ï¼Œè€Œç›´æ¥è§£å‹å¾—åˆ°çš„æ˜¯å­—èŠ‚ç ã€‚</li><li>dex2jar ç”¨äºå°†.dexæ–‡ä»¶è½¬ä¸ºjaræ–‡ä»¶<br> ä¼ ç»Ÿçš„Javaç¨‹åºç»è¿‡ç¼–è¯‘ï¼Œç”ŸæˆJavaå­—èŠ‚ç ä¿å­˜åœ¨classæ–‡ä»¶ä¸­ï¼ŒJavaè™šæ‹Ÿæœºé€šè¿‡è§£ç classæ–‡ä»¶ä¸­çš„å†…å®¹æ¥è¿è¡Œç¨‹åºã€‚è€ŒDalvikè™šæ‹Ÿæœºè¿è¡Œçš„æ˜¯Davikå­—èŠ‚ç ï¼Œæ‰€æœ‰çš„Davikå­—èŠ‚ç ç”±Javaå­—èŠ‚ç è½¬æ¢è€Œæ¥ï¼Œå¹¶è¢«æ‰“åŒ…åˆ°ä¸€ä¸ªDEXï¼ˆDalvik Executableï¼‰å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒDalvikè™šæ‹Ÿæœºé€šè¿‡è§£é‡ŠDEXæ–‡ä»¶æ¥æ‰§è¡Œè¿™äº›å­—èŠ‚ç ã€‚</li><li>jd-gui ç”¨äºé˜…è¯»æºç </li></ol><h3 id="2-å¼€å§‹å·¥ä½œ"><a href="#2-å¼€å§‹å·¥ä½œ" class="headerlink" title="2. å¼€å§‹å·¥ä½œ"></a>2. å¼€å§‹å·¥ä½œ</h3><p>ä½¿ç”¨AndroidCrackToolåç¼–è¯‘apkï¼Œè®¾ç½®å¥½ç›®å½•ç‚¹å‡»æ‰§è¡ŒæŒ‰é’®ï¼Œå‡ºç°endå­—æ ·å³æˆåŠŸã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-9dde0fe67fd84a07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="åç¼–è¯‘apk"><br>åœ¨è¿™é‡Œå¯ä»¥æŸ¥çœ‹ä¸€äº›èµ„æºæ–‡ä»¶</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-33d7aeb6f6b20770.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æŸ¥çœ‹èµ„æºæ–‡ä»¶"><br>å°†apkä»¥æ™®é€šè§£å‹çš„æ–¹å¼è§£å‹å‡ºæ¥ï¼Œæ‰¾åˆ°å…¶ä¸­çš„classes.dexæ–‡ä»¶ï¼Œ<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-46a0928132602efb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="classes.dexä½ç½®"><br>å°†å…¶å¤åˆ¶åˆ°dex2jarç›®å½•ï¼Œä½¿ç”¨ç»ˆç«¯è¿›å…¥dex2jarç›®å½•å¹¶æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">sh dex2jar.sh classes.dex<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨dex2jarç›®å½•ä¸‹ç”Ÿæˆäº†classes_dex2jar.jarçš„æ–‡ä»¶ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-a489b4dd84c84ecd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ç»ˆç«¯ä¸‹æ“ä½œ"></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-6c746a8c946c3275.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ç”Ÿæˆçš„classes_dex2jar.jar"><br>ä½¿ç”¨  jd-guiæ‰“å¼€classes_dex2jar.jarå³å¯çœ‹åˆ°æºç ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘çš„apkå¹¶æ²¡æœ‰æ··æ·†ï¼Œæ‰€ä»¥åå­—éƒ½æ˜¯æ­£å¸¸çš„å‘½åï¼Œç»è¿‡æ··æ·†çš„åå­—å¤§éƒ½æ˜¯äº›å­—æ¯ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-b7afdfda627a9e6b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/06/Mac-decompile/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="é˜…è¯»æºç "></p>]]></content>
      
      
      <categories>
          
          <category> app </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åç¼–è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Handleræ·±å…¥åˆ†æ</title>
      <link href="/2017/07/04/Handler/"/>
      <url>/2017/07/04/Handler/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨androidä¸­æˆ‘ä»¬å¯ä»¥æœ‰å¾ˆå¤šæ–¹å¼å»å®ç°å¼‚æ­¥ï¼Œæ¯”å¦‚AsyncTaskï¼ŒRxjavaã€‚ä¸è¿‡å®ƒä»¬åº•å±‚éƒ½æ˜¯ä½¿ç”¨çš„Handlerï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹Handelrçš„å®ç°ã€‚</p></blockquote><a id="more"></a><h3 id="1-TreadLocalçš„ä½¿ç”¨"><a href="#1-TreadLocalçš„ä½¿ç”¨" class="headerlink" title="1. TreadLocalçš„ä½¿ç”¨"></a>1. TreadLocalçš„ä½¿ç”¨</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥å†™ä¸€ä¸ªå°demoï¼Œåˆ›å»ºä¸¤ä¸ªå­çº¿ç¨‹ï¼Œåœ¨ä¸¤ä¸ªå­çº¿ç¨‹ä¸­åˆ†åˆ«ä¸ºå­—ç¬¦ä¸²result2ï¼Œresult3èµ‹å€¼ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ä¸¤ä¸ªå­çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸ºå­—ç¬¦ä¸²result1èµ‹å€¼ï¼Œæœ€åæ‰“å°è¾“å‡ºç»“æœã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-2e352e80d8f708cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä¸»çº¿ç¨‹"></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-3593c9860a191e71.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å­çº¿ç¨‹1"></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-106032139bef8248.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å­çº¿ç¨‹2"></p><p>æœ€åæˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰“å°ç»“æœ</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-0fded8b582305652.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æµ‹è¯•ç»“æœ"></p><p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚çœ‹æ¥çº¿ç¨‹ä¹‹é—´ç›¸äº’å½±å“äº†ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•å®ç°ä¸Šè¿°çš„åŠŸèƒ½å‘¢ï¼Ÿ</p><p>å½“ç„¶æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ TreadLocal</p><blockquote><p>æˆ‘ä»¬å¯ä»¥æŠŠTreadLocalçœ‹åšæˆä¸€ä¸ªå®¹å™¨ï¼Œè°ƒç”¨å…¶ä¸­çš„setå’Œgetæ–¹æ³•ï¼Œå¯ä»¥è®¾å€¼å’Œå–å€¼ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p></blockquote><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œå¹¶è®¾ç½®æ³›å‹ä¸ºString<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-b274968c0d87042d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ThreadLocal"><br>è¿™é‡Œä¸åŒçš„æ˜¯é¦–å…ˆå°†è¦æ‰“å°çš„å­—ä¸²æ”¾å…¥ThreadLocalä¸­ï¼Œç„¶åä»ThreadLocalä¸­å–å‡ºã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-b8a37fcc57787a3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä¸»çº¿ç¨‹"></p><p>å­çº¿ç¨‹çš„æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-9b8b4a3c8f495526.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å­çº¿ç¨‹"></p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰“å°ç»“æœ</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-71885237f2c74d29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œç»“æœ"></p><p>è¿™æ ·å°±å®Œæˆäº†ä¸Šè¿°åŠŸèƒ½ã€‚é‚£ä¹ˆè¿™é‡Œè¯´çš„ThreadLocalä¸Handleræœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿåˆ«æ€¥ï¼Œå¾€ä¸‹çœ‹ã€‚</p><h3 id="2-åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºHandelr"><a href="#2-åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºHandelr" class="headerlink" title="2. åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºHandelr"></a>2. åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºHandelr</h3><p>æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªHandlerå¯¹è±¡ï¼Œç„¶åè¿è¡Œç¨‹åºã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-4673d3b294d1ff08.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å­çº¿ç¨‹ä¸­åˆ›å»ºHandlerå¯¹è±¡"></p><p>å¯ä»¥çœ‹åˆ°è¿è¡Œæ—¶å‡ºç°äº†å¼‚å¸¸</p><blockquote><p> java.lang.RuntimeException: Canâ€™t create handler inside thread that has not called Looper.prepare()</p></blockquote><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-42a0e89fbd6cfe2f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å¼‚å¸¸"><br>çœ‹å­—é¢æ„æ€æ˜¯ä¸èƒ½åœ¨è°ƒç”¨Looper.prepare()ä¹‹å‰åœ¨çº¿ç¨‹ä¸­åˆ›å»ºhandlerã€‚<br>é‚£ä¹ˆæˆ‘ä»¬åœ¨åˆ›å»ºhandlerä¹‹å‰å»è°ƒç”¨Looper.prepare()ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-036e11a4312a1dd7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è°ƒç”¨Looper.prepare()"><br>ä¹‹åå°±èƒ½æˆåŠŸè¿è¡Œäº†ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šè¿™æ ·ã€‚<br>é¼ æ ‡æ”¾åœ¨Handler()ä¸Šï¼ŒwinæŒ‰ä½control+é¼ æ ‡å·¦é”®ï¼ŒMacæŒ‰ä½command+é¼ æ ‡å·¦é”®ã€‚è¿›å…¥Handlerçš„æ„é€ å™¨ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-ddcf57bb316f4d6a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Handleræ„é€ å™¨"><br>ç‚¹å‡»this</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-322cff8f6407b3f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ›´è¿›ä¸€æ­¥"></p><p>æˆ‘ä»¬æ‰¾åˆ°äº†æºå¤´ï¼Œå¦‚æœlooperä¸ºç©ºåˆ™æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚</p><p>åœ¨è¿™é‡Œä»looperé‡Œå–å‡ºmQueueèµ‹å€¼ç»™mQueue</p><p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªLooper.prepareæ–¹æ³•ï¼Œ<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-8092676c88450ad6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="prepare"></p><p>ä¸Šæ–¹çš„æ³¨é‡Šè¯´å¾—å¾ˆæ¸…æ¥šï¼Œåœ¨çœŸæ­£å¼€å§‹è¿™ä¸ªloopä¹‹å‰ï¼Œè¯¥æ–¹æ³•ä¸ºä½ æä¾›äº†åˆ›å»ºå¼•ç”¨è¿™ä¸ªlooperçš„handelrçš„æœºä¼šã€‚åœ¨è°ƒç”¨å®Œè¯¥æ–¹æ³•åï¼Œåº”è¯¥ç¡®ä¿è°ƒç”¨äº†loop()æ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨quit()æ–¹æ³•å»ç»“æŸå®ƒã€‚</p><p>æˆ‘ä»¬è¿˜çœ‹åˆ°å¦‚æœå¤šæ¬¡è°ƒç”¨prepareæ–¹æ³•ä¼šæŠ›å‡ºOnly one Looper may be created per threadå¼‚å¸¸ã€‚<br>åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„èº«å½±ï¼ŒThreadLocalã€‚åœ¨è¿™é‡Œä½¿ç”¨ThreadLocalæ¥å­˜looperã€‚</p><p>çœ‹åˆ°è¿™æˆ‘ä»¬ä¸ç¦è¦é—®ï¼Œåœ¨ä¸»çº¿ç¨‹æˆ‘ä»¬å¹¶æ²¡æœ‰è°ƒç”¨prepareæ–¹æ³•å•Šï¼Œæ²¡é”™ï¼Œåœ¨ä¸»çº¿ç¨‹ä½¿ç”¨çš„æ˜¯prepareMainLooper<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-28263341bcc4e038.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="prepareMainLooper"><br>å¯ä»¥çœ‹åˆ°è¿™ä¸ªmain looperå·²ç»è¢«android environmentåˆ›å»ºäº†ï¼Œæ‰€ä»¥ä¸éœ€è¦è‡ªå·±è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºHandlerçš„æ ‡å‡†å†™æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadLooper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> Handler mHandler;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">super</span>.run();<br>            Looper.prepare();<br>            mHandler = <span class="hljs-keyword">new</span> Handler() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleMessage</span><span class="hljs-params">(Message msg)</span> </span>&#123;<br>                &#125;<br>            &#125;;<br>            Looper.loop();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="3-Messageçš„å‘é€å’Œå¤„ç†è¿‡ç¨‹"><a href="#3-Messageçš„å‘é€å’Œå¤„ç†è¿‡ç¨‹" class="headerlink" title="3. Messageçš„å‘é€å’Œå¤„ç†è¿‡ç¨‹"></a>3. Messageçš„å‘é€å’Œå¤„ç†è¿‡ç¨‹</h3><p>Handleré‡Œæä¾›äº†å‡ ä¸ªæ¶ˆæ¯å…¥é˜Ÿçš„æ–¹æ³•</p><blockquote><p>post()<br>postAtTime()<br>postDelayed()<br>postAtFrontOfQueue()<br>sendMessageAtTime(Message msg , long uptimeMillis)</p></blockquote><p>å…¶ä¸­post()ï¼ŒpostAtTime()ï¼ŒpostDelayed()éƒ½ä¼šç›´æ¥æˆ–é—´æ¥è°ƒç”¨sendMessageAtTimeæ–¹æ³•ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-8f15bc3b507a098f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="post"><br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-1b8a08501a2a9251.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="postAtTime"><br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-c5ef6085b80726ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="postDelayed"><br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-dbe0fccf4cc81722.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="sendMessageDelayed"><br>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹sendMessageAtTimeæ–¹æ³•</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-678aac95b1c8ad85.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="sendMessageAtTime"></p><p>æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œmsg å’ŒuptimeMillis ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ‰“å°è­¦å‘Šï¼ŒåŒæ—¶è¿”å›falseã€‚åä¹‹åˆ™è°ƒç”¨enqueueMessageæ–¹æ³•ã€‚</p><p>ä¸‹é¢çœ‹ä¸€ä¸‹enqueueMessage</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-ba4cd0593a2e8df7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="enqueueMessage"><br>è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ“ä½œã€‚<br>msg.targetèµ‹å€¼ä¸ºthisï¼Œæœ‰ä¸¤å±‚å«ä¹‰ï¼Œä¸€æ˜¯messageçš„æ¥æºæ˜¯å½“å‰handlerï¼ŒäºŒæ˜¯å½“å‰çš„handleræ¥å¤„ç†æ¶ˆæ¯ã€‚<br>å°†æ¶ˆæ¯åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ—¢ç„¶æ˜¯é˜Ÿåˆ—å°±æœ‰é¡ºåºï¼Œé‚£ä¹ˆæ ¹æ®ä»€ä¹ˆæ¥åˆ¤æ–­é¡ºåºå‘¢ï¼Ÿå°±æ˜¯æ ¹æ®uptimeMillis,è¿™ä¸ªæ—¶é—´ï¼Œæ—¶é—´çŸ­å°±åœ¨å‰é¢ï¼Œé•¿å°±åœ¨åé¢ã€‚</p><p>ç»†å¿ƒçš„ä½ å¯èƒ½å‘ç°åˆšåˆšæˆ‘æåˆ°post()ï¼ŒpostAtTime()ï¼ŒpostDelayed()éƒ½ä¼šç›´æ¥æˆ–é—´æ¥è°ƒç”¨sendMessageAtTimeæ–¹æ³•ï¼Œé‚£postAtFrontOfQueue()å‘¢ï¼Ÿ<br>ä»å­—é¢ä¸Šçœ‹è¯¥æ–¹æ³•æ˜¯å°†æ¶ˆæ¯ç½®äºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€å‰è¾¹ã€‚æ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹æºç ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-76f2c74c7c0a3e51.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="postAtFrontOfQueue"><br>è¿™é‡Œå°†å…¥é˜Ÿçš„æ—¶é—´å‚æ•°ç›´æ¥å†™æ­»ä¸º0ï¼Œé‚£ä¹ˆè‚¯å®šå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„æœ€å‰è¾¹å•¦ã€‚</p><p>æˆ‘ä»¬å†æ¥åˆ†æä¸‹å…¥é˜Ÿä¹‹åçš„è¿‡ç¨‹ï¼Œä¸Šæ–‡æåˆ°è°ƒç”¨Looper.prepare()æ–¹æ³•ååº”è°ƒç”¨Looper.loop()æ–¹æ³•å¼€å§‹æ¶ˆæ¯çš„è½®è¯¢ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹loopæ–¹æ³•åšäº†äº›ä»€ä¹ˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> Looper me = myLooper();<br>    <span class="hljs-keyword">if</span> (me == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> MessageQueue queue = me.mQueue;<br><br>    <span class="hljs-comment">// Make sure the identity of this thread is that of the local process,</span><br>    <span class="hljs-comment">// and keep track of what that identity token actually is.</span><br>    Binder.clearCallingIdentity();<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> ident = Binder.clearCallingIdentity();<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        Message msg = queue.next(); <span class="hljs-comment">// might block</span><br>        <span class="hljs-keyword">if</span> (msg == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// No message indicates that the message queue is quitting.</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// This must be in a local variable, in case a UI event sets the logger</span><br>        <span class="hljs-keyword">final</span> Printer logging = me.mLogging;<br>        <span class="hljs-keyword">if</span> (logging != <span class="hljs-keyword">null</span>) &#123;<br>            logging.println(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="hljs-string">" "</span> +<br>                    msg.callback + <span class="hljs-string">": "</span> + msg.what);<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> traceTag = me.mTraceTag;<br>        <span class="hljs-keyword">if</span> (traceTag != <span class="hljs-number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;<br>            Trace.traceBegin(traceTag, msg.target.getTraceName(msg));<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            msg.target.dispatchMessage(msg);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (traceTag != <span class="hljs-number">0</span>) &#123;<br>                Trace.traceEnd(traceTag);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (logging != <span class="hljs-keyword">null</span>) &#123;<br>            logging.println(<span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="hljs-string">" "</span> + msg.callback);<br>        &#125;<br><br>        <span class="hljs-comment">// Make sure that during the course of dispatching the</span><br>        <span class="hljs-comment">// identity of the thread wasn't corrupted.</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> newIdent = Binder.clearCallingIdentity();<br>        <span class="hljs-keyword">if</span> (ident != newIdent) &#123;<br>            Log.wtf(TAG, <span class="hljs-string">"Thread identity changed from 0x"</span><br>                    + Long.toHexString(ident) + <span class="hljs-string">" to 0x"</span><br>                    + Long.toHexString(newIdent) + <span class="hljs-string">" while dispatching to "</span><br>                    + msg.target.getClass().getName() + <span class="hljs-string">" "</span><br>                    + msg.callback + <span class="hljs-string">" what="</span> + msg.what);<br>        &#125;<br><br>        msg.recycleUnchecked();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-5797c552356958b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="looper"><br>é¦–å…ˆä»ThreadLocalä¸­å–å‡ºlooperå¹¶åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œä¹‹åå°†looperä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—èµ‹å€¼ï¼Œå†ç„¶åè¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¾ªç¯å†…å»ä¸æ–­å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‹ä¸€é¡¹ï¼Œæ²¡æœ‰æ¶ˆæ¯å‘ç”Ÿé˜»å¡ã€‚</p><p>æ‰¾åˆ° msg.target.dispatchMessage(msg);è¿™ä¸€è¡Œï¼Œ<br>ä¹‹å‰æˆ‘ä»¬æåˆ°targetå°±æ˜¯handlerå¯¹è±¡ï¼Œè¿™é‡ŒhandleræŠŠæ¶ˆæ¯æ´¾å‘å‡ºå»ï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥æ¶ˆæ¯çš„å¤„ç†äº†ã€‚</p><p>è¿›å…¥åˆ°msg.target.dispatchMessageæ–¹æ³•ï¼Œ<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-3d37b2fa8bb03c78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="dispatchMessage"><br>è¿™é‡Œåˆ†ä¸‰æ­¥<br>1.åˆ¤æ–­msgçš„å›è°ƒæ˜¯å¦ä¸ºç©º<br> å¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥è¯¥å›è°ƒè‡ªå·±å¤„ç†ï¼Œåä¹‹åˆ¤æ–­è‡ªå·±çš„å›è°ƒ</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-5cabf5368375e861.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="messageçš„å›è°ƒ"><br>æŠŠRunnable å°è£…æˆmsgçš„callback</p><p>2.åˆ¤æ–­è‡ªå·±çš„å›è°ƒæ˜¯å¦ä¸ºç©º<br>3.è°ƒç”¨handleMessageæ–¹æ³•</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-ad49dc188525989f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/07/04/Handler/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="handleMessage"><br>è¿™é‡Œç”±å­ç±»é‡å†™æ¥å¤„ç†message</p><h3 id="4-Handleræœºåˆ¶çš„æ€»ç»“"><a href="#4-Handleræœºåˆ¶çš„æ€»ç»“" class="headerlink" title="4. Handleræœºåˆ¶çš„æ€»ç»“"></a>4. Handleræœºåˆ¶çš„æ€»ç»“</h3><blockquote><p>Thread è´Ÿè´£ä¸šåŠ¡é€»è¾‘<br>Handler è´Ÿè´£å‘é€æ¶ˆæ¯å’Œå¤„ç†æ¶ˆæ¯<br>MessageQueue è´Ÿè´£ä¿å­˜æ¶ˆæ¯<br>Looper è´Ÿè´£è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> app </category>
          
      </categories>
      
      
        <tags>
            
            <tag> handler </tag>
            
            <tag> å¼‚æ­¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.2ä»æ•™åŠ¡ç³»ç»ŸæŸ¥è¯¢æˆç»©å¹¶è®¡ç®—ç»©ç‚¹â€”â€”å±±ä¸œå»ºç­‘å¤§å­¦ä¸ºä¾‹</title>
      <link href="/2017/06/18/2-2-grade/"/>
      <url>/2017/06/18/2-2-grade/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å‰ä¸¤å¤©é¢è¯•æ—¶è¢«é—®åˆ°ç»©ç‚¹æ˜¯å¤šå°‘ï¼Œä½†å­¦æ ¡æ•™åŠ¡ç³»ç»Ÿä¸æä¾›ç»©ç‚¹æŸ¥è¯¢çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å†™ä¸€ä¸ªçˆ¬è™«ç¨‹åºå¹¶è®¡ç®—å‡ºç»©ç‚¹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼</p></blockquote><p> <a href="http://blog.csdn.net/pleasecallmewhy/article/details/9305229" target="_blank" rel="noopener">æ„Ÿè°¢è¯¥åšå®¢æä¾›çš„æ€è·¯</a></p><a id="more"></a><h3 id="1-å‡†å¤‡"><a href="#1-å‡†å¤‡" class="headerlink" title="1. å‡†å¤‡"></a>1. å‡†å¤‡</h3><p>HttpFoxæ’ä»¶ï¼Œæ˜¯ä¸€æ¬¾httpåè®®åˆ†ææ’ä»¶ï¼Œåˆ†æé¡µé¢è¯·æ±‚å’Œå“åº”çš„æ—¶é—´ã€å†…å®¹ã€ä»¥åŠæµè§ˆå™¨ç”¨åˆ°çš„COOKIEç­‰ã€‚æ˜¯ç«ç‹æµè§ˆå™¨çš„æ’ä»¶ã€‚è°·æ­Œæµè§ˆå™¨å’ŒSafariéƒ½æœ‰è‡ªå¸¦çš„åˆ†æå·¥å…·ï¼Œå¯æ˜¯æ„Ÿè§‰å¤ªå¤æ‚ï¼Œæ²¡æœ‰è¿™æ¬¾å¥½ç”¨ã€‚ä¸è¿‡ç«ç‹æµè§ˆå™¨å¯¹å­¦æ ¡çš„æ•™åŠ¡ç³»ç»Ÿå…¼å®¹æ€§ä¸æ˜¯å¾ˆå¥½ï¼Œæˆ‘è¿˜ä¸‹è½½äº†IE tabæ’ä»¶ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-79a8f42d306c605c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ’ä»¶çš„å®‰è£…"></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-fdddcc6520d47f18.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt><br>å¯ä»¥éå¸¸ç›´è§‚çš„æŸ¥çœ‹ç›¸åº”çš„ä¿¡æ¯ã€‚<br>ç‚¹å‡»startæ˜¯å¼€å§‹æ£€æµ‹ï¼Œç‚¹å‡»stopæš‚åœæ£€æµ‹ï¼Œç‚¹å‡»clearæ¸…é™¤å†…å®¹ã€‚</p><h3 id="2-æ¢ç©¶è¿‡ç¨‹"><a href="#2-æ¢ç©¶è¿‡ç¨‹" class="headerlink" title="2. æ¢ç©¶è¿‡ç¨‹"></a>2. æ¢ç©¶è¿‡ç¨‹</h3><p>ä¸‹é¢å°±å»å±±ä¸œå»ºç­‘å¤§å­¦å®˜ç½‘ç™»å½•åˆ°æ•°å­—æ ¡å›­ç»¼åˆä¿¡æ¯é—¨æˆ·ï¼Œçœ‹ä¸€çœ‹åœ¨ç™»å½•çš„æ—¶å€™ï¼Œåˆ°åº•å‘é€äº†é‚£äº›ä¿¡æ¯ã€‚<br>å…ˆæ¥åˆ°ç™»å½•é¡µé¢ï¼ŒæŠŠhttpfoxæ‰“å¼€ï¼Œclearä¹‹åï¼Œç‚¹å‡»startå¼€å¯æ£€æµ‹ï¼š</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-0a6c714e2c2ff3a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å¼€å¯æ£€æµ‹"><br>è¾“å…¥å®Œè´¦å·å¯†ç ï¼Œç¡®ä¿httpfoxå¤„äºå¼€å¯çŠ¶æ€ï¼Œç„¶åç‚¹å‡»ç™»å½•ã€‚<br>è¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹åˆ°ï¼Œhttpfoxæ£€æµ‹åˆ°äº†å¥½å¤šä¿¡æ¯ï¼š<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-d757be497cda18ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æ•æ‰åˆ°çš„ä¿¡æ¯"></p><p>é‚£ä¹ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™äº›æ•°æ®</p><p>çœ‹èµ·æ¥çº¢æ¡†é‡Œçš„ä¸¤æ¡æ•°æ®æ¯”è¾ƒæœ‰æ„æ€ï¼Œå…ˆçœ‹çœ‹è¿™ä¸ªpost</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-f72b7d8e3375dafc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="postæ•°æ®"></p><p>PostDataä¸­æˆ‘ä»¬çœ‹åˆ°äº†æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œusernameå’Œpasswordï¼Œå­¦è¿‡java webçš„æˆ‘ä»¬å¾ˆæ¸…æ¥šè¿™æ®µæ•°æ®çš„å«ä¹‰ï¼Œç‚¹å‡»ç™»å½•åå°†è¿™ç”¨æˆ·åå’Œä½ ä»¬æäº¤åˆ°æœåŠ¡å™¨æ¯”å¯¹ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-2a025613cb9cd840.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="é‡å®šå‘åˆ°è¿™é‡Œ"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨getçš„æ–¹å¼åœ¨é“¾æ¥ä¸Šä»¥?çš„æ–¹å¼æ˜¾ç¤ºçš„åŠ ä¸Šäº†å‚æ•°ï¼Œè·³è½¬åˆ°ä¿¡æ¯é—¨æˆ·ã€‚<br>æˆ‘ä»¬çš„postçš„æ•°æ®å°±å‘é€åˆ°äº†è¿™ä¸ªåœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">http://urpe.sdjzu.edu.cn/loginPortalUrlForIndexLogin.portal<br></code></pre></td></tr></table></figure><p>éœ€è¦çš„postæ•°æ®æ˜¯ç”¨æˆ·åå¯†ç ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦è¾“å…¥è¿™ä¸¤ç§æ•°æ®æ¥æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-40ea67af08eb6ab1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿›å…¥åˆ°æ•™åŠ¡ç³»ç»Ÿ"></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-c30fa7de450e5621.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ç‚¹å‡»æˆç»©æŸ¥è¯¢"><br>è¿›å…¥æ•™åŠ¡ç³»ç»Ÿåç‚¹å‡»æˆç»©æŸ¥è¯¢ï¼Œæˆ‘ä»¬çœ‹åˆ°è¯·æ±‚çš„åœ°å€ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">http://jwfw1.sdjzu.edu.cn/ssfw/jwnavmenu.do?menuItemWid=1E057E24ABAB4CAFE0540010E0235690<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ•´ç†ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹çš„æ€è·¯ã€‚</p><ol><li>POSTå­¦å·å’Œå¯†ç â€”&gt;ç„¶åè¿”å›cookieçš„å€¼</li><li>å‘é€cookieç»™æœåŠ¡å™¨â€”&gt;è¿”å›é¡µé¢ä¿¡æ¯ã€‚</li><li>è·å–åˆ°æˆç»©é¡µé¢çš„æ•°æ®ï¼Œç”¨æ­£åˆ™è¡¨è¾¾å¼å°†æˆç»©å’Œå­¦åˆ†å•ç‹¬å–å‡ºå¹¶è®¡ç®—åŠ æƒå¹³å‡æ•°ã€‚</li></ol><p>okï¼Œç†é¡ºæ€è·¯åå‰©ä¸‹çš„å°±åªæœ‰ç¼–ç é—®é¢˜äº†ã€‚</p><h3 id="3-å®éªŒ"><a href="#3-å®éªŒ" class="headerlink" title="3. å®éªŒ"></a>3. å®éªŒ</h3><p>æˆ‘ä»¬å…ˆæ¥å®éªŒä¸‹æ˜¯å¦èƒ½å¤Ÿè·å¾—æŸ¥è¯¢æˆç»©ç•Œé¢çš„æºç </p><p>æˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ªPOSTçš„æ•°æ®ï¼Œå†å‡†å¤‡ä¸€ä¸ªcookieçš„æ¥æ”¶ï¼Œç„¶åå†™å‡ºæºç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs undefined"># coding=utf-8<br>import urllib<br>import urllib2<br>import cookielib<br><br>cookie = cookielib.CookieJar()<br>opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookie))<br><br># éœ€è¦çš„POSTæ•°æ®<br>postdata = urllib.urlencode(&#123;<br>    &apos;userName&apos;: &apos;20140216064&apos;,<br>    &apos;password&apos;: &apos;*********&apos;<br>&#125;)<br># è‡ªå®šä¹‰ä¸€ä¸ªè¯·æ±‚<br>req1 = urllib2.Request(<br>    url=&apos;http://urpe.sdjzu.edu.cn/loginPortalUrlForIndexLogin.portal&apos;,<br>    data=postdata<br>)<br><br>req2 = urllib2.Request(<br>    url=&apos;http://jwfw1.sdjzu.edu.cn/ssfw/jwnavmenu.do?menuItemWid=1E057E24ABAB4CAFE0540010E0235690&apos;<br>)<br><br># è®¿é—®ç™»å½•é“¾æ¥<br>opener.open(req1)<br>result = opener.open(req2)<br># æ‰“å°è¿”å›çš„å†…å®¹<br>print result.read()<br></code></pre></td></tr></table></figure><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-c2476106a0e29a70.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œç»“æœ"></p><p>å¾ˆæ£’å‘¦ï¼Œçœ‹æ¥è·Ÿæˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·ã€‚</p><h3 id="4-æ•´ç†æ•°æ®"><a href="#4-æ•´ç†æ•°æ®" class="headerlink" title="4. æ•´ç†æ•°æ®"></a>4. æ•´ç†æ•°æ®</h3><blockquote><p>è·å¾—äº†æˆç»©æŸ¥è¯¢ç•Œé¢çš„æºç åæˆ‘ä»¬éœ€è¦å°†æ•°æ®è¿›è¡Œæ•´ç†ï¼Œè·å¾—æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œè¯¾ç¨‹åç§°ï¼Œå­¦åˆ†ï¼Œæˆç»©ã€‚</p></blockquote><p>å°†ç½‘é¡µæºç è´´åˆ°Sublime Textä¸­ï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹æºç </p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-480626d6803e99fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="åˆ†ææºç "><br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-6a978cc4d4c27ba1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="åˆ†ææºç "><br>é€šè¿‡æŸ¥çœ‹æºç æˆ‘ä»¬çœ‹åˆ°ä»è¿™ä¸ª<div>å¼€å§‹åˆ°3640è¡Œéƒ½æ˜¯å…³äºæˆç»©çš„ä»£ç ï¼Œè€Œæˆç»©æ˜¯å­˜æ”¾åœ¨è¿™ä¸ªtableæ ‡ç­¾ä¸‹ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-b1573f6441632f38.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="éœ€è¦æå–çš„ä¿¡æ¯"><br>çº¢è‰²æ¡†ä¸­åˆ†åˆ«ä¸ºè¯¾ç¨‹åï¼Œå­¦åˆ†ï¼Œä»¥åŠæˆç»©ã€‚è¿™äº›æ˜¯æˆ‘ä»¬éœ€è¦æŠ½å–å‡ºæ¥çš„æ•°æ®ã€‚<br>çœ‹åˆ°è¿™é‡Œç«Ÿç„¶æœ‰æ„å¤–æ”¶è·ï¼æ³¨æ„é»„è‰²æ¡†è¢«æ³¨é‡Šçš„éƒ¨åˆ†ï¼Œçœ‹æ¥å­¦æ ¡çš„æ•™åŠ¡ç³»ç»Ÿæœ‰è®¡ç®—ç»©ç‚¹çš„åŠŸèƒ½çš„ï¼Œä¸çŸ¥ç”±äºä½•ç§åŸå› ä¸ç”¨å‘¢ï¼Ÿ</div></p><p>è¿™é‡Œæ˜¯è¿™æ®µç¨‹åºä¸­æœ€å›°éš¾çš„éƒ¨åˆ†ï¼Œæˆ‘ä¹Ÿè¸©äº†å¾ˆå¤šå‘ã€‚æˆ‘å‚ç…§çš„åšå®¢æ˜¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æŠ½å–æƒ³è¦çš„ä¿¡æ¯çš„ï¼Œä½†æˆ‘å¯¹æ­£åˆ™è¡¨è¾¾å¼æŒæ¡çš„å¹¶ä¸å¥½ï¼Œå¼„äº†å¥½ä¹…ä¹Ÿæ²¡å†™å‡ºåˆé€‚çš„è¡¨è¾¾å¼ï¼Œäºæ˜¯æˆ‘æœæ–­æ”¾å¼ƒäº†ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‡‡ç”¨BeautifulSoupæ¥è¿›è¡Œä¿¡æ¯çš„ç­›é€‰ã€‚<br><a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/index.zh.html" target="_blank" rel="noopener">BeautifulSoupç”¨æ³•å‚è€ƒ</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs undefined"># å°†å†…å®¹ä»é¡µé¢æºç ä¸­æå–å‡ºæ¥<br>   def deal_data(self, myPage):<br><br>       soup = BeautifulSoup(myPage)<br><br>       # ä»titleå±æ€§ä¸ºæœ‰æ•ˆæˆç»©çš„æ ‡ç­¾ä¸­è·å–æ‰€æœ‰classå±æ€§ä¸ºt_conçš„TAG(træ ‡ç­¾)<br>       trs = soup.find(attrs=&#123;&quot;title&quot;: &quot;æœ‰æ•ˆæˆç»©&quot;&#125;).findAll(attrs=&#123;&quot;class&quot;: &quot;t_con&quot;&#125;)<br><br>       # ä»træ ‡ç­¾ä¸­çš„tdæ ‡ç­¾ä¸­è·å–éœ€è¦çš„ä¿¡æ¯ã€‚ä¸‹æ ‡ä¸º3ï¼Œ7ï¼Œ8çš„åˆ†åˆ«ä¸ºè¯¾ç¨‹åï¼Œå­¦åˆ†ï¼Œæˆç»©<br>       for tr in trs:<br>           for index, td in enumerate(tr.findAll(&apos;td&apos;)):  # enumerateèƒ½åœ¨forå¾ªç¯ä¸­ä½¿ç”¨ä¸‹æ ‡<br><br>               if index == 3:<br>                   print td.text<br>               elif index == 7:<br>                   self.weights.append(td.text.encode(&apos;utf8&apos;))<br>                   print td.text<br>               elif index == 8:<br>                   self.points.append(td.text.encode(&apos;utf8&apos;))<br>                   print td.text<br><br>           print<br></code></pre></td></tr></table></figure><p>æ•´ä¸ªé€»è¾‘æˆ‘ç®€å•è¯´ä¸€ä¸‹ï¼Œæˆ‘è§‰å¾—è¿˜å¯ä»¥æ”¹è¿›ã€‚<br>é¦–å…ˆæŸ¥æ‰¾titleå±æ€§ä¸ºâ€æœ‰æ•ˆæˆç»©â€œçš„æ ‡ç­¾ï¼Œé€šè¿‡ä¸Šæ–‡çš„æˆªå›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™æ˜¯é‚£ä¸ªdivæ ‡ç­¾ï¼Œä¹‹ååœ¨è¯¥divæ ‡ç­¾ä¸­å®šä½classä¸ºt_conçš„træ ‡ç­¾ã€‚ä½ ä¹Ÿè®¸ä¼šé—®ä¸ºä»€ä¹ˆä¸ç›´æ¥å®šä½åˆ°træ ‡ç­¾ï¼Œå› ä¸ºåé¢çš„ç½‘é¡µä»£ç ä¸­è¿˜å­˜åœ¨class ä¸ºt_conçš„træ ‡ç­¾ï¼Œä½†ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„æˆç»©ã€‚ç„¶ååœ¨æ¯ä¸ªtræ ‡ç­¾ä¸‹æŠ½å–ä¸‹æ ‡ä¸º3ï¼Œ7ï¼Œ8çš„æ ‡ç­¾ï¼Œè¿™é‡Œæˆ‘æ˜¯æŠŠå®ƒå­˜åˆ°æ•°ç»„é‡Œäº†ã€‚<br>æ¥ä¸‹æ¥å°±æ¸…æ™°äº†ï¼Œå…ˆæ‰“å°æˆç»©ä¿¡æ¯ï¼Œç„¶åè®¡ç®—ç»©ç‚¹ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-f6d0aff398d0089a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œæˆªå›¾"></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-3d48f5287d16407e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-2-grade/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œæˆªå›¾"><br>å­¦æ¸£ä¸€ä¸ªï¼Œç»©ç‚¹ä½è¯·å¿½ç•¥ã€‚</p><p>æºç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs undefined"># encoding=utf8<br>import urllib<br>import urllib2<br>import cookielib<br>import re<br>import string<br>from BeautifulSoup import BeautifulSoup<br>import sys<br><br>reload(sys)<br>sys.setdefaultencoding(&apos;utf8&apos;)<br><br><br>class SDJZU_Crawler:<br>    # å£°æ˜ç›¸å…³çš„å±æ€§<br>    def __init__(self):<br><br>        self.loginUrl = &apos;http://urpe.sdjzu.edu.cn/loginPortalUrlForIndexLogin.portal&apos;  # ç™»å½•çš„url<br>        self.resultUrl = &apos;http://jwfw1.sdjzu.edu.cn/ssfw/jwnavmenu.do?menuItemWid=1E057E24ABAB4CAFE0540010E0235690&apos;  # æŸ¥è¯¢æˆç»©çš„url<br>        self.cookieJar = cookielib.CookieJar()  # åˆå§‹åŒ–ä¸€ä¸ªCookieJaræ¥å¤„ç†Cookieçš„ä¿¡æ¯<br>        self.postdata = urllib.urlencode(&#123;&apos;userName&apos;: &apos;&apos;, &apos;password&apos;: &apos;&apos;&#125;)  # ç™»å½•éœ€è¦POSTçš„æ•°æ®<br>        self.weights = []  # å­˜å‚¨æƒé‡ï¼Œä¹Ÿå°±æ˜¯å­¦åˆ†<br>        self.points = []  # å­˜å‚¨åˆ†æ•°ï¼Œä¹Ÿå°±æ˜¯æˆç»©<br>        self.opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(self.cookieJar))<br><br>    def sdjzu_init(self):<br>        username = raw_input(&apos;è¯·è¾“å…¥å­¦å·:&apos;)  # è¿™é‡Œä¸è¦ç”¨inputï¼ŒäºŒè€…åŒºåˆ«è¯·è‡ªè¡ŒæŸ¥è¯¢<br>        password = raw_input(&apos;è¯·è¾“å…¥å¯†ç :&apos;)<br>        self.postdata = urllib.urlencode(&#123;&apos;userName&apos;: username, &apos;password&apos;: password&#125;)  # å°†ç”¨æˆ·åå¯†ç åŠ å…¥åˆ°POSTä¸­<br>        # åˆå§‹åŒ–é“¾æ¥å¹¶ä¸”è·å–cookie<br>        myRequest = urllib2.Request(url=self.loginUrl, data=self.postdata)  # è‡ªå®šä¹‰ä¸€ä¸ªè¯·æ±‚<br>        result = self.opener.open(myRequest)  # è®¿é—®ç™»å½•é¡µé¢ï¼Œè·å–åˆ°å¿…é¡»çš„cookieçš„å€¼<br>        result = self.opener.open(self.resultUrl)  # è®¿é—®æˆç»©é¡µé¢ï¼Œè·å¾—æˆç»©çš„æ•°æ®<br>        self.deal_data(result.read())<br>        self.calculate_gpa()<br><br>    # å°†å†…å®¹ä»é¡µé¢æºç ä¸­æå–å‡ºæ¥<br>    def deal_data(self, myPage):<br><br>        soup = BeautifulSoup(myPage)<br><br>        # ä»titleå±æ€§ä¸ºæœ‰æ•ˆæˆç»©çš„æ ‡ç­¾ä¸­è·å–æ‰€æœ‰classå±æ€§ä¸ºt_conçš„TAG(træ ‡ç­¾)<br>        trs = soup.find(attrs=&#123;&quot;title&quot;: &quot;æœ‰æ•ˆæˆç»©&quot;&#125;).findAll(attrs=&#123;&quot;class&quot;: &quot;t_con&quot;&#125;)<br><br>        # ä»træ ‡ç­¾ä¸­çš„tdæ ‡ç­¾ä¸­è·å–éœ€è¦çš„ä¿¡æ¯ã€‚ä¸‹æ ‡ä¸º3ï¼Œ7ï¼Œ8çš„åˆ†åˆ«ä¸ºè¯¾ç¨‹åï¼Œå­¦åˆ†ï¼Œæˆç»©<br>        for tr in trs:<br>            for index, td in enumerate(tr.findAll(&apos;td&apos;)):  # enumerateèƒ½åœ¨forå¾ªç¯ä¸­ä½¿ç”¨ä¸‹æ ‡<br><br>                if index == 3:<br>                    print td.text<br>                elif index == 7:<br>                    self.weights.append(td.text.encode(&apos;utf8&apos;))<br>                    print td.text<br>                elif index == 8:<br>                    self.points.append(td.text.encode(&apos;utf8&apos;))<br>                    print td.text<br><br>            print<br><br>    # è®¡ç®—ç»©ç‚¹ï¼Œå¦‚æœæˆç»©è¿˜æ²¡å‡ºæ¥ï¼Œå°±ä¸ç®—è¯¥æˆç»©ï¼Œ<br>    def calculate_gpa(self):<br>        point = 0.0  # æˆç»©<br>        weight = 0.0  # å­¦åˆ†<br>        for i in range(len(self.points)):<br>            if self.points[i].isdigit() and (self.weights[i] != 0):<br>                point += string.atof(self.points[i]) * string.atof(self.weights[i])  # æˆç»©*å­¦åˆ†ç´¯åŠ æ±‚å’Œ<br>                weight += string.atof(self.weights[i])  # å­¦åˆ†ç´¯åŠ æ±‚å’Œ<br><br>        print &quot;ç»©ç‚¹ä¸ºï¼š&quot;<br>        print point / weight  # è¾“å‡ºç»©ç‚¹ å€¼æˆç»©*å­¦åˆ†ç´¯åŠ æ±‚å’Œ / å­¦åˆ†ç´¯åŠ æ±‚å’Œ<br><br><br># è°ƒç”¨<br>mySpider = SDJZU_Crawler()<br>mySpider.sdjzu_init()<br></code></pre></td></tr></table></figure><p><a href="https://github.com/Flywith24" target="_blank" rel="noopener">æˆ‘çš„githubåœ°å€</a></p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> çˆ¬è™« </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2.1å¼€å§‹ç¬¬ä¸€ä¸ªçˆ¬è™«ç¨‹åº</title>
      <link href="/2017/06/18/2-1-first-program/"/>
      <url>/2017/06/18/2-1-first-program/</url>
      
        <content type="html"><![CDATA[<h3 id="1-å®‰è£…IDEä»¥åŠhello-world"><a href="#1-å®‰è£…IDEä»¥åŠhello-world" class="headerlink" title="1. å®‰è£…IDEä»¥åŠhello world"></a>1. å®‰è£…IDEä»¥åŠhello world</h3><blockquote><p>ä¸€ä¸ªä¼˜ç§€çš„IDEå¯ä»¥æå¤§åœ°æé«˜å·¥ä½œæ•ˆç‡ï¼Œåœ¨è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨JetBrainså…¬å¸çš„PyCharmã€‚æ˜¯ä¸æ˜¯æœ‰äº›çœ¼ç†Ÿï¼Ÿæ²¡é”™ï¼ŒIDEA å’ŒAndroid Studioå°±æ˜¯ä»–ä»¬åšçš„ï¼ŒJetBrainså‡ºå“ï¼Œå¿…å±ç²¾å“ã€‚</p></blockquote><a id="more"></a><p><a href="https://www.jetbrains.com/pycharm/" target="_blank" rel="noopener">ç‚¹å‡»è¿›å…¥ä¸‹è½½é“¾æ¥</a></p><p>ç‚¹å‡»downloadé€‰æ‹©ç›¸åº”å¹³å°åŠç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ç¤¾åŒºç‰ˆã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-752e691985633d3e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-1-first-program/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä¸‹è½½ç•Œé¢"></p><p>å®‰è£…è¿‡ç¨‹ï¼Œåˆ‡æ¢ä¸»é¢˜ï¼Œè°ƒæ•´å­—ä½“ä¹‹ç±»çš„éƒ½è·Ÿè·ŸIDEAç±»ä¼¼ï¼Œä¸éœ€èµ˜è¿°ã€‚</p><p>é‚£ä¹ˆå¼€å§‹æˆ‘ä»¬çš„hello worldç¨‹åºå§ã€‚<br>æ–°å»ºä¸€ä¸ªPython file ï¼Œç„¶åå†™å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">print (&quot;hello world&quot;)<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è¿è¡Œåœ¨å·¥ä½œåŒºå³å‡» runå³å¯</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-4ffc1a9c05699113.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-1-first-program/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å³å‡»è¿è¡Œ"><br>ä¹‹åå°±ä¼šåœ¨Toolbarä¸Šæ˜¾ç¤ºrunæŒ‰é’®äº†</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-a540d17991f6282d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-1-first-program/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œæˆªå›¾"><br>å¾ˆæ£’æœ‰æœ¨æœ‰</p><h3 id="2-1-å…ˆçˆ¬ä»–ä¸€ä¸ªç½‘é¡µä¸‹æ¥"><a href="#2-1-å…ˆçˆ¬ä»–ä¸€ä¸ªç½‘é¡µä¸‹æ¥" class="headerlink" title="2.1 å…ˆçˆ¬ä»–ä¸€ä¸ªç½‘é¡µä¸‹æ¥"></a>2.1 å…ˆçˆ¬ä»–ä¸€ä¸ªç½‘é¡µä¸‹æ¥</h3><p>æ•²å…¥å¦‚ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs undefined">import urllib2<br><br>response = urllib2.urlopen(&quot;http://www.baidu.com&quot;)<br>print response.read()<br></code></pre></td></tr></table></figure><p>ç‚¹å‡»è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç»“æœ</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-165b12f5711bcd47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-1-first-program/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>è¿™ä¸ªç½‘é¡µçš„æºç è¢«æˆ‘ä»¬çˆ¬ä¸‹æ¥äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼</p><h3 id="2-2-åˆ†æä»£ç "><a href="#2-2-åˆ†æä»£ç " class="headerlink" title="2.2 åˆ†æä»£ç "></a>2.2 åˆ†æä»£ç </h3><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹è¿™æ®µä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">import urllib2<br></code></pre></td></tr></table></figure><p>urllib2åº“æ˜¯å­¦ä¹ Pythonçˆ¬è™«æœ€åŸºæœ¬çš„æ¨¡å—ï¼Œåˆ©ç”¨è¿™ä¸ªæ¨¡å—æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç½‘é¡µçš„å†…å®¹ï¼Œå¹¶å¯¹å†…å®¹ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–åˆ†æï¼Œå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">response = urllib2.urlopen(&quot;http://www.baidu.com&quot;)<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬è°ƒç”¨çš„æ˜¯urllib2åº“é‡Œé¢çš„urlopenæ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªURLï¼Œè¿™ä¸ªç½‘å€æ˜¯ç™¾åº¦é¦–é¡µï¼Œåè®®æ˜¯HTTPåè®®ï¼Œurlopenä¸€èˆ¬æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-f03abc16265de8dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/18/2-1-first-program/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="urlopenå‚æ•°"></p><p>ç¬¬ä¸€ä¸ªå‚æ•°urlå³ä¸ºURLï¼Œç¬¬äºŒä¸ªå‚æ•°dataæ˜¯è®¿é—®URLæ—¶è¦ä¼ é€çš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªtimeoutæ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</p><p>ç¬¬äºŒä¸‰ä¸ªå‚æ•°æ˜¯å¯ä»¥ä¸ä¼ é€çš„ï¼Œdataé»˜è®¤ä¸ºç©ºNoneï¼Œtimeouté»˜è®¤ä¸º socket._GLOBAL_DEFAULT_TIMEOUT</p><p>ç¬¬ä¸€ä¸ªå‚æ•°URLæ˜¯å¿…é¡»è¦ä¼ é€çš„ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œé¢æˆ‘ä»¬ä¼ é€äº†ç™¾åº¦çš„URLï¼Œæ‰§è¡Œurlopenæ–¹æ³•ä¹‹åï¼Œè¿”å›ä¸€ä¸ªresponseå¯¹è±¡ï¼Œè¿”å›ä¿¡æ¯ä¾¿ä¿å­˜åœ¨è¿™é‡Œé¢ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">print response.read()<br></code></pre></td></tr></table></figure><p>responseå¯¹è±¡æœ‰ä¸€ä¸ªreadæ–¹æ³•ï¼Œå¯ä»¥è¿”å›è·å–åˆ°çš„ç½‘é¡µå†…å®¹</p><h3 id="2-3-æ„é€ Request"><a href="#2-3-æ„é€ Request" class="headerlink" title="2.3 æ„é€ Request"></a>2.3 æ„é€ Request</h3><p>ä¸Šé¢çš„urlopenå‚æ•°å¯ä»¥ä¼ å…¥ä¸€ä¸ªrequestè¯·æ±‚,å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªRequestç±»çš„å®ä¾‹ï¼Œæ„é€ æ—¶éœ€è¦ä¼ å…¥Url,Dataç­‰ç­‰çš„å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ä»£ç æ”¹å†™ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs undefined">import urllib2<br><br>request = urllib2.Request(&quot;http://www.baidu.com&quot;)<br>response = urllib2.urlopen(request)<br>print response.read()<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¸­é—´å¤šäº†ä¸€ä¸ªrequestå¯¹è±¡ï¼Œæ¨èå¤§å®¶è¿™ä¹ˆå†™ï¼Œå› ä¸ºåœ¨æ„å»ºè¯·æ±‚æ—¶è¿˜éœ€è¦åŠ å…¥å¥½å¤šå†…å®¹ï¼Œé€šè¿‡æ„å»ºä¸€ä¸ªrequestï¼ŒæœåŠ¡å™¨å“åº”è¯·æ±‚å¾—åˆ°åº”ç­”ï¼Œè¿™æ ·æ˜¾å¾—é€»è¾‘ä¸Šæ¸…æ™°æ˜ç¡®ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> çˆ¬è™« </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1.1ä½¿ç”¨å‡½æ•°</title>
      <link href="/2017/06/05/1-1-use-function/"/>
      <url>/2017/06/05/1-1-use-function/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æˆ‘ä»¬ç¼–ç¨‹æ—¶å¾ˆå®¹æ˜“ç–²åŠ³ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªå¯ä»¥åœ¨ä¸€æ®µæ—¶é—´åæé†’ä½ ä¼‘æ¯çš„å°ç¨‹åºã€‚æ¯”å¦‚æ¯éš”ä¸¤ä¸ªå°æ—¶æ‰“å¼€<a href="http://lines.frvr.com" target="_blank" rel="noopener">http://lines.frvr.com</a> æ­¤ç½‘ç«™æ¥ç©ä¸€ä¼šå„¿å°æ¸¸æˆã€‚</p></blockquote><a id="more"></a><p>è®©æˆ‘ä»¬æ¥åˆ†æä¸‹éœ€è¦å“ªäº›æ­¥éª¤<br>æˆ‘ä»¬é¦–å…ˆè¦è®©ç¨‹åºç­‰å¾…ä¸¤ä¸ªå°æ—¶ï¼Œåœ¨éœ€è¦ä¼‘æ¯çš„æ—¶å€™æ‰“å¼€æµè§ˆå™¨å¹¶è½¬åˆ°è¿™ä¸ªå°æ¸¸æˆçš„ç½‘ç«™ã€‚ä¹Ÿè®¸æˆ‘ä»¬ä¸€å¤©è¦ä¼‘æ¯å¤šæ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¾ªç¯æ¥è®©å…¶å®ç°å¤šæ¬¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs undefined">1. ç­‰å¾…ä¸¤å°æ—¶<br>2. æ‰“å¼€æµè§ˆå™¨<br>é‡å¤<br></code></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§~</p><p>é¦–å…ˆè®©æˆ‘ä»¬googleä¸€ä¸‹å¦‚ä½•ç”¨Pythonæ¥æ‰“å¼€æµè§ˆå™¨<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-ec11c33f9934a657.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/1-1-use-function/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="æŸ¥è¯¢Pyhonå¦‚ä½•æ‰“å¼€æµè§ˆå™¨"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">webbrowser.open(&quot;http://lines.frvr.com&quot;)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šè¿°ä»£ç å¯ä»¥ä½¿ç”¨é»˜è®¤æµè§ˆå™¨æ‰“å¼€æŒ‡å®šç½‘é¡µã€‚</p><p>è®©æˆ‘ä»¬è¯•è¯•å§~<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-ebeadc44e9ed109a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/1-1-use-function/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä¿å­˜"><br>ä¿å­˜å¹¶æ‰§è¡Œ</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-07994ea86762efd2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/1-1-use-function/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="è¿è¡Œæˆªå›¾"></p><p>å‡ºç°äº†é”™è¯¯ï¼Œä¸è¿‡å­¦è¿‡javaçš„ä½ è‚¯å®šèƒ½çœ‹æ‡‚æ˜¯ä»€ä¹ˆåŸå› ã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-5f2951beae5bec8e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/1-1-use-function/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="ä¿®æ­£"><br>å¯¼å…¥webbrowseræ¨¡å—å°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼Œä¸è¦è¢«è¿™ä¸ªç½‘ç«™çš„å°æ¸¸æˆå¸å¼•èµ°å“¦ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰ç»“æŸã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹Pythonå¦‚ä½•èƒ½è®©ç¨‹åºç­‰å¾…2å°æ—¶ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬æŠŠç­‰å¾…æ—¶é—´è®¾ç½®ä¸º3ç§’</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-0690b4988c6f6ae1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/1-1-use-function/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Pythonè®©ç¨‹åºç­‰å¾…"></p><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨time.sleep()æ–¹æ³•å¯ä»¥æ˜¯ç¨‹åºç­‰å¾…ä¸€æ®µæ—¶é—´æ‰§è¡Œï¼Œå‚æ•°ä»¥ç§’ä¸ºå•ä½<br>æ‰€ä»¥æˆ‘ä»¬åœ¨ç¨‹åºä¸­æ·»åŠ ä»¥ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">time.sleep(3)<br></code></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿè¦å¯¼å…¥ç›¸åº”æ¨¡å—ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-3d2bb6b60a4ff0e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/1-1-use-function/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>å¾ˆç®€å•æœ‰æ²¡æœ‰ï¼Ÿ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®©å…¶å¾ªç¯3æ¬¡</p><p>è¾“å…¥ä»¥ä¸‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs undefined">import webbrowser<br>import time<br>total_breaks = 3<br>break_count = 0<br><br>print(&quot;This program started on&quot; + time.ctime())<br>while(break_count &lt; total_breaks):<br>    time.sleep(3)<br>    webbrowser.open(&quot;http://lines.frvr.com&quot;)<br>    break_count = break_count + 1<br></code></pre></td></tr></table></figure><p>ä»£ç å¾ˆç®€å•ï¼Œé¦–å…ˆæˆ‘ä»¬å®šä¹‰äº†æ€»çš„ä¼‘æ¯æ¬¡æ•°ä¸º3ï¼Œæˆ‘ä»¬åˆå®šä¹‰äº†å·²ä¼‘æ¯æ¬¡æ•°åˆå§‹å€¼ä¸º0ã€‚æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œå½“å·²ä¼‘æ¯æ¬¡æ•°å°äºæ€»ä¼‘æ¯æ¬¡æ•°æ—¶æ‰§è¡Œå¾ªç¯ä½“ã€‚æœ€åå°†å·²ä¼‘æ¯æ¬¡æ•°åŠ 1ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯whileå¾ªç¯å¹¶æ²¡æœ‰èŠ±æ‹¬å·ã€‚</p><p>å­¦ä¹  Python ä¸å…¶ä»–è¯­è¨€æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼ŒPython çš„ä»£ç å—ä¸ä½¿ç”¨å¤§æ‹¬å· {} æ¥æ§åˆ¶ç±»ï¼Œå‡½æ•°ä»¥åŠå…¶ä»–é€»è¾‘åˆ¤æ–­ã€‚python æœ€å…·ç‰¹è‰²çš„å°±æ˜¯ç”¨ç¼©è¿›æ¥å†™æ¨¡å—ã€‚<br>ç¼©è¿›çš„ç©ºç™½æ•°é‡æ˜¯å¯å˜çš„ï¼Œä½†æ˜¯æ‰€æœ‰ä»£ç å—è¯­å¥å¿…é¡»åŒ…å«ç›¸åŒçš„ç¼©è¿›ç©ºç™½æ•°é‡ï¼Œè¿™ä¸ªå¿…é¡»ä¸¥æ ¼æ‰§è¡Œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs undefined">if True:<br>    print &quot;True&quot;<br>else:<br>  print &quot;False&quot;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹ä»£ç å°†ä¼šæ‰§è¡Œé”™è¯¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs undefined">#!/usr/bin/python<br># -*- coding: UTF-8 -*-<br># æ–‡ä»¶åï¼štest.py<br> if True:<br>    print &quot;Answer&quot;<br>    print &quot;True&quot;<br>else:<br>    print &quot;Answer&quot;<br>    # æ²¡æœ‰ä¸¥æ ¼ç¼©è¿›ï¼Œåœ¨æ‰§è¡Œæ—¶ä¼šæŠ¥é”™<br>  print &quot;False&quot;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯æé†’ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs undefined">$ python test.py  <br>  File &quot;test.py&quot;, line 5<br>    if True:<br>    ^<br>IndentationError: unexpected indent<br></code></pre></td></tr></table></figure><p> IndentationError: unexpected indent é”™è¯¯æ˜¯ python ç¼–è¯‘å™¨æ˜¯åœ¨å‘Šè¯‰ä½ â€Hiï¼Œè€å…„ï¼Œä½ çš„æ–‡ä»¶é‡Œæ ¼å¼ä¸å¯¹äº†ï¼Œå¯èƒ½æ˜¯tabå’Œç©ºæ ¼æ²¡å¯¹é½çš„é—®é¢˜â€ï¼Œæ‰€æœ‰ python å¯¹æ ¼å¼è¦æ±‚éå¸¸ä¸¥æ ¼ã€‚<br>å¦‚æœæ˜¯ IndentationError: unindent does not match any outer indentation levelé”™è¯¯è¡¨æ˜ï¼Œä½ ä½¿ç”¨çš„ç¼©è¿›æ–¹å¼ä¸ä¸€è‡´ï¼Œæœ‰çš„æ˜¯ tab é”®ç¼©è¿›ï¼Œæœ‰çš„æ˜¯ç©ºæ ¼ç¼©è¿›ï¼Œæ”¹ä¸ºä¸€è‡´å³å¯ã€‚<br>å› æ­¤ï¼Œåœ¨ Python çš„ä»£ç å—ä¸­å¿…é¡»ä½¿ç”¨ç›¸åŒæ•°ç›®çš„è¡Œé¦–ç¼©è¿›ç©ºæ ¼æ•°ã€‚<br>å»ºè®®ä½ åœ¨æ¯ä¸ªç¼©è¿›å±‚æ¬¡ä½¿ç”¨ å•ä¸ªåˆ¶è¡¨ç¬¦ æˆ– ä¸¤ä¸ªç©ºæ ¼ æˆ– å››ä¸ªç©ºæ ¼ , åˆ‡è®°ä¸èƒ½æ··ç”¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> çˆ¬è™« </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0.ä»é›¶å¼€å§‹ï¼ŒPythonçš„å®‰è£…</title>
      <link href="/2017/06/05/0-indtall-python/"/>
      <url>/2017/06/05/0-indtall-python/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¿™å­¦æœŸè®¡ç®—æœºç½‘ç»œè¯¾ç¨‹æœ‰ä¸€ä¸ªè¯¾ç¨‹è®¾è®¡ï¼Œè¦æ±‚ä½¿ç”¨Pythonå†™ä¸€ä¸ªå°ç¨‹åºã€‚ä¹‹å‰ä¹Ÿæ²¡æ¥è§¦è¿‡Pythonï¼Œä»ä¼˜è¾¾å­¦åŸé‡Œçœ‹åˆ°ä¸€ä¸ªå…³äºPythonçš„è¯¾ç¨‹ï¼Œåœ¨æ­¤è®°å½•ã€‚</p></blockquote><a id="more"></a><h3 id="Windowså®‰è£…"><a href="#Windowså®‰è£…" class="headerlink" title="Windowså®‰è£…"></a>Windowså®‰è£…</h3><p>ä¸‹è½½åœ°å€ï¼š<a href="https://www.python.org/downloads/" target="_blank" rel="noopener">https://www.python.org/downloads/</a></p><hr><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-837d626cf0404cc4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/0-indtall-python/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å®‰è£…æ­¥éª¤1"></p><p>ç¡®ä¿å®‰è£…äº† pip å¹¶ä¸” Python æ·»åŠ åˆ°äº†ä½ çš„ PATHã€‚</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-1ce43800911a180c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/0-indtall-python/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-9bccbfe4b2d0e766.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/0-indtall-python/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å®‰è£…æ­¥éª¤2"></p><p>è¦æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸï¼Œæ‰“å¼€ IDLEï¼ˆPython å®‰è£…çš„ä¸€æ¬¾ç¨‹åºï¼Œä½¿ä½ èƒ½å¤Ÿè½»æ¾åœ°ç¼–è¾‘å’Œè¿è¡Œ Python ä»£ç ï¼‰ã€‚</p><p>a) Windows 7ï¼ˆåŠæ›´æ—©ç‰ˆæœ¬ï¼‰ï¼šä¾æ¬¡ç‚¹å‡»â€œå¼€å§‹â€èœå•&gt;â€œæ‰€æœ‰ç¨‹åºâ€&gt;â€œPython 2.7â€ï¼Œæœ€åé€‰æ‹© IDLE (Python GUI)ã€‚</p><p>b) Windows 8/10ï¼šæœç´¢ IDLEã€‚ç›®å‰ï¼Œä½ å¯ä»¥ä»å±å¹•å³ä¾§å‘å·¦æ»‘åŠ¨æˆ–ç”¨é¼ æ ‡ç‚¹å‡»å±å¹•çš„å³ä¸‹è§’è¿›è¡Œæœç´¢ã€‚</p><hr><h3 id="MACå®‰è£…"><a href="#MACå®‰è£…" class="headerlink" title="MACå®‰è£…"></a>MACå®‰è£…</h3><p>è¦åœ¨ Mac æœºå™¨ä¸Šå®‰è£… Pythonï¼Œä½ å¯ä»¥é‡‡ç”¨ä¸¤ç§æ–¹æ³•ï¼šåœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ Homebrewï¼Œæˆ–åœ¨å®˜ç½‘ä¸Šæ‰¾åˆ°æ™®é€šçš„ Python å®‰è£…ç¨‹åºã€‚</p><p>æ–¹æ³• 1ï¼šç¨‹åºåŒ…å®‰è£…ç¨‹åº<br>å®‰è£…åœ°å€ï¼š<a href="https://www.python.org/downloads/release/python-2713/" target="_blank" rel="noopener">https://www.python.org/downloads/release/python-2713/</a><br>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</p><p>a) IDLE åº”è¯¥ä½äºæ‚¨çš„åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ä¸­ã€‚<br><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-746f86c26858feec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/0-indtall-python/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt><br>b)é€šè¿‡æŒ‰ä¸‹ âŒ˜+ç©ºæ ¼é”®ï¼Œæ‰“å¼€ Spotlight ï¼Œå¹¶è¾“å…¥â€œidleâ€æ¥æŸ¥æ‰¾ IDLE</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-327506f6845e4d77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/0-indtall-python/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt><br>ä»¥ä¸‹æ˜¯å®ƒåœ¨æˆ‘ä»¬çš„è®¡ç®—æœºä¸Šè¿è¡Œçš„å±å¹•æˆªå›¾ï¼</p><p><img class="lazyload" data-original="http://upload-images.jianshu.io/upload_images/3155702-f5b789535b05b7ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="/2017/06/05/0-indtall-python/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt></p><p>æ–¹æ³• 2ï¼šHomebrew<br>è¦é€šè¿‡ Homebrew å®‰è£… Pythonï¼Œåªéœ€æ‰§è¡Œä»¥ä¸‹ä¸¤æ­¥ï¼š</p><p>æ‰“å¼€ç»ˆç«¯ï¼Œå¹¶è¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)â€ã€‚<br></code></pre></td></tr></table></figure><p>å®‰è£…è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šå¤šæ¬¡å‘å‡ºæç¤º ã€‚<br>å®‰è£…å®Œ Homebrew åï¼Œä½ å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ brew helpï¼ŒéªŒè¯ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ã€‚ç°åœ¨è¾“å…¥ brew install python è·å– Python 2 çš„æœ€æ–°ç‰ˆæœ¬ã€‚è¿™æ ·å°±å¯ä»¥äº†ï¼</p><p>é€šè¿‡åœ¨å‘½ä»¤è¡Œé‡Œè¾“å…¥ python å³å¯éªŒè¯ Python æ˜¯å¦å®‰è£…æ­£ç¡®ã€‚ç³»ç»Ÿåº”è¯¥æ¬¢è¿ä½ ä½¿ç”¨ Python Shellã€‚</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> çˆ¬è™« </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
